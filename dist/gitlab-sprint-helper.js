// ==UserScript==
// @name         GitLab Sprint Helper
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Display a summary of assignees' time estimates on GitLab boards with API integration and comment shortcuts
// @author       Daniel Samer | Linkster
// @match        https://gitlab.com/*/boards/*
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-idle
// @updateURL    https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// @downloadURL  https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// ==/UserScript==

!function(e){e.formatHours=function formatHours(e){return(e/3600).toFixed(1)},e.formatDuration=function formatDuration(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60);return t>0&&s>0?`${t}h ${s}m`:t>0?`${t}h`:`${s}m`},e.getNestedProperty=function getNestedProperty(e,t){return t.split(".").reduce(((e,t)=>e&&e[t]?e[t]:null),e)},e.truncateText=function truncateText(e,t){return!e||e.length<=t?e:e.substring(0,t)+"..."},e.safeJSONParse=function safeJSONParse(e,t={}){try{return JSON.parse(e)}catch(e){return console.error("Error parsing JSON:",e),t}},e.waitForElement=function waitForElement(e,t=1e4){return new Promise(((s,n)=>{if(document.querySelector(e))return s(document.querySelector(e));const i=new MutationObserver((()=>{document.querySelector(e)&&(i.disconnect(),s(document.querySelector(e)))}));i.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{i.disconnect(),n(new Error(`Timeout waiting for element: ${e}`))}),t)}))},e.generateColorFromString=function generateColorFromString(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return`hsl(${Math.abs(t)%360}, 70%, 75%)`},e.getContrastColor=function getContrastColor(t){if(t.startsWith("hsl")){const e=t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%\s*\)/);if(e&&e[1]){return parseInt(e[1],10)>60?"black":"white"}}let s=0,n=0,i=0;try{const o=document.createElement("div");o.style.backgroundColor=t,document.body.appendChild(o);const a=e.getComputedStyle(o).backgroundColor;document.body.removeChild(o);const l=a.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);l&&(s=parseInt(l[1],10),n=parseInt(l[2],10),i=parseInt(l[3],10))}catch(e){return t.startsWith("hsl")&&t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)?parseInt(t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)[1],10)>60?"black":"white":"black"}return(.299*s+.587*n+.114*i)/255>.5?"black":"white"},e.getPathFromUrl=function getPathFromUrl(){try{const t=e.location.pathname;if(t.includes("/groups/")&&t.includes("/-/boards")){const e=/\/groups\/([^\/]+(?:\/[^\/]+)*)\/?\-?\/?boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract group path from URL:",t),null;const n=s[1].replace(/\/-$/,""),i=encodeURIComponent(n);return{path:n,encodedPath:i,type:"group",apiUrl:`groups/${i}/labels`}}if(t.includes("/-/boards")){const e=/^\/([^\/]+(?:\/[^\/]+)*)\/-\/boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract project path from URL pattern:",t),null;const n=s[1],i=encodeURIComponent(n);return{path:n,encodedPath:i,type:"project",apiUrl:`projects/${i}/labels`}}return console.warn("Not on a GitLab boards page:",t),null}catch(e){return console.error("Error extracting path from URL:",e),null}},e.getCurrentUrlKey=function getCurrentUrlKey(){return e.location.href.split("#")[0]},e.getHistoryKey=function getHistoryKey(){return`timeEstimateHistory_${getCurrentUrlKey()}`},e.GitLabAPI=class GitLabAPI{constructor(){this.csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),this.baseUrl="/api/v4"}callGitLabApi(e,t={}){const{method:s="GET",data:n=null,params:i=null}=t;let o=`${this.baseUrl}/${e}`;if(i){const e=new URLSearchParams;Object.entries(i).forEach((([t,s])=>{null!=s&&e.append(t,s)}));const t=e.toString();t&&(o+=`?${t}`)}const a={method:s,headers:{"Content-Type":"application/json"},credentials:"same-origin"};return"GET"!==s&&this.csrfToken&&(a.headers["X-CSRF-Token"]=this.csrfToken),n&&["POST","PUT","PATCH"].includes(s)&&(a.body=JSON.stringify(n)),fetch(o,a).then((e=>{if(!e.ok)throw new Error(`API request failed: ${e.status} ${e.statusText}`);return e.json()}))}getIssue(e){const t=e.referencePath.split("#")[0],s=e.iid,n=encodeURIComponent(t);return this.callGitLabApi(`projects/${n}/issues/${s}`)}addComment(e,t){const s=e.referencePath.split("#")[0],n=e.iid,i=encodeURIComponent(s);return this.callGitLabApi(`projects/${i}/issues/${n}/notes`,{method:"POST",data:{body:t}})}getCurrentUser(){return this.callGitLabApi("user")}getProject(e){return this.callGitLabApi(`projects/${e}`)}getProjectIssues(e,t={}){return this.callGitLabApi(`projects/${e}/issues`,{params:t})}getMilestone(e,t){return this.callGitLabApi(`projects/${e}/milestones/${t}`)}updateIssue(e,t){const s=e.referencePath.split("#")[0],n=e.iid,i=encodeURIComponent(s);return this.callGitLabApi(`projects/${i}/issues/${n}`,{method:"PUT",data:t})}getIssueItemFromCard(e){try{if(e.__vue__&&e.__vue__.$children){const t=e.__vue__.$children.find((e=>e.$props&&e.$props.item));if(t&&t.$props&&t.$props.item)return t.$props.item}}catch(e){console.error("Error getting issue item from card:",e)}return null}},e.GitLabAPI=GitLabAPI,e.processBoards=function processBoards(){const e={},t={},s={};let n=0,i=0,o=0,a=null,l=0;return document.querySelectorAll(".board-list").forEach(((r,d)=>{let c="U"+d.toString();try{if(r.__vue__&&r.__vue__.$children&&r.__vue__.$children.length>0){const e=r.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(c=e.$props.list.title)}if("Unknown"===c){const e=r.querySelector(".board-title-text");e&&(c=e.textContent.trim())}}catch(e){console.error("Error getting board title:",e);const t=r.querySelector(".board-title-text");t&&(c=t.textContent.trim())}if("Unknown"===c)return;{t[c]||(t[c]={tickets:0,timeEstimate:0}),s[c]||(s[c]={});const e=c.toLowerCase();e.includes("done")||e.includes("closed")||e.includes("complete")||e.includes("finished")}const u=r.querySelectorAll(".board-card"),h=c.toLowerCase();(h.includes("done")||h.includes("closed")||h.includes("complete")||h.includes("finished"))&&(l+=u.length),u.forEach((l=>{try{if(i++,t[c].tickets++,l.__vue__&&l.__vue__.$children){const i=l.__vue__.$children.find((e=>e.$props&&e.$props.item&&void 0!==e.$props.item.timeEstimate));if(i&&i.$props){const l=i.$props;if(!a&&l.item&&l.item.milestone&&(a=l.item.milestone.title),l.item&&l.item.timeEstimate){o++;const i=l.item.timeEstimate;n+=i,t[c].timeEstimate+=i;let a=[];l.item.assignees&&l.item.assignees.nodes&&l.item.assignees.nodes.length?a=l.item.assignees.nodes:l.item.assignees&&l.item.assignees.length>0&&(a=l.item.assignees),a.length>0?a.forEach((t=>{const n=i/a.length,o=t.name;e[o]||(e[o]=0),e[o]+=n,s[c][o]||(s[c][o]={tickets:0,timeEstimate:0}),s[c][o].tickets++,s[c][o].timeEstimate+=n})):(e.Unassigned||(e.Unassigned=0),e.Unassigned+=i,s[c].Unassigned||(s[c].Unassigned={tickets:0,timeEstimate:0}),s[c].Unassigned.tickets++,s[c].Unassigned.timeEstimate+=i)}}}}catch(e){console.error("Error processing card:",e)}}))})),{assigneeTimeMap:e,boardData:t,boardAssigneeData:s,totalEstimate:n,cardsProcessed:i,cardsWithTime:o,currentMilestone:a,closedBoardCards:l}},e.saveHistoryEntry=function saveHistoryEntry(t,s,n=!1){try{const n=new Date,i=n.toISOString(),o=(t/3600).toFixed(1),a=getHistoryKey();let l="None";s&&(l=s.replace(/\n/g," ").trim());let r=GM_getValue(a,[]);const d={date:i,timestamp:n.getTime(),totalHours:o,milestone:l,url:e.location.href};let c=!1;if(0===r.length)c=!0;else{const e=r[r.length-1];e.totalHours===d.totalHours&&e.milestone===d.milestone||(c=!0)}c&&(r.push(d),r.length>100&&(r=r.slice(-100)),GM_setValue(a,r),"block"===document.getElementById("history-time-summary-content").style.display&&"function"==typeof e.renderHistory&&e.renderHistory())}catch(e){console.error("Error saving history:",e)}},e.saveToStorage=function saveToStorage(e,t){try{return"object"==typeof t?localStorage.setItem(e,JSON.stringify(t)):localStorage.setItem(e,t),!0}catch(t){return console.error(`Error saving to localStorage (${e}):`,t),!1}},e.loadFromStorage=function loadFromStorage(e,t=null){try{const s=localStorage.getItem(e);if(null===s)return t;if(s.trim().startsWith("{")||s.trim().startsWith("["))try{return JSON.parse(s)}catch(t){return console.warn(`Failed to parse value for ${e} as JSON, returning as string instead`),s}return s}catch(s){return console.error(`Error loading from localStorage (${e}):`,s),t}},e.removeFromStorage=function removeFromStorage(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error(`Error removing from localStorage (${e}):`,t),!1}},e.clearStorage=function clearStorage(e=null){try{if(e){const t=[];for(let s=0;s<localStorage.length;s++){const n=localStorage.key(s);n.startsWith(e)&&t.push(n)}t.forEach((e=>localStorage.removeItem(e)))}else localStorage.clear();return!0}catch(e){return console.error("Error clearing localStorage:",e),!1}},e.hasStorageKey=function hasStorageKey(e){try{return null!==localStorage.getItem(e)}catch(t){return console.error(`Error checking localStorage for key (${e}):`,t),!1}},e.setGMValue=function setGMValue(e,t){try{return"function"==typeof GM_setValue?(GM_setValue(e,t),!0):(console.warn("GM_setValue not available, falling back to localStorage"),saveToStorage(e,t))}catch(t){return console.error(`Error in GM_setValue (${e}):`,t),!1}},e.getGMValue=function getGMValue(e,t=null){try{if("function"==typeof GM_getValue){return GM_getValue(e,t)}return console.warn("GM_getValue not available, falling back to localStorage"),loadFromStorage(e,t)}catch(s){return console.error(`Error in GM_getValue (${e}):`,s),t}};const t="gitLabHelperLabelWhitelist",s="gitLabHelperAssigneeWhitelist",n="gitLabHelperLastActiveTab",i="gitlabTimeSummaryCollapsed",o={labelWhitelist:["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"],assigneeWhitelist:[],lastActiveTab:"summary",uiCollapsed:!1};function createUIManager(){return e.uiManager=e.uiManager||new UIManager,uiManager.settingsBtn&&(uiManager.settingsBtn.onclick=t=>{if(t.stopPropagation(),uiManager.bulkCommentsView&&uiManager.bulkCommentsView.settingsManager)uiManager.bulkCommentsView.settingsManager.openSettingsModal();else if(e.settingsManager)e.settingsManager.openSettingsModal();else{const t=new SettingsManager({labelManager:uiManager.labelManager,assigneeManager:uiManager.assigneeManager,gitlabApi:e.gitlabApi||uiManager.gitlabApi,onSettingsChanged:e=>{"all"!==e&&"labels"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addAssignShortcut()}});uiManager.bulkCommentsView&&(uiManager.bulkCommentsView.settingsManager=t),e.settingsManager=t,t.openSettingsModal()}}),uiManager}function createUIManager(t=document.body){if(!e.gitlabApi)try{e.gitlabApi=new GitLabAPI}catch(e){console.error("Error creating GitLabAPI instance:",e)}try{if(e.uiManager=e.uiManager||new UIManager,uiManager.initialize(t),e.uiManager=uiManager,!e.settingsManager&&"function"==typeof SettingsManager)try{e.settingsManager=new SettingsManager({labelManager:uiManager?.labelManager,assigneeManager:uiManager?.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:e=>{uiManager?.bulkCommentsView&&("all"!==e&&"labels"!==e||uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView.addAssignShortcut())}})}catch(e){console.error("Error creating SettingsManager:",e)}return uiManager}catch(e){return console.error("Error creating UI Manager:",e),null}}e.getLabelWhitelist=function getLabelWhitelist(){try{const e=loadFromStorage(t,null);if(null===e)return[...o.labelWhitelist];if(!Array.isArray(e))return console.warn("Label whitelist is not an array, using default"),[...o.labelWhitelist];const s=e.filter((e=>"string"==typeof e));return 0===s.length&&e.length>0?(console.warn("Label whitelist contained no valid strings, using default"),[...o.labelWhitelist]):s}catch(e){return console.error("Error getting label whitelist:",e),[...o.labelWhitelist]}},e.saveLabelWhitelist=function saveLabelWhitelist(e){try{Array.isArray(e)||(console.warn("Attempting to save invalid whitelist (not an array), using empty array instead"),e=[]);const s=e.filter((e=>"string"==typeof e));return saveToStorage(t,s)}catch(e){return console.error("Error saving label whitelist:",e),!1}},e.resetLabelWhitelist=function resetLabelWhitelist(){try{const e=[...o.labelWhitelist];return saveToStorage(t,e),e}catch(e){return console.error("Error resetting label whitelist:",e),[...o.labelWhitelist]}},e.getAssigneeWhitelist=function getAssigneeWhitelist(){try{const e=loadFromStorage(s,null);if(null===e)return[];if(!Array.isArray(e))return console.warn("Assignee whitelist is not an array, using empty array"),[];return e.filter((e=>e&&"object"==typeof e&&"string"==typeof e.username))}catch(e){return console.error("Error getting assignee whitelist:",e),[]}},e.saveAssigneeWhitelist=function saveAssigneeWhitelist(e){try{Array.isArray(e)||(console.warn("Attempting to save invalid assignee whitelist (not an array), using empty array instead"),e=[]);const t=e.filter((e=>e&&"object"==typeof e&&"string"==typeof e.username));return saveToStorage(s,t)}catch(e){return console.error("Error saving assignee whitelist:",e),!1}},e.getLastActiveTab=function getLastActiveTab(){try{const e=loadFromStorage(n,null);if(null===e)return o.lastActiveTab;if("string"!=typeof e){const t=String(e);return t&&["summary","boards","history","bulkcomments"].includes(t)?t:(console.warn("Invalid tab ID format, using default"),o.lastActiveTab)}return["summary","boards","history","bulkcomments"].includes(e)?e:(console.warn(`Unknown tab ID: ${e}, using default`),o.lastActiveTab)}catch(e){return console.error("Error getting last active tab:",e),o.lastActiveTab}},e.saveLastActiveTab=function saveLastActiveTab(e){try{const t=String(e);return["summary","boards","history","bulkcomments"].includes(t)?saveToStorage(n,t):(console.warn(`Attempting to save invalid tab ID: ${t}, using default`),saveToStorage(n,o.lastActiveTab))}catch(e){return console.error("Error saving last active tab:",e),!1}},e.getUICollapsedState=function getUICollapsedState(){try{const e=loadFromStorage(i,null);return null===e?o.uiCollapsed:"string"==typeof e?"true"===e.toLowerCase():"boolean"==typeof e?e:o.uiCollapsed}catch(e){return console.error("Error getting UI collapsed state:",e),o.uiCollapsed}},e.saveUICollapsedState=function saveUICollapsedState(e){try{let t=e;return"string"==typeof e&&(t="true"===e.toLowerCase()),t=Boolean(t),saveToStorage(i,String(t))}catch(e){return console.error("Error saving UI collapsed state:",e),!1}},e.Dropdown=class Dropdown{constructor(e){this.items=e.items||[],this.onChange=e.onChange,this.placeholder=e.placeholder||"Select an option...",this.optionRenderer=e.optionRenderer,this.searchable=e.searchable||!1,this.width=e.width||"100%",this.container=null,this.selectElement=null,this.selectedValue=null,this.open=!1}render(e){this.container=document.createElement("div"),this.container.className="custom-dropdown",this.container.style.position="relative",this.container.style.display="inline-block",this.container.style.width=this.width,this.selectElement=document.createElement("div"),this.selectElement.className="custom-dropdown-select",this.selectElement.style.border="1px solid #ddd",this.selectElement.style.borderRadius="4px",this.selectElement.style.padding="6px 10px",this.selectElement.style.backgroundColor="#fff",this.selectElement.style.cursor="pointer",this.selectElement.style.display="flex",this.selectElement.style.justifyContent="space-between",this.selectElement.style.alignItems="center",this.selectElement.style.fontSize="13px";const t=document.createElement("span");t.className="dropdown-placeholder",t.textContent=this.placeholder,t.style.color="#666";const s=document.createElement("span");s.className="dropdown-arrow",s.innerHTML="▼",s.style.fontSize="10px",s.style.marginLeft="5px",s.style.transition="transform 0.2s ease",this.selectElement.appendChild(t),this.selectElement.appendChild(s);const n=document.createElement("div");if(n.className="dropdown-menu",n.style.position="absolute",n.style.top="100%",n.style.left="0",n.style.right="0",n.style.backgroundColor="#fff",n.style.border="1px solid #ddd",n.style.borderRadius="0 0 4px 4px",n.style.maxHeight="200px",n.style.overflowY="auto",n.style.zIndex="100",n.style.display="none",n.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)",this.searchable){const e=document.createElement("div");e.style.padding="5px",e.style.position="sticky",e.style.top="0",e.style.backgroundColor="#fff",e.style.borderBottom="1px solid #eee";const t=document.createElement("input");t.type="text",t.placeholder="Search...",t.style.width="100%",t.style.padding="5px",t.style.border="1px solid #ccc",t.style.borderRadius="3px",t.style.fontSize="12px",t.addEventListener("input",(e=>{const t=e.target.value.toLowerCase();this.filterItems(t,n)})),e.appendChild(t),n.appendChild(e)}return this.populateDropdown(n),this.selectElement.addEventListener("click",(()=>{this.toggleDropdown(n,s)})),document.addEventListener("click",(e=>{!this.container.contains(e.target)&&this.open&&this.closeDropdown(n,s)})),this.container.appendChild(this.selectElement),this.container.appendChild(n),e&&e.appendChild(this.container),this.container}populateDropdown(e){this.items.forEach((t=>{const s=document.createElement("div");if(s.className="dropdown-item",s.dataset.value=t.value,s.style.padding="8px 10px",s.style.cursor="pointer",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""})),this.optionRenderer&&"function"==typeof this.optionRenderer){const e=this.optionRenderer(t);e instanceof HTMLElement?s.appendChild(e):s.innerHTML=e}else s.textContent=t.label;s.addEventListener("click",(n=>{n.stopPropagation(),this.selectItem(t,s),this.closeDropdown(e)})),e.appendChild(s)}))}filterItems(e,t){t.querySelectorAll(".dropdown-item").forEach((t=>{t.textContent.toLowerCase().includes(e)?t.style.display="":t.style.display="none"}))}toggleDropdown(e,t){this.open?this.closeDropdown(e,t):this.openDropdown(e,t)}openDropdown(e,t){if(e.style.display="block",t.style.transform="rotate(180deg)",this.open=!0,this.searchable){const t=e.querySelector("input");t&&t.focus()}}closeDropdown(e,t){e.style.display="none",t&&(t.style.transform=""),this.open=!1}selectItem(e,t){this.selectedValue=e.value;const s=this.selectElement.querySelector(".dropdown-placeholder");if(this.optionRenderer&&"function"==typeof this.optionRenderer){s.innerHTML="";const t=this.optionRenderer(e);t instanceof HTMLElement?s.appendChild(t.cloneNode(!0)):s.innerHTML=t,s.style.color=""}else s.textContent=e.label,s.style.color="";"function"==typeof this.onChange&&this.onChange(e.value,e)}setValue(e){const t=this.items.find((t=>t.value===e));if(t){const s=this.container.querySelector(`.dropdown-item[data-value="${e}"]`);if(s)return this.selectItem(t,s),!0}return!1}getValue(){return this.selectedValue}reset(){this.selectedValue=null;const e=this.selectElement.querySelector(".dropdown-placeholder");e.textContent=this.placeholder,e.style.color="#666"}updateItems(e){this.items=e;const t=this.container.querySelector(".dropdown-menu"),s=this.searchable?t.firstChild:null;t.innerHTML="",s&&t.appendChild(s),this.populateDropdown(t),this.reset()}disable(){this.selectElement.style.opacity="0.6",this.selectElement.style.pointerEvents="none"}enable(){this.selectElement.style.opacity="1",this.selectElement.style.pointerEvents="auto"}},e.Notification=class Notification{constructor(e={}){this.position="bottom-left",this.duration=e.duration||3e3,this.animationDuration=e.animationDuration||"0.3s",this.container=null,this.createContainer()}createContainer(){if(document.getElementById("gitlab-helper-notifications"))this.container=document.getElementById("gitlab-helper-notifications");else{switch(this.container=document.createElement("div"),this.container.id="gitlab-helper-notifications",this.container.style.position="fixed",this.container.style.zIndex="100",this.position){case"top-right":this.container.style.top="20px",this.container.style.right="20px";break;case"top-left":this.container.style.top="20px",this.container.style.left="20px";break;case"top-center":this.container.style.top="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;case"bottom-left":this.container.style.bottom="20px",this.container.style.left="20px";break;case"bottom-center":this.container.style.bottom="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;default:this.container.style.bottom="20px",this.container.style.right="20px"}document.body.appendChild(this.container)}}show(e){const t=e.message||"",s=e.type||"info",n=e.duration||this.duration,i=e.onClose||null,o=document.createElement("div");switch(o.className=`notification notification-${s}`,o.style.padding="12px 16px",o.style.marginBottom="10px",o.style.borderRadius="4px",o.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.minWidth="200px",o.style.maxWidth="350px",o.style.opacity="0",o.style.transform=this.getInitialTransform(),o.style.transition=`opacity ${this.animationDuration} ease, transform ${this.animationDuration} ease`,s){case"success":o.style.backgroundColor="#28a745",o.style.color="white";break;case"error":o.style.backgroundColor="#dc3545",o.style.color="white";break;case"warning":o.style.backgroundColor="#ffc107",o.style.color="black";break;default:o.style.backgroundColor="#17a2b8",o.style.color="white"}const a=document.createElement("div");a.style.flex="1",a.textContent=t;const l=document.createElement("button");return l.innerHTML="&times;",l.style.backgroundColor="transparent",l.style.border="none",l.style.color=o.style.color,l.style.fontSize="18px",l.style.marginLeft="10px",l.style.cursor="pointer",l.style.padding="0 5px",l.style.opacity="0.7",l.style.transition="opacity 0.2s ease",l.style.outline="none",l.addEventListener("mouseenter",(()=>{l.style.opacity="1"})),l.addEventListener("mouseleave",(()=>{l.style.opacity="0.7"})),l.addEventListener("click",(()=>{this.close(o,i)})),o.appendChild(a),o.appendChild(l),this.container.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),10),n>0&&setTimeout((()=>{this.close(o,i)}),n),o}close(e,t=null){"true"!==e.dataset.closing&&(e.dataset.closing="true",e.style.opacity="0",e.style.transform=this.getInitialTransform(),setTimeout((()=>{e.parentNode===this.container&&this.container.removeChild(e),t&&"function"==typeof t&&t()}),1e3*parseFloat(this.animationDuration)))}getInitialTransform(){return this.position.startsWith("top")?"translateY(-20px)":"translateY(20px)"}success(e,t={}){return this.show({message:e,type:"success",...t})}error(e,t={}){return this.show({message:e,type:"error",...t})}warning(e,t={}){return this.show({message:e,type:"warning",...t})}info(e,t={}){return this.show({message:e,type:"info",...t})}clearAll(){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild)}},e.CommandShortcut=class CommandShortcut{constructor(e){this.targetElement=e.targetElement,this.onShortcutInsert=e.onShortcutInsert||null,this.shortcutsContainer=null,this.shortcuts={},this.customDropdowns=[]}initialize(e){this.shortcutsContainer&&this.shortcutsContainer.parentNode&&this.shortcutsContainer.parentNode.removeChild(this.shortcutsContainer),this.shortcutsContainer=document.createElement("div"),this.shortcutsContainer.className="command-shortcuts-container",this.shortcutsContainer.style.marginBottom="10px",this.shortcutsContainer.style.display="flex",this.shortcutsContainer.style.flexDirection="column",this.shortcutsContainer.style.gap="8px",this.shortcutsContainer.style.alignItems="stretch",e.appendChild(this.shortcutsContainer),this.initializeEstimateShortcut()}initializeEstimateShortcut(){this.shortcuts.estimate&&this.removeShortcut("estimate"),this.addCustomShortcut({type:"estimate",label:"/estimate",items:[{value:"",label:"Estimate Hours"},{value:"1",label:"1h"},{value:"2",label:"2h"},{value:"4",label:"4h"},{value:"8",label:"8h"},{value:"16",label:"16h"},{value:"32",label:"32h"},{value:"custom",label:"Custom..."}],onSelect:e=>{"custom"===e?this.handleCustomEstimate():e&&this.insertEstimateText(e)}})}removeShortcut(e){if(this.shortcuts[e]&&this.shortcuts[e].element){const t=this.shortcuts[e].element;t.parentNode&&t.parentNode.removeChild(t),delete this.shortcuts[e]}}handleCustomEstimate(){const e=prompt("Enter custom estimate hours (whole numbers only):","");if(null===e||""===e)return;const t=parseInt(e,10);isNaN(t)||t<=0||t!==parseFloat(e)?alert("Please enter a valid positive whole number."):this.insertEstimateText(t.toString())}insertEstimateText(e){if(!this.targetElement)return;const t=`/estimate ${e}h`,s=this.targetElement.value,n=/\/estimate\s+\d+h/g;if(n.test(s)){const e=s.replace(n,t);this.targetElement.value=e}else{const e=this.targetElement.selectionStart,n=this.targetElement.selectionEnd;let i=t;e>0&&"\n"!==s.charAt(e-1)&&s.length>0&&(i="\n"+i);const o=s.substring(0,e)+i+s.substring(n);this.targetElement.value=o;const a=e+i.length;this.targetElement.setSelectionRange(a,a)}this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert("estimate",e)}addCustomShortcut(e){if(!this.shortcutsContainer)return console.error("Shortcuts container not initialized"),null;this.shortcuts&&this.shortcuts[e.type]&&this.removeShortcut(e.type);const t=document.createElement("div");t.className=`shortcut-item ${e.type}-shortcut`,t.style.display="flex",t.style.alignItems="center",t.style.width="100%",t.style.marginBottom="8px",t.style.justifyContent="space-between",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="6px 10px",t.style.backgroundColor="#f8f9fa",t.style.height="36px",t.style.boxSizing="border-box",t.dataset.shortcutType=e.type;const s=document.createElement("div");s.textContent=e.label,s.style.fontSize="13px",s.style.fontWeight="bold",s.style.color="#555",s.style.minWidth="100px",s.style.flexShrink="0",s.style.whiteSpace="nowrap";const n=document.createElement("div");n.style.flex="1",n.style.position="relative",n.style.height="24px",n.style.marginLeft="10px";const i=document.createElement("select");i.className=`${e.type}-dropdown`,i.style.width="100%",i.style.height="100%",i.style.appearance="auto",i.style.padding="0 25px 0 8px",i.style.fontSize="13px",i.style.border="1px solid #ccc",i.style.borderRadius="4px",i.style.backgroundColor="#fff",i.style.boxSizing="border-box";const o=document.createElement("option");o.value="",o.textContent=e.items[0]?.label||"Select...",o.selected=!0,i.appendChild(o),e.items&&e.items.length>0&&e.items.forEach(((e,t)=>{if(0===t)return;const s=document.createElement("option");s.value=e.value,s.textContent=e.label,i.appendChild(s)})),i.addEventListener("change",(t=>{const s=t.target.value;s&&e.onSelect&&(e.onSelect(s),t.target.value="")})),n.appendChild(i),t.appendChild(s),t.appendChild(n);const a=["estimate","label","milestone","assign"],l=a.indexOf(e.type);if(-1===l)this.shortcutsContainer.appendChild(t);else{let e=!1;const s=this.shortcutsContainer.querySelectorAll(".shortcut-item");for(let n=0;n<s.length;n++){const i=s[n].dataset.shortcutType;if(a.indexOf(i)>l){this.shortcutsContainer.insertBefore(t,s[n]),e=!0;break}}e||this.shortcutsContainer.appendChild(t)}return this.shortcuts[e.type]={element:t,dropdown:i,options:e},t}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const i=this.targetElement.value;if(s.test(i)){const e=i.replace(s,t);this.targetElement.value=e}else n();this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert(e,t)}},e.SelectionDisplay=class SelectionDisplay{constructor(e={}){this.selectedIssues=e.selectedIssues||[],this.onRemoveIssue=e.onRemoveIssue||null,this.container=null,this.issuesList=null}createSelectionContainer(e){this.container=e;const t=document.createElement("div");t.style.marginBottom="12px",t.style.padding="8px",t.style.borderRadius="4px",t.style.border="1px dashed #ccc",t.style.backgroundColor="#f9f9f9",t.style.maxHeight="150px",t.style.overflowY="auto";const s=document.createElement("div");s.style.fontSize="12px",s.style.color="#666",s.style.marginBottom="5px",s.textContent="Selected Issues:",t.appendChild(s);const n=document.createElement("div");n.id="selected-issues-list",n.style.fontSize="14px",this.issuesList=n,this.displayNoIssuesMessage(),t.appendChild(n),e.appendChild(t),this.updateDisplay()}displayNoIssuesMessage(){if(!this.issuesList)return;if(this.issuesList.querySelector("#no-issues-selected"))return;const e=document.createElement("div");e.id="no-issues-selected",e.textContent="No issues selected",e.style.color="#666",e.style.fontStyle="italic",this.issuesList.appendChild(e)}updateDisplay(){if(!this.issuesList)return void console.error("Issues list not initialized");if(this.issuesList.innerHTML="",!this.selectedIssues||0===this.selectedIssues.length){this.displayNoIssuesMessage();const e=this.issuesList.parentElement;return void(e&&(e.style.borderColor="#ccc",e.style.backgroundColor="#f9f9f9"))}const e=this.issuesList.parentElement;e&&(e.style.borderColor="#1f75cb",e.style.backgroundColor="rgba(31, 117, 203, 0.05)"),this.selectedIssues.forEach(((e,t)=>{if(!e)return;const s=document.createElement("div");s.className="selected-issue-item",s.style.padding="5px",s.style.marginBottom="3px",s.style.borderRadius="3px",s.style.backgroundColor="rgba(31, 117, 203, 0.1)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center";const n=document.createElement("div"),i=e.iid||"Unknown",o=e.title||"Untitled Issue";n.innerHTML=`<strong>#${i}</strong> - ${o}`,n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.style.whiteSpace="nowrap",n.style.marginRight="5px",s.appendChild(n);const a=document.createElement("button");a.textContent="×",a.style.backgroundColor="transparent",a.style.border="none",a.style.color="#dc3545",a.style.fontSize="16px",a.style.fontWeight="bold",a.style.cursor="pointer",a.style.padding="0 5px",a.title="Remove this issue",a.addEventListener("mouseenter",(()=>{a.style.color="#c82333"})),a.addEventListener("mouseleave",(()=>{a.style.color="#dc3545"})),a.onclick=e=>{e.stopPropagation(),this.removeIssue(t)},s.appendChild(a),this.issuesList.appendChild(s)}))}removeIssue(t){if(t>=0&&t<this.selectedIssues.length){this.selectedIssues[t];if(this.selectedIssues.splice(t,1),this.updateDisplay(),"function"==typeof this.onRemoveIssue)this.onRemoveIssue(t);else try{e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}catch(e){console.error("Error syncing with IssueSelector:",e)}}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.updateDisplay()}getSelectedIssues(){return[...this.selectedIssues]}},e.IssueSelector=class IssueSelector{constructor(e={}){this.uiManager=e.uiManager,this.onSelectionChange=e.onSelectionChange||null,this.onSelectionComplete=e.onSelectionComplete||null,this.isSelectingIssue=!1,this.selectionOverlays=[],this.selectedOverlays=[],this.selectedIssues=e.initialSelection||[],document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isSelectingIssue&&this.exitSelectionMode()}))}startSelection(){if(this.isSelectingIssue)return;this.isSelectingIssue=!0;const e=[...this.selectedIssues],t=document.getElementById("comment-status");t&&(t.textContent="Click on cards to select/deselect issues. Press ESC or click DONE when finished.",t.style.color="#1f75cb");let s=document.querySelector(".boards-list");if(!s){const e=['[data-testid="boards-list"]',".boards-app",".js-boards-selector",".board",".boards-app-content",".board-wrapper",".boards-selector"];for(const t of e){const e=document.querySelector(t);if(e){s=e;break}}}s||(console.warn("Could not find boards container, falling back to document.body"),s=document.body),s.style.position="relative";const n=Math.max(s.scrollWidth,s.offsetWidth,s.clientWidth),i=document.createElement("div");i.id="selection-page-overlay",i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width=`${n}px`,i.style.height="100%",i.style.backgroundColor="rgba(0, 0, 0, 0.4)",i.style.zIndex="98",i.style.pointerEvents="none",s.appendChild(i),this.createCardOverlays(e,s),this.createFixedControls();const o=document.getElementById("select-issues-button");o&&(o.dataset.active="true",o.style.backgroundColor="#28a745",o.textContent="✓ Selecting...")}createCancelButton(e=document.body){const t=document.createElement("div");t.id="selection-cancel-button",t.textContent="DONE",t.style.position="absolute",t.style.bottom="20px",t.style.right="20px",t.style.backgroundColor="#28a745",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.cursor="pointer",t.style.fontWeight="bold",t.style.zIndex="99",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",t.style.transition="all 0.2s ease",t.addEventListener("mouseenter",(()=>{t.style.backgroundColor="#218838",t.style.transform="translateY(-2px)",t.style.boxShadow="0 6px 15px rgba(0, 0, 0, 0.5)"})),t.addEventListener("mouseleave",(()=>{t.style.backgroundColor="#28a745",t.style.transform="translateY(0)",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"})),t.addEventListener("click",(e=>{e.stopPropagation(),this.exitSelectionMode()})),e.appendChild(t),this.selectionOverlays.push(t);const s=document.createElement("div");s.id="selection-counter",s.textContent=`${this.selectedIssues.length} issues selected`,s.style.position="absolute",s.style.bottom="20px",s.style.left="20px",s.style.backgroundColor=this.selectedIssues.length>0?"rgba(40, 167, 69, 0.9)":"rgba(0, 0, 0, 0.8)",s.style.color="white",s.style.padding="8px 16px",s.style.borderRadius="20px",s.style.fontSize="14px",s.style.zIndex="99",s.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",e.appendChild(s),this.selectionOverlays.push(s)}createCardOverlays(t=[],s=document.body){const n=document.querySelectorAll(".board-card");this.selectedIssues=t||[],this.selectedOverlays=[],n.forEach(((n,i)=>{try{const o=n.getBoundingClientRect(),a=s.getBoundingClientRect(),l=e.pageXOffset||document.documentElement.scrollLeft,r=e.pageYOffset||document.documentElement.scrollTop,d=o.left-a.left+l,c=o.top-a.top+r,u=document.createElement("div");u.className="card-selection-overlay",u.style.position="absolute",u.style.left=`${d}px`,u.style.top=`${c}px`,u.style.width=`${o.width}px`,u.style.height=`${o.height}px`,u.style.backgroundColor="rgba(31, 117, 203, 0.2)",u.style.border="2px solid rgba(31, 117, 203, 0.6)",u.style.borderRadius="4px",u.style.zIndex="99",u.style.cursor="pointer",u.style.transition="background-color 0.2s ease",u.dataset.cardId=n.id||`card-${Date.now()}-${i}`,u.dataset.selected="false",u.originalCard=n;const h=this.getIssueItemFromCard(n);if(h&&(u.dataset.issueId=`${h.iid}-${h.referencePath}`,t.some((e=>e.iid===h.iid&&e.referencePath===h.referencePath)))){u.dataset.selected="true",u.style.backgroundColor="rgba(0, 177, 106, 0.3)",u.style.borderColor="rgba(0, 177, 106, 0.8)",u.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedOverlays.length+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",u.appendChild(t),this.selectedOverlays.push(u)}u.addEventListener("mouseenter",(()=>{"true"!==u.dataset.selected&&(u.style.backgroundColor="rgba(31, 117, 203, 0.3)",u.style.boxShadow="0 0 8px rgba(31, 117, 203, 0.5)")})),u.addEventListener("mouseleave",(()=>{"true"!==u.dataset.selected&&(u.style.backgroundColor="rgba(31, 117, 203, 0.2)",u.style.boxShadow="none")})),u.addEventListener("click",(e=>{e.stopPropagation(),this.toggleCardSelection(n,u)})),s.appendChild(u),this.selectionOverlays.push(u)}catch(e){console.error("Error creating overlay for card:",e)}}))}updateSelectionCounter(){const e=document.getElementById("selection-counter");if(e){const t=this.selectedIssues.length;e.textContent=`${t} issue${1!==t?"s":""} selected`,e.style.backgroundColor=t>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)"}"function"==typeof this.onSelectionChange&&this.onSelectionChange(this.selectedIssues),this.syncSelectionWithBulkCommentsView()}getIssueItemFromCard(t){try{if(t.__vue__){if(t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$options&&t.__vue__.$options.children&&t.__vue__.$options.children.length>0){const e=t.__vue__.$options.children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$props&&t.__vue__.$props.item)return t.__vue__.$props.item}const s=t.querySelector("[data-issue-id]")?.dataset?.issueId,n=t.querySelector(".board-card-title");if(s&&n)return{iid:s,title:n.textContent.trim(),referencePath:e.location.pathname.split("/boards")[0]}}catch(e){console.error("Error getting issue item from card:",e)}return null}renumberBadges(){this.selectedOverlays.forEach(((e,t)=>{const s=e.querySelector(".selection-badge");s&&(s.textContent=t+1)}))}exitSelectionMode(){this.isSelectingIssue=!1;const e=document.getElementById("selection-page-overlay");e&&e.remove(),this.selectionOverlays.forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})),this.selectionOverlays=[],this.selectedOverlays=[];const t=document.getElementById("select-issues-button");t&&(t.dataset.active="false",t.style.backgroundColor="#6c757d",t.textContent="📎 Select Issues"),this.syncSelectionWithBulkCommentsView(),"function"==typeof this.onSelectionComplete&&this.onSelectionComplete(this.selectedIssues);const s=document.getElementById("comment-status");s&&(this.selectedIssues.length>0?(s.textContent=`${this.selectedIssues.length} issues selected.`,s.style.color="#28a745",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef"):(s.textContent='No issues selected. Click "Select" to choose issues.',s.style.color="#666",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef"))}toggleCardSelection(e,t){if(!this.isSelectingIssue)return;const s=this.getIssueItemFromCard(e);if(s){if("true"===t.dataset.selected)t.dataset.selected="false",t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)",t.style.boxShadow="none",this.selectedIssues=this.selectedIssues.filter((e=>!(e.iid===s.iid&&e.referencePath===s.referencePath))),this.selectedOverlays=this.selectedOverlays.filter((e=>e!==t)),t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),this.renumberBadges();else{t.dataset.selected="true",t.style.backgroundColor="rgba(0, 177, 106, 0.3)",t.style.borderColor="rgba(0, 177, 106, 0.8)",t.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedIssues.length+1,n=document.createElement("div");n.className="selection-badge",n.textContent=e,n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.backgroundColor="rgba(0, 177, 106, 1)",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontWeight="bold",n.style.fontSize="12px",n.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),t.appendChild(n),this.selectedIssues.push(s),this.selectedOverlays.push(t)}this.updateSelectionCounter(),this.syncSelectionWithBulkCommentsView()}else{console.error("Failed to get issue item from card"),t.style.backgroundColor="rgba(220, 53, 69, 0.4)",t.style.borderColor="rgba(220, 53, 69, 0.8)",setTimeout((()=>{t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)"}),500);const e=document.getElementById("comment-status");e&&(e.textContent="Could not extract issue data from this card. Try another one.",e.style.color="#dc3545")}}syncSelectionWithBulkCommentsView(){try{if(this.uiManager&&this.uiManager.bulkCommentsView)this.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else if(e.uiManager&&e.uiManager.bulkCommentsView)e.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else{const e=document.querySelector(".bulk-comments-view");e&&e.__vue__&&e.__vue__.setSelectedIssues?e.__vue__.setSelectedIssues([...this.selectedIssues]):console.warn("BulkCommentsView not found for synchronization")}}catch(e){console.error("Error syncing selection with bulk comments view:",e)}}repositionOverlays(){if(!this.isSelectingIssue)return;const t=(document.querySelector('[data-testid="boards-list"]')||document.body).getBoundingClientRect(),s=e.pageXOffset||document.documentElement.scrollLeft,n=e.pageYOffset||document.documentElement.scrollTop;this.selectionOverlays.forEach((e=>{if("card-selection-overlay"===e.className&&e.originalCard){const i=e.originalCard.getBoundingClientRect(),o=i.left-t.left+s,a=i.top-t.top+n;e.style.left=`${o}px`,e.style.top=`${a}px`,e.style.width=`${i.width}px`,e.style.height=`${i.height}px`}}));const i=document.getElementById("selection-cancel-button");i&&(i.style.bottom="20px",i.style.right="20px");const o=document.getElementById("selection-counter");o&&(o.style.bottom="20px",o.style.left="20px");const a=document.getElementById("selection-help-text");a&&(a.style.top="10px",a.style.left="50%")}getSelectedIssues(){return[...this.selectedIssues]}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.isSelectingIssue&&this.selectionOverlays.length>0&&this.updateOverlaysFromSelection();const t=document.getElementById("comment-status");if(t&&!this.isSelectingIssue){const e=this.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected.`,t.style.color="green"):(t.textContent='No issues selected. Click "Select" to choose issues.',t.style.color="#666")}this.syncSelectionWithBulkCommentsView()}updateOverlaysFromSelection(){if(this.isSelectingIssue)try{const e=this.selectionOverlays.filter((e=>"card-selection-overlay"===e.className));e.forEach((e=>{e.dataset&&e.originalCard&&(e.dataset.selected="false",e.style.backgroundColor="rgba(31, 117, 203, 0.2)",e.style.borderColor="rgba(31, 117, 203, 0.6)",e.style.boxShadow="none",e.querySelectorAll(".selection-badge").forEach((e=>e.remove())))})),this.selectedOverlays=[],this.selectedIssues.forEach(((t,s)=>{if(!t)return;const n=e.find((e=>!(!e.dataset||!e.dataset.issueId)&&e.dataset.issueId===`${t.iid}-${t.referencePath}`));if(n){n.dataset.selected="true",n.style.backgroundColor="rgba(0, 177, 106, 0.3)",n.style.borderColor="rgba(0, 177, 106, 0.8)",n.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=s+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",n.appendChild(t),this.selectedOverlays.push(n)}})),this.updateSelectionCounter()}catch(e){console.error("Error updating overlays from selection:",e)}}clearSelection(){this.selectedIssues=[],this.syncSelectionWithBulkCommentsView(),this.onSelectionChange&&this.onSelectionChange(this.selectedIssues)}createFixedControls(){const e=document.createElement("div");e.id="selection-cancel-button",e.textContent="DONE",e.style.position="fixed",e.style.bottom="20px",e.style.right="430px;",e.style.backgroundColor="#28a745",e.style.color="white",e.style.padding="10px 20px",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.zIndex="999",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",e.style.transition="all 0.2s ease",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#218838",e.style.transform="translateY(-2px)",e.style.boxShadow="0 6px 15px rgba(0, 0, 0, 0.5)"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#28a745",e.style.transform="translateY(0)",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"})),e.addEventListener("click",(e=>{e.stopPropagation(),this.exitSelectionMode()})),document.body.appendChild(e),this.selectionOverlays.push(e);const t=document.createElement("div");t.id="selection-counter",t.textContent=`${this.selectedIssues.length} issues selected`,t.style.position="fixed",t.style.bottom="20px",t.style.left="275px",t.style.backgroundColor=this.selectedIssues.length>0?"rgba(40, 167, 69, 0.9)":"rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="8px 16px",t.style.borderRadius="20px",t.style.fontSize="14px",t.style.zIndex="999",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",document.body.appendChild(t),this.selectionOverlays.push(t);const s=document.createElement("div");s.id="selection-help-text",s.textContent="Click on issues to select/deselect them • Press ESC or click DONE when finished",s.style.position="fixed",s.style.top="10px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.7)",s.style.color="white",s.style.padding="8px 16px",s.style.borderRadius="20px",s.style.fontSize="14px",s.style.zIndex="999",s.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",document.body.appendChild(s),this.selectionOverlays.push(s)}},e.TabManager=class TabManager{constructor(uiManager){this.uiManager=uiManager,this.tabContainer=null,this.tabs={},this.contentAreas={};try{this.currentTab=getLastActiveTab()||"summary"}catch(e){console.warn("Error loading last active tab:",e),this.currentTab="summary"}}initialize(e){this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.marginBottom="10px",this.tabContainer.style.borderBottom="1px solid #ddd",this.createTab("summary","Summary","summary"===this.currentTab),this.createTab("boards","Boards","boards"===this.currentTab),this.createTab("history","History","history"===this.currentTab),this.createTab("bulkcomments","Bulk Comments","bulkcomments"===this.currentTab),e.appendChild(this.tabContainer),this.createContentAreas(e)}createTab(e,t,s=!1){const n=document.createElement("div");n.textContent=t,n.dataset.tab=e,n.style.padding="5px 10px",n.style.cursor="pointer",s&&(n.style.borderBottom="2px solid #1f75cb",n.style.fontWeight="bold",this.currentTab=e),n.addEventListener("click",(()=>{this.switchToTab(e)})),this.tabs[e]=n,this.tabContainer.appendChild(n)}createContentAreas(e){const t=document.createElement("div");t.id="assignee-time-summary-content",t.style.display="summary"===this.currentTab?"block":"none",t.style.position="relative",t.style.minHeight="300px",e.appendChild(t),this.contentAreas.summary=t,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(t,"summary-tab","Loading summary data...");const s=document.createElement("div");s.id="boards-time-summary-content",s.style.display="boards"===this.currentTab?"block":"none",s.style.position="relative",s.style.minHeight="300px",e.appendChild(s),this.contentAreas.boards=s,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(s,"boards-tab","Loading board data...");const n=document.createElement("div");n.id="history-time-summary-content",n.style.display="history"===this.currentTab?"block":"none",n.style.position="relative",n.style.minHeight="300px",e.appendChild(n),this.contentAreas.history=n,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(n,"history-tab","Loading history data...");const i=document.createElement("div");i.id="bulk-comments-content",i.style.display="bulkcomments"===this.currentTab?"block":"none",i.style.position="relative",i.style.minHeight="300px",e.appendChild(i),this.contentAreas.bulkcomments=i,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(i,"bulkcomments-tab","Loading comment tools...")}switchToTab(t){Object.keys(this.tabs).forEach((e=>{this.tabs[e].style.borderBottom="none",this.tabs[e].style.fontWeight="normal",this.contentAreas[e].style.display="none"})),this.tabs[t].style.borderBottom="2px solid #1f75cb",this.tabs[t].style.fontWeight="bold",this.contentAreas[t].style.display="block",this.currentTab=t;try{saveLastActiveTab(t)}catch(e){console.warn("Error saving tab selection:",e)}"history"===t&&"function"==typeof e.renderHistory?(e.renderHistory(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("history-tab")):"bulkcomments"===t&&this.uiManager.bulkCommentsView&&(this.uiManager.bulkCommentsView.render(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab"))}getContentArea(e){return this.contentAreas[e]}getCurrentTab(){return this.currentTab}},e.CommandManager=class CommandManager{constructor(e={}){this.targetElement=e.targetElement,this.gitlabApi=e.gitlabApi,this.labelManager=e.labelManager,this.onCommandInsert=e.onCommandInsert||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.shortcutContainer=null,this.commandShortcut=null}initialize(e){this.shortcutContainer=e,this.commandShortcut=new CommandShortcut({targetElement:this.targetElement,onShortcutInsert:(e,t)=>{"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}}),this.commandShortcut.initialize(e),this.addCustomShortcuts()}addCustomShortcuts(){this.commandShortcut&&(this.addMilestoneShortcut(),this.addAssignShortcut(),this.addDueDateShortcut(),this.addWeightShortcut())}addMilestoneShortcut(){this.commandShortcut.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"%backlog",label:"Backlog"},{value:"none",label:"Remove Milestone"}],onSelect:e=>{if(!this.targetElement)return;let t="/milestone ";"none"===e?t+='%""':e.startsWith("%")?t+=e:t+=`%"${e}"`;this.replaceOrInsertCommand("milestone",t,/\/milestone\s+%[^\n]+/g,(()=>this.insertTextAtCursor(t))),this.notification.info(`Milestone command added: ${e}`)}})}addAssignShortcut(){if(this.commandShortcuts)try{let t=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}];if(this.assigneeManager&&"function"==typeof this.assigneeManager.getAssigneeWhitelist)try{const e=this.assigneeManager.getAssigneeWhitelist();if(Array.isArray(e)&&e.length>0){t.push({value:"separator",label:"────── Favorites ──────"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s)}}catch(e){console.error("Error getting assignee whitelist from manager:",e);try{const e=getAssigneeWhitelist();if(Array.isArray(e)&&e.length>0){t.push({value:"separator",label:"────── Favorites ──────"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s)}}catch(e){console.error("Error accessing assignee whitelist from storage:",e)}}else try{let s=[];if("function"==typeof getAssigneeWhitelist?s=getAssigneeWhitelist():e.getAssigneeWhitelist?s=e.getAssigneeWhitelist():console.warn("getAssigneeWhitelist function not available, no assignees will be loaded"),Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"────── Favorites ──────"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}}catch(e){console.error("Error directly accessing assignee whitelist:",e)}this.fetchGroupMembers().then((e=>{if(e&&e.length>0){t.push({value:"separator2",label:"────── Group Members ──────"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s),this.updateAssignShortcut(t)}})).catch((e=>{console.error("Error fetching group members:",e)})),t.push({value:"custom",label:"Custom..."}),t.push({value:"manage",label:"✏️ Manage Assignees..."}),this.updateAssignShortcut(t)}catch(e){console.error("Error adding assign shortcut:",e)}}addDueDateShortcut(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=new Date(e);s.setDate(s.getDate()+7);const n=new Date(e);n.setMonth(n.getMonth()+1);const formatDate=e=>e.toISOString().substring(0,10);this.commandShortcut.addCustomShortcut({type:"due",label:"/due",items:[{value:"",label:"Set Due Date"},{value:formatDate(e),label:"Today"},{value:formatDate(t),label:"Tomorrow"},{value:formatDate(s),label:"Next Week"},{value:formatDate(n),label:"Next Month"},{value:"custom",label:"Custom Date..."},{value:"none",label:"Remove Due Date"}],onSelect:t=>{if(!this.targetElement)return;if("custom"===t){const s=prompt("Enter due date (YYYY-MM-DD):",formatDate(e));if(!s)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(s))return void this.notification.error("Invalid date format. Please use YYYY-MM-DD");t=s}let s="/due ";s+="none"===t?"none":t;this.replaceOrInsertCommand("due",s,/\/due\s+[^\n]+/g,(()=>this.insertTextAtCursor(s))),"none"===t?this.notification.info("Due date will be removed"):this.notification.info(`Due date set to ${t}`)}})}addWeightShortcut(){this.commandShortcut.addCustomShortcut({type:"weight",label:"/weight",items:[{value:"",label:"Set Weight"},{value:"1",label:"1 (Trivial)"},{value:"2",label:"2 (Small)"},{value:"3",label:"3 (Medium)"},{value:"5",label:"5 (Large)"},{value:"8",label:"8 (Very Large)"},{value:"custom",label:"Custom Weight..."},{value:"none",label:"Remove Weight"}],onSelect:e=>{if(!this.targetElement)return;if("custom"===e){const t=prompt("Enter weight (number):","");if(!t)return;const s=parseInt(t,10);if(isNaN(s)||s<0)return void this.notification.error("Invalid weight. Please enter a positive number");e=t}let t="/weight ";t+="none"===e?"none":e;this.replaceOrInsertCommand("weight",t,/\/weight\s+[^\n]+/g,(()=>this.insertTextAtCursor(t))),"none"===e?this.notification.info("Weight will be removed"):this.notification.info(`Weight set to ${e}`)}})}openAssigneeManager(){const e=document.createElement("div");e.id="assignee-manager-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="110",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="500px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div"),a=document.createElement("p");a.textContent="Add usernames to quickly assign issues. These will appear in your /assign dropdown.",a.style.marginBottom="15px";const l=document.createElement("div");l.style.marginBottom="15px",l.style.maxHeight="200px",l.style.overflowY="auto";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add some below.",e.style.color="#666",e.style.fontStyle="italic",e.style.padding="10px 0",e};this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="8px",s.style.borderBottom="1px solid #eee";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const i=document.createElement("div");i.textContent=e.name||e.username,i.style.fontWeight="bold",i.style.marginRight="5px";const o=document.createElement("div");o.textContent=`@${e.username}`,o.style.color="#666",o.style.fontSize="13px",n.appendChild(i),n.appendChild(o);const a=document.createElement("button");a.textContent="Remove",a.style.padding="3px 8px",a.style.backgroundColor="#dc3545",a.style.color="white",a.style.border="none",a.style.borderRadius="3px",a.style.cursor="pointer",a.onclick=()=>{this.assigneeWhitelist.splice(t,1),saveAssigneeWhitelist(this.assigneeWhitelist),s.remove(),0===this.assigneeWhitelist.length&&l.appendChild(createEmptyMessage())},s.appendChild(n),s.appendChild(a),l.appendChild(s)})),0===this.assigneeWhitelist.length&&l.appendChild(createEmptyMessage());const r=document.createElement("div");r.style.marginTop="20px",r.style.marginBottom="20px",r.style.padding="15px",r.style.backgroundColor="#f8f9fa",r.style.borderRadius="4px";const d=document.createElement("div");d.textContent="Add New Assignee",d.style.fontWeight="bold",d.style.marginBottom="10px";const c=document.createElement("div");c.style.marginBottom="10px";const u=document.createElement("label");u.textContent="Display Name:",u.style.display="block",u.style.marginBottom="5px";const h=document.createElement("input");h.type="text",h.placeholder="John Doe",h.style.width="100%",h.style.padding="8px",h.style.borderRadius="4px",h.style.border="1px solid #ccc",c.appendChild(u),c.appendChild(h);const p=document.createElement("div");p.style.marginBottom="15px";const m=document.createElement("label");m.textContent="GitLab Username:",m.style.display="block",m.style.marginBottom="5px";const g=document.createElement("input");g.type="text",g.placeholder="username (without @)",g.style.width="100%",g.style.padding="8px",g.style.borderRadius="4px",g.style.border="1px solid #ccc",p.appendChild(m),p.appendChild(g);const y=document.createElement("button");y.textContent="Add Assignee",y.style.padding="8px 16px",y.style.backgroundColor="#28a745",y.style.color="white",y.style.border="none",y.style.borderRadius="4px",y.style.cursor="pointer",y.onclick=()=>{const e=h.value.trim(),t=g.value.trim();if(!t)return void alert("Username is required");const s={name:e||t,username:t},n=this.assigneeWhitelist.findIndex((e=>e.username===t));n>=0?this.assigneeWhitelist[n]=s:this.assigneeWhitelist.push(s),saveAssigneeWhitelist(this.assigneeWhitelist);const i=l.querySelector('div[style*="italic"]');i&&i.remove();const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.padding="8px",o.style.borderBottom="1px solid #eee";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center";const r=document.createElement("div");r.textContent=s.name,r.style.fontWeight="bold",r.style.marginRight="5px";const d=document.createElement("div");d.textContent=`@${s.username}`,d.style.color="#666",d.style.fontSize="13px",a.appendChild(r),a.appendChild(d);const c=document.createElement("button");c.textContent="Remove",c.style.padding="3px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="3px",c.style.cursor="pointer",c.onclick=()=>{const e=this.assigneeWhitelist.findIndex((e=>e.username===s.username));e>=0&&(this.assigneeWhitelist.splice(e,1),saveAssigneeWhitelist(this.assigneeWhitelist),o.remove(),0===this.assigneeWhitelist.length&&l.appendChild(createEmptyMessage()))},o.appendChild(a),o.appendChild(c),l.appendChild(o),h.value="",g.value="",this.notification.success(`Added assignee: ${s.name}`)},r.appendChild(d),r.appendChild(c),r.appendChild(p),r.appendChild(y);const b=document.createElement("button");b.textContent="Close",b.style.padding="8px 16px",b.style.backgroundColor="#6c757d",b.style.color="white",b.style.border="none",b.style.borderRadius="4px",b.style.cursor="pointer",b.style.marginTop="10px",b.onclick=()=>{e.remove(),this.addAssignShortcut()},o.appendChild(a),o.appendChild(l),o.appendChild(r),o.appendChild(b),t.appendChild(s),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&(e.remove(),this.addAssignShortcut())}))}insertTextAtCursor(e){if(!this.targetElement)return;const t=this.targetElement.selectionStart,s=this.targetElement.selectionEnd,n=this.targetElement.value;let i=e;t>0&&"\n"!==n.charAt(t-1)&&n.length>0&&(i="\n"+i),this.targetElement.value=n.substring(0,t)+i+n.substring(s);const o=t+i.length;this.targetElement.setSelectionRange(o,o),this.targetElement.focus()}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const i=this.targetElement.value;if(s.test(i)){const e=i.replace(s,t);this.targetElement.value=e,this.targetElement.focus()}else n();"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}},e.LabelManager=class LabelManager{constructor(t={}){this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onLabelsLoaded=t.onLabelsLoaded||null,this.labelWhitelist=[];try{this.labelWhitelist=getLabelWhitelist(),Array.isArray(this.labelWhitelist)||(console.warn("Loaded whitelist is not an array, using default"),this.labelWhitelist=this.getDefaultWhitelist())}catch(e){console.warn("Error loading label whitelist, using default",e),this.labelWhitelist=this.getDefaultWhitelist()}this.availableLabels=[],this.filteredLabels=[],this.isLoading=!1}getDefaultWhitelist(){return["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"]}saveWhitelist(e){Array.isArray(e)||(e=[]),this.labelWhitelist=e;try{saveLabelWhitelist(e)}catch(e){console.error("Error saving label whitelist",e)}this.filterLabels()}resetToDefaultWhitelist(){try{this.labelWhitelist=this.getDefaultWhitelist(),saveLabelWhitelist(this.labelWhitelist)}catch(e){console.error("Error resetting label whitelist",e)}return this.filterLabels(),this.labelWhitelist}isLabelInWhitelist(e,t=null){const s=t||this.labelWhitelist;if(!Array.isArray(s)||"string"!=typeof e)return!1;const n=e.toLowerCase();return s.some((e=>"string"==typeof e&&n.includes(e.toLowerCase())))}filterLabels(){this.availableLabels&&0!==this.availableLabels.length?(this.filteredLabels=this.availableLabels.filter((e=>!(!e||"string"!=typeof e.name)&&this.isLabelInWhitelist(e.name))),this.filteredLabels.sort(((e,t)=>e.name.localeCompare(t.name))),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels)):this.filteredLabels=[]}async fetchAllLabels(){try{if(this.isLoading=!0,this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)return console.warn("GitLab API instance not available, using fallback labels"),this.isLoading=!1,this.addFallbackLabels();const t=getPathFromUrl();if(!t||!t.apiUrl)return console.warn("Path info not found or invalid, returning fallback labels"),this.isLoading=!1,this.addFallbackLabels();try{const e=await this.gitlabApi.callGitLabApi(t.apiUrl,{params:{per_page:100}});return Array.isArray(e)?(this.availableLabels=e,this.filterLabels(),this.isLoading=!1,this.filteredLabels):(console.warn("API did not return an array of labels, using fallback"),this.isLoading=!1,this.addFallbackLabels())}catch(e){return console.error(`Error fetching ${t.type} labels from API:`,e),this.isLoading=!1,this.addFallbackLabels()}}catch(e){return console.error("Error in fetchAllLabels:",e),this.isLoading=!1,this.addFallbackLabels()}}addFallbackLabels(){return this.availableLabels=[{name:"bug",color:"#ff0000"},{name:"feature",color:"#1f75cb"},{name:"enhancement",color:"#7057ff"},{name:"documentation",color:"#0075ca"},{name:"priority",color:"#d73a4a"},{name:"blocked",color:"#b60205"}],this.filterLabels(),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels),this.filteredLabels}getLabelOptions(e=!0){if(!this.filteredLabels||0===this.filteredLabels.length){const t=[];return e&&t.push({value:"",label:"Add Label"}),t.concat([{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"custom",label:"Custom..."}])}const t=this.filteredLabels.map((e=>({value:e.name,label:e.name,color:e.color})));return e&&t.unshift({value:"",label:"Add Label"}),t.push({value:"custom",label:"Custom..."}),t}createStyledLabel(e){const t=document.createElement("span");t.textContent=e.label||e.name||"";const s=e.label||e.name||"label",n=e.color||generateColorFromString(s),i=getContrastColor(n);return t.style.backgroundColor=n,t.style.color=i,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}insertLabelCommand(e,t){if(!e||"string"!=typeof t)return;const s=`/label ~"${t}"`,n=/\/label\s+~[^\n]+/g,i=e.value;if(n.test(i))e.value=i.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let o=s;t>0&&"\n"!==i.charAt(t-1)&&i.length>0&&(o="\n"+o),e.value=i.substring(0,t)+o+i.substring(n);const a=t+o.length;e.setSelectionRange(a,a)}e.focus()}async initLabelDropdown(e,t={}){const s=e({items:[{value:"",label:"Loading labels..."}],disabled:!0,...t});try{await this.fetchAllLabels(),s.updateItems(this.getLabelOptions()),s.enable()}catch(e){console.error("Error initializing label dropdown:",e),s.updateItems([{value:"",label:"Error loading labels"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"custom",label:"Custom..."}]),s.enable()}return s}},e.AssigneeManager=class AssigneeManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onAssigneesChange=e.onAssigneesChange||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.currentUsers=[],this.isLoading=!1}getAssigneeWhitelist(){return[...this.assigneeWhitelist]}saveWhitelist(e){this.assigneeWhitelist=e,saveAssigneeWhitelist(e),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist)}addAssignee(e){if(!e||!e.username)return!1;const t=this.assigneeWhitelist.findIndex((t=>t.username.toLowerCase()===e.username.toLowerCase()));return t>=0?this.assigneeWhitelist[t]={...this.assigneeWhitelist[t],...e}:this.assigneeWhitelist.push(e),saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0}removeAssignee(e){if(!e)return!1;const t=this.assigneeWhitelist.length;return this.assigneeWhitelist=this.assigneeWhitelist.filter((t=>t.username.toLowerCase()!==e.toLowerCase())),this.assigneeWhitelist.length!==t&&(saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0)}async fetchCurrentUser(){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");try{const e=await this.gitlabApi.getCurrentUser();return this.addAssignee({name:e.name,username:e.username}),e}catch(e){throw console.error("Error fetching current user:",e),e}}async fetchProjectMembers(e){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");if(!e)throw new Error("Project ID is required");try{this.isLoading=!0;const t=await this.gitlabApi.callGitLabApi(`projects/${encodeURIComponent(e)}/members`,{params:{per_page:100}});return this.currentUsers=t.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.isLoading=!1,this.currentUsers}catch(t){throw console.error(`Error fetching members for project ${e}:`,t),this.isLoading=!1,t}}async fetchGroupMembers(e){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");if(!e)throw new Error("Group ID is required");try{this.isLoading=!0;const t=await this.gitlabApi.callGitLabApi(`groups/${encodeURIComponent(e)}/members`,{params:{per_page:100}});return this.currentUsers=t.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.isLoading=!1,this.currentUsers}catch(t){throw console.error(`Error fetching members for group ${e}:`,t),this.isLoading=!1,t}}insertAssignCommand(e,t){if(!e)return;let s="/assign ";s+=t&&"none"!==t?"me"===t?"@me":t.startsWith("@")?t:`@${t}`:"@none";const n=/\/assign\s+@[^\n]+/g,i=e.value;if(n.test(i))e.value=i.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let o=s;t>0&&"\n"!==i.charAt(t-1)&&i.length>0&&(o="\n"+o),e.value=i.substring(0,t)+o+i.substring(n);const a=t+o.length;e.setSelectionRange(a,a)}e.focus(),"none"===t?this.notification.info("Issue will be unassigned"):"me"===t?this.notification.info("Issue will be assigned to you"):this.notification.info(`Issue will be assigned to ${t.replace("@","")}`)}createAssigneeOption(e,t){const s=document.createElement("div");if(s.className="assignee-option",s.style.padding="8px 12px",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""})),e.avatar_url){const t=document.createElement("img");t.src=e.avatar_url,t.alt=e.name||e.username,t.style.width="24px",t.style.height="24px",t.style.borderRadius="50%",t.style.marginRight="8px",s.appendChild(t)}else{const t=document.createElement("div");t.style.width="24px",t.style.height="24px",t.style.borderRadius="50%",t.style.backgroundColor="#e0e0e0",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.marginRight="8px",t.style.fontSize="12px",t.style.fontWeight="bold",t.style.color="#666";const n=(e.name||e.username||"").split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();t.textContent=n,s.appendChild(t)}const n=document.createElement("div"),i=document.createElement("div");if(i.textContent=e.name||e.username,i.style.fontWeight="bold",n.appendChild(i),e.username&&"none"!==e.username&&"me"!==e.username&&e.name&&e.name!==e.username){const t=document.createElement("div");t.textContent=`@${e.username}`,t.style.fontSize="12px",t.style.color="#666",n.appendChild(t)}return s.appendChild(n),"function"==typeof t&&s.addEventListener("click",t),s}openAssigneeSelector(e){const t=document.createElement("div");t.id="assignee-selector-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.zIndex="110",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";const s=document.createElement("div");s.style.backgroundColor="white",s.style.borderRadius="6px",s.style.padding="20px",s.style.width="600px",s.style.maxWidth="90%",s.style.maxHeight="80vh",s.style.overflow="auto",s.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.marginBottom="15px",n.style.borderBottom="1px solid #eee",n.style.paddingBottom="10px";const i=document.createElement("h3");i.textContent="Select Assignee",i.style.margin="0",i.style.cursor="pointer",i.innerHTML='Select Assignee <span style="font-size: 14px; margin-left: 5px; color: #666;">🔄</span>',i.addEventListener("mouseenter",(()=>{i.style.color="#1f75cb"})),i.addEventListener("mouseleave",(()=>{i.style.color=""})),i.addEventListener("click",(()=>{this.reloadAssigneeSelector(s,e)}));const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>t.remove(),n.appendChild(i),n.appendChild(o);const a=document.createElement("div");a.id="assignee-selector-content";const l=document.createElement("div");l.style.marginBottom="15px";const r=document.createElement("input");r.type="text",r.placeholder="Search assignees...",r.style.width="100%",r.style.padding="8px",r.style.borderRadius="4px",r.style.border="1px solid #ccc",l.appendChild(r),a.appendChild(l);const d=document.createElement("div");d.style.marginBottom="20px";[{value:"none",label:"Unassign",description:"Remove assignee from this issue"},{value:"@me",label:"Myself",description:"Assign this issue to you"}].forEach((s=>{const n=this.createAssigneeOption(s,(()=>{this.insertAssignCommand(e,s.value),t.remove()}));d.appendChild(n)}));const c=document.createElement("div");c.style.borderBottom="1px solid #eee",c.style.margin="20px 0";const u=document.createElement("div");u.id="assignee-loading-indicator",u.textContent="Loading assignees...",u.style.textAlign="center",u.style.padding="20px",u.style.color="#666";const h=document.createElement("div");h.id="assignees-section";const p=document.createElement("h4");p.textContent="Whitelisted Assignees",p.style.marginBottom="10px",p.style.cursor="pointer",p.innerHTML='Whitelisted Assignees <span style="font-size: 12px; margin-left: 5px; color: #666;">🔄</span>',p.addEventListener("mouseenter",(()=>{p.style.color="#1f75cb"})),p.addEventListener("mouseleave",(()=>{p.style.color=""})),p.addEventListener("click",(()=>{const t=document.getElementById("assignee-list-container");t&&(t.innerHTML="",t.appendChild(u.cloneNode(!0)),setTimeout((()=>{this.reloadWhitelistedAssignees(t,e)}),300))})),h.appendChild(p);const m=document.createElement("div");m.id="assignee-list-container",m.style.height="300px",m.style.overflowY="auto",m.appendChild(u),h.appendChild(m),a.appendChild(d),a.appendChild(c),a.appendChild(h),s.appendChild(n),s.appendChild(a),t.appendChild(s),document.body.appendChild(t),t.addEventListener("click",(e=>{e.target===t&&t.remove()})),this.loadAssigneesIntoSelector(m,e),r.addEventListener("input",(()=>{const e=r.value.toLowerCase();m.querySelectorAll(".assignee-option").forEach((t=>{const s=t.querySelector("div > div:first-child"),n=t.querySelector("div > div:last-child");if(!s)return;const i=s.textContent.toLowerCase(),o=n?n.textContent.toLowerCase():"";i.includes(e)||o.includes(e)?t.style.display="":t.style.display="none"}))}))}reloadAssigneeSelector(e,t){const s=e.querySelector("#assignee-selector-content");if(!s)return;let n=s.querySelector("#full-reload-indicator");if(n)n.style.display="flex";else{n=document.createElement("div"),n.id="full-reload-indicator",n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(255, 255, 255, 0.8)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="10";const t=document.createElement("div");t.textContent="Reloading assignees...",t.style.backgroundColor="#1f75cb",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",n.appendChild(t),e.style.position="relative",e.appendChild(n)}setTimeout((()=>{const e=s.querySelector("#assignee-list-container");if(e){e.innerHTML="";const s=document.createElement("div");s.textContent="Loading assignees...",s.style.textAlign="center",s.style.padding="20px",s.style.color="#666",e.appendChild(s),this.loadAssigneesIntoSelector(e,t)}setTimeout((()=>{n&&(n.style.display="none")}),300)}),500),this.notification.info("Refreshing assignee list...")}reloadWhitelistedAssignees(e,t){if(e.innerHTML="",this.assigneeWhitelist=getAssigneeWhitelist(),0===this.assigneeWhitelist.length){const t=document.createElement("div");t.textContent="No assignees added yet. Add some from Available Users or add manually below.",t.style.color="#666",t.style.fontStyle="italic",t.style.textAlign="center",t.style.padding="15px",e.appendChild(t)}else{const s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns="repeat(auto-fill, minmax(250px, 1fr))",s.style.gap="10px";[...this.assigneeWhitelist].sort(((e,t)=>{const s=(e.name||e.username||"").toLowerCase(),n=(t.name||t.username||"").toLowerCase();return s.localeCompare(n)})).forEach((e=>{const n=this.createAssigneeOption(e,(()=>{this.insertAssignCommand(t,e.username);const s=document.getElementById("assignee-selector-overlay");s&&s.remove()}));s.appendChild(n)})),e.appendChild(s)}const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="center",s.style.marginTop="15px";const n=document.createElement("button");n.textContent="Fetch Project Members",n.style.padding="8px 16px",n.style.backgroundColor="#1f75cb",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.addEventListener("click",(()=>{this.fetchProjectMembers().then((s=>{s&&s.length>0?this.showProjectMembers(e,s,t):this.notification.info("No project members found")})).catch((e=>{console.error("Error fetching project members:",e),this.notification.error("Failed to fetch project members")}))})),s.appendChild(n),e.appendChild(s)}showProjectMembers(e,t,s){const n=document.createElement("div");n.style.marginTop="20px";const i=document.createElement("h4");i.textContent="Project Members",i.style.borderTop="1px solid #eee",i.style.paddingTop="15px",i.style.marginBottom="10px",n.appendChild(i);const o=document.createElement("div");o.style.display="grid",o.style.gridTemplateColumns="repeat(auto-fill, minmax(250px, 1fr))",o.style.gap="10px";if([...t].sort(((e,t)=>(e.name||e.username||"").localeCompare(t.name||t.username||""))).forEach((e=>{if(!this.assigneeWhitelist.some((t=>t.username.toLowerCase()===e.username.toLowerCase()))){const t=this.createAssigneeOption(e,(()=>{this.insertAssignCommand(s,e.username);const t=document.getElementById("assignee-selector-overlay");t&&t.remove()})),n=document.createElement("button");n.textContent="+ Save",n.style.padding="4px 8px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="3px",n.style.marginLeft="10px",n.style.cursor="pointer",n.addEventListener("click",(t=>{t.stopPropagation(),this.addAssignee({name:e.name||e.username,username:e.username}),this.notification.success(`Added ${e.name||e.username} to saved assignees`),n.textContent="✓ Saved",n.style.backgroundColor="#6c757d",n.disabled=!0,n.style.cursor="default"}));const i=t.querySelector("div:last-child");i&&i.appendChild(n),o.appendChild(t)}})),0===o.children.length){const e=document.createElement("div");e.textContent="All project members are already in your saved assignees.",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e.style.padding="15px",n.appendChild(e)}else n.appendChild(o);e.appendChild(n)}loadAssigneesIntoSelector(e,t){e.innerHTML="";const s=document.createElement("div");s.textContent="Loading assignees...",s.style.textAlign="center",s.style.padding="20px",s.style.color="#666",e.appendChild(s),setTimeout((()=>{this.reloadWhitelistedAssignees(e,t)}),300)}openAssigneeManager(){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="110",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="600px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div"),a=document.createElement("p");a.textContent="Manage assignees that appear in the assignee dropdown. These users will be available for quick assignment to issues.",a.style.marginBottom="20px";const l=document.createElement("div");l.style.marginBottom="20px";const r=document.createElement("h4");r.textContent="Current Assignees",r.style.marginBottom="10px",r.style.fontSize="16px",l.appendChild(r);const d=document.createElement("div");if(d.style.height="300px",d.style.overflowY="auto",d.style.border="1px solid #eee",d.style.borderRadius="4px",this.assigneeWhitelist.length>0)this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="10px",s.style.borderBottom=t<this.assigneeWhitelist.length-1?"1px solid #eee":"none";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const i=document.createElement("div");i.style.width="32px",i.style.height="32px",i.style.borderRadius="50%",i.style.backgroundColor="#e0e0e0",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.marginRight="10px",i.style.fontSize="14px",i.style.fontWeight="bold",i.style.color="#666";const o=(e.name||e.username||"").split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();i.textContent=o,n.appendChild(i);const a=document.createElement("div"),l=document.createElement("div");l.textContent=e.name||e.username,l.style.fontWeight="bold";const r=document.createElement("div");r.textContent=`@${e.username}`,r.style.fontSize="12px",r.style.color="#666",a.appendChild(l),a.appendChild(r),n.appendChild(a);const c=document.createElement("button");c.textContent="Remove",c.style.padding="4px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=()=>{if(this.removeAssignee(e.username),s.remove(),this.notification.info(`Removed assignee: ${e.name||e.username}`),0===this.assigneeWhitelist.length){const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}},s.appendChild(n),s.appendChild(c),d.appendChild(s)}));else{const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}l.appendChild(d);const c=document.createElement("div");c.style.marginTop="20px",c.style.padding="15px",c.style.backgroundColor="#f8f9fa",c.style.borderRadius="4px";const u=document.createElement("h4");u.textContent="Add New Assignee",u.style.marginBottom="15px",u.style.fontSize="16px";const h=document.createElement("div");h.style.marginBottom="10px";const p=document.createElement("label");p.textContent="Display Name:",p.style.display="block",p.style.marginBottom="5px";const m=document.createElement("input");m.type="text",m.placeholder="John Doe",m.style.width="100%",m.style.padding="8px",m.style.borderRadius="4px",m.style.border="1px solid #ccc",h.appendChild(p),h.appendChild(m);const g=document.createElement("div");g.style.marginBottom="15px";const y=document.createElement("label");y.textContent="GitLab Username:",y.style.display="block",y.style.marginBottom="5px";const b=document.createElement("input");b.type="text",b.placeholder="username (without @)",b.style.width="100%",b.style.padding="8px",b.style.borderRadius="4px",b.style.border="1px solid #ccc",g.appendChild(y),g.appendChild(b);const f=document.createElement("div");f.style.display="flex",f.style.justifyContent="space-between";const x=document.createElement("button");x.textContent="Add Assignee",x.style.padding="8px 16px",x.style.backgroundColor="#28a745",x.style.color="white",x.style.border="none",x.style.borderRadius="4px",x.style.cursor="pointer",x.onclick=()=>{const t=m.value.trim(),s=b.value.trim();if(!s)return void this.notification.error("Username is required");const n={name:t||s,username:s};this.addAssignee(n),this.notification.success(`Added assignee: ${n.name}`),e.remove(),this.openAssigneeManager()};const C=document.createElement("button");C.textContent="Add Current User",C.style.padding="8px 16px",C.style.backgroundColor="#17a2b8",C.style.color="white",C.style.border="none",C.style.borderRadius="4px",C.style.cursor="pointer",C.style.marginRight="10px",C.onclick=async()=>{C.disabled=!0,C.textContent="Loading...";try{const t=await this.fetchCurrentUser();this.notification.success(`Added current user: ${t.name}`),e.remove(),this.openAssigneeManager()}catch(e){this.notification.error("Failed to fetch current user"),C.disabled=!1,C.textContent="Add Current User"}},f.appendChild(C),f.appendChild(x),c.appendChild(u),c.appendChild(h),c.appendChild(g),c.appendChild(f);const v=document.createElement("div");v.style.marginTop="20px",v.style.display="flex",v.style.justifyContent="flex-end";const S=document.createElement("button");S.textContent="Close",S.style.padding="8px 16px",S.style.backgroundColor="#6c757d",S.style.color="white",S.style.border="none",S.style.borderRadius="4px",S.style.cursor="pointer",S.onclick=()=>{e.remove()},v.appendChild(S),o.appendChild(a),o.appendChild(l),o.appendChild(c),o.appendChild(v),t.appendChild(s),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}},e.MilestoneManager=class MilestoneManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onMilestonesLoaded=e.onMilestonesLoaded||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.milestones=[],this.currentMilestone=null,this.isLoading=!1}async fetchMilestones(e="active"){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");try{this.isLoading=!0;const t=getPathFromUrl();if(!t)return console.warn("Could not determine project/group path"),this.isLoading=!1,[];const s=`${t.type}s/${t.encodedPath}/milestones`,n=await this.gitlabApi.callGitLabApi(s,{params:{state:e,per_page:100,order_by:"due_date"}});return this.milestones=n.map((e=>({id:e.id,iid:e.iid,title:e.title,description:e.description,state:e.state,due_date:e.due_date,start_date:e.start_date,web_url:e.web_url}))),this.isLoading=!1,"function"==typeof this.onMilestonesLoaded&&this.onMilestonesLoaded(this.milestones),this.milestones}catch(e){throw console.error("Error fetching milestones:",e),this.isLoading=!1,e}}getMilestone(e){return e?"number"==typeof e||/^\d+$/.test(e)?this.milestones.find((t=>t.id===parseInt(e)||t.iid===parseInt(e))):this.milestones.find((t=>t.title===e)):null}getCurrentMilestone(){if(0===this.milestones.length)return null;const e=new Date;e.setHours(0,0,0,0);const t=this.milestones.filter((t=>"active"===t.state&&t.due_date&&new Date(t.due_date)>=e));if(t.length>0)return t.sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date)))[0];const s=this.milestones.filter((e=>"active"===e.state));return s.length>0?s[0]:null}getNextMilestone(){const e=this.getCurrentMilestone();if(!e||!e.due_date){const e=this.milestones.filter((e=>"active"===e.state));return e.length>0?e[0]:null}const t=new Date(e.due_date),s=this.milestones.filter((e=>"active"===e.state&&e.due_date&&new Date(e.due_date)>t));return s.length>0?s.sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date)))[0]:null}getUpcomingMilestones(e=5){const t=this.getCurrentMilestone(),s=this.getNextMilestone();return this.milestones.filter((e=>{if(!e.due_date||"active"!==e.state)return!1;if(t&&e.id===t.id)return!1;if(s&&e.id===s.id)return!1;const n=new Date(e.due_date),i=new Date;return i.setHours(0,0,0,0),n>=i})).sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date))).slice(0,e)}getMilestoneOptions(){const e=[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"none",label:"Remove Milestone"}];if(this.milestones.length>0){e.push({value:"separator",label:"─────────────"});const t=this.milestones.filter((e=>"active"===e.state)).map((e=>({value:e.title,label:e.title,dueDate:e.due_date})));e.push(...t)}return e}insertMilestoneCommand(e,t){if(!e)return;let s="/milestone ";"none"===t?s+='%""':t.startsWith("%")?s+=t:s+=`%"${t}"`;const n=/\/milestone\s+%[^\n]+/g,i=e.value;if(n.test(i))e.value=i.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let o=s;t>0&&"\n"!==i.charAt(t-1)&&i.length>0&&(o="\n"+o),e.value=i.substring(0,t)+o+i.substring(n);const a=t+o.length;e.setSelectionRange(a,a)}if(e.focus(),"none"===t)this.notification.info("Milestone will be removed");else{const e=t.startsWith("%")?t.substring(1):t;this.notification.info(`Milestone set to ${e}`)}}createMilestoneOption(e,t){const s=document.createElement("div");s.className="milestone-option",s.style.padding="10px",s.style.borderRadius="4px",s.style.border="1px solid #dee2e6",s.style.cursor="pointer",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""}));const n=document.createElement("div");if(n.className="milestone-title",n.textContent=e.label,n.style.fontWeight="bold",n.style.fontSize="14px",n.style.marginBottom="5px",s.appendChild(n),e.dueDate){const t=document.createElement("div");t.className="milestone-due-date";const n=new Date(e.dueDate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});t.textContent=`Due: ${n}`,t.style.fontSize="12px",t.style.color="#6c757d",t.style.marginBottom="5px",s.appendChild(t)}if(e.description){const t=document.createElement("div");t.className="milestone-description";let n=e.description;n.length>100&&(n=n.substring(0,97)+"..."),t.textContent=n,t.style.fontSize="12px",t.style.color="#6c757d",s.appendChild(t)}if(e.state){const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="flex-end",t.style.marginTop="5px";const n=document.createElement("span");n.className="milestone-state",n.textContent=e.state,n.style.fontSize="11px",n.style.padding="2px 6px",n.style.borderRadius="10px",n.style.textTransform="capitalize","active"===e.state?(n.style.backgroundColor="#28a745",n.style.color="white"):"closed"===e.state&&(n.style.backgroundColor="#6c757d",n.style.color="white"),t.appendChild(n),s.appendChild(t)}return"function"==typeof t&&s.addEventListener("click",t),s}openMilestoneSelector(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.zIndex="110",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";const s=document.createElement("div");s.style.backgroundColor="white",s.style.borderRadius="6px",s.style.padding="20px",s.style.width="600px",s.style.maxWidth="90%",s.style.maxHeight="80vh",s.style.overflow="auto",s.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.marginBottom="15px",n.style.borderBottom="1px solid #eee",n.style.paddingBottom="10px";const i=document.createElement("h3");i.textContent="Select Milestone",i.style.margin="0";const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>t.remove(),n.appendChild(i),n.appendChild(o);const a=document.createElement("div"),l=document.createElement("div");l.style.marginBottom="15px";const r=document.createElement("input");r.type="text",r.placeholder="Search milestones...",r.style.width="100%",r.style.padding="8px",r.style.borderRadius="4px",r.style.border="1px solid #ccc",l.appendChild(r),a.appendChild(l);const d=document.createElement("div");d.style.marginBottom="20px";[{value:"%current",label:"Current Sprint",description:"The active milestone with the closest due date"},{value:"%next",label:"Next Sprint",description:"The milestone following the current one"},{value:"%upcoming",label:"Upcoming",description:"Future milestones beyond the next one"},{value:"none",label:"Remove Milestone",description:"Clear the milestone from this issue"}].forEach((s=>{const n=this.createMilestoneOption(s,(()=>{this.insertMilestoneCommand(e,s.value),t.remove()}));d.appendChild(n)}));const c=document.createElement("div");c.style.borderBottom="1px solid #eee",c.style.margin="20px 0";const u=document.createElement("div");u.textContent="Loading milestones...",u.style.textAlign="center",u.style.padding="20px",u.style.color="#666";const h=document.createElement("div"),p=document.createElement("h4");p.textContent="Project Milestones",p.style.marginBottom="10px",h.appendChild(p),h.appendChild(u);const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="flex-end",m.style.marginTop="20px";const g=document.createElement("button");g.textContent="Refresh Milestones",g.style.padding="6px 12px",g.style.backgroundColor="#6c757d",g.style.color="white",g.style.border="none",g.style.borderRadius="4px",g.style.cursor="pointer",m.appendChild(g),a.appendChild(d),a.appendChild(c),a.appendChild(h),a.appendChild(m),s.appendChild(n),s.appendChild(a),t.appendChild(s),document.body.appendChild(t),t.addEventListener("click",(e=>{e.target===t&&t.remove()})),this.fetchMilestones().then((s=>{if(u.remove(),0===s.length){const e=document.createElement("div");return e.textContent="No milestones found for this project.",e.style.textAlign="center",e.style.padding="20px",e.style.color="#666",void h.appendChild(e)}const n=document.createElement("div");n.style.display="grid",n.style.gap="10px",n.style.gridTemplateColumns="1fr",s.forEach((s=>{const i=this.createMilestoneOption({value:s.title,label:s.title,description:s.description,dueDate:s.due_date,state:s.state},(()=>{this.insertMilestoneCommand(e,s.title),t.remove()}));n.appendChild(i)})),h.appendChild(n),r.addEventListener("input",(()=>{const e=r.value.toLowerCase();Array.from(n.children).forEach((t=>{const s=t.querySelector(".milestone-title"),n=t.querySelector(".milestone-description");if(!s)return;const i=s.textContent.toLowerCase(),o=n?n.textContent.toLowerCase():"";i.includes(e)||o.includes(e)?t.style.display="":t.style.display="none"}))})),g.addEventListener("click",(()=>{n.innerHTML="",n.appendChild(u),u.style.display="block",this.fetchMilestones().then((s=>{u.style.display="none",n.innerHTML="",s.forEach((s=>{const i=this.createMilestoneOption({value:s.title,label:s.title,description:s.description,dueDate:s.due_date,state:s.state},(()=>{this.insertMilestoneCommand(e,s.title),t.remove()}));n.appendChild(i)})),this.notification.success("Milestones refreshed")})).catch((e=>{console.error("Error refreshing milestones:",e),u.style.display="none";const t=document.createElement("div");t.textContent="Error refreshing milestones.",t.style.color="#dc3545",t.style.textAlign="center",t.style.padding="10px",n.innerHTML="",n.appendChild(t),this.notification.error("Failed to refresh milestones")}))}))})).catch((e=>{console.error("Error loading milestones:",e),u.textContent="Error loading milestones.",u.style.color="#dc3545"}))}},e.SettingsManager=class SettingsManager{constructor(t={}){this.labelManager=t.labelManager,this.assigneeManager=t.assigneeManager,this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onSettingsChanged=t.onSettingsChanged||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.availableAssignees=[],this.isLoadingAssignees=!1}openSettingsModal(){const e=document.createElement("div");e.id="git-helper-settings-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="110",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="700px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Settings",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div");this.createCollapsibleSection(o,"Assignees","Manage assignees for quick access in comments",(e=>this.createAssigneeSettings(e)),!0),this.createCollapsibleSection(o,"Labels","Manage which labels appear in the dropdown menus",(e=>this.createLabelWhitelistSettings(e)),!1),this.createCollapsibleSection(o,"Appearance","Customize the appearance of GitLab Sprint Helper",(e=>this.createAppearanceSettings(e)),!1);const a=document.createElement("div");a.style.marginTop="20px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.borderTop="1px solid #eee",a.style.paddingTop="15px";const l=document.createElement("button");l.textContent="Reset to Defaults",l.style.padding="8px 16px",l.style.backgroundColor="#6c757d",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer",l.onclick=()=>{confirm("Are you sure you want to reset all settings to default values?")&&(this.resetAllSettings(),e.remove(),this.notification.success("Settings reset to defaults"))};const r=document.createElement("button");r.textContent="Close",r.style.padding="8px 16px",r.style.backgroundColor="#28a745",r.style.color="white",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.onclick=()=>{e.remove()},a.appendChild(l),a.appendChild(r),t.appendChild(s),t.appendChild(o),t.appendChild(a),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}createCollapsibleSection(e,t,s,n,i=!1){const o=document.createElement("div");o.className="settings-section",o.style.marginBottom="15px",o.style.border="1px solid #ddd",o.style.borderRadius="6px",o.style.overflow="hidden";const a=document.createElement("div");a.className="settings-section-header",a.style.padding="12px 15px",a.style.backgroundColor="#f8f9fa",a.style.borderBottom="none",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.cursor="pointer",a.style.transition="background-color 0.2s ease",a.addEventListener("mouseenter",(()=>{a.style.backgroundColor="#e9ecef"})),a.addEventListener("mouseleave",(()=>{a.style.backgroundColor="#f8f9fa"}));const l=document.createElement("div"),r=document.createElement("h4");r.textContent=t,r.style.margin="0",r.style.fontSize="16px";const d=document.createElement("div");d.textContent=s,d.style.fontSize="13px",d.style.color="#6c757d",d.style.marginTop="4px",l.appendChild(r),l.appendChild(d);const c=document.createElement("span");c.textContent="▶",c.style.fontSize="14px",c.style.transition="transform 0.3s ease",a.appendChild(l),a.appendChild(c);const u=document.createElement("div");u.className="settings-section-content",u.style.padding="15px",u.style.display="none",u.style.backgroundColor="white";let h=!1;return a.addEventListener("click",(()=>{const e="block"===u.style.display;u.style.display=e?"none":"block",c.textContent=e?"▶":"▼",a.style.borderBottom=e?"none":"1px solid #ddd",h||e||(n(u),h=!0)})),o.appendChild(a),o.appendChild(u),e.appendChild(o),o}createAssigneeSettings(e){const t=document.createElement("div"),s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.marginBottom="15px",s.style.gap="10px";const n=document.createElement("div");n.style.flex="1";const i=document.createElement("input");i.type="text",i.placeholder="Search assignees...",i.style.width="100%",i.style.padding="8px 10px",i.style.borderRadius="4px",i.style.border="1px solid #ccc",n.appendChild(i);const o=document.createElement("button");o.textContent="Fetch GitLab Users",o.style.padding="8px 12px",o.style.backgroundColor="#1f75cb",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.onclick=()=>this.fetchGitLabUsers(m),s.appendChild(n),s.appendChild(o),t.appendChild(s);const a=document.createElement("div");a.style.display="flex",a.style.borderBottom="1px solid #dee2e6",a.style.marginBottom="15px";const l=[{id:"whitelisted",label:"My Assignees",active:!0},{id:"available",label:"Available Users",active:!1}],r={},d={};l.forEach((e=>{const t=document.createElement("div");t.textContent=e.label,t.style.padding="8px 15px",t.style.cursor="pointer",t.style.transition="all 0.2s ease",e.active&&(t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold"),t.addEventListener("mouseenter",(()=>{e.active||(t.style.backgroundColor="#f5f5f5")})),t.addEventListener("mouseleave",(()=>{e.active||(t.style.backgroundColor="")})),t.addEventListener("click",(()=>{l.forEach((e=>{e.active=!1,r[e.id].style.borderBottom="none",r[e.id].style.fontWeight="normal",r[e.id].style.backgroundColor="",d[e.id].style.display="none"})),e.active=!0,t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold",d[e.id].style.display="block","whitelisted"===e.id?this.refreshAssigneeList(h):"available"===e.id&&this.fetchGitLabUsers(m)})),r[e.id]=t,a.appendChild(t)})),t.appendChild(a);const c=document.createElement("div");c.style.display="block";const u=document.createElement("div");u.style.display="none";const h=document.createElement("div");h.style.height="300px",h.style.overflowY="auto",h.style.border="1px solid #eee",h.style.borderRadius="4px";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};let p=[];p=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),p.length>0?p.forEach(((e,t)=>{h.appendChild(this.createAssigneeListItem(e,t,h,createEmptyMessage))})):h.appendChild(createEmptyMessage()),c.appendChild(h),c.appendChild(this.createAddAssigneeForm(h,createEmptyMessage));const m=document.createElement("div");m.className="available-assignees-list",m.style.height="300px",m.style.overflowY="auto",m.style.border="1px solid #eee",m.style.borderRadius="4px";const g=document.createElement("div");g.textContent='Click "Fetch GitLab Users" to load available assignees.',g.style.padding="15px",g.style.color="#666",g.style.fontStyle="italic",g.style.textAlign="center",m.appendChild(g),u.appendChild(m),d.whitelisted=c,d.available=u,t.appendChild(c),t.appendChild(u),i.addEventListener("input",(()=>{const e=i.value.toLowerCase();("whitelisted"===l.find((e=>e.active)).id?h:m).querySelectorAll(".assignee-item").forEach((t=>{const s=t.querySelector(".assignee-name"),n=t.querySelector(".assignee-username");if(!s||!n)return;const i=s.textContent.toLowerCase(),o=n.textContent.toLowerCase();i.includes(e)||o.includes(e)?t.style.display="":t.style.display="none"}))})),e.appendChild(t)}createAddAssigneeForm(e,t){const s=document.createElement("div");s.style.marginTop="15px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="4px";const n=document.createElement("h5");n.textContent="Add New Assignee",n.style.marginTop="0",n.style.marginBottom="10px";const i=document.createElement("div");i.style.marginBottom="10px";const o=document.createElement("label");o.textContent="Display Name:",o.style.display="block",o.style.marginBottom="5px";const a=document.createElement("input");a.type="text",a.placeholder="John Doe",a.style.width="100%",a.style.padding="6px 10px",a.style.borderRadius="4px",a.style.border="1px solid #ccc",i.appendChild(o),i.appendChild(a);const l=document.createElement("div");l.style.marginBottom="15px";const r=document.createElement("label");r.textContent="GitLab Username:",r.style.display="block",r.style.marginBottom="5px";const d=document.createElement("input");d.type="text",d.placeholder="username (without @)",d.style.width="100%",d.style.padding="6px 10px",d.style.borderRadius="4px",d.style.border="1px solid #ccc",l.appendChild(r),l.appendChild(d);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="flex-end";const u=document.createElement("button");return u.textContent="Add Assignee",u.style.padding="6px 12px",u.style.backgroundColor="#28a745",u.style.color="white",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",u.onclick=()=>{const s=a.value.trim(),n=d.value.trim();if(!n)return void this.notification.error("Username is required");const i={name:s||n,username:n};if(this.assigneeManager)this.assigneeManager.addAssignee(i);else{const e=getAssigneeWhitelist(),t=e.findIndex((e=>e.username===n));t>=0?e[t]=i:e.push(i),saveAssigneeWhitelist(e)}const o=e.querySelector('div[style*="italic"]');o&&o.remove();const l=getAssigneeWhitelist();e.appendChild(this.createAssigneeListItem(i,l.length-1,e,t)),a.value="",d.value="",this.notification.success(`Added assignee: ${i.name}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},c.appendChild(u),s.appendChild(n),s.appendChild(i),s.appendChild(l),s.appendChild(c),s}async fetchGitLabUsers(e){if(!this.gitlabApi)return void this.notification.error("GitLab API not available");this.isLoadingAssignees=!0,e.innerHTML="";const t=document.createElement("div");t.textContent="Loading users from GitLab...",t.style.padding="15px",t.style.textAlign="center",e.appendChild(t);try{const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s=[];"project"===t.type?s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}}):"group"===t.type&&(s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})),this.availableAssignees=s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.renderAvailableUsers(e)}catch(t){console.error("Error fetching GitLab users:",t),e.innerHTML="";const s=document.createElement("div");s.textContent=`Error loading users: ${t.message}`,s.style.padding="15px",s.style.color="#dc3545",s.style.textAlign="center",e.appendChild(s),this.notification.error("Failed to load GitLab users")}finally{this.isLoadingAssignees=!1}}renderAvailableUsers(e){e.innerHTML="";const t=getAssigneeWhitelist().map((e=>e.username.toLowerCase()));if(0===this.availableAssignees.length){const t=document.createElement("div");return t.textContent="No users found. Try fetching again.",t.style.padding="15px",t.style.color="#666",t.style.fontStyle="italic",t.style.textAlign="center",void e.appendChild(t)}this.availableAssignees.sort(((e,t)=>e.name.localeCompare(t.name))),this.availableAssignees.forEach((s=>{const n=t.includes(s.username.toLowerCase()),i=document.createElement("div");i.className="assignee-item",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="10px 15px",i.style.borderBottom="1px solid #eee",i.style.backgroundColor=n?"rgba(40, 167, 69, 0.05)":"";const o=document.createElement("div");if(o.style.display="flex",o.style.alignItems="center",s.avatar_url){const e=document.createElement("img");e.src=s.avatar_url,e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.marginRight="10px",o.appendChild(e)}else{const e=document.createElement("div");e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.backgroundColor="#e0e0e0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.marginRight="10px",e.style.fontWeight="bold",e.style.color="#666";const t=(s.name||s.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();e.textContent=t,o.appendChild(e)}const a=document.createElement("div"),l=document.createElement("div");l.className="assignee-name",l.textContent=s.name,l.style.fontWeight="bold";const r=document.createElement("div");r.className="assignee-username",r.textContent=`@${s.username}`,r.style.fontSize="12px",r.style.color="#666",a.appendChild(l),a.appendChild(r),o.appendChild(a);const d=document.createElement("button");n?(d.textContent="Added ✓",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default"):(d.textContent="Add",d.style.backgroundColor="#28a745",d.style.color="white",d.style.cursor="pointer",d.addEventListener("click",(()=>{const e={name:s.name,username:s.username};if(this.assigneeManager)this.assigneeManager.addAssignee(e);else{const t=getAssigneeWhitelist();t.push(e),saveAssigneeWhitelist(t)}d.textContent="Added ✓",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default",i.style.backgroundColor="rgba(40, 167, 69, 0.05)",this.notification.success(`Added ${s.name} to assignees`),"function"==typeof this.onSettingsChanged&&this.onSettingsChanged("assignees"),this.refreshWhitelistedTab()}))),d.style.padding="5px 10px",d.style.border="none",d.style.borderRadius="4px",d.style.fontSize="12px",i.appendChild(o),i.appendChild(d),e.appendChild(i)}))}refreshWhitelistedTab(){const e=document.querySelector('div[style*="display: block"]');if(!e)return;const t=e.querySelector('div[style*="overflowY: auto"]');if(!t)return;const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};t.innerHTML="";const s=document.createElement("div");s.textContent="Refreshing assignees...",s.style.padding="15px",s.style.textAlign="center",s.style.color="#666",t.appendChild(s),setTimeout((()=>{let e=[];e=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),t.innerHTML="",e.length>0?e.forEach(((e,s)=>{t.appendChild(this.createAssigneeListItem(e,s,t,createEmptyMessage))})):t.appendChild(createEmptyMessage())}),300)}createAssigneeListItem(e,t,s,n){const i=document.createElement("div");i.className="assignee-item",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="10px 15px",i.style.borderBottom="1px solid #eee";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center";const a=document.createElement("div");a.style.width="30px",a.style.height="30px",a.style.borderRadius="50%",a.style.backgroundColor="#e0e0e0",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.marginRight="10px",a.style.fontWeight="bold",a.style.color="#666";const l=(e.name||e.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();a.textContent=l,o.appendChild(a);const r=document.createElement("div"),d=document.createElement("div");d.className="assignee-name",d.textContent=e.name||e.username,d.style.fontWeight="bold";const c=document.createElement("div");c.className="assignee-username",c.textContent=`@${e.username}`,c.style.fontSize="12px",c.style.color="#666",r.appendChild(d),r.appendChild(c),o.appendChild(r);const u=document.createElement("div"),h=document.createElement("button");return h.textContent="Remove",h.style.padding="5px 10px",h.style.backgroundColor="#dc3545",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontSize="12px",h.onclick=()=>{let t=[];if(this.assigneeManager)this.assigneeManager.removeAssignee(e.username),t=this.assigneeManager.getAssigneeWhitelist();else{t=getAssigneeWhitelist();const s=t.filter((t=>t.username.toLowerCase()!==e.username.toLowerCase()));saveAssigneeWhitelist(s),t=s}i.remove(),0===t.length&&s.appendChild(n()),this.notification.info(`Removed assignee: ${e.name||e.username}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},u.appendChild(h),i.appendChild(o),i.appendChild(u),i}createLabelWhitelistSettings(e){const t=document.createElement("div");t.style.marginBottom="20px";const s=document.createElement("h4");s.textContent="Label Whitelist",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Select which labels should appear in the dropdown. The system will show any label that contains these terms.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n);const i=document.createElement("div");i.id="whitelist-loading-message",i.textContent="Loading all labels from GitLab...",i.style.fontStyle="italic",i.style.color="#666",t.appendChild(i);const o=document.createElement("div");o.id="whitelist-container",o.style.display="flex",o.style.flexWrap="wrap",o.style.gap="10px",o.style.marginTop="15px",o.style.height="300px",o.style.overflowY="auto",o.style.border="1px solid #eee",o.style.borderRadius="4px",o.style.padding="10px",t.appendChild(o);const a=getLabelWhitelist(),l=Array.isArray(a)?a:[],displayLabels=e=>{if(i.remove(),!e||0===e.length){const e=document.createElement("div");return e.textContent="No labels found in this project.",e.style.width="100%",e.style.textAlign="center",e.style.marginBottom="15px",e.style.color="#666",void o.appendChild(e)}e.sort(((e,t)=>e.name.localeCompare(t.name)));const t=new Set;e.forEach((e=>{if(t.has(e.name.toLowerCase()))return;t.add(e.name.toLowerCase());const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="10px",s.style.width="calc(33.33% - 10px)";const n=document.createElement("input");n.type="checkbox",n.id=`label-${e.name}`,n.dataset.label=e.name.toLowerCase(),n.style.marginRight="8px";const i=l.some((t=>e.name.toLowerCase().includes(t.toLowerCase())));n.checked=i;const a=this.createGitLabStyleLabel(e);a.style.cursor="pointer",a.onclick=()=>{n.checked=!n.checked,this.autoSaveWhitelist(o)},n.addEventListener("change",(()=>{this.autoSaveWhitelist(o)})),s.appendChild(n),s.appendChild(a),o.appendChild(s)}))};(async()=>{try{if(!this.gitlabApi)throw new Error("GitLab API not available");const e=getPathFromUrl();if(!e||!e.apiUrl)throw new Error("Could not determine project/group path");const t=await this.gitlabApi.callGitLabApi(e.apiUrl,{params:{per_page:100}});displayLabels(t)}catch(e){console.error("Error fetching ALL labels:",e),i.textContent="Error loading labels. "+e.message,i.style.color="#dc3545"}})(),e.appendChild(t)}refreshAssigneeList(e){if(!e)return;const t=document.createElement("div");t.textContent="Refreshing assignees...",t.style.padding="15px",t.style.textAlign="center",t.style.color="#666",e.innerHTML="",e.appendChild(t);const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};setTimeout((()=>{let t=[];t=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),e.innerHTML="",t.length>0?t.forEach(((t,s)=>{e.appendChild(this.createAssigneeListItem(t,s,e,createEmptyMessage))})):e.appendChild(createEmptyMessage())}),300)}createAppearanceSettings(e){const t=document.createElement("div"),s=document.createElement("h4");s.textContent="Appearance Settings",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Customize the appearance of the GitLab Sprint Helper.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n);const i=document.createElement("div");i.style.padding="20px",i.style.textAlign="center",i.style.backgroundColor="#f8f9fa",i.style.borderRadius="4px",i.style.color="#666",i.textContent="Appearance settings coming soon!",t.appendChild(i),e.appendChild(t)}createGitLabStyleLabel(e){const t=document.createElement("span");t.textContent=e.name;const s=e.color||generateColorFromString(e.name),n=getContrastColor(s);return t.style.backgroundColor=s,t.style.color=n,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}createWhitelistEditor(e){const t=document.createElement("div");t.id="whitelist-loading-message",t.textContent="Loading available labels...",t.style.fontStyle="italic",t.style.color="#666",e.appendChild(t);const s=document.createElement("div");s.id="whitelist-container",s.style.display="flex",s.style.flexWrap="wrap",s.style.gap="10px",s.style.marginTop="15px",e.appendChild(s),currentWhitelist=getLabelWhitelist(),Array.isArray(currentWhitelist)||(console.warn("Whitelist is not an array, using default"),currentWhitelist=[]),this.labelManager?this.labelManager.fetchAllLabels().then((e=>{if(t.remove(),!e||0===e.length){const e=document.createElement("div");return e.textContent="No labels found. Showing whitelist terms instead.",e.style.width="100%",e.style.marginBottom="15px",s.appendChild(e),void this.showWhitelistTermsOnly(s,currentWhitelist)}e.sort(((e,t)=>e.name.localeCompare(t.name)));const n=new Set;e.forEach((e=>{if(n.has(e.name.toLowerCase()))return;n.add(e.name.toLowerCase());const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="10px",t.style.width="calc(33.33% - 10px)";const i=document.createElement("input");i.type="checkbox",i.id=`label-${e.name}`,i.dataset.label=e.name.toLowerCase(),i.style.marginRight="8px",this.labelManager.isLabelInWhitelist(e.name,currentWhitelist)&&(i.checked=!0);const o=this.createGitLabStyleLabel(e);o.style.cursor="pointer",o.onclick=()=>{i.checked=!i.checked},t.appendChild(i),t.appendChild(o),s.appendChild(t)}));const i=document.createElement("div");i.style.width="100%",i.style.marginTop="20px",i.style.padding="15px",i.style.borderTop="1px solid #ddd";const o=document.createElement("div");o.textContent="Add custom terms (comma separated):",o.style.marginBottom="8px",o.style.fontWeight="bold";const a=document.createElement("input");a.type="text",a.id="custom-whitelist-terms",a.style.width="100%",a.style.padding="8px",a.style.borderRadius="4px",a.style.border="1px solid #ccc";const l=Array.from(n);let r=[];Array.isArray(currentWhitelist)&&(r=currentWhitelist.filter((e=>"string"==typeof e&&!l.some((t=>t.includes(e.toLowerCase())))))),a.value=r.join(", "),i.appendChild(o),i.appendChild(a),s.appendChild(i)})).catch((e=>{console.error("Error fetching labels for whitelist editor:",e),t.textContent="Error loading labels. Using whitelist terms instead.",t.style.color="#dc3545",this.showWhitelistTermsOnly(s,currentWhitelist)})):(t.textContent="Label manager not available. Using whitelist terms instead.",t.style.color="#dc3545",this.showWhitelistTermsOnly(s,currentWhitelist))}showWhitelistTermsOnly(e,t){Array.isArray(t)||(console.warn("Whitelist is not an array in showWhitelistTermsOnly"),t=[]),t.forEach((t=>{if("string"!=typeof t)return;const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="10px",s.style.width="calc(33.33% - 10px)";const n=document.createElement("input");n.type="checkbox",n.id=`label-${t}`,n.dataset.label=t.toLowerCase(),n.style.marginRight="8px",n.checked=!0;const i=document.createElement("span");i.textContent=t,i.style.padding="4px 8px",i.style.borderRadius="100px",i.style.fontSize="12px",i.style.fontWeight="500",i.style.display="inline-block",i.style.margin="2px",i.style.backgroundColor=generateColorFromString(t),i.style.color=getContrastColor(i.style.backgroundColor),i.style.cursor="pointer",i.onclick=()=>{n.checked=!n.checked},s.appendChild(n),s.appendChild(i),e.appendChild(s)}));const s=document.createElement("div");s.style.width="100%",s.style.marginTop="20px",s.style.padding="15px",s.style.borderTop="1px solid #ddd";const n=document.createElement("div");n.textContent="Add custom terms (comma separated):",n.style.marginBottom="8px",n.style.fontWeight="bold";const i=document.createElement("input");i.type="text",i.id="custom-whitelist-terms",i.style.width="100%",i.style.padding="8px",i.style.borderRadius="4px",i.style.border="1px solid #ccc",s.appendChild(n),s.appendChild(i),e.appendChild(s)}saveWhitelistSettings(){const e=[],t=new Set;document.querySelectorAll('#whitelist-container input[type="checkbox"]').forEach((s=>{if(s.checked){const n=s.dataset.label.toLowerCase();t.has(n)||(e.push(n),t.add(n))}}));const s=document.getElementById("custom-whitelist-terms");if(s&&s.value){s.value.split(",").map((e=>e.trim().toLowerCase())).forEach((s=>{s&&!t.has(s)&&(e.push(s),t.add(s))}))}saveLabelWhitelist(e),this.labelManager&&this.labelManager.saveWhitelist(e),this.notification&&this.notification.success(`Saved ${e.length} whitelist terms`),this.onSettingsChanged&&this.onSettingsChanged("labels")}resetLabelWhitelist(){resetLabelWhitelist(),this.labelManager&&this.labelManager.resetToDefaultWhitelist(),this.onSettingsChanged&&this.onSettingsChanged("labels")}resetAllSettings(){this.resetLabelWhitelist(),saveAssigneeWhitelist([]),this.onSettingsChanged&&this.onSettingsChanged("all")}autoSaveWhitelist(e){const t=[],s=new Set;e.querySelectorAll('input[type="checkbox"]').forEach((e=>{if(e.checked){const n=e.dataset.label.toLowerCase();s.has(n)||(t.push(n),s.add(n))}})),saveLabelWhitelist(t),this.labelManager&&this.labelManager.saveWhitelist(t),this.notification&&this.notification.success("Label whitelist updated"),this.onSettingsChanged&&this.onSettingsChanged("labels")}},e.SummaryView=class SummaryView{constructor(uiManager){this.uiManager=uiManager}render(e,t,s,n,i,o,a){const l=document.getElementById("assignee-time-summary-content");if(!l)return;if(l.innerHTML="",this.uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:this.getClosedBoardCount()}),0===n)return this.renderNoDataMessage(l),void(this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("summary-tab"));const r=formatHours(t);let d=0;for(const e in o){const t=e.toLowerCase();(t.includes("done")||t.includes("closed")||t.includes("complete")||t.includes("finished"))&&(d+=o[e].timeEstimate||0)}const c=formatHours(d);this.uiManager.updateHeader(`Summary ${r}h - <span style="color:#28a745">${c}h</span>`),i&&this.renderMilestoneInfo(l,i),this.renderDataTableWithDistribution(l,e,r,o,a),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("summary-tab")}getClosedBoardCount(){let e=0;return document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}if(s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished")){const s=t.querySelectorAll(".board-card");e+=s.length}})),e}renderNoDataMessage(e){const t=document.createElement("p");t.textContent="No time estimate data found. Make sure the board is fully loaded and try again.",t.style.color="#666",e.appendChild(t);const s=document.createElement("p");s.style.fontSize="12px",s.style.fontStyle="italic",s.innerHTML="Tip: Try scrolling through all cards to ensure they are loaded before clicking Recalculate.",e.appendChild(s),this.uiManager.updateHeader("Summary 0.0h")}renderMilestoneInfo(e,t){const s=document.createElement("div");s.style.marginBottom="10px",s.style.fontSize="13px",s.style.color="#555",s.textContent=`Current Milestone: ${t}`,e.appendChild(s)}renderDataTableWithDistribution(e,t,s,n,i){const o=document.createElement("table");o.style.width="100%",o.style.borderCollapse="collapse";const a=Object.keys(n||{}),l=document.createElement("tr");l.style.borderBottom="2px solid #ddd",l.style.fontWeight="bold";const r=document.createElement("td");r.textContent="Total",r.style.padding="5px 0";const d=document.createElement("td");d.textContent=`${s}h`,d.style.textAlign="right",d.style.padding="5px 0";const c=document.createElement("td");if(c.style.textAlign="right",c.style.padding="5px 0 5px 15px",c.style.color="#666",c.style.fontSize="12px",a.length>0&&n){const e=a.map((e=>{const t=n[e]||{timeEstimate:0},s=parseFloat(formatHours(t.timeEstimate||0));return Math.round(s)})),t=e.map(((t,s)=>{let n='<span style="';return 0===t&&(n+="color:#aaa;"),s===e.length-1&&t>0&&(n+="color:#28a745;"),n+=`">${t}</span>`,n})).join("/");c.innerHTML=t}l.appendChild(r),l.appendChild(d),l.appendChild(c),o.appendChild(l);Object.keys(t).sort(((e,s)=>t[s]-t[e])).forEach((e=>{const s=formatHours(t[e]),n=document.createElement("tr");n.style.borderBottom="1px solid #eee";const l=document.createElement("td");l.textContent=e,l.style.padding="5px 0";const r=document.createElement("td");r.textContent=`${s}h`,r.style.textAlign="right",r.style.padding="5px 0";const d=document.createElement("td");if(d.style.textAlign="right",d.style.padding="5px 0 5px 15px",d.style.color="#666",d.style.fontSize="12px",a.length>0&&i){const t=a.map((t=>{const s=(i[t]||{})[e]||{timeEstimate:0},n=parseFloat(formatHours(s.timeEstimate||0));return Math.round(n)})),s=t.map(((e,s)=>{let n='<span style="';return 0===e&&(n+="color:#aaa;"),s===t.length-1&&e>0&&(n+="color:#28a745;"),n+=`">${e}</span>`,n})).join("/");d.innerHTML=s}n.appendChild(l),n.appendChild(r),n.appendChild(d),o.appendChild(n)})),e.appendChild(o)}},e.BoardsView=class BoardsView{constructor(uiManager){this.uiManager=uiManager}render(e,t){const s=document.getElementById("boards-time-summary-content");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="boards-list-summary";Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const i=this.createBoardSection(s,e[s],t[s]);n.appendChild(i)})),s.appendChild(n),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("boards-tab")}createBoardSection(e,t,s){const n=formatHours(t.timeEstimate),i=document.createElement("div");i.className="board-section",i.style.marginBottom="15px";const o=document.createElement("div");o.className="board-header",o.style.display="flex",o.style.justifyContent="space-between",o.style.padding="5px",o.style.backgroundColor="#f5f5f5",o.style.borderRadius="3px",o.style.cursor="pointer",o.style.fontWeight="bold";const a=document.createElement("div");a.className="board-details",a.style.display="none",a.style.marginTop="5px",a.style.marginLeft="10px",o.addEventListener("click",(()=>{"none"===a.style.display?(a.style.display="block",r.textContent="▼"):(a.style.display="none",r.textContent="▶")}));const l=document.createElement("div");l.textContent=`${e} (${t.tickets} tickets, ${n}h)`;const r=document.createElement("span");return r.textContent="▶",r.style.marginLeft="5px",o.appendChild(l),o.appendChild(r),s&&a.appendChild(this.createAssigneeTable(s)),i.appendChild(o),i.appendChild(a),i}createAssigneeTable(e){const t=document.createElement("table");t.style.width="100%",t.style.borderCollapse="collapse",t.style.marginTop="5px";const s=document.createElement("tr");s.style.borderBottom="1px solid #ddd";const n=document.createElement("th");n.textContent="Assignee",n.style.textAlign="left",n.style.padding="3px 0";const i=document.createElement("th");i.textContent="Tickets",i.style.textAlign="right",i.style.padding="3px 5px";const o=document.createElement("th");o.textContent="Hours",o.style.textAlign="right",o.style.padding="3px 0",s.appendChild(n),s.appendChild(i),s.appendChild(o),t.appendChild(s);return Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const n=e[s],i=formatHours(n.timeEstimate),o=document.createElement("tr");o.style.borderBottom="1px solid #eee";const a=document.createElement("td");a.textContent=s,a.style.padding="3px 0";const l=document.createElement("td");l.textContent=n.tickets,l.style.textAlign="right",l.style.padding="3px 5px";const r=document.createElement("td");r.textContent=`${i}h`,r.style.textAlign="right",r.style.padding="3px 0",o.appendChild(a),o.appendChild(l),o.appendChild(r),t.appendChild(o)})),t}},e.HistoryView=class HistoryView{constructor(uiManager){this.uiManager=uiManager}render(){const e=document.getElementById("history-time-summary-content");if(!e)return;e.innerHTML="";const t=getHistoryKey(),s=GM_getValue(t,[]),n=document.createElement("div");if(n.style.fontSize="12px",n.style.color="#666",n.style.marginBottom="10px",n.style.wordBreak="break-all",e.appendChild(n),0===s.length)return this.renderNoHistoryMessage(e),void(this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("history-tab"));this.addClearHistoryButton(e,t),this.renderHistoryTable(e,s),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("history-tab")}renderNoHistoryMessage(e){const t=document.createElement("p");t.textContent="No history data available for this URL yet.",t.style.color="#666",e.appendChild(t)}addClearHistoryButton(e,t){const s=document.createElement("button");s.textContent="Clear History",s.style.padding="3px 6px",s.style.fontSize="12px",s.style.backgroundColor="#dc3545",s.style.color="white",s.style.border="none",s.style.borderRadius="3px",s.style.cursor="pointer",s.style.marginBottom="10px",s.onclick=()=>{confirm("Are you sure you want to clear history data for this URL?")&&(GM_setValue(t,[]),this.render())},e.appendChild(s)}renderHistoryTable(e,t){const s=document.createElement("table");s.style.width="100%",s.style.borderCollapse="collapse";const n=document.createElement("tr");n.style.borderBottom="2px solid #ddd",n.style.fontWeight="bold";const i=document.createElement("th");i.textContent="Date",i.style.textAlign="left",i.style.padding="5px 0";const o=document.createElement("th");o.textContent="Hours",o.style.textAlign="right",o.style.padding="5px 0";const a=document.createElement("th");a.textContent="Milestone",a.style.textAlign="left",a.style.padding="5px 0",n.appendChild(i),n.appendChild(o),n.appendChild(a),s.appendChild(n),t.slice().reverse().forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid #eee";const n=document.createElement("td"),i=new Date(e.timestamp);n.textContent=i.toLocaleDateString()+" "+i.toLocaleTimeString().substring(0,5),n.style.padding="5px 0";const o=document.createElement("td");o.textContent=`${e.totalHours}h`,o.style.textAlign="right",o.style.padding="5px 0";const a=document.createElement("td");a.textContent=e.milestone,a.style.padding="5px 0",t.appendChild(n),t.appendChild(o),t.appendChild(a),s.appendChild(t)})),e.appendChild(s)}},e.BulkCommentsView=class BulkCommentsView{constructor(uiManager){this.uiManager=uiManager,this.selectedIssues=[],this.commandShortcuts=null,this.isLoading=!1,this.initializedShortcuts=new Set,this.commentInput=null,this.gitlabApi=e.gitlabApi||uiManager&&uiManager.gitlabApi,this.notification=new Notification({position:"bottom-right",duration:3e3}),uiManager&&uiManager.labelManager?this.labelManager=uiManager.labelManager:"function"==typeof LabelManager?this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.commandShortcuts&&this.addLabelShortcut()}}):this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([])},this.selectionDisplay=new SelectionDisplay({selectedIssues:this.selectedIssues,onRemoveIssue:e=>this.onRemoveIssue(e)})}initializeManagers(uiManager){if(uiManager&&uiManager.labelManager)this.labelManager=uiManager.labelManager;else try{"function"==typeof LabelManager?this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.commandShortcuts&&this.addLabelShortcut()}}):(console.warn("LabelManager class not available, using placeholder"),this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([]),isLabelInWhitelist:()=>!1})}catch(e){console.error("Error initializing LabelManager:",e),this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([]),isLabelInWhitelist:()=>!1}}uiManager&&uiManager.assigneeManager?this.assigneeManager=uiManager.assigneeManager:this.assigneeManager=e.assigneeManager}updateAssignShortcut(t){if(this.commandShortcuts)if(!t||t.length<=3)console.warn("Not updating assign shortcut: no meaningful items to add");else try{let s=null;this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(s=this.commandShortcuts.shortcuts.assign.dropdown.value),this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.removeShortcut("assign"),this.commandShortcuts.addCustomShortcut({type:"assign",label:"/assign",items:t,onSelect:t=>{if(!t||"separator"===t||"separator2"===t)return;if("manage"===t){if(this.assigneeManager&&"function"==typeof this.assigneeManager.openAssigneeManager)this.assigneeManager.openAssigneeManager();else if(e.assigneeManager&&"function"==typeof e.assigneeManager.openAssigneeManager)e.assigneeManager.openAssigneeManager();else{if("function"!=typeof openAssigneeManager)return console.error("No assignee manager found"),void this.notification.error("Assignee manager not available");openAssigneeManager()}return void setTimeout((()=>{this.addAssignShortcut()}),500)}if("custom"===t){const e=prompt("Enter GitLab username (without @):");if(!e)return;t=e}const s=this.commentInput||document.getElementById("issue-comment-input");if(!s)return void console.error("No textarea found for inserting assign command");let n="/assign ";n+="none"===t?"@none":"@me"===t?"@me":t.startsWith("@")?t:`@${t}`,this.insertTextAtCursor(s,n),"none"===t?this.notification.info("Issue will be unassigned"):"@me"===t?this.notification.info("Issue will be assigned to you"):this.notification.info(`Issue will be assigned to ${t.replace("@","")}`)}}),s&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(this.commandShortcuts.shortcuts.assign.dropdown.value=s)}catch(e){console.error("Error updating assign shortcut:",e)}else console.error("Cannot update assign shortcut: commandShortcuts not available")}initializeAllShortcuts(){if(this.commandShortcuts)try{const e=new Set(Object.keys(this.commandShortcuts.shortcuts||{}));e.has("estimate")||(this.commandShortcuts.initializeEstimateShortcut(),e.add("estimate")),e.has("label")||(this.addLabelShortcut([{value:"",label:"Loading labels..."}]),e.add("label")),e.has("milestone")||(this.addMilestoneShortcut(),e.add("milestone")),e.has("assign")||(this.addAssignShortcut(),e.add("assign"))}catch(e){console.error("Error initializing shortcuts:",e),this.notification.error("Error initializing shortcuts")}}addMilestoneShortcut(){if(this.commandShortcuts)try{this.commandShortcuts.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"none",label:"Remove Milestone"},{value:"custom",label:"Custom..."}],onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter milestone name:");if(!t)return;e=t}if(!this.commentInput)return void console.warn("Comment input not available");let t="/milestone ";"none"===e?t+='%""':e.startsWith("%")?t+=e:t+=`%"${e}"`,this.insertTextAtCursor(this.commentInput,t),this.notification.info(`Milestone set to ${"none"===e?"none":e}`)}})}catch(e){console.error("Error adding milestone shortcut:",e)}}addAssignShortcut(){if(!this.commandShortcuts)return;let t=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}],s=null;try{"function"==typeof GM_getValue&&(s=GM_getValue("gitLabHelperAssigneeWhitelist",[]))}catch(e){console.error("Error accessing GM_getValue:",e)}if(Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"────── Favorites ──────"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}else{let s=[];if(this.assigneeManager&&"function"==typeof this.assigneeManager.getAssigneeWhitelist)try{s=this.assigneeManager.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from this.assigneeManager:",e)}if((!s||!s.length)&&e.assigneeManager&&"function"==typeof e.assigneeManager.getAssigneeWhitelist)try{s=e.assigneeManager.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from window.assigneeManager:",e)}if(!(s&&s.length||"function"!=typeof getAssigneeWhitelist))try{s=getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from imported getAssigneeWhitelist:",e)}if(!(s&&s.length||"function"!=typeof e.getAssigneeWhitelist))try{s=e.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from window.getAssigneeWhitelist:",e)}if(!s||!s.length)try{const e=localStorage.getItem("gitLabHelperAssigneeWhitelist");e&&(s=JSON.parse(e))}catch(e){console.error("Error getting assignees from localStorage:",e)}if(Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"────── Favorites ──────"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}else console.warn("Could not find any assignees through any method")}t.push({value:"custom",label:"Custom..."}),this.updateAssignShortcut(t),setTimeout((()=>{this.fetchGroupMembers().then((e=>{if(e&&e.length>0){const s=[...t];s.push({value:"separator2",label:"────── Group Members ──────"});const n=t.filter((e=>e.value&&!["separator","separator2","custom","manage","@me","none",""].includes(e.value))).map((e=>e.value.toLowerCase())),i=e.filter((e=>!n.includes(e.username.toLowerCase()))).map((e=>({value:e.username,label:e.name||e.username})));i.length>0&&(s.push(...i),this.updateAssignShortcut(s))}})).catch((e=>{console.error("Error fetching group members:",e)}))}),100)}async fetchGroupMembers(){try{if(this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)throw new Error("GitLab API not available");const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s;if("project"===t.type)s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}});else{if("group"!==t.type)throw new Error("Unsupported path type: "+t.type);s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})}return Array.isArray(s)?s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))):(console.warn("API did not return an array of members"),[])}catch(e){return console.error("Error fetching group members:",e),[]}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.selectionDisplay&&this.selectionDisplay.setSelectedIssues(this.selectedIssues);const t=document.getElementById("comment-status");if(t){const e=this.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected. Enter your comment and click "Add Comment".`,t.style.color="green"):this.isLoading||(t.textContent='No issues selected. Click "Select Issues".',t.style.color="#666")}}onRemoveIssue(t){if(this.selectedIssues.length>t){this.selectedIssues[t];this.selectedIssues.splice(t,1),this.uiManager&&this.uiManager.issueSelector?this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]):e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}const s=document.getElementById("comment-status");if(s){const e=this.selectedIssues.length;e>0?(s.textContent=`${e} issue${1!==e?"s":""} selected.`,s.style.color="green"):(s.textContent='No issues selected. Click "Select Issues" to choose issues.',s.style.color="#666")}}createActionButtons(e){const t=document.createElement("div");t.style.display="flex",t.style.gap="8px",t.style.marginBottom="8px";const s=document.createElement("button");s.id="select-issues-button",s.textContent="Select",s.style.padding="8px 12px",s.style.backgroundColor="#6c757d",s.style.color="white",s.style.border="none",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="background-color 0.2s ease",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.minWidth="80px",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#218838":"#5a6268"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#28a745":"#6c757d"})),s.onclick=()=>{if(this.uiManager&&this.uiManager.issueSelector)this.uiManager.issueSelector.isSelectingIssue?(this.uiManager.issueSelector.exitSelectionMode(),s.dataset.active="false",s.style.backgroundColor="#6c757d",s.textContent="Select"):(this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]),this.uiManager.issueSelector.startSelection(),s.dataset.active="true",s.style.backgroundColor="#28a745",s.textContent="Done");else{console.error("Issue selector not initialized");const e=document.getElementById("comment-status");e&&(e.textContent="Error: Issue selector not initialized.",e.style.color="#dc3545")}},t.appendChild(s);const n=document.createElement("button");n.textContent="Send",n.style.padding="8px 12px",n.style.backgroundColor="#1f75cb",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="14px",n.style.transition="background-color 0.2s ease",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flex="1",n.style.minWidth="80px",n.addEventListener("mouseenter",(()=>{n.style.backgroundColor="#1a63ac"})),n.addEventListener("mouseleave",(()=>{n.style.backgroundColor="#1f75cb"})),n.onclick=()=>this.submitComments(),t.appendChild(n),e.appendChild(t)}clearSelectedIssues(){this.selectedIssues=[],this.selectionDisplay&&this.selectionDisplay.setSelectedIssues([]);const e=document.getElementById("comment-status");e&&(e.textContent="Selection cleared.",e.style.color="#666"),this.notification&&this.notification.info("Selection cleared")}setSelectedIssue(e){this.setSelectedIssues(e?[e]:[])}render(){const e=document.getElementById("bulk-comments-content");e&&(e.innerHTML="",this.addCommentSection(e),this.commandShortcuts?(this.initializeAllShortcuts(),this.isLoading=!0,this.labelManager&&"function"==typeof this.labelManager.fetchAllLabels?this.labelManager.fetchAllLabels().then((e=>{this.addLabelShortcut(),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")})).catch((e=>{console.error("Error loading labels:",e),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")})):(console.warn("Label manager not available, using fallback labels"),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab"))):(console.error("Command shortcuts not initialized"),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")))}addCommentSection(e){const t=document.createElement("div");t.classList.add("api-section"),t.style.marginBottom="15px",t.style.padding="10px",t.style.backgroundColor="#f5f5f5",t.style.borderRadius="8px",t.style.border="1px solid #e0e0e0",this.selectionDisplay.createSelectionContainer(t),this.createCommentInput(t),this.createActionButtons(t),this.createStatusElements(t),this.isLoading=!0,this.showLoadingState();try{this.commentInput&&this.commandShortcuts?(this.initializeAllShortcuts(),this.addLabelShortcut([{value:"",label:"Loading labels..."}]),this.labelManager&&"function"==typeof this.labelManager.fetchAllLabels?this.labelManager.fetchAllLabels().then((e=>{this.addLabelShortcut(),this.isLoading=!1,this.hideLoadingState()})).catch((e=>{console.error("Error loading labels:",e),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState()})):(console.warn("Label manager not available, using fallback labels"),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState())):(console.error("Textarea or command shortcuts not initialized"),this.isLoading=!1,this.hideLoadingState())}catch(e){console.error("Error initializing shortcuts:",e),this.isLoading=!1,this.hideLoadingState()}e.appendChild(t)}getFallbackLabels(){return[{value:"",label:"Add Label"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"documentation",label:"Documentation"},{value:"custom",label:"Custom..."}]}createCommentInput(e){const t=document.createElement("div");t.id="shortcuts-wrapper",t.style.width="100%",t.style.marginBottom="15px",t.style.minHeight="120px",t.style.position="relative";const s=document.createElement("div");s.style.opacity="0.4",s.style.pointerEvents="none",["Estimate","Label","Milestone","Assign"].forEach((e=>{const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="8px",t.style.height="36px",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="6px 10px";const n=document.createElement("div");n.textContent=`/${e.toLowerCase()}`,n.style.fontWeight="bold",n.style.minWidth="100px";const i=document.createElement("div");i.style.flex="1",i.style.height="24px",i.style.backgroundColor="#eee",i.style.marginLeft="10px",i.style.borderRadius="4px",t.appendChild(n),t.appendChild(i),s.appendChild(t)})),t.appendChild(s),e.appendChild(t);const n=document.createElement("textarea");n.id="issue-comment-input",n.placeholder="Enter your comment here...",n.style.width="100%",n.style.padding="8px",n.style.marginBottom="12px",n.style.borderRadius="4px",n.style.border="1px solid #ccc",n.style.minHeight="60px",n.style.fontSize="14px",n.style.transition="border-color 0.2s ease",n.style.resize="vertical",n.style.boxSizing="border-box",n.addEventListener("focus",(()=>{n.style.borderColor="#1f75cb",n.style.outline="none",n.style.boxShadow="0 0 0 2px rgba(31, 117, 203, 0.2)"})),n.addEventListener("blur",(()=>{n.style.borderColor="#ccc",n.style.boxShadow="none"})),e.appendChild(n),this.commentInput=n;try{"function"==typeof CommandShortcut?(this.commandShortcuts=new CommandShortcut({targetElement:n,onShortcutInsert:(e,t)=>{}}),this.commandShortcuts.initialize(t),s.parentNode===t&&t.removeChild(s)):console.error("CommandShortcut class not available")}catch(e){console.error("Error initializing CommandShortcut:",e)}}insertTextAtCursor(e,t){if(!e)return;const s=e.value,n=e.selectionStart,i=e.selectionEnd;let o=t;n>0&&"\n"!==s.charAt(n-1)&&s.length>0&&(o="\n"+o),e.value=s.substring(0,n)+o+s.substring(i);const a=n+o.length;e.setSelectionRange(a,a),e.focus()}createStatusElements(e){const t=document.createElement("div");t.id="comment-status",t.style.fontSize="13px",t.style.marginTop="10px",t.style.padding="8px 12px",t.style.borderRadius="4px",t.style.backgroundColor="#f8f9fa",t.style.border="1px solid #e9ecef",t.style.textAlign="center",t.style.color="#666",t.textContent="Loading shortcuts...",e.appendChild(t);const s=document.createElement("div");s.id="comment-progress-container",s.style.display="none",s.style.marginTop="15px",s.style.padding="10px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="4px",s.style.border="1px solid #e9ecef";const n=document.createElement("div");n.id="comment-progress-label",n.textContent="Submitting comments...",n.style.fontSize="13px",n.style.marginBottom="8px",n.style.textAlign="center",n.style.fontWeight="bold",s.appendChild(n);const i=document.createElement("div");i.style.height="12px",i.style.backgroundColor="#e9ecef",i.style.borderRadius="6px",i.style.overflow="hidden",i.style.boxShadow="inset 0 1px 3px rgba(0,0,0,0.1)";const o=document.createElement("div");o.id="comment-progress-bar",o.style.height="100%",o.style.width="0%",o.style.backgroundColor="#1f75cb",o.style.transition="width 0.3s ease",i.appendChild(o),s.appendChild(i),e.appendChild(s)}showLoadingState(){const e=document.getElementById("comment-status");e&&(e.textContent="Loading shortcuts...",e.style.color="#1f75cb",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef"),this.commandShortcuts&&!this.commandShortcuts.shortcuts?.label&&this.addLabelShortcut([{value:"",label:"Loading labels..."}]),this.commandShortcuts&&!this.commandShortcuts.shortcuts?.milestone&&this.addMilestoneShortcut(),this.commandShortcuts&&!this.commandShortcuts.shortcuts?.assign&&this.addAssignShortcut(),this.commentInput&&(this.commentInput.disabled=!0,this.commentInput.style.backgroundColor="#f9f9f9")}hideLoadingState(){const e=document.getElementById("comment-status");if(e){const t=this.selectedIssues.length;t>0?(e.textContent=`${t} issue${1!==t?"s":""} selected.`,e.style.color="#28a745",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef"):(e.textContent="Select issues to add comments.",e.style.color="#666",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef")}const t=document.getElementById("issue-comment-input");t&&(t.disabled=!1,t.style.opacity="1",t.style.cursor="text");document.querySelectorAll(".api-section button").forEach((e=>{e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"}))}async submitComments(){if(!this.commentInput)return void this.notification.error("Comment input not found");const t=document.getElementById("comment-status"),s=document.getElementById("comment-progress-container"),n=document.getElementById("comment-progress-bar"),i=document.getElementById("comment-progress-label");if(0===this.selectedIssues.length)return this.notification.error("No issues selected"),void(t&&(t.textContent="Error: No issues selected.",t.style.color="#dc3545"));const o=this.commentInput.value.trim();if(!o)return this.notification.error("Comment cannot be empty"),void(t&&(t.textContent="Error: Comment cannot be empty.",t.style.color="#dc3545"));let a;if(this.uiManager&&this.uiManager.addLoadingScreen){const t=document.getElementById("assignee-time-summary");if(t){const s=e.getComputedStyle(t).position;"static"===s&&(t.style.position="relative",t.dataset.originalPosition=s),a=this.uiManager.addLoadingScreen(t,"comment-submit",`Sending comments to ${this.selectedIssues.length} issues...`)}}t&&(t.textContent=`Submitting comments to ${this.selectedIssues.length} issues...`,t.style.color="#1f75cb"),s&&(s.style.display="block"),n&&(n.style.width="0%");const l=Array.from(document.querySelectorAll("button")).find((e=>e.textContent&&e.textContent.includes("Send")));l&&(l.disabled=!0,l.style.opacity="0.7",l.style.cursor="not-allowed");let r=0,d=0;const gitlabApi=this.gitlabApi||e.gitlabApi||this.uiManager&&this.uiManager.gitlabApi;if(!gitlabApi)return this.notification.error("GitLab API not available"),t&&(t.textContent="Error: GitLab API not available.",t.style.color="#dc3545"),l&&(l.disabled=!1,l.style.opacity="1",l.style.cursor="pointer"),s&&(s.style.display="none"),void(this.uiManager&&this.uiManager.removeLoadingScreen&&a&&this.uiManager.removeLoadingScreen("comment-submit"));for(let e=0;e<this.selectedIssues.length;e++){const t=this.selectedIssues[e];if(!t){d++;continue}const s=Math.round(e/this.selectedIssues.length*100);n&&(n.style.width=`${s}%`),i&&(i.textContent=`Processing ${e+1} of ${this.selectedIssues.length} issues...`),this.uiManager&&this.uiManager.updateLoadingMessage&&this.uiManager.updateLoadingMessage("comment-submit",`Sending comment to issue #${t.iid||e+1} (${e+1}/${this.selectedIssues.length})...`);try{await gitlabApi.addComment(t,o),r++}catch(e){console.error(`Failed to add comment to issue #${t.iid}:`,e),d++}}n&&(n.style.width="100%"),l&&(l.disabled=!1,l.style.opacity="1",l.style.cursor="pointer"),r===this.selectedIssues.length?(t&&(t.textContent=`Successfully added comment to all ${r} issues!`,t.style.color="#28a745"),this.notification.success(`Added comment to ${r} issues`),this.commentInput&&(this.commentInput.value=""),setTimeout((()=>{s&&(s.style.display="none")}),2e3),this.uiManager&&this.uiManager.issueSelector&&this.uiManager.issueSelector.isSelectingIssue&&this.uiManager.issueSelector.exitSelectionMode(),setTimeout((()=>{this.clearSelectedIssues(),t&&(t.textContent="")}),3e3),setTimeout((()=>{this.refreshBoard()}),1e3)):(t&&(t.textContent=`Added comment to ${r} issues, failed for ${d} issues.`,t.style.color=r>0?"#ff9900":"#dc3545"),r>0?(this.notification.warning(`Added comment to ${r} issues, failed for ${d}`),setTimeout((()=>{this.refreshBoard()}),1e3)):this.notification.error(`Failed to add comments to all ${d} issues`),n&&(n.style.backgroundColor=r>0?"#ff9900":"#dc3545"))}addLabelShortcut(e){if(this.commandShortcuts)try{let t,s=null;if(this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(s=this.commandShortcuts.shortcuts.label.dropdown.value),e)t=e;else if(this.labelManager&&this.labelManager.filteredLabels&&this.labelManager.filteredLabels.length){t=[{value:"",label:"Add Label"}];const e=this.labelManager.filteredLabels.map((e=>({value:e.name,label:e.name})));t=t.concat(e),t.push({value:"custom",label:"Custom..."})}else try{const e=getLabelWhitelist();if(e&&e.length>0){t=[{value:"",label:"Add Label"}];const s=e.map((e=>({value:e,label:e})));t=t.concat(s),t.push({value:"custom",label:"Custom..."})}else t=this.getFallbackLabels()}catch(e){console.error("Error getting label whitelist:",e),t=this.getFallbackLabels()}this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.removeShortcut("label"),this.commandShortcuts.addCustomShortcut({type:"label",label:"/label",items:t,onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter custom label name:");if(!t)return;e=t}const t=document.getElementById("issue-comment-input");if(!t)return;const s=`/label ~"${e}"`;this.insertTextAtCursor(t,s),this.notification.info(`Label added: ${e}`)}}),s&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(this.commandShortcuts.shortcuts.label.dropdown.value=s)}catch(e){console.error("Error adding label shortcut:",e)}}refreshBoard(){e.location.reload()}},e.UIManager=class UIManager{constructor(){this.gitlabApi=e.gitlabApi,this.container=null,this.contentWrapper=null,this.headerDiv=null,this.header=null,this.recalculateBtn=null,this.collapseBtn=null,this.boardStats=null,this.initializeManagers(),this.tabManager=new TabManager(this),this.summaryView=new SummaryView(this),this.boardsView=new BoardsView(this),this.historyView=new HistoryView(this),this.bulkCommentsView=new BulkCommentsView(this),this.issueSelector=new IssueSelector({uiManager:this,onSelectionChange:e=>{this.bulkCommentsView&&this.bulkCommentsView.setSelectedIssues(e)}})}initialize(e=document.body){if(document.getElementById("assignee-time-summary"))return this.container=document.getElementById("assignee-time-summary"),this.contentWrapper=document.getElementById("assignee-time-summary-wrapper"),void(this.container.style.position="relative");this.container=document.createElement("div"),this.container.id="assignee-time-summary",this.container.style.position="fixed",this.container.style.bottom="15px",this.container.style.right="15px",this.container.style.backgroundColor="white",this.container.style.border="1px solid #ddd",this.container.style.borderRadius="4px",this.container.style.padding="10px",this.container.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)",this.container.style.zIndex="100",this.container.style.maxHeight="80vh",this.container.style.overflow="hidden",this.container.style.fontSize="14px",this.container.style.width="400px",this.container.style.transition="height 0.3s ease-in-out",this.contentWrapper=document.createElement("div"),this.contentWrapper.id="assignee-time-summary-wrapper",this.contentWrapper.style.display="block",this.contentWrapper.style.maxHeight="70vh",this.contentWrapper.style.minHeight="350px",this.contentWrapper.style.overflowY="auto",this.contentWrapper.style.position="relative",this.createHeader(),this.createBoardStats(),this.tabManager.initialize(this.contentWrapper),this.ensureTabContentHeight(),this.container.appendChild(this.contentWrapper),e.appendChild(this.container),this.attachmentElement=e,this.container.addEventListener("click",(e=>{!this.issueSelector||!this.issueSelector.isSelectingIssue||e.target.classList.contains("card-selection-overlay")||e.target.classList.contains("selection-badge")||e.target.closest("#bulk-comments-content button")||e.target.closest("#issue-comment-input")||e.target.closest("#shortcuts-wrapper")||e.target.closest("#selected-issues-list")||e.target.closest("#selection-cancel-button")||this.issueSelector.exitSelectionMode()}));try{"true"===loadFromStorage("gitlabTimeSummaryCollapsed","false")&&(this.contentWrapper.style.display="none",this.collapseBtn&&(this.collapseBtn.textContent="▲"),this.container.style.height="auto")}catch(e){console.warn("Error loading collapsed state:",e)}}initializeManagers(){try{this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.bulkCommentsView&&this.bulkCommentsView.addLabelShortcut&&this.bulkCommentsView.addLabelShortcut()}})}catch(e){console.error("Error initializing LabelManager:",e),this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([]),isLabelInWhitelist:()=>!1}}try{this.assigneeManager=new AssigneeManager({gitlabApi:this.gitlabApi,onAssigneesChange:e=>{this.bulkCommentsView&&this.bulkCommentsView.addAssignShortcut&&this.bulkCommentsView.addAssignShortcut()}})}catch(e){console.error("Error initializing AssigneeManager:",e),this.assigneeManager={getAssigneeWhitelist:()=>[]}}try{this.milestoneManager=new MilestoneManager({gitlabApi:this.gitlabApi,onMilestonesLoaded:e=>{}})}catch(e){console.error("Error initializing MilestoneManager:",e),this.milestoneManager={milestones:[],fetchMilestones:()=>Promise.resolve([])}}}createHeader(){this.headerDiv=document.createElement("div"),this.headerDiv.style.display="flex",this.headerDiv.style.justifyContent="space-between",this.headerDiv.style.alignItems="center",this.headerDiv.style.marginBottom="5px",this.headerDiv.style.cursor="pointer",this.headerDiv.addEventListener("click",(e=>{e.target!==this.recalculateBtn&&e.target!==this.collapseBtn&&e.target!==this.settingsBtn&&this.toggleCollapse()})),this.header=document.createElement("h3"),this.header.id="assignee-time-summary-header",this.header.textContent="Summary",this.header.style.margin="0",this.header.style.fontSize="16px";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",this.recalculateBtn=document.createElement("button"),this.recalculateBtn.textContent="🔄",this.recalculateBtn.title="Recalculate",this.recalculateBtn.style.padding="3px 6px",this.recalculateBtn.style.fontSize="12px",this.recalculateBtn.style.backgroundColor="#1f75cb",this.recalculateBtn.style.color="white",this.recalculateBtn.style.border="none",this.recalculateBtn.style.borderRadius="3px",this.recalculateBtn.style.cursor="pointer",this.recalculateBtn.onclick=t=>{t.stopPropagation(),"function"==typeof e.updateSummary&&e.updateSummary(!0),this.recalculateBtn.textContent="✓",setTimeout((()=>{this.recalculateBtn.textContent="🔄"}),1e3)},this.settingsBtn=document.createElement("button"),this.settingsBtn.textContent="⚙️",this.settingsBtn.title="Settings",this.settingsBtn.style.padding="3px 6px",this.settingsBtn.style.fontSize="12px",this.settingsBtn.style.backgroundColor="#6c757d",this.settingsBtn.style.color="white",this.settingsBtn.style.border="none",this.settingsBtn.style.borderRadius="3px",this.settingsBtn.style.cursor="pointer",this.settingsBtn.onclick=e=>{e.stopPropagation(),this.openSettings()},this.collapseBtn=document.createElement("button"),this.collapseBtn.textContent="▼",this.collapseBtn.title="Collapse/Expand",this.collapseBtn.style.padding="3px 6px",this.collapseBtn.style.fontSize="12px",this.collapseBtn.style.backgroundColor="#777",this.collapseBtn.style.color="white",this.collapseBtn.style.border="none",this.collapseBtn.style.borderRadius="3px",this.collapseBtn.style.cursor="pointer",this.collapseBtn.onclick=e=>{e.stopPropagation(),this.toggleCollapse()},t.appendChild(this.recalculateBtn),t.appendChild(this.settingsBtn),t.appendChild(this.collapseBtn),this.headerDiv.appendChild(this.header),this.headerDiv.appendChild(t),this.container.appendChild(this.headerDiv)}createBoardStats(){const e=document.getElementById("board-stats-summary");e?this.boardStats=e:(this.boardStats=document.createElement("div"),this.boardStats.id="board-stats-summary",this.boardStats.style.fontSize="13px",this.boardStats.style.color="#555",this.boardStats.style.marginBottom="10px",this.boardStats.style.display="flex",this.boardStats.style.justifyContent="space-between",this.boardStats.textContent="Loading board statistics...",this.container.appendChild(this.boardStats))}updateBoardStats(e){if(!this.boardStats)return;const t=e?.totalCards||0,s=e?.withTimeCards||0,n=e?.closedCards||0;this.boardStats.innerHTML="";const i=document.createElement("div");i.style.display="flex",i.style.gap="8px";const o=document.createElement("span");o.textContent=`Total: ${t} cards`,i.appendChild(o);const a=document.createElement("span");a.textContent=`(${s} with time)`,a.style.color="#777",i.appendChild(a);const l=document.createElement("div");l.textContent=`Closed: ${n} cards`,l.style.color="#28a745",this.boardStats.appendChild(i),this.boardStats.appendChild(l)}toggleCollapse(){if(this.contentWrapper&&this.collapseBtn)try{"none"===this.contentWrapper.style.display?(this.contentWrapper.style.display="block",this.collapseBtn.textContent="▼",this.container.style.height="",saveToStorage("gitlabTimeSummaryCollapsed","false")):(this.contentWrapper.style.display="none",this.collapseBtn.textContent="▲",this.container.style.height="auto",saveToStorage("gitlabTimeSummaryCollapsed","true"))}catch(e){console.error("Error toggling collapse state:",e)}}openSettings(){try{if("function"==typeof e.SettingsManager){new e.SettingsManager({labelManager:this.labelManager,assigneeManager:this.assigneeManager,gitlabApi:this.gitlabApi,onSettingsChanged:e=>{"all"!==e&&"labels"!==e||this.bulkCommentsView&&this.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||this.bulkCommentsView&&this.bulkCommentsView.addAssignShortcut()}}).openSettingsModal()}else console.error("SettingsManager not available")}catch(e){console.error("Error opening settings:",e)}}updateHeader(e){this.header&&(this.header.innerHTML=e)}showLoading(e="Loading..."){let t=document.getElementById("assignee-time-summary-loading");if(t){const s=t.querySelector('div:not([style*="animation"])');s&&(s.textContent=e),t.style.display="flex"}else{t=document.createElement("div"),t.id="assignee-time-summary-loading",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="101",t.style.flexDirection="column";const s="40px",n=`\n            <div style="width: ${s}; height: ${s}; border: 3px solid rgba(255, 255, 255, 0.2); \n                        border-top: 3px solid #ffffff; border-radius: 50%; \n                        animation: spin 1s linear infinite;"></div>\n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            </style>\n        `;t.innerHTML=n;const i=document.createElement("div");i.textContent=e,i.style.marginTop="10px",i.style.fontWeight="bold",i.style.color="#ffffff",i.style.maxWidth="90%",i.style.textAlign="center",i.style.padding="0 20px",t.appendChild(i),this.container.style.position="relative",this.container.appendChild(t)}}hideLoading(){const e=document.getElementById("assignee-time-summary-loading");e&&(e.style.display="none")}showErrorMessage(e){let t=document.getElementById("assignee-time-summary-error");if(t){const s=t.querySelector("div");s&&(s.textContent=e),t.style.display="flex"}else{t=document.createElement("div"),t.id="assignee-time-summary-error",t.style.margin="10px 0",t.style.padding="10px",t.style.backgroundColor="#f8d7da",t.style.color="#721c24",t.style.borderRadius="4px",t.style.border="1px solid #f5c6cb",t.style.fontSize="14px",t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center";const s=document.createElement("div");s.textContent=e,t.appendChild(s);const n=document.createElement("button");n.innerHTML="&times;",n.style.background="none",n.style.border="none",n.style.fontSize="20px",n.style.cursor="pointer",n.style.color="#721c24",n.style.fontWeight="bold",n.onclick=()=>{t.remove()},t.appendChild(n),this.contentWrapper&&this.contentWrapper.insertBefore(t,this.contentWrapper.firstChild)}setTimeout((()=>{t&&t.parentNode&&t.remove()}),1e4)}addLoadingScreen(t,s,n="Loading..."){if("string"==typeof t&&(t=document.getElementById(t)),!t)return console.warn(`Container not found for loading screen: ${s}`),null;const i=document.getElementById(`loading-screen-${s}`);if(i){const e=i.querySelector(".loading-message");return e&&(e.textContent=n),i}const o=document.createElement("div");o.id=`loading-screen-${s}`,o.className="gitlab-helper-loading-screen",o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="rgba(0, 0, 0, 0.5)",o.style.display="flex",o.style.flexDirection="column",o.style.justifyContent="center",o.style.alignItems="center",o.style.zIndex="101",o.style.transition="opacity 0.3s ease";const a=document.createElement("div");a.className="loading-spinner",a.style.width="40px",a.style.height="40px",a.style.borderRadius="50%",a.style.border="3px solid rgba(255, 255, 255, 0.2)",a.style.borderTopColor="#ffffff",a.style.animation="gitlab-helper-spin 1s linear infinite";const l=document.createElement("div");if(l.className="loading-message",l.textContent=n,l.style.marginTop="15px",l.style.fontWeight="bold",l.style.color="#ffffff",l.style.fontSize="14px",l.style.textAlign="center",l.style.padding="0 20px",l.style.maxWidth="90%",!document.getElementById("gitlab-helper-loading-styles")){const e=document.createElement("style");e.id="gitlab-helper-loading-styles",e.textContent="\n        @keyframes gitlab-helper-spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        @keyframes gitlab-helper-pulse {\n            0% { opacity: 0.6; }\n            50% { opacity: 1; }\n            100% { opacity: 0.6; }\n        }\n    ",document.head.appendChild(e)}o.appendChild(a),o.appendChild(l);const r=e.getComputedStyle(t).position;return"static"!==r&&r||(t.style.position="relative",t.dataset.originalPosition=r),t.appendChild(o),l.style.animation="gitlab-helper-pulse 2s ease infinite",o}removeLoadingScreen(e,t=!0){const s=document.getElementById(`loading-screen-${e}`);if(!s)return;const n=s.parentNode;t?(s.style.opacity="0",setTimeout((()=>{s.parentNode&&s.parentNode.removeChild(s),n&&n.dataset.originalPosition&&(n.style.position=n.dataset.originalPosition,delete n.dataset.originalPosition)}),300)):(s.parentNode.removeChild(s),n&&n.dataset.originalPosition&&(n.style.position=n.dataset.originalPosition,delete n.dataset.originalPosition))}updateLoadingMessage(e,t){const s=document.getElementById(`loading-screen-${e}`);if(!s)return;const n=s.querySelector(".loading-message");n&&(n.textContent=t)}ensureTabContentHeight(){const e=[document.getElementById("assignee-time-summary-content"),document.getElementById("boards-time-summary-content"),document.getElementById("history-time-summary-content"),document.getElementById("bulk-comments-content")],t=document.getElementById("assignee-time-summary-wrapper"),s=this.headerDiv||document.querySelector("#assignee-time-summary > div:first-child");if(!t||!s)return console.warn("Could not find wrapper or header elements for height calculation"),void e.forEach((e=>{e&&(e.style.minHeight="300px",e.style.position="relative")}));const n=s.offsetHeight+36+(this.boardStats?this.boardStats.offsetHeight:0)+20;e.forEach((e=>{e&&(e.style.minHeight=`calc(100% - ${n}px)`,e.style.height=`calc(100% - ${n}px)`,e.style.position="relative")}))}},e.uiManager=e.uiManager||new UIManager,e.createSummaryContainer=function createSummaryContainer(){return uiManager.initialize(),uiManager.container},e.updateSummaryTab=function updateSummaryTab(e,t,s,n,i,o,a){if("function"==typeof processBoards){const{closedBoardCards:e}=processBoards();uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:e||0})}uiManager.summaryView.render(e,t,s,n,i,o,a)},e.updateBoardsTab=function updateBoardsTab(e,t){uiManager.boardsView.render(e,t)},e.updateBulkCommentsTab=function updateBulkCommentsTab(){uiManager.bulkCommentsView.render()},e.renderHistory=function renderHistory(){uiManager.historyView.render()},e.addEventListener("scroll",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.uiManager=uiManager,e.updateSummaryTab=updateSummaryTab,e.updateBoardsTab=updateBoardsTab,e.updateBulkCommentsTab=updateBulkCommentsTab,e.renderHistory=renderHistory,e.createSummaryContainer=createSummaryContainer,e.SettingsManager=SettingsManager,setTimeout((()=>{const t=document.querySelector('#assignee-time-summary button[title="Settings"]');t?t.onclick=t=>{t.stopPropagation();try{new SettingsManager({labelManager:e.uiManager?.labelManager,assigneeManager:e.uiManager?.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:t=>{e.uiManager?.bulkCommentsView&&("all"!==t&&"labels"!==t||e.uiManager.bulkCommentsView.addLabelShortcut(),"all"!==t&&"assignees"!==t||e.uiManager.bulkCommentsView.addAssignShortcut())}}).openSettingsModal()}catch(e){console.error("Error creating settings manager:",e)}}:console.warn("Settings button not found")}),2e3);let a=!1;function checkAndInit(){a||e.location.href.includes("/boards")&&function waitForBoardsElement(e=30,t=500){return new Promise(((s,n)=>{let i=0;const checkForElement=()=>{i++;const n=document.querySelector('[data-testid="boards-list"]');if(n)return void s(n);const o=[".boards-list",".board-list-component",".boards-app"];for(const e of o){const t=document.querySelector(e);if(t)return void s(t)}if(i>=e)return console.warn("Maximum attempts reached, attaching to body as fallback"),void s(document.body);setTimeout(checkForElement,t)};checkForElement()}))}().then((e=>{createUIManager(e);a=!0,waitForBoards()})).catch((e=>{console.error("Error initializing UI:",e);createUIManager(document.body);a=!0,waitForBoards()}))}function updateSummary(t=!1){if(!e.uiManager)return void console.warn("UI Manager not initialized, cannot update summary");let s,n=!1;clearTimeout(s);try{const i=processBoards(),{assigneeTimeMap:o,boardData:a,boardAssigneeData:l,totalEstimate:r,cardsProcessed:d,cardsWithTime:c,currentMilestone:u,closedBoardCards:h}=i;clearTimeout(s),s=setTimeout((()=>{if(n=!0,n)try{saveHistoryEntry(r,u,t)}catch(e){console.error("Error saving history:",e)}}),3e3),e.uiManager.updateBoardStats({totalCards:d,withTimeCards:c,closedCards:h||0});const p=(r/3600).toFixed(1);e.uiManager.updateHeader(`Summary ${p}h`);const m=a||{},g=l||{};e.uiManager.summaryView&&e.uiManager.summaryView.render(o,r,d,c,u,m,g),e.uiManager.boardsView&&e.uiManager.boardsView.render(m,g);const y=document.getElementById("bulk-comments-content");y&&"block"===y.style.display&&e.uiManager.bulkCommentsView&&e.uiManager.bulkCommentsView.render()}catch(e){console.error("Error updating summary:",e)}}function addBoardChangeListeners(){try{document.querySelectorAll(".board-list").forEach((e=>{new MutationObserver((()=>{updateSummary()})).observe(e,{childList:!0,subtree:!0})}))}catch(e){console.error("Error adding board change listeners:",e)}}function waitForBoards(){if(e.boardsInitialized)return;let t=document.getElementById("board-stats-summary");if(!t)if(t=document.createElement("div"),t.id="board-stats-summary",t.style.fontSize="13px",t.style.color="#555",t.style.marginBottom="10px",e.uiManager?.container)e.uiManager.container.appendChild(t);else{const e=document.createElement("div");e.id="temp-stats-container",e.appendChild(t),document.body.appendChild(e)}t.textContent="Waiting for boards to load...";let s=0;const n=setInterval((()=>{s++;const i=document.querySelectorAll(".board-list");i.length>=3?(clearInterval(n),t&&(t.textContent=`Found ${i.length} boards, initializing...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners(),e.boardsInitialized=!0}),1e3)):s>=30?(clearInterval(n),t&&(t.textContent=`Found ${i.length} boards, continuing anyway...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners(),e.boardsInitialized=!0}),1e3)):i.length>0&&t&&(t.textContent=`Found ${i.length} boards, waiting for more...`)}),500)}function renderHistory(){try{e.uiManager?.historyView&&e.uiManager.historyView.render()}catch(e){console.error("Error rendering history:",e)}}checkAndInit();let l=e.location.href;try{new MutationObserver((()=>{e.location.href!==l&&(l=e.location.href,setTimeout(checkAndInit,1e3))})).observe(document,{subtree:!0,childList:!0})}catch(e){console.error("Error setting up URL observer:",e)}e.gitlabApi=e.gitlabApi||new GitLabAPI,e.updateSummary=updateSummary,e.checkAndInit=checkAndInit,e.waitForBoards=waitForBoards,e.renderHistory=renderHistory,e.SettingsManager=SettingsManager,e.LabelManager=LabelManager,e.AssigneeManager=AssigneeManager,e.addEventListener("scroll",(()=>{e.uiManager?.issueSelector&&"function"==typeof e.uiManager.issueSelector.repositionOverlays&&e.uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{e.uiManager?.issueSelector&&"function"==typeof e.uiManager.issueSelector.repositionOverlays&&e.uiManager.issueSelector.repositionOverlays()})),function(){"use strict"}()}(window);