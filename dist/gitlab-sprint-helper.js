// ==UserScript==
// @name         GitLab Sprint Helper
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Display a summary of assignees' time estimates on GitLab boards with API integration and comment shortcuts
// @author       You
// @match        https://gitlab.com/*/boards/*
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-idle
// @updateURL    https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// @downloadURL  https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// ==/UserScript==

!function(e){function processBoards(){const e={},t={},s={};let n=0,o=0,l=0,a=null,i=0;return document.querySelectorAll(".board-list").forEach(((r,c)=>{let d="Unknown";try{if(r.__vue__&&r.__vue__.$children&&r.__vue__.$children.length>0){const e=r.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(d=e.$props.list.title)}if("Unknown"===d){const e=r.querySelector(".board-title-text");e&&(d=e.textContent.trim())}}catch(e){console.error("Error getting board title:",e);const t=r.querySelector(".board-title-text");t&&(d=t.textContent.trim())}if("Unknown"===d)return;{t[d]||(t[d]={tickets:0,timeEstimate:0}),s[d]||(s[d]={});const e=d.toLowerCase();e.includes("done")||e.includes("closed")||e.includes("complete")||e.includes("finished")}const u=r.querySelectorAll(".board-card"),p=d.toLowerCase();(p.includes("done")||p.includes("closed")||p.includes("complete")||p.includes("finished"))&&(i+=u.length),u.forEach((i=>{try{if(o++,t[d].tickets++,i.__vue__&&i.__vue__.$children){const o=i.__vue__.$children.find((e=>e.$props&&e.$props.item&&void 0!==e.$props.item.timeEstimate));if(o&&o.$props){const i=o.$props;if(!a&&i.item&&i.item.milestone&&(a=i.item.milestone.title),i.item&&i.item.timeEstimate){l++;const o=i.item.timeEstimate;n+=o,t[d].timeEstimate+=o;let a=[];i.item.assignees&&i.item.assignees.nodes&&i.item.assignees.nodes.length?a=i.item.assignees.nodes:i.item.assignees&&i.item.assignees.length>0&&(a=i.item.assignees),a.length>0?a.forEach((t=>{const n=o/a.length,l=t.name;e[l]||(e[l]=0),e[l]+=n,s[d][l]||(s[d][l]={tickets:0,timeEstimate:0}),s[d][l].tickets++,s[d][l].timeEstimate+=n})):(e.Unassigned||(e.Unassigned=0),e.Unassigned+=o,s[d].Unassigned||(s[d].Unassigned={tickets:0,timeEstimate:0}),s[d].Unassigned.tickets++,s[d].Unassigned.timeEstimate+=o)}}}}catch(e){console.error("Error processing card:",e)}}))})),{assigneeTimeMap:e,boardData:t,boardAssigneeData:s,totalEstimate:n,cardsProcessed:o,cardsWithTime:l,currentMilestone:a,closedBoardCards:i}}function getHistoryKey(){return`timeEstimateHistory_${function getCurrentUrlKey(){return e.location.href.split("#")[0]}()}`}function renderHistory(){const t=document.getElementById("history-time-summary-content");if(!t)return;t.innerHTML="";const s=getHistoryKey(),n=GM_getValue(s,[]),o=document.createElement("div");o.style.fontSize="12px",o.style.color="#666",o.style.marginBottom="10px",o.style.wordBreak="break-all";let l=e.location.href;if(l.length>60&&(l=l.substring(0,57)+"..."),t.appendChild(o),0===n.length){const e=document.createElement("p");return e.textContent="No history data available for this URL yet.",e.style.color="#666",void t.appendChild(e)}const a=document.createElement("button");a.textContent="Clear History",a.style.padding="3px 6px",a.style.fontSize="12px",a.style.backgroundColor="#dc3545",a.style.color="white",a.style.border="none",a.style.borderRadius="3px",a.style.cursor="pointer",a.style.marginBottom="10px",a.onclick=function(){confirm("Are you sure you want to clear history data for this URL?")&&(GM_setValue(s,[]),renderHistory())},t.appendChild(a);const i=document.createElement("table");i.style.width="100%",i.style.borderCollapse="collapse";const r=document.createElement("tr");r.style.borderBottom="2px solid #ddd",r.style.fontWeight="bold";const c=document.createElement("th");c.textContent="Date",c.style.textAlign="left",c.style.padding="5px 0";const d=document.createElement("th");d.textContent="Hours",d.style.textAlign="right",d.style.padding="5px 0";const u=document.createElement("th");u.textContent="Milestone",u.style.textAlign="left",u.style.padding="5px 0",r.appendChild(c),r.appendChild(d),r.appendChild(u),i.appendChild(r),n.slice().reverse().forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid #eee";const s=document.createElement("td"),n=new Date(e.timestamp);s.textContent=n.toLocaleDateString()+" "+n.toLocaleTimeString().substring(0,5),s.style.padding="5px 0";const o=document.createElement("td");o.textContent=`${e.totalHours}h`,o.style.textAlign="right",o.style.padding="5px 0";const l=document.createElement("td");l.textContent=e.milestone,l.style.padding="5px 0",t.appendChild(s),t.appendChild(o),t.appendChild(l),i.appendChild(t)})),t.appendChild(i)}function createSummaryContainer(){return uiManager.initialize(),uiManager.container}function renderHistory(){uiManager.historyView.render()}e.GitLabAPI=e.GitLabAPI||class GitLabAPI{constructor(){this.csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),this.baseUrl="/api/v4"}callGitLabApi(e,t={}){const{method:s="GET",data:n=null,params:o=null}=t;let l=`${this.baseUrl}/${e}`;if(o){const e=new URLSearchParams;Object.entries(o).forEach((([t,s])=>{null!=s&&e.append(t,s)}));const t=e.toString();t&&(l+=`?${t}`)}const a={method:s,headers:{"Content-Type":"application/json"},credentials:"same-origin"};return"GET"!==s&&this.csrfToken&&(a.headers["X-CSRF-Token"]=this.csrfToken),n&&["POST","PUT","PATCH"].includes(s)&&(a.body=JSON.stringify(n)),fetch(l,a).then((e=>{if(!e.ok)throw new Error(`API request failed: ${e.status} ${e.statusText}`);return e.json()}))}getIssue(e){const t=e.referencePath.split("#")[0],s=e.iid,n=encodeURIComponent(t);return this.callGitLabApi(`projects/${n}/issues/${s}`)}addComment(e,t){const s=e.referencePath.split("#")[0],n=e.iid,o=encodeURIComponent(s);return this.callGitLabApi(`projects/${o}/issues/${n}/notes`,{method:"POST",data:{body:t}})}getCurrentUser(){return this.callGitLabApi("user")}getProject(e){return this.callGitLabApi(`projects/${e}`)}getProjectIssues(e,t={}){return this.callGitLabApi(`projects/${e}/issues`,{params:t})}getMilestone(e,t){return this.callGitLabApi(`projects/${e}/milestones/${t}`)}updateIssue(e,t){const s=e.referencePath.split("#")[0],n=e.iid,o=encodeURIComponent(s);return this.callGitLabApi(`projects/${o}/issues/${n}`,{method:"PUT",data:t})}getIssueItemFromCard(e){try{if(e.__vue__&&e.__vue__.$children){const t=e.__vue__.$children.find((e=>e.$props&&e.$props.item));if(t&&t.$props&&t.$props.item)return t.$props.item}}catch(e){console.error("Error getting issue item from card:",e)}return null}},e.gitlabApi=e.gitlabApi||new GitLabAPI,e.TabManager=e.TabManager||class TabManager{constructor(uiManager){this.uiManager=uiManager,this.tabContainer=null,this.tabs={},this.contentAreas={},this.currentTab="summary"}initialize(e){this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.marginBottom="10px",this.tabContainer.style.borderBottom="1px solid #ddd",this.createTab("summary","Summary",!0),this.createTab("boards","Boards"),this.createTab("history","History"),this.createTab("api","Bulk Actions"),e.appendChild(this.tabContainer),this.createContentAreas(e)}createTab(e,t,s=!1){const n=document.createElement("div");n.textContent=t,n.dataset.tab=e,n.style.padding="5px 10px",n.style.cursor="pointer",s&&(n.style.borderBottom="2px solid #1f75cb",n.style.fontWeight="bold",this.currentTab=e),n.addEventListener("click",(()=>{this.switchToTab(e)})),this.tabs[e]=n,this.tabContainer.appendChild(n)}createContentAreas(e){const t=document.createElement("div");t.id="assignee-time-summary-content",t.style.display="summary"===this.currentTab?"block":"none",e.appendChild(t),this.contentAreas.summary=t;const s=document.createElement("div");s.id="boards-time-summary-content",s.style.display="boards"===this.currentTab?"block":"none",e.appendChild(s),this.contentAreas.boards=s;const n=document.createElement("div");n.id="history-time-summary-content",n.style.display="history"===this.currentTab?"block":"none",e.appendChild(n),this.contentAreas.history=n;const o=document.createElement("div");o.id="api-info-content",o.style.display="api"===this.currentTab?"block":"none",e.appendChild(o),this.contentAreas.api=o}switchToTab(e){Object.keys(this.tabs).forEach((e=>{this.tabs[e].style.borderBottom="none",this.tabs[e].style.fontWeight="normal",this.contentAreas[e].style.display="none"})),this.tabs[e].style.borderBottom="2px solid #1f75cb",this.tabs[e].style.fontWeight="bold",this.contentAreas[e].style.display="block",this.currentTab=e,"history"===e?renderHistory():"api"===e&&this.uiManager.apiView.render()}getContentArea(e){return this.contentAreas[e]}getCurrentTab(){return this.currentTab}},e.CommentShortcuts=e.CommentShortcuts||class CommentShortcuts{constructor(e){this.targetElement=e.targetElement,this.onShortcutInsert=e.onShortcutInsert||null,this.shortcutsContainer=null,this.shortcuts=[]}initialize(e){this.shortcutsContainer=document.createElement("div"),this.shortcutsContainer.className="comment-shortcuts-container",this.shortcutsContainer.style.marginBottom="10px",this.shortcutsContainer.style.display="flex",this.shortcutsContainer.style.flexWrap="wrap",this.shortcutsContainer.style.gap="8px",e.insertBefore(this.shortcutsContainer,this.targetElement),this.initializeEstimateShortcut()}initializeEstimateShortcut(){const e=document.createElement("div");e.className="shortcut-item estimate-shortcut",e.style.display="flex",e.style.alignItems="center";const t=document.createElement("span");t.textContent="/estimate",t.style.fontSize="13px",t.style.marginRight="5px",t.style.fontFamily="monospace",t.style.color="#555",e.appendChild(t);const s=document.createElement("select");s.className="estimate-dropdown",s.style.padding="3px 6px",s.style.borderRadius="3px",s.style.border="1px solid #ccc",s.style.backgroundColor="#f8f9fa",s.style.fontSize="12px";[{value:"",label:"Estimate Hours"},{value:"1",label:"1h"},{value:"2",label:"2h"},{value:"4",label:"4h"},{value:"8",label:"8h"},{value:"16",label:"16h"},{value:"32",label:"32h"},{value:"custom",label:"Custom..."}].forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,s.appendChild(t)})),s.addEventListener("change",(()=>{const e=s.value;e&&("custom"===e?this.handleCustomEstimate():this.insertEstimateText(e),s.value="")})),e.appendChild(s),this.shortcutsContainer.appendChild(e),this.shortcuts.push({type:"estimate",element:e})}handleCustomEstimate(){const e=prompt("Enter custom estimate hours (whole numbers only):","");if(null===e||""===e)return;const t=parseInt(e,10);isNaN(t)||t<=0||t!==parseFloat(e)?alert("Please enter a valid positive whole number."):this.insertEstimateText(t.toString())}insertEstimateText(e){if(!this.targetElement)return;const t=`/estimate ${e}h`,s=this.targetElement.value,n=/\/estimate\s+\d+h/g;if(n.test(s)){const e=s.replace(n,t);this.targetElement.value=e}else{const e=this.targetElement.selectionStart,n=this.targetElement.selectionEnd;let o=t;e>0&&"\n"!==s.charAt(e-1)&&s.length>0&&(o="\n"+o);const l=s.substring(0,e)+o+s.substring(n);this.targetElement.value=l;const a=e+o.length;this.targetElement.setSelectionRange(a,a)}this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert("estimate",e)}addCustomShortcut(e){const t=document.createElement("div");t.className=`shortcut-item ${e.type}-shortcut`,t.style.display="flex",t.style.alignItems="center";const s=document.createElement("span");s.textContent=e.label,s.style.fontSize="13px",s.style.marginRight="5px",s.style.fontFamily="monospace",s.style.color="#555",t.appendChild(s);const n=document.createElement("select");n.className=`${e.type}-dropdown`,n.style.padding="3px 6px",n.style.borderRadius="3px",n.style.border="1px solid #ccc",n.style.backgroundColor="#f8f9fa",n.style.fontSize="12px",e.items.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,n.appendChild(t)})),n.addEventListener("change",(()=>{const t=n.value;t&&"function"==typeof e.onSelect&&e.onSelect(t),n.value=""})),t.appendChild(n),this.shortcutsContainer.appendChild(t),this.shortcuts.push({type:e.type,element:t})}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const o=this.targetElement.value;if(s.test(o)){const e=o.replace(s,t);this.targetElement.value=e}else n();this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert(e,t)}},e.ShortcutManager=e.ShortcutManager||class ShortcutManager{constructor(e){this.apiTabView=e}addCustomShortcuts(){this.apiTabView.commentShortcuts&&(this.addMilestoneShortcut(),this.addDueDateShortcut(),this.addAssignShortcut())}addMilestoneShortcut(){this.apiTabView.commentShortcuts.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"%backlog",label:"Backlog"},{value:"none",label:"Remove Milestone"}],onSelect:e=>{const t=document.getElementById("issue-comment-input");if(!t)return;let s="/milestone ";"none"===e?s+='%""':e.startsWith("%")?s+=e:s+=`%"${e}"`;this.replaceOrInsertCommand(t,"milestone",s,/\/milestone\s+%[^\n]+/g,(()=>{const e=t.selectionStart,n=t.selectionEnd,o=t.value;let l=s;e>0&&"\n"!==o.charAt(e-1)&&o.length>0&&(l="\n"+l);const a=o.substring(0,e)+l+o.substring(n);t.value=a;const i=e+l.length;t.setSelectionRange(i,i)}))}})}addDueDateShortcut(){this.apiTabView.commentShortcuts.addCustomShortcut({type:"due",label:"/due",items:[{value:"",label:"Set Due Date"},{value:"today",label:"Today"},{value:"tomorrow",label:"Tomorrow"},{value:"week",label:"In 1 week"},{value:"month",label:"In 1 month"},{value:"custom",label:"Custom..."},{value:"none",label:"Remove Due Date"}],onSelect:e=>{const t=document.getElementById("issue-comment-input");if(!t)return;let s="/due ";if("none"===e)s+="none";else if("custom"===e){const e=prompt("Enter due date (format: YYYY-MM-DD):","");if(!e)return;s+=e}else if("today"===e)s+="today";else if("tomorrow"===e)s+="tomorrow";else if("week"===e){const e=new Date;e.setDate(e.getDate()+7),s+=this.formatDate(e)}else if("month"===e){const e=new Date;e.setMonth(e.getMonth()+1),s+=this.formatDate(e)}this.replaceOrInsertCommand(t,"due",s,/\/due\s+[^\n]+/g,(()=>{const e=t.selectionStart,n=t.selectionEnd,o=t.value;let l=s;e>0&&"\n"!==o.charAt(e-1)&&o.length>0&&(l="\n"+l);const a=o.substring(0,e)+l+o.substring(n);t.value=a;const i=e+l.length;t.setSelectionRange(i,i)}))}})}addAssignShortcut(){this.apiTabView.commentShortcuts.addCustomShortcut({type:"assign",label:"/assign",items:[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}],onSelect:e=>{const t=document.getElementById("issue-comment-input");if(!t)return;let s="/assign ";if("none"===e)s+="@none";else{if("@me"!==e)return;s+="@me"}this.replaceOrInsertCommand(t,"assign",s,/\/assign\s+@[^\n]+/g,(()=>{const e=t.selectionStart,n=t.selectionEnd,o=t.value;let l=s;e>0&&"\n"!==o.charAt(e-1)&&o.length>0&&(l="\n"+l);const a=o.substring(0,e)+l+o.substring(n);t.value=a;const i=e+l.length;t.setSelectionRange(i,i)}))}})}formatDate(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}replaceOrInsertCommand(e,t,s,n,o){if(!e)return;const l=e.value;if(n.test(l)){const t=l.replace(n,s);e.value=t,e.focus()}else o();this.apiTabView.commentShortcuts.onShortcutInsert&&this.apiTabView.commentShortcuts.onShortcutInsert(t,s)}},e.LabelManager=e.LabelManager||class LabelManager{constructor(e){this.apiTabView=e,this.defaultLabelWhitelist=["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"],this.labelWhitelist=this.loadSavedWhitelist()}loadSavedWhitelist(){const e=localStorage.getItem("gitLabHelperLabelWhitelist");if(e)try{return JSON.parse(e)}catch(e){return console.error("Error parsing saved whitelist:",e),[...this.defaultLabelWhitelist]}return[...this.defaultLabelWhitelist]}saveWhitelist(e){this.labelWhitelist=e,localStorage.setItem("gitLabHelperLabelWhitelist",JSON.stringify(e))}resetToDefaultWhitelist(){this.labelWhitelist=[...this.defaultLabelWhitelist],localStorage.setItem("gitLabHelperLabelWhitelist",JSON.stringify(this.defaultLabelWhitelist))}isLabelInWhitelist(e,t=this.labelWhitelist){const s=e.toLowerCase();return t.some((e=>s.includes(e.toLowerCase())))}getPathFromUrl(){try{console.log("Current URL:",e.location.href),console.log("Current pathname:",e.location.pathname);const t=e.location.pathname;if(t.includes("/groups/")&&t.includes("/-/boards")){const e=/\/groups\/([^\/]+(?:\/[^\/]+)*)\/?\-?\/?boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract group path from URL:",t),null;const n=s[1];console.log("Extracted group path:",n);const o=n.replace(/\/-$/,""),l=encodeURIComponent(o);console.log("Encoded group path for API:",l);const a=`groups/${l}/labels`;return console.log("Group API URL that will be used:",a),{path:o,encodedPath:l,type:"group",apiUrl:a}}if(t.includes("/-/boards")){const e=/^\/([^\/]+(?:\/[^\/]+)*)\/-\/boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract project path from URL pattern:",t),null;const n=s[1];console.log("Extracted project path:",n);const o=encodeURIComponent(n);console.log("Encoded project path for API:",o);const l=`projects/${o}/labels`;return console.log("Project API URL that will be used:",l),{path:n,encodedPath:o,type:"project",apiUrl:l}}return console.warn("Not on a GitLab boards page:",t),null}catch(e){return console.error("Error extracting path from URL:",e),null}}async fetchAllLabels(){try{const e=this.getPathFromUrl();return e?await gitlabApi.callGitLabApi(e.apiUrl,{params:{per_page:100}}).catch((t=>(console.error(`Error fetching ${e.type} labels from API:`,t),[]))):(console.warn("Path info not found, returning empty labels array"),[])}catch(e){return console.error("Error in fetchAllLabels:",e),[]}}safeInsertOrReplaceCommand(e,t,s){if(!e)return;const n=e.value;if(s.test(n))e.value=n.replace(s,t),e.focus();else{const s=e.selectionStart,o=e.selectionEnd;let l=t;s>0&&"\n"!==n.charAt(s-1)&&n.length>0&&(l="\n"+l),e.value=n.substring(0,s)+l+n.substring(o);const a=s+l.length;e.setSelectionRange(a,a),e.focus()}}createStyledLabel(e,t){const s=document.createElement("span");s.textContent=e;const n=t||this.getColorForLabel(e),o=this.getContrastColor(n);return s.style.backgroundColor=n,s.style.color=o,s.style.padding="4px 8px",s.style.borderRadius="100px",s.style.fontSize="12px",s.style.fontWeight="500",s.style.display="inline-block",s.style.margin="2px",s.style.maxWidth="100%",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",s}getColorForLabel(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return`hsl(${Math.abs(t)%360}, 70%, 75%)`}getContrastColor(t){if(t.startsWith("hsl")){const e=t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%\s*\)/);if(e&&e[1]){return parseInt(e[1],10)>60?"black":"white"}}let s=0,n=0,o=0;try{const l=document.createElement("div");l.style.backgroundColor=t,document.body.appendChild(l);const a=e.getComputedStyle(l).backgroundColor;document.body.removeChild(l);const i=a.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);i&&(s=parseInt(i[1],10),n=parseInt(i[2],10),o=parseInt(i[3],10))}catch(e){return t.startsWith("hsl")&&t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)?parseInt(t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)[1],10)>60?"black":"white":"black"}return(.299*s+.587*n+.114*o)/255>.5?"black":"white"}fetchAndAddLabels(){try{const e=this.getPathFromUrl();if(!e)return console.warn("Could not get path info, using fallback labels"),void this.addFallbackLabels();console.log(`About to call GitLab API for ${e.type} labels with URL:`,e.apiUrl),gitlabApi.callGitLabApi(e.apiUrl,{params:{per_page:100}}).then((e=>{if(console.log("API call succeeded, received labels:",e),!e||0===e.length)return console.warn("No labels found, using fallback labels"),void this.addFallbackLabels();const t=e.filter((e=>this.isLabelInWhitelist(e.name))).sort(((e,t)=>e.name.localeCompare(t.name))).map((e=>({value:e.name,label:e.name,color:e.color})));t.unshift({value:"",label:"Add Label"}),t.length>1?this.addLabelShortcut(t):(console.warn("No matching labels found after filtering, using fallback"),this.addFallbackLabels())})).catch((t=>{console.error(`Error fetching ${e.type} labels from API:`,t),console.error("API URL was:",e.apiUrl),this.addFallbackLabels()}))}catch(e){console.error("Error in fetchAndAddLabels:",e),this.addFallbackLabels()}}addFallbackLabels(){this.addLabelShortcut([{value:"",label:"Add Label"},{value:"bug",label:"Bug",color:"#d9534f"},{value:"feature",label:"Feature",color:"#428bca"},{value:"documentation",label:"Documentation",color:"#5cb85c"},{value:"enhancement",label:"Enhancement",color:"#5bc0de"},{value:"priority",label:"Priority",color:"#f0ad4e"}])}addLabelShortcut(e){if(!this.apiTabView.commentShortcuts)return;this.apiTabView.commentShortcuts.addCustomShortcut({type:"label",label:"/label",items:e,customOptionRenderer:e=>this.createStyledLabel(e.label,e.color),onSelect:e=>{const t=document.getElementById("issue-comment-input");if(!t)return;const s=`/label ~${e}`,n=/\/label\s+~[^\n]+/g;this.apiTabView.shortcutManager?this.apiTabView.shortcutManager.replaceOrInsertCommand(t,"label",s,n,(()=>{const e=t.selectionStart,n=t.selectionEnd,o=t.value;let l=s;e>0&&"\n"!==o.charAt(e-1)&&o.length>0&&(l="\n"+l);const a=o.substring(0,e)+l+o.substring(n);t.value=a;const i=e+l.length;t.setSelectionRange(i,i)})):this.safeInsertOrReplaceCommand(t,s,n)}})}},e.IssueSelectionDisplay=e.IssueSelectionDisplay||class IssueSelectionDisplay{constructor(e){this.apiTabView=e}createSelectionContainer(e){const t=document.createElement("div");t.style.marginBottom="12px",t.style.padding="8px",t.style.borderRadius="4px",t.style.border="1px dashed #ccc",t.style.backgroundColor="#f9f9f9",t.style.maxHeight="150px",t.style.overflowY="auto";const s=document.createElement("div");s.style.fontSize="12px",s.style.color="#666",s.style.marginBottom="5px",s.textContent="Selected Issues:",t.appendChild(s);const n=document.createElement("div");n.id="selected-issues-list",n.style.fontSize="14px";const o=document.createElement("div");o.id="no-issues-selected",o.textContent="No issues selected",o.style.color="#666",o.style.fontStyle="italic",n.appendChild(o),t.appendChild(n),e.appendChild(t)}updateDisplay(){const e=document.getElementById("selected-issues-list");if(!e)return;if(e.innerHTML="",!this.apiTabView.selectedIssues||0===this.apiTabView.selectedIssues.length){const t=document.createElement("div");t.id="no-issues-selected",t.textContent="No issues selected",t.style.color="#666",t.style.fontStyle="italic",e.appendChild(t);const s=e.parentElement;return void(s&&(s.style.borderColor="#ccc",s.style.backgroundColor="#f9f9f9"))}const t=e.parentElement;t&&(t.style.borderColor="#1f75cb",t.style.backgroundColor="rgba(31, 117, 203, 0.05)"),this.apiTabView.selectedIssues.forEach(((t,s)=>{const n=document.createElement("div");n.className="selected-issue-item",n.style.padding="5px",n.style.marginBottom="3px",n.style.borderRadius="3px",n.style.backgroundColor="rgba(31, 117, 203, 0.1)",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center";const o=document.createElement("div");o.innerHTML=`<strong>#${t.iid}</strong> - ${t.title}`,o.style.overflow="hidden",o.style.textOverflow="ellipsis",o.style.whiteSpace="nowrap",o.style.marginRight="5px",n.appendChild(o);const l=document.createElement("button");l.textContent="×",l.style.backgroundColor="transparent",l.style.border="none",l.style.color="#dc3545",l.style.fontSize="16px",l.style.fontWeight="bold",l.style.cursor="pointer",l.style.padding="0 5px",l.title="Remove this issue",l.addEventListener("mouseenter",(()=>{l.style.color="#c82333"})),l.addEventListener("mouseleave",(()=>{l.style.color="#dc3545"})),l.onclick=e=>{e.stopPropagation(),this.removeIssue(s)},n.appendChild(l),e.appendChild(n)}))}removeIssue(e){this.apiTabView.selectedIssues.splice(e,1),this.updateDisplay();const t=document.getElementById("comment-status");if(t){const e=this.apiTabView.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected.`,t.style.color="green"):(t.textContent='No issues selected. Click "Select Issues" to choose issues.',t.style.color="#666")}}},e.SettingsManager=e.SettingsManager||class SettingsManager{constructor(e){this.apiTabView=e}addSettingsButton(e){const t=document.createElement("button");t.textContent="⚙️ Settings",t.style.padding="6px 10px",t.style.backgroundColor="#6c757d",t.style.color="white",t.style.border="none",t.style.borderRadius="4px",t.style.cursor="pointer",t.style.fontSize="12px",t.style.marginTop="10px",t.style.display="flex",t.style.alignItems="center",t.style.marginLeft="auto",t.addEventListener("mouseenter",(()=>{t.style.backgroundColor="#5a6268"})),t.addEventListener("mouseleave",(()=>{t.style.backgroundColor="#6c757d"})),t.onclick=()=>this.openSettingsModal(),e.appendChild(t)}openSettingsModal(){const e=document.createElement("div");e.id="git-helper-settings-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="1010",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="700px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px";const n=document.createElement("h3");n.textContent="Settings",n.style.margin="0";const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(o);const l=document.createElement("div");l.style.marginBottom="20px";const a=document.createElement("h4");a.textContent="Label Whitelist",a.style.marginBottom="10px";const i=document.createElement("p");i.textContent="Select which labels should appear in the dropdown. The system will show any label that contains these terms.",i.style.marginBottom="15px",i.style.fontSize="14px",i.style.color="#666",l.appendChild(a),l.appendChild(i),this.createWhitelistEditor(l),t.appendChild(s),t.appendChild(l);const r=document.createElement("div");r.style.marginTop="20px",r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center";const c=document.createElement("button");c.textContent="Reset to Defaults",c.style.padding="8px 16px",c.style.backgroundColor="#6c757d",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=()=>{confirm("Are you sure you want to reset all settings to default values?")&&(this.apiTabView.labelManager.resetToDefaultWhitelist(),this.showSettingsSavedNotification("Settings reset to defaults"),e.remove(),this.apiTabView.labelManager.fetchAndAddLabels())};const d=document.createElement("button");d.textContent="Save Settings",d.style.padding="8px 16px",d.style.backgroundColor="#28a745",d.style.color="white",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",d.onclick=()=>{this.saveWhitelistSettings(),e.remove(),this.showSettingsSavedNotification("Settings saved successfully"),this.apiTabView.labelManager.fetchAndAddLabels()},r.appendChild(c),r.appendChild(d),t.appendChild(r),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}createGitLabStyleLabel(e){const t=document.createElement("span");t.textContent=e.name;const s=e.color||this.getColorForLabel(e.name),n=this.getContrastColor(s);return t.style.backgroundColor=s,t.style.color=n,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}getColorForLabel(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return`hsl(${Math.abs(t)%360}, 70%, 75%)`}getContrastColor(e){let t={r:0,g:0,b:0};if(e.startsWith("#")){const s=e.substring(1);t.r=parseInt(s.substr(0,2),16),t.g=parseInt(s.substr(2,2),16),t.b=parseInt(s.substr(4,2),16)}else if(e.startsWith("rgb")){const s=e.match(/\d+/g);s&&s.length>=3&&(t.r=parseInt(s[0]),t.g=parseInt(s[1]),t.b=parseInt(s[2]))}else if(e.startsWith("hsl")){const t=e.match(/\d+/g);if(t&&t.length>=3)return parseInt(t[2])>70?"black":"white"}return(299*t.r+587*t.g+114*t.b)/1e3>125?"black":"white"}createWhitelistEditor(e){const t=document.createElement("div");t.id="whitelist-loading-message",t.textContent="Loading available labels...",t.style.fontStyle="italic",t.style.color="#666",e.appendChild(t);const s=document.createElement("div");s.id="whitelist-container",s.style.display="flex",s.style.flexWrap="wrap",s.style.gap="10px",s.style.marginTop="15px",e.appendChild(s);const n=this.apiTabView.labelManager.labelWhitelist;this.apiTabView.labelManager.fetchAllLabels().then((e=>{if(t.remove(),0===e.length){const e=document.createElement("div");return e.textContent="No labels found. Try refreshing the page.",e.style.width="100%",void s.appendChild(e)}e.sort(((e,t)=>e.name.localeCompare(t.name)));const o=new Set;e.forEach((e=>{if(o.has(e.name.toLowerCase()))return;o.add(e.name.toLowerCase());const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="10px",t.style.width="calc(33.33% - 10px)";const l=document.createElement("input");l.type="checkbox",l.id=`label-${e.name}`,l.dataset.label=e.name.toLowerCase(),l.style.marginRight="8px",this.apiTabView.labelManager.isLabelInWhitelist(e.name,n)&&(l.checked=!0);const a=this.createGitLabStyleLabel(e);a.style.cursor="pointer",a.onclick=()=>{l.checked=!l.checked},t.appendChild(l),t.appendChild(a),s.appendChild(t)}));const l=document.createElement("div");l.style.width="100%",l.style.marginTop="20px",l.style.padding="15px",l.style.borderTop="1px solid #ddd";const a=document.createElement("div");a.textContent="Add custom terms (comma separated):",a.style.marginBottom="8px",a.style.fontWeight="bold";const i=document.createElement("input");i.type="text",i.id="custom-whitelist-terms",i.style.width="100%",i.style.padding="8px",i.style.borderRadius="4px",i.style.border="1px solid #ccc";const r=Array.from(o),c=n.filter((e=>!r.some((t=>t.includes(e)))));i.value=c.join(", "),l.appendChild(a),l.appendChild(i),s.appendChild(l)})).catch((e=>{console.error("Error fetching labels for whitelist editor:",e),t.textContent="Error loading labels. Try refreshing the page.",t.style.color="#dc3545"}))}saveWhitelistSettings(){const e=[];document.querySelectorAll('#whitelist-container input[type="checkbox"]').forEach((t=>{t.checked&&e.push(t.dataset.label.toLowerCase())}));const t=document.getElementById("custom-whitelist-terms");if(t&&t.value){t.value.split(",").map((e=>e.trim().toLowerCase())).forEach((t=>{t&&!e.includes(t)&&e.push(t)}))}this.apiTabView.labelManager.saveWhitelist(e)}showSettingsSavedNotification(e="Settings saved successfully!"){const t=document.createElement("div");t.textContent=e,t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.backgroundColor="#28a745",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",t.style.zIndex="1001",t.style.opacity="0",t.style.transform="translateY(20px)",t.style.transition="opacity 0.3s ease, transform 0.3s ease",document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),10),setTimeout((()=>{t.style.opacity="0",t.style.transform="translateY(20px)",setTimeout((()=>{t.remove()}),300)}),3e3)}},e.ApiTabView=e.ApiTabView||class ApiTabView{constructor(uiManager){this.uiManager=uiManager,this.selectedIssues=[],this.commentShortcuts=null,this.labelManager=new LabelManager(this),this.settingsManager=new SettingsManager(this),this.shortcutManager=new ShortcutManager(this),this.selectionDisplay=new IssueSelectionDisplay(this)}render(){const e=document.getElementById("api-info-content");if(!e)return;e.innerHTML="";const t=document.createElement("h4");t.textContent="Bulk Actions",t.style.margin="0 0 10px 0",e.appendChild(t),this.addCommentSection(e)}addCommentSection(e){const t=document.createElement("div");t.classList.add("api-section"),t.style.marginBottom="15px",t.style.padding="10px",t.style.backgroundColor="#f5f5f5",t.style.borderRadius="8px",t.style.border="1px solid #e0e0e0";const s=document.createElement("div");s.style.fontWeight="bold",s.style.marginBottom="10px",s.textContent="Add Comment to Selected Issues",t.appendChild(s),this.selectionDisplay.createSelectionContainer(t),this.createCommentInput(t),this.createActionButtons(t),this.createStatusElements(t),this.settingsManager.addSettingsButton(t),this.labelManager.fetchAndAddLabels(),this.shortcutManager.addCustomShortcuts(),e.appendChild(t)}createCommentInput(e){const t=document.createElement("textarea");t.id="issue-comment-input",t.placeholder="Enter your comment here...",t.style.width="100%",t.style.padding="8px",t.style.marginBottom="12px",t.style.borderRadius="4px",t.style.border="1px solid #ccc",t.style.minHeight="60px",t.style.fontSize="14px",t.style.transition="border-color 0.2s ease",t.style.resize="vertical",t.addEventListener("focus",(()=>{t.style.borderColor="#1f75cb",t.style.outline="none",t.style.boxShadow="0 0 0 2px rgba(31, 117, 203, 0.2)"})),t.addEventListener("blur",(()=>{t.style.borderColor="#ccc",t.style.boxShadow="none"})),this.commentShortcuts=new CommentShortcuts({targetElement:t,onShortcutInsert:(e,t)=>{console.log(`Shortcut inserted: ${e} with value ${t}`)}}),e.appendChild(t),this.commentShortcuts.initialize(e)}createActionButtons(e){const t=document.createElement("div");t.style.display="flex",t.style.gap="8px",t.style.marginBottom="8px";const s=document.createElement("button");s.textContent="📎 Select Issues",s.style.padding="8px 12px",s.style.backgroundColor="#6c757d",s.style.color="white",s.style.border="none",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="background-color 0.2s ease",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#5a6268"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="#6c757d"})),s.onclick=()=>this.uiManager.issueSelector.startSelection(),t.appendChild(s);const n=document.createElement("button");n.textContent="💬 Add Comment",n.style.padding="8px 12px",n.style.backgroundColor="#1f75cb",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="14px",n.style.transition="background-color 0.2s ease",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flex="1",n.addEventListener("mouseenter",(()=>{n.style.backgroundColor="#1a63ac"})),n.addEventListener("mouseleave",(()=>{n.style.backgroundColor="#1f75cb"})),n.onclick=()=>this.submitComments(),t.appendChild(n);const o=document.createElement("button");o.textContent="🗑️ Clear",o.style.padding="8px 12px",o.style.backgroundColor="#dc3545",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.fontSize="14px",o.style.transition="background-color 0.2s ease",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.addEventListener("mouseenter",(()=>{o.style.backgroundColor="#c82333"})),o.addEventListener("mouseleave",(()=>{o.style.backgroundColor="#dc3545"})),o.onclick=()=>this.clearSelectedIssues(),t.appendChild(o),e.appendChild(t)}createStatusElements(e){const t=document.createElement("div");t.id="comment-status",t.style.fontSize="12px",t.style.marginTop="5px",t.style.fontStyle="italic",e.appendChild(t);const s=document.createElement("div");s.id="comment-progress-container",s.style.display="none",s.style.marginTop="10px";const n=document.createElement("div");n.id="comment-progress-label",n.textContent="Submitting comments...",n.style.fontSize="12px",n.style.marginBottom="5px",s.appendChild(n);const o=document.createElement("div");o.style.height="10px",o.style.backgroundColor="#e9ecef",o.style.borderRadius="5px",o.style.overflow="hidden";const l=document.createElement("div");l.id="comment-progress-bar",l.style.height="100%",l.style.width="0%",l.style.backgroundColor="#1f75cb",l.style.transition="width 0.3s ease",o.appendChild(l),s.appendChild(o),e.appendChild(s)}clearSelectedIssues(){this.selectedIssues=[],this.selectionDisplay.updateDisplay();const e=document.getElementById("comment-status");e&&(e.textContent="Selection cleared.",e.style.color="#666")}async submitComments(){const e=document.getElementById("issue-comment-input"),t=document.getElementById("comment-status"),s=document.getElementById("comment-progress-container"),n=document.getElementById("comment-progress-bar"),o=document.getElementById("comment-progress-label");if(0===this.selectedIssues.length)return t.textContent="Error: No issues selected.",void(t.style.color="#dc3545");const l=e.value.trim();if(!l)return t.textContent="Error: Comment cannot be empty.",void(t.style.color="#dc3545");t.textContent=`Submitting comments to ${this.selectedIssues.length} issues...`,t.style.color="#1f75cb",s.style.display="block",n.style.width="0%";const a=document.querySelector("button");a&&a.textContent.includes("Add Comment")&&(a.disabled=!0,a.style.opacity="0.7",a.style.cursor="not-allowed");let i=0,r=0;for(let e=0;e<this.selectedIssues.length;e++){const t=this.selectedIssues[e],s=Math.round(e/this.selectedIssues.length*100);n.style.width=`${s}%`,o.textContent=`Processing ${e+1} of ${this.selectedIssues.length} issues...`;try{await gitlabApi.addComment(t,l),i++}catch(e){console.error(`Failed to add comment to issue #${t.iid}:`,e),r++}}n.style.width="100%",a&&a.textContent.includes("Add Comment")&&(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer"),i===this.selectedIssues.length?(t.textContent=`Successfully added comment to all ${i} issues!`,t.style.color="green",e.value="",this.showSuccessNotification(i),setTimeout((()=>{s.style.display="none"}),2e3),setTimeout((()=>{this.clearSelectedIssues(),t.textContent=""}),3e3)):(t.textContent=`Added comment to ${i} issues, failed for ${r} issues.`,t.style.color=i>0?"#ff9900":"#dc3545",n.style.backgroundColor=i>0?"#ff9900":"#dc3545")}setSelectedIssues(e){this.selectedIssues=e||[],this.selectionDisplay.updateDisplay();const t=document.getElementById("comment-status");if(t){const e=this.selectedIssues.length;t.textContent=`${e} issue${1!==e?"s":""} selected. Enter your comment and click "Add Comment".`,t.style.color="green"}}setSelectedIssue(e){this.setSelectedIssues(e?[e]:[])}showSuccessNotification(e=1){const t=document.createElement("div");t.textContent=1===e?"Comment added successfully!":`Comments added to ${e} issues successfully!`,t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.backgroundColor="#28a745",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="4px",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",t.style.zIndex="1001",t.style.opacity="0",t.style.transform="translateY(20px)",t.style.transition="opacity 0.3s ease, transform 0.3s ease",document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),10),setTimeout((()=>{t.style.opacity="0",t.style.transform="translateY(20px)",setTimeout((()=>{t.remove()}),300)}),3e3)}},e.SummaryTabView=e.SummaryTabView||class SummaryTabView{constructor(uiManager){this.uiManager=uiManager}render(e,t,s,n,o){const l=document.getElementById("assignee-time-summary-content");if(!l)return;if(l.innerHTML="",this.uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:this.getClosedBoardCount()}),0===n)return void this.renderNoDataMessage(l);const a=(t/3600).toFixed(1);this.uiManager.updateHeader(`Summary ${a}h`),o&&this.renderMilestoneInfo(l,o),this.renderDataTable(l,e,a)}getClosedBoardCount(){let e=0;return document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}if(s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished")){const s=t.querySelectorAll(".board-card");e+=s.length}})),e}renderNoDataMessage(e){const t=document.createElement("p");t.textContent="No time estimate data found. Make sure the board is fully loaded and try again.",t.style.color="#666",e.appendChild(t);const s=document.createElement("p");s.style.fontSize="12px",s.style.fontStyle="italic",s.innerHTML="Tip: Try scrolling through all cards to ensure they are loaded before clicking Recalculate.",e.appendChild(s),this.uiManager.updateHeader("Summary 0.0h")}renderMilestoneInfo(e,t){const s=document.createElement("div");s.style.marginBottom="10px",s.style.fontSize="13px",s.style.color="#555",s.textContent=`Current Milestone: ${t}`,e.appendChild(s)}renderDataTable(e,t,s){const n=document.createElement("table");n.style.width="100%",n.style.borderCollapse="collapse";const o=document.createElement("tr");o.style.borderBottom="2px solid #ddd",o.style.fontWeight="bold";const l=document.createElement("td");l.textContent="Total",l.style.padding="5px 0";const a=document.createElement("td");a.textContent=`${s}h`,a.style.textAlign="right",a.style.padding="5px 0",o.appendChild(l),o.appendChild(a),n.appendChild(o);Object.keys(t).sort(((e,s)=>t[s]-t[e])).forEach((e=>{const s=(t[e]/3600).toFixed(1),o=document.createElement("tr");o.style.borderBottom="1px solid #eee";const l=document.createElement("td");l.textContent=e,l.style.padding="5px 0";const a=document.createElement("td");a.textContent=`${s}h`,a.style.textAlign="right",a.style.padding="5px 0",o.appendChild(l),o.appendChild(a),n.appendChild(o)})),e.appendChild(n)}},e.BoardsTabView=e.BoardsTabView||class BoardsTabView{constructor(uiManager){this.uiManager=uiManager}render(e,t){const s=document.getElementById("boards-time-summary-content");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="boards-list-summary";Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const o=this.createBoardSection(s,e[s],t[s]);n.appendChild(o)})),s.appendChild(n)}createBoardSection(e,t,s){const n=(t.timeEstimate/3600).toFixed(1),o=document.createElement("div");o.className="board-section",o.style.marginBottom="15px";const l=document.createElement("div");l.className="board-header",l.style.display="flex",l.style.justifyContent="space-between",l.style.padding="5px",l.style.backgroundColor="#f5f5f5",l.style.borderRadius="3px",l.style.cursor="pointer",l.style.fontWeight="bold";const a=document.createElement("div");a.className="board-details",a.style.display="none",a.style.marginTop="5px",a.style.marginLeft="10px",l.addEventListener("click",(()=>{"none"===a.style.display?(a.style.display="block",r.textContent="▼"):(a.style.display="none",r.textContent="▶")}));const i=document.createElement("div");i.textContent=`${e} (${t.tickets} tickets, ${n}h)`;const r=document.createElement("span");return r.textContent="▶",r.style.marginLeft="5px",l.appendChild(i),l.appendChild(r),s&&a.appendChild(this.createAssigneeTable(s)),o.appendChild(l),o.appendChild(a),o}createAssigneeTable(e){const t=document.createElement("table");t.style.width="100%",t.style.borderCollapse="collapse",t.style.marginTop="5px";const s=document.createElement("tr");s.style.borderBottom="1px solid #ddd";const n=document.createElement("th");n.textContent="Assignee",n.style.textAlign="left",n.style.padding="3px 0";const o=document.createElement("th");o.textContent="Tickets",o.style.textAlign="right",o.style.padding="3px 5px";const l=document.createElement("th");l.textContent="Hours",l.style.textAlign="right",l.style.padding="3px 0",s.appendChild(n),s.appendChild(o),s.appendChild(l),t.appendChild(s);return Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const n=e[s],o=(n.timeEstimate/3600).toFixed(1),l=document.createElement("tr");l.style.borderBottom="1px solid #eee";const a=document.createElement("td");a.textContent=s,a.style.padding="3px 0";const i=document.createElement("td");i.textContent=n.tickets,i.style.textAlign="right",i.style.padding="3px 5px";const r=document.createElement("td");r.textContent=`${o}h`,r.style.textAlign="right",r.style.padding="3px 0",l.appendChild(a),l.appendChild(i),l.appendChild(r),t.appendChild(l)})),t}},e.HistoryTabView=e.HistoryTabView||class HistoryTabView{constructor(uiManager){this.uiManager=uiManager}render(){const t=document.getElementById("history-time-summary-content");if(!t)return;t.innerHTML="";const s=getHistoryKey(),n=GM_getValue(s,[]),o=document.createElement("div");o.style.fontSize="12px",o.style.color="#666",o.style.marginBottom="10px",o.style.wordBreak="break-all";let l=e.location.href;l.length>60&&(l=l.substring(0,57)+"..."),t.appendChild(o),0!==n.length?(this.addClearHistoryButton(t,s),this.renderHistoryTable(t,n)):this.renderNoHistoryMessage(t)}renderNoHistoryMessage(e){const t=document.createElement("p");t.textContent="No history data available for this URL yet.",t.style.color="#666",e.appendChild(t)}addClearHistoryButton(e,t){const s=document.createElement("button");s.textContent="Clear History",s.style.padding="3px 6px",s.style.fontSize="12px",s.style.backgroundColor="#dc3545",s.style.color="white",s.style.border="none",s.style.borderRadius="3px",s.style.cursor="pointer",s.style.marginBottom="10px",s.onclick=()=>{confirm("Are you sure you want to clear history data for this URL?")&&(GM_setValue(t,[]),this.render())},e.appendChild(s)}renderHistoryTable(e,t){const s=document.createElement("table");s.style.width="100%",s.style.borderCollapse="collapse";const n=document.createElement("tr");n.style.borderBottom="2px solid #ddd",n.style.fontWeight="bold";const o=document.createElement("th");o.textContent="Date",o.style.textAlign="left",o.style.padding="5px 0";const l=document.createElement("th");l.textContent="Hours",l.style.textAlign="right",l.style.padding="5px 0";const a=document.createElement("th");a.textContent="Milestone",a.style.textAlign="left",a.style.padding="5px 0",n.appendChild(o),n.appendChild(l),n.appendChild(a),s.appendChild(n),t.slice().reverse().forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid #eee";const n=document.createElement("td"),o=new Date(e.timestamp);n.textContent=o.toLocaleDateString()+" "+o.toLocaleTimeString().substring(0,5),n.style.padding="5px 0";const l=document.createElement("td");l.textContent=`${e.totalHours}h`,l.style.textAlign="right",l.style.padding="5px 0";const a=document.createElement("td");a.textContent=e.milestone,a.style.padding="5px 0",t.appendChild(n),t.appendChild(l),t.appendChild(a),s.appendChild(t)})),e.appendChild(s)}},e.IssueSelector=e.IssueSelector||class IssueSelector{constructor(uiManager){this.uiManager=uiManager,this.isSelectingIssue=!1,this.selectionOverlays=[],this.selectedOverlays=[],this.selectedIssues=[],document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isSelectingIssue&&this.exitSelectionMode()}))}startSelection(){this.isSelectingIssue=!0;const e=[...this.selectedIssues],t=document.getElementById("comment-status");t&&(t.textContent="Click on cards to select/deselect issues. Press ESC when finished.",t.style.color="#1f75cb");const s=document.createElement("div");s.id="selection-page-overlay",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(0, 0, 0, 0.2)",s.style.zIndex="998",s.style.pointerEvents="none",document.body.appendChild(s),this.createCardOverlays(e),this.createCancelButton()}createCancelButton(){const e=document.createElement("div");e.id="selection-cancel-button",e.textContent="DONE",e.style.position="fixed",e.style.bottom="20px",e.style.right="330px",e.style.backgroundColor="#6c757d",e.style.color="white",e.style.padding="10px 20px",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.zIndex="999",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)",e.style.transition="all 0.2s ease",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#5a6268",e.style.transform="translateY(-2px)",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#6c757d",e.style.transform="translateY(0)",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)"})),e.addEventListener("click",(()=>{this.exitSelectionMode()})),document.body.appendChild(e),this.selectionOverlays.push(e);const t=document.createElement("div");t.id="selection-counter",t.textContent=`${this.selectedIssues.length} issues selected`,t.style.position="fixed",t.style.bottom="20px",t.style.left="20px",t.style.backgroundColor=this.selectedIssues.length>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="8px 16px",t.style.borderRadius="20px",t.style.fontSize="14px",t.style.zIndex="999",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",document.body.appendChild(t),this.selectionOverlays.push(t)}updateSelectionCounter(){const e=document.getElementById("selection-counter");if(e){const t=this.selectedIssues.length;e.textContent=`${t} issue${1!==t?"s":""} selected`,e.style.backgroundColor=t>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)"}this.syncSelectionWithApiTab()}syncSelectionWithApiTab(){this.uiManager&&this.uiManager.apiView&&this.uiManager.apiView.setSelectedIssues([...this.selectedIssues])}createCardOverlays(e=[]){const t=document.querySelectorAll(".board-card");this.selectedIssues=e||[],this.selectedOverlays=[],t.forEach((t=>{const s=t.getBoundingClientRect(),n=document.createElement("div");n.className="card-selection-overlay",n.style.position="absolute",n.style.left=`${s.left}px`,n.style.top=`${s.top}px`,n.style.width=`${s.width}px`,n.style.height=`${s.height}px`,n.style.backgroundColor="rgba(31, 117, 203, 0.2)",n.style.border="2px solid rgba(31, 117, 203, 0.6)",n.style.borderRadius="4px",n.style.zIndex="999",n.style.cursor="pointer",n.style.transition="background-color 0.2s ease",n.dataset.cardId=t.id||Date.now()+Math.random().toString(36).substring(2,9),n.dataset.selected="false",n.dataset.originalCard=t.id||t.innerText.substring(0,20);const o=gitlabApi.getIssueItemFromCard(t);if(o&&e.some((e=>e.iid===o.iid&&e.referencePath===o.referencePath))){n.dataset.selected="true",n.style.backgroundColor="rgba(0, 177, 106, 0.3)",n.style.borderColor="rgba(0, 177, 106, 0.8)",n.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedOverlays.length+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",n.appendChild(t),this.selectedOverlays.push(n)}n.addEventListener("mouseenter",(()=>{"true"!==n.dataset.selected&&(n.style.backgroundColor="rgba(31, 117, 203, 0.3)",n.style.boxShadow="0 0 8px rgba(31, 117, 203, 0.5)")})),n.addEventListener("mouseleave",(()=>{"true"!==n.dataset.selected&&(n.style.backgroundColor="rgba(31, 117, 203, 0.2)",n.style.boxShadow="none")})),n.addEventListener("click",(e=>{e.stopPropagation(),this.toggleCardSelection(t,n)})),document.body.appendChild(n),this.selectionOverlays.push(n)}));const s=document.createElement("div");s.id="selection-help-text",s.textContent="Click on issues to select/deselect them • Press ESC or DONE when finished",s.style.position="fixed",s.style.top="10px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.7)",s.style.color="white",s.style.padding="8px 16px",s.style.borderRadius="20px",s.style.fontSize="14px",s.style.zIndex="999",s.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",document.body.appendChild(s),this.selectionOverlays.push(s),this.updateSelectionCounter()}toggleCardSelection(e,t){if(!this.isSelectingIssue)return;const s=gitlabApi.getIssueItemFromCard(e);if(s){if("true"===t.dataset.selected)t.dataset.selected="false",t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)",t.style.boxShadow="none",this.selectedIssues=this.selectedIssues.filter((e=>!(e.iid===s.iid&&e.referencePath===s.referencePath))),this.selectedOverlays=this.selectedOverlays.filter((e=>e!==t)),t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),this.renumberBadges();else{t.dataset.selected="true",t.style.backgroundColor="rgba(0, 177, 106, 0.3)",t.style.borderColor="rgba(0, 177, 106, 0.8)",t.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedIssues.length+1,n=document.createElement("div");n.className="selection-badge",n.textContent=e,n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.backgroundColor="rgba(0, 177, 106, 1)",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontWeight="bold",n.style.fontSize="12px",n.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),t.appendChild(n),this.selectedIssues.push(s),this.selectedOverlays.push(t)}this.updateSelectionCounter()}else{t.style.backgroundColor="rgba(220, 53, 69, 0.4)",t.style.borderColor="rgba(220, 53, 69, 0.8)",setTimeout((()=>{t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)"}),500);const e=document.getElementById("comment-status");e&&(e.textContent="Could not extract issue data from this card. Try another one.",e.style.color="#dc3545")}}renumberBadges(){this.selectedOverlays.forEach(((e,t)=>{const s=e.querySelector(".selection-badge");s&&(s.textContent=t+1)}))}exitSelectionMode(){this.isSelectingIssue=!1,document.getElementById("selection-page-overlay")?.remove(),this.selectionOverlays.forEach((e=>{e.remove()})),this.selectionOverlays=[],this.selectedOverlays=[],this.syncSelectionWithApiTab();const e=document.getElementById("comment-status");e&&(this.selectedIssues.length>0?(e.textContent=`${this.selectedIssues.length} issues selected. Enter your comment and click "Add Comment".`,e.style.color="green"):(e.textContent='No issues selected. Click "Select Issues" to choose issues.',e.style.color="#666"))}repositionOverlays(){if(!this.isSelectingIssue)return;document.querySelectorAll(".board-card").forEach((e=>{const t=this.selectionOverlays.find((t=>t.dataset&&"card-selection-overlay"===t.className&&t.dataset.originalCard===(e.id||e.innerText.substring(0,20))));if(t){const s=e.getBoundingClientRect();t.style.left=`${s.left}px`,t.style.top=`${s.top}px`,t.style.width=`${s.width}px`,t.style.height=`${s.height}px`}}));const e=document.getElementById("selection-cancel-button");e&&(e.style.bottom="20px",e.style.right="330px");const t=document.getElementById("selection-counter");t&&(t.style.bottom="20px",t.style.left="20px")}},e.UIManager=e.UIManager||class UIManager{constructor(){this.container=null,this.contentWrapper=null,this.headerDiv=null,this.header=null,this.recalculateBtn=null,this.settingsBtn=null,this.collapseBtn=null,this.boardStats=null,this.tabManager=new TabManager(this),this.summaryView=new SummaryTabView(this),this.boardsView=new BoardsTabView(this),this.historyView=new HistoryTabView(this),this.apiView=new ApiTabView(this),this.issueSelector=new IssueSelector(this)}initialize(){document.getElementById("assignee-time-summary")?this.container=document.getElementById("assignee-time-summary"):(this.container=document.createElement("div"),this.container.id="assignee-time-summary",this.container.style.position="fixed",this.container.style.bottom="15px",this.container.style.right="15px",this.container.style.backgroundColor="white",this.container.style.border="1px solid #ddd",this.container.style.borderRadius="4px",this.container.style.padding="10px",this.container.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)",this.container.style.zIndex="1000",this.container.style.maxHeight="80vh",this.container.style.overflow="hidden",this.container.style.fontSize="14px",this.container.style.width="350px",this.container.style.transition="height 0.3s ease-in-out",this.contentWrapper=document.createElement("div"),this.contentWrapper.id="assignee-time-summary-wrapper",this.contentWrapper.style.display="block",this.contentWrapper.style.maxHeight="70vh",this.contentWrapper.style.overflowY="auto",this.createHeader(),this.createBoardStats(),this.tabManager.initialize(this.contentWrapper),this.container.appendChild(this.contentWrapper),document.body.appendChild(this.container),this.container.addEventListener("click",(e=>{!this.issueSelector.isSelectingIssue||e.target.classList.contains("card-selection-overlay")||e.target.classList.contains("selection-badge")||this.issueSelector.exitSelectionMode()})),"true"===localStorage.getItem("gitlabTimeSummaryCollapsed")&&(this.contentWrapper.style.display="none",this.collapseBtn.textContent="▲",this.container.style.height="auto"))}createHeader(){this.headerDiv=document.createElement("div"),this.headerDiv.style.display="flex",this.headerDiv.style.justifyContent="space-between",this.headerDiv.style.alignItems="center",this.headerDiv.style.marginBottom="5px",this.headerDiv.style.cursor="pointer",this.headerDiv.addEventListener("click",(e=>{e.target!==this.recalculateBtn&&e.target!==this.settingsBtn&&e.target!==this.collapseBtn&&this.toggleCollapse()})),this.header=document.createElement("h3"),this.header.id="assignee-time-summary-header",this.header.textContent="Summary",this.header.style.margin="0",this.header.style.fontSize="16px";const e=document.createElement("div");e.style.display="flex",e.style.gap="5px",this.recalculateBtn=document.createElement("button"),this.recalculateBtn.textContent="🔄",this.recalculateBtn.title="Recalculate",this.recalculateBtn.style.padding="3px 6px",this.recalculateBtn.style.fontSize="12px",this.recalculateBtn.style.backgroundColor="#1f75cb",this.recalculateBtn.style.color="white",this.recalculateBtn.style.border="none",this.recalculateBtn.style.borderRadius="3px",this.recalculateBtn.style.cursor="pointer",this.recalculateBtn.onclick=e=>{e.stopPropagation(),updateSummary(!0),this.recalculateBtn.textContent="✓",setTimeout((()=>{this.recalculateBtn.textContent="🔄"}),1e3)},this.settingsBtn=document.createElement("button"),this.settingsBtn.textContent="⚙️",this.settingsBtn.title="Settings",this.settingsBtn.style.padding="3px 6px",this.settingsBtn.style.fontSize="12px",this.settingsBtn.style.backgroundColor="#6c757d",this.settingsBtn.style.color="white",this.settingsBtn.style.border="none",this.settingsBtn.style.borderRadius="3px",this.settingsBtn.style.cursor="pointer",this.settingsBtn.onclick=e=>{e.stopPropagation(),this.apiView&&this.apiView.settingsManager&&this.apiView.settingsManager.openSettingsModal()},this.collapseBtn=document.createElement("button"),this.collapseBtn.textContent="▼",this.collapseBtn.title="Collapse/Expand",this.collapseBtn.style.padding="3px 6px",this.collapseBtn.style.fontSize="12px",this.collapseBtn.style.backgroundColor="#777",this.collapseBtn.style.color="white",this.collapseBtn.style.border="none",this.collapseBtn.style.borderRadius="3px",this.collapseBtn.style.cursor="pointer",this.collapseBtn.onclick=e=>{e.stopPropagation(),this.toggleCollapse()},e.appendChild(this.recalculateBtn),e.appendChild(this.settingsBtn),e.appendChild(this.collapseBtn),this.headerDiv.appendChild(this.header),this.headerDiv.appendChild(e),this.container.appendChild(this.headerDiv)}createBoardStats(){this.boardStats=document.createElement("div"),this.boardStats.id="board-stats-summary",this.boardStats.style.fontSize="13px",this.boardStats.style.color="#555",this.boardStats.style.marginBottom="10px",this.boardStats.style.display="flex",this.boardStats.style.justifyContent="space-between",this.boardStats.textContent="Loading board statistics...",this.container.appendChild(this.boardStats)}updateBoardStats(e){if(!this.boardStats)return;this.boardStats.innerHTML="";const t=document.createElement("div");t.style.display="flex",t.style.gap="8px";const s=document.createElement("span");s.textContent=`Total: ${e.totalCards} cards`,t.appendChild(s);const n=document.createElement("span");n.textContent=`(${e.withTimeCards} with time)`,n.style.color="#777",t.appendChild(n);const o=document.createElement("div");o.textContent=`Closed: ${e.closedCards} cards`,o.style.color="#28a745",this.boardStats.appendChild(t),this.boardStats.appendChild(o)}toggleCollapse(){"none"===this.contentWrapper.style.display?(this.contentWrapper.style.display="block",this.collapseBtn.textContent="▼",this.container.style.height="",localStorage.setItem("gitlabTimeSummaryCollapsed","false")):(this.contentWrapper.style.display="none",this.collapseBtn.textContent="▲",this.container.style.height="auto",localStorage.setItem("gitlabTimeSummaryCollapsed","true"))}updateHeader(e){this.header&&(this.header.textContent=e)}},e.uiManager=e.uiManager||new UIManager,e.addEventListener("scroll",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.uiManager=uiManager,function(){"use strict";let t,s=!1;function updateSummary(n=!1){s=!1,clearTimeout(t);const{assigneeTimeMap:o,boardData:l,boardAssigneeData:a,totalEstimate:i,cardsProcessed:r,cardsWithTime:c,currentMilestone:d,closedBoardCards:u}=processBoards();clearTimeout(t),t=setTimeout((()=>{s=!0,s&&function saveHistoryEntry(t,s,n=!1){try{const n=new Date,o=n.toISOString(),l=(t/3600).toFixed(1),a=getHistoryKey();let i="None";s&&(i=s.replace(/\n/g," ").trim());let r=GM_getValue(a,[]);const c={date:o,timestamp:n.getTime(),totalHours:l,milestone:i,url:e.location.href};let d=!1;if(0===r.length)d=!0;else{const e=r[r.length-1];e.totalHours===c.totalHours&&e.milestone===c.milestone||(d=!0)}d&&(r.push(c),r.length>100&&(r=r.slice(-100)),GM_setValue(a,r),"block"===document.getElementById("history-time-summary-content").style.display&&renderHistory())}catch(e){console.error("Error saving history:",e)}}(i,d,n)}),3e3),function updateSummaryTab(t,s,n,o,l){if(e.processBoards){const{closedBoardCards:e}=processBoards();uiManager.updateBoardStats({totalCards:n,withTimeCards:o,closedCards:e||0})}uiManager.summaryView.render(t,s,n,o,l)}(o,i,r,c,d),function updateBoardsTab(e,t){uiManager.boardsView.render(e,t)}(l,a);const p=document.getElementById("api-info-content");p&&"block"===p.style.display&&function updateApiInfoTab(){uiManager.apiView.render()}()}function addBoardChangeListeners(){document.querySelectorAll(".board-list").forEach((e=>{new MutationObserver((()=>{updateSummary()})).observe(e,{childList:!0,subtree:!0})}))}function checkAndInit(){e.location.href.includes("/boards")&&(document.getElementById("assignee-time-summary")||createSummaryContainer(),function waitForBoards(){const e=document.getElementById("assignee-time-summary-status");e&&(e.textContent="Waiting for boards to load...");let t=0;const s=setInterval((()=>{t++;const n=document.querySelectorAll(".board-list");n.length>=5||t>=30?(clearInterval(s),e&&(e.textContent=`Found ${n.length} boards, initializing...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners()}),1e3)):n.length>0&&e&&(e.textContent=`Found ${n.length} of 5 boards...`)}),500)}())}checkAndInit();let n=e.location.href;new MutationObserver((()=>{e.location.href!==n&&(n=e.location.href,setTimeout(checkAndInit,1e3))})).observe(document,{subtree:!0,childList:!0}),e.gitlabHelper={updateSummary:updateSummary,gitlabApi:gitlabApi,uiManager:uiManager}}()}(window);