// ==UserScript==
// @name         GitLab Sprint Helper
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Display a summary of assignees' time estimates on GitLab boards with API integration and comment shortcuts
// @author       You
// @match        https://gitlab.com/*/boards/*
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-idle
// @updateURL    https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// @downloadURL  https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// ==/UserScript==

!function(e){e.formatHours=function formatHours(e){return(e/3600).toFixed(1)},e.formatDuration=function formatDuration(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60);return t>0&&s>0?`${t}h ${s}m`:t>0?`${t}h`:`${s}m`},e.getNestedProperty=function getNestedProperty(e,t){return t.split(".").reduce(((e,t)=>e&&e[t]?e[t]:null),e)},e.truncateText=function truncateText(e,t){return!e||e.length<=t?e:e.substring(0,t)+"..."},e.safeJSONParse=function safeJSONParse(e,t={}){try{return JSON.parse(e)}catch(e){return console.error("Error parsing JSON:",e),t}},e.waitForElement=function waitForElement(e,t=1e4){return new Promise(((s,n)=>{if(document.querySelector(e))return s(document.querySelector(e));const o=new MutationObserver((()=>{document.querySelector(e)&&(o.disconnect(),s(document.querySelector(e)))}));o.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{o.disconnect(),n(new Error(`Timeout waiting for element: ${e}`))}),t)}))},e.generateColorFromString=function generateColorFromString(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return`hsl(${Math.abs(t)%360}, 70%, 75%)`},e.getContrastColor=function getContrastColor(t){if(t.startsWith("hsl")){const e=t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%\s*\)/);if(e&&e[1]){return parseInt(e[1],10)>60?"black":"white"}}let s=0,n=0,o=0;try{const i=document.createElement("div");i.style.backgroundColor=t,document.body.appendChild(i);const l=e.getComputedStyle(i).backgroundColor;document.body.removeChild(i);const a=l.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);a&&(s=parseInt(a[1],10),n=parseInt(a[2],10),o=parseInt(a[3],10))}catch(e){return t.startsWith("hsl")&&t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)?parseInt(t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)[1],10)>60?"black":"white":"black"}return(.299*s+.587*n+.114*o)/255>.5?"black":"white"},e.getPathFromUrl=function getPathFromUrl(){try{console.log("Current URL:",e.location.href),console.log("Current pathname:",e.location.pathname);const t=e.location.pathname;if(t.includes("/groups/")&&t.includes("/-/boards")){const e=/\/groups\/([^\/]+(?:\/[^\/]+)*)\/?\-?\/?boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract group path from URL:",t),null;const n=s[1];console.log("Extracted group path:",n);const o=n.replace(/\/-$/,""),i=encodeURIComponent(o);console.log("Encoded group path for API:",i);const l=`groups/${i}/labels`;return console.log("Group API URL that will be used:",l),{path:o,encodedPath:i,type:"group",apiUrl:l}}if(t.includes("/-/boards")){const e=/^\/([^\/]+(?:\/[^\/]+)*)\/-\/boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract project path from URL pattern:",t),null;const n=s[1];console.log("Extracted project path:",n);const o=encodeURIComponent(n);console.log("Encoded project path for API:",o);const i=`projects/${o}/labels`;return console.log("Project API URL that will be used:",i),{path:n,encodedPath:o,type:"project",apiUrl:i}}return console.warn("Not on a GitLab boards page:",t),null}catch(e){return console.error("Error extracting path from URL:",e),null}},e.getCurrentUrlKey=function getCurrentUrlKey(){return e.location.href.split("#")[0]},e.getHistoryKey=function getHistoryKey(){return`timeEstimateHistory_${getCurrentUrlKey()}`},e.GitLabAPI=class GitLabAPI{constructor(){this.csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),this.baseUrl="/api/v4"}callGitLabApi(e,t={}){const{method:s="GET",data:n=null,params:o=null}=t;let i=`${this.baseUrl}/${e}`;if(o){const e=new URLSearchParams;Object.entries(o).forEach((([t,s])=>{null!=s&&e.append(t,s)}));const t=e.toString();t&&(i+=`?${t}`)}const l={method:s,headers:{"Content-Type":"application/json"},credentials:"same-origin"};return"GET"!==s&&this.csrfToken&&(l.headers["X-CSRF-Token"]=this.csrfToken),n&&["POST","PUT","PATCH"].includes(s)&&(l.body=JSON.stringify(n)),fetch(i,l).then((e=>{if(!e.ok)throw new Error(`API request failed: ${e.status} ${e.statusText}`);return e.json()}))}getIssue(e){const t=e.referencePath.split("#")[0],s=e.iid,n=encodeURIComponent(t);return this.callGitLabApi(`projects/${n}/issues/${s}`)}addComment(e,t){const s=e.referencePath.split("#")[0],n=e.iid,o=encodeURIComponent(s);return this.callGitLabApi(`projects/${o}/issues/${n}/notes`,{method:"POST",data:{body:t}})}getCurrentUser(){return this.callGitLabApi("user")}getProject(e){return this.callGitLabApi(`projects/${e}`)}getProjectIssues(e,t={}){return this.callGitLabApi(`projects/${e}/issues`,{params:t})}getMilestone(e,t){return this.callGitLabApi(`projects/${e}/milestones/${t}`)}updateIssue(e,t){const s=e.referencePath.split("#")[0],n=e.iid,o=encodeURIComponent(s);return this.callGitLabApi(`projects/${o}/issues/${n}`,{method:"PUT",data:t})}getIssueItemFromCard(e){try{if(e.__vue__&&e.__vue__.$children){const t=e.__vue__.$children.find((e=>e.$props&&e.$props.item));if(t&&t.$props&&t.$props.item)return t.$props.item}}catch(e){console.error("Error getting issue item from card:",e)}return null}},e.GitLabAPI=GitLabAPI,e.processBoards=function processBoards(){const e={},t={},s={};let n=0,o=0,i=0,l=null,a=0;return document.querySelectorAll(".board-list").forEach(((r,d)=>{let c="Unknown";try{if(r.__vue__&&r.__vue__.$children&&r.__vue__.$children.length>0){const e=r.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(c=e.$props.list.title)}if("Unknown"===c){const e=r.querySelector(".board-title-text");e&&(c=e.textContent.trim())}}catch(e){console.error("Error getting board title:",e);const t=r.querySelector(".board-title-text");t&&(c=t.textContent.trim())}if("Unknown"===c)return;{t[c]||(t[c]={tickets:0,timeEstimate:0}),s[c]||(s[c]={});const e=c.toLowerCase();e.includes("done")||e.includes("closed")||e.includes("complete")||e.includes("finished")}const u=r.querySelectorAll(".board-card"),h=c.toLowerCase();(h.includes("done")||h.includes("closed")||h.includes("complete")||h.includes("finished"))&&(a+=u.length),u.forEach((a=>{try{if(o++,t[c].tickets++,a.__vue__&&a.__vue__.$children){const o=a.__vue__.$children.find((e=>e.$props&&e.$props.item&&void 0!==e.$props.item.timeEstimate));if(o&&o.$props){const a=o.$props;if(!l&&a.item&&a.item.milestone&&(l=a.item.milestone.title),a.item&&a.item.timeEstimate){i++;const o=a.item.timeEstimate;n+=o,t[c].timeEstimate+=o;let l=[];a.item.assignees&&a.item.assignees.nodes&&a.item.assignees.nodes.length?l=a.item.assignees.nodes:a.item.assignees&&a.item.assignees.length>0&&(l=a.item.assignees),l.length>0?l.forEach((t=>{const n=o/l.length,i=t.name;e[i]||(e[i]=0),e[i]+=n,s[c][i]||(s[c][i]={tickets:0,timeEstimate:0}),s[c][i].tickets++,s[c][i].timeEstimate+=n})):(e.Unassigned||(e.Unassigned=0),e.Unassigned+=o,s[c].Unassigned||(s[c].Unassigned={tickets:0,timeEstimate:0}),s[c].Unassigned.tickets++,s[c].Unassigned.timeEstimate+=o)}}}}catch(e){console.error("Error processing card:",e)}}))})),{assigneeTimeMap:e,boardData:t,boardAssigneeData:s,totalEstimate:n,cardsProcessed:o,cardsWithTime:i,currentMilestone:l,closedBoardCards:a}},e.saveHistoryEntry=function saveHistoryEntry(t,s,n=!1){try{const n=new Date,o=n.toISOString(),i=(t/3600).toFixed(1),l=getHistoryKey();let a="None";s&&(a=s.replace(/\n/g," ").trim());let r=GM_getValue(l,[]);const d={date:o,timestamp:n.getTime(),totalHours:i,milestone:a,url:e.location.href};let c=!1;if(0===r.length)c=!0;else{const e=r[r.length-1];e.totalHours===d.totalHours&&e.milestone===d.milestone||(c=!0)}c&&(r.push(d),r.length>100&&(r=r.slice(-100)),GM_setValue(l,r),"block"===document.getElementById("history-time-summary-content").style.display&&"function"==typeof e.renderHistory&&e.renderHistory())}catch(e){console.error("Error saving history:",e)}},e.saveToStorage=function saveToStorage(e,t){try{return"object"==typeof t?localStorage.setItem(e,JSON.stringify(t)):localStorage.setItem(e,t),!0}catch(t){return console.error(`Error saving to localStorage (${e}):`,t),!1}},e.loadFromStorage=function loadFromStorage(e,t=null){try{const s=localStorage.getItem(e);if(null===s)return t;if(s.trim().startsWith("{")||s.trim().startsWith("["))try{return JSON.parse(s)}catch(t){return console.warn(`Failed to parse value for ${e} as JSON, returning as string instead`),s}return s}catch(s){return console.error(`Error loading from localStorage (${e}):`,s),t}},e.removeFromStorage=function removeFromStorage(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error(`Error removing from localStorage (${e}):`,t),!1}},e.clearStorage=function clearStorage(e=null){try{if(e){const t=[];for(let s=0;s<localStorage.length;s++){const n=localStorage.key(s);n.startsWith(e)&&t.push(n)}t.forEach((e=>localStorage.removeItem(e)))}else localStorage.clear();return!0}catch(e){return console.error("Error clearing localStorage:",e),!1}},e.hasStorageKey=function hasStorageKey(e){try{return null!==localStorage.getItem(e)}catch(t){return console.error(`Error checking localStorage for key (${e}):`,t),!1}},e.setGMValue=function setGMValue(e,t){try{return"function"==typeof GM_setValue?(GM_setValue(e,t),!0):(console.warn("GM_setValue not available, falling back to localStorage"),saveToStorage(e,t))}catch(t){return console.error(`Error in GM_setValue (${e}):`,t),!1}},e.getGMValue=function getGMValue(e,t=null){try{if("function"==typeof GM_getValue){return GM_getValue(e,t)}return console.warn("GM_getValue not available, falling back to localStorage"),loadFromStorage(e,t)}catch(s){return console.error(`Error in GM_getValue (${e}):`,s),t}};const t="gitLabHelperLabelWhitelist",s="gitLabHelperAssigneeWhitelist",n="gitLabHelperLastActiveTab",o="gitlabTimeSummaryCollapsed",i={labelWhitelist:["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"],assigneeWhitelist:[],lastActiveTab:"summary",uiCollapsed:!1};function createUIManager(){return e.uiManager=e.uiManager||new UIManager,uiManager.settingsBtn&&(uiManager.settingsBtn.onclick=t=>{if(t.stopPropagation(),uiManager.bulkCommentsView&&uiManager.bulkCommentsView.settingsManager)uiManager.bulkCommentsView.settingsManager.openSettingsModal();else if(e.settingsManager)e.settingsManager.openSettingsModal();else{const t=new SettingsManager({labelManager:uiManager.labelManager,assigneeManager:uiManager.assigneeManager,gitlabApi:e.gitlabApi||uiManager.gitlabApi,onSettingsChanged:e=>{console.log(`Settings changed: ${e}`),"all"!==e&&"labels"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addAssignShortcut()}});uiManager.bulkCommentsView&&(uiManager.bulkCommentsView.settingsManager=t),e.settingsManager=t,t.openSettingsModal()}}),uiManager}function checkAndInit(){if(e.location.href.includes("/boards")){if(!document.getElementById("assignee-time-summary")){const uiManager=createUIManager();e.settingsManager||(e.settingsManager=new SettingsManager({labelManager:uiManager.labelManager,assigneeManager:uiManager.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:e=>{console.log(`Settings changed: ${e}`),"all"!==e&&"labels"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addAssignShortcut()}})),e.uiManager=uiManager,createSummaryContainer()}waitForBoards()}}function updateSummary(e=!1){let t,s=!1;clearTimeout(t);const{assigneeTimeMap:n,boardData:o,boardAssigneeData:i,totalEstimate:l,cardsProcessed:a,cardsWithTime:r,currentMilestone:d}=processBoards();clearTimeout(t),t=setTimeout((()=>{s=!0,s&&saveHistoryEntry(l,d,e)}),3e3),updateSummaryTab(n,l,a,r,d),updateBoardsTab(o,i);const c=document.getElementById("bulk-comments-content");c&&"block"===c.style.display&&updateBulkCommentsTab()}function addBoardChangeListeners(){document.querySelectorAll(".board-list").forEach((e=>{new MutationObserver((()=>{updateSummary()})).observe(e,{childList:!0,subtree:!0})}))}function waitForBoards(){const e=document.getElementById("assignee-time-summary-status");e&&(e.textContent="Waiting for boards to load...");let t=0;const s=setInterval((()=>{t++;const n=document.querySelectorAll(".board-list");n.length>=5||t>=30?(clearInterval(s),e&&(e.textContent=`Found ${n.length} boards, initializing...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners()}),1e3)):n.length>0&&e&&(e.textContent=`Found ${n.length} of 5 boards...`)}),500)}e.getLabelWhitelist=function getLabelWhitelist(){const e=loadFromStorage(t,i.labelWhitelist);return Array.isArray(e)?e:i.labelWhitelist},e.saveLabelWhitelist=function saveLabelWhitelist(e){return saveToStorage(t,e)},e.resetLabelWhitelist=function resetLabelWhitelist(){return saveToStorage(t,i.labelWhitelist)},e.getAssigneeWhitelist=function getAssigneeWhitelist(){return loadFromStorage(s,i.assigneeWhitelist)},e.saveAssigneeWhitelist=function saveAssigneeWhitelist(e){return saveToStorage(s,e)},e.getLastActiveTab=function getLastActiveTab(){try{let e=loadFromStorage(n,i.lastActiveTab);return"string"==typeof e?e:i.lastActiveTab}catch(e){return console.warn("Error retrieving last active tab:",e),"summary"}},e.saveLastActiveTab=function saveLastActiveTab(e){return saveToStorage(n,String(e))},e.getUICollapsedState=function getUICollapsedState(){return loadFromStorage(o,i.uiCollapsed)},e.saveUICollapsedState=function saveUICollapsedState(e){return saveToStorage(o,e)},e.Dropdown=class Dropdown{constructor(e){this.items=e.items||[],this.onChange=e.onChange,this.placeholder=e.placeholder||"Select an option...",this.optionRenderer=e.optionRenderer,this.searchable=e.searchable||!1,this.width=e.width||"100%",this.container=null,this.selectElement=null,this.selectedValue=null,this.open=!1}render(e){this.container=document.createElement("div"),this.container.className="custom-dropdown",this.container.style.position="relative",this.container.style.display="inline-block",this.container.style.width=this.width,this.selectElement=document.createElement("div"),this.selectElement.className="custom-dropdown-select",this.selectElement.style.border="1px solid #ddd",this.selectElement.style.borderRadius="4px",this.selectElement.style.padding="6px 10px",this.selectElement.style.backgroundColor="#fff",this.selectElement.style.cursor="pointer",this.selectElement.style.display="flex",this.selectElement.style.justifyContent="space-between",this.selectElement.style.alignItems="center",this.selectElement.style.fontSize="13px";const t=document.createElement("span");t.className="dropdown-placeholder",t.textContent=this.placeholder,t.style.color="#666";const s=document.createElement("span");s.className="dropdown-arrow",s.innerHTML="▼",s.style.fontSize="10px",s.style.marginLeft="5px",s.style.transition="transform 0.2s ease",this.selectElement.appendChild(t),this.selectElement.appendChild(s);const n=document.createElement("div");if(n.className="dropdown-menu",n.style.position="absolute",n.style.top="100%",n.style.left="0",n.style.right="0",n.style.backgroundColor="#fff",n.style.border="1px solid #ddd",n.style.borderRadius="0 0 4px 4px",n.style.maxHeight="200px",n.style.overflowY="auto",n.style.zIndex="1000",n.style.display="none",n.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)",this.searchable){const e=document.createElement("div");e.style.padding="5px",e.style.position="sticky",e.style.top="0",e.style.backgroundColor="#fff",e.style.borderBottom="1px solid #eee";const t=document.createElement("input");t.type="text",t.placeholder="Search...",t.style.width="100%",t.style.padding="5px",t.style.border="1px solid #ccc",t.style.borderRadius="3px",t.style.fontSize="12px",t.addEventListener("input",(e=>{const t=e.target.value.toLowerCase();this.filterItems(t,n)})),e.appendChild(t),n.appendChild(e)}return this.populateDropdown(n),this.selectElement.addEventListener("click",(()=>{this.toggleDropdown(n,s)})),document.addEventListener("click",(e=>{!this.container.contains(e.target)&&this.open&&this.closeDropdown(n,s)})),this.container.appendChild(this.selectElement),this.container.appendChild(n),e&&e.appendChild(this.container),this.container}populateDropdown(e){this.items.forEach((t=>{const s=document.createElement("div");if(s.className="dropdown-item",s.dataset.value=t.value,s.style.padding="8px 10px",s.style.cursor="pointer",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""})),this.optionRenderer&&"function"==typeof this.optionRenderer){const e=this.optionRenderer(t);e instanceof HTMLElement?s.appendChild(e):s.innerHTML=e}else s.textContent=t.label;s.addEventListener("click",(n=>{n.stopPropagation(),this.selectItem(t,s),this.closeDropdown(e)})),e.appendChild(s)}))}filterItems(e,t){t.querySelectorAll(".dropdown-item").forEach((t=>{t.textContent.toLowerCase().includes(e)?t.style.display="":t.style.display="none"}))}toggleDropdown(e,t){this.open?this.closeDropdown(e,t):this.openDropdown(e,t)}openDropdown(e,t){if(e.style.display="block",t.style.transform="rotate(180deg)",this.open=!0,this.searchable){const t=e.querySelector("input");t&&t.focus()}}closeDropdown(e,t){e.style.display="none",t&&(t.style.transform=""),this.open=!1}selectItem(e,t){this.selectedValue=e.value;const s=this.selectElement.querySelector(".dropdown-placeholder");if(this.optionRenderer&&"function"==typeof this.optionRenderer){s.innerHTML="";const t=this.optionRenderer(e);t instanceof HTMLElement?s.appendChild(t.cloneNode(!0)):s.innerHTML=t,s.style.color=""}else s.textContent=e.label,s.style.color="";"function"==typeof this.onChange&&this.onChange(e.value,e)}setValue(e){const t=this.items.find((t=>t.value===e));if(t){const s=this.container.querySelector(`.dropdown-item[data-value="${e}"]`);if(s)return this.selectItem(t,s),!0}return!1}getValue(){return this.selectedValue}reset(){this.selectedValue=null;const e=this.selectElement.querySelector(".dropdown-placeholder");e.textContent=this.placeholder,e.style.color="#666"}updateItems(e){this.items=e;const t=this.container.querySelector(".dropdown-menu"),s=this.searchable?t.firstChild:null;t.innerHTML="",s&&t.appendChild(s),this.populateDropdown(t),this.reset()}disable(){this.selectElement.style.opacity="0.6",this.selectElement.style.pointerEvents="none"}enable(){this.selectElement.style.opacity="1",this.selectElement.style.pointerEvents="auto"}},e.Notification=class Notification{constructor(e={}){this.position=e.position||"bottom-right",this.duration=e.duration||3e3,this.animationDuration=e.animationDuration||"0.3s",this.container=null,this.createContainer()}createContainer(){if(document.getElementById("gitlab-helper-notifications"))this.container=document.getElementById("gitlab-helper-notifications");else{switch(this.container=document.createElement("div"),this.container.id="gitlab-helper-notifications",this.container.style.position="fixed",this.container.style.zIndex="10000",this.position){case"top-right":this.container.style.top="20px",this.container.style.right="20px";break;case"top-left":this.container.style.top="20px",this.container.style.left="20px";break;case"top-center":this.container.style.top="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;case"bottom-left":this.container.style.bottom="20px",this.container.style.left="20px";break;case"bottom-center":this.container.style.bottom="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;default:this.container.style.bottom="20px",this.container.style.right="20px"}document.body.appendChild(this.container)}}show(e){const t=e.message||"",s=e.type||"info",n=e.duration||this.duration,o=e.onClose||null,i=document.createElement("div");switch(i.className=`notification notification-${s}`,i.style.padding="12px 16px",i.style.marginBottom="10px",i.style.borderRadius="4px",i.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.minWidth="200px",i.style.maxWidth="350px",i.style.opacity="0",i.style.transform=this.getInitialTransform(),i.style.transition=`opacity ${this.animationDuration} ease, transform ${this.animationDuration} ease`,s){case"success":i.style.backgroundColor="#28a745",i.style.color="white";break;case"error":i.style.backgroundColor="#dc3545",i.style.color="white";break;case"warning":i.style.backgroundColor="#ffc107",i.style.color="black";break;default:i.style.backgroundColor="#17a2b8",i.style.color="white"}const l=document.createElement("div");l.style.flex="1",l.textContent=t;const a=document.createElement("button");return a.innerHTML="&times;",a.style.backgroundColor="transparent",a.style.border="none",a.style.color=i.style.color,a.style.fontSize="18px",a.style.marginLeft="10px",a.style.cursor="pointer",a.style.padding="0 5px",a.style.opacity="0.7",a.style.transition="opacity 0.2s ease",a.style.outline="none",a.addEventListener("mouseenter",(()=>{a.style.opacity="1"})),a.addEventListener("mouseleave",(()=>{a.style.opacity="0.7"})),a.addEventListener("click",(()=>{this.close(i,o)})),i.appendChild(l),i.appendChild(a),this.container.appendChild(i),setTimeout((()=>{i.style.opacity="1",i.style.transform="translateY(0)"}),10),n>0&&setTimeout((()=>{this.close(i,o)}),n),i}close(e,t=null){"true"!==e.dataset.closing&&(e.dataset.closing="true",e.style.opacity="0",e.style.transform=this.getInitialTransform(),setTimeout((()=>{e.parentNode===this.container&&this.container.removeChild(e),t&&"function"==typeof t&&t()}),1e3*parseFloat(this.animationDuration)))}getInitialTransform(){return this.position.startsWith("top")?"translateY(-20px)":"translateY(20px)"}success(e,t={}){return this.show({message:e,type:"success",...t})}error(e,t={}){return this.show({message:e,type:"error",...t})}warning(e,t={}){return this.show({message:e,type:"warning",...t})}info(e,t={}){return this.show({message:e,type:"info",...t})}clearAll(){for(;this.container.firstChild;)this.container.removeChild(this.container.firstChild)}},e.CommandShortcut=class CommandShortcut{constructor(e){this.targetElement=e.targetElement,this.onShortcutInsert=e.onShortcutInsert||null,this.shortcutsContainer=null,this.shortcuts={},this.customDropdowns=[]}initialize(e){this.shortcutsContainer&&this.shortcutsContainer.parentNode&&this.shortcutsContainer.parentNode.removeChild(this.shortcutsContainer),this.shortcutsContainer=document.createElement("div"),this.shortcutsContainer.className="command-shortcuts-container",this.shortcutsContainer.style.marginBottom="10px",this.shortcutsContainer.style.display="flex",this.shortcutsContainer.style.flexWrap="wrap",this.shortcutsContainer.style.gap="8px",this.shortcutsContainer.style.alignItems="center",e.appendChild(this.shortcutsContainer),this.initializeEstimateShortcut()}initializeEstimateShortcut(){this.shortcuts.estimate&&this.removeShortcut("estimate"),this.addCustomShortcut({type:"estimate",label:"/estimate",items:[{value:"",label:"Estimate Hours"},{value:"1",label:"1h"},{value:"2",label:"2h"},{value:"4",label:"4h"},{value:"8",label:"8h"},{value:"16",label:"16h"},{value:"32",label:"32h"},{value:"custom",label:"Custom..."}],onSelect:e=>{"custom"===e?this.handleCustomEstimate():e&&this.insertEstimateText(e)}})}removeShortcut(e){if(this.shortcuts[e]&&this.shortcuts[e].element){const t=this.shortcuts[e].element;t.parentNode&&t.parentNode.removeChild(t),delete this.shortcuts[e]}}handleCustomEstimate(){const e=prompt("Enter custom estimate hours (whole numbers only):","");if(null===e||""===e)return;const t=parseInt(e,10);isNaN(t)||t<=0||t!==parseFloat(e)?alert("Please enter a valid positive whole number."):this.insertEstimateText(t.toString())}insertEstimateText(e){if(!this.targetElement)return;const t=`/estimate ${e}h`,s=this.targetElement.value,n=/\/estimate\s+\d+h/g;if(n.test(s)){const e=s.replace(n,t);this.targetElement.value=e}else{const e=this.targetElement.selectionStart,n=this.targetElement.selectionEnd;let o=t;e>0&&"\n"!==s.charAt(e-1)&&s.length>0&&(o="\n"+o);const i=s.substring(0,e)+o+s.substring(n);this.targetElement.value=i;const l=e+o.length;this.targetElement.setSelectionRange(l,l)}this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert("estimate",e)}addCustomShortcut(e){this.shortcuts[e.type]&&this.removeShortcut(e.type);const t=document.createElement("div");t.className=`shortcut-item ${e.type}-shortcut`,t.style.display="flex",t.style.alignItems="center",t.style.width="100%",t.style.marginBottom="8px",t.style.justifyContent="space-between",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="6px 10px",t.style.backgroundColor="#f8f9fa";const s=document.createElement("span");s.textContent=e.label,s.style.fontSize="13px",s.style.fontFamily="monospace",s.style.color="#555",s.style.fontWeight="bold",s.style.minWidth="100px";const n=document.createElement("select");n.className=`${e.type}-dropdown`,n.style.border="none",n.style.backgroundColor="transparent",n.style.fontSize="13px",n.style.appearance="none",n.style.paddingRight="20px",n.style.paddingLeft="5px",n.style.width="100%",n.style.backgroundImage="url(\"data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 4 5'%3E%3Cpath fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E\")",n.style.backgroundRepeat="no-repeat",n.style.backgroundPosition="right 5px center",n.style.backgroundSize="8px 10px",n.style.WebkitAppearance="none",n.style.outline="none",n.style.cursor="pointer";const o=document.createElement("div");return o.style.flexGrow="1",o.style.marginLeft="10px",e.items.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,n.appendChild(t)})),n.addEventListener("change",(()=>{const t=n.value;t&&"function"==typeof e.onSelect&&e.onSelect(t),n.value=""})),t.appendChild(s),o.appendChild(n),t.appendChild(o),this.shortcutsContainer.appendChild(t),this.shortcuts[e.type]={element:t,dropdown:n,options:e},t}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const o=this.targetElement.value;if(s.test(o)){const e=o.replace(s,t);this.targetElement.value=e}else n();this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert(e,t)}},e.SelectionDisplay=class SelectionDisplay{constructor(e={}){this.selectedIssues=e.selectedIssues||[],this.onRemoveIssue=e.onRemoveIssue||null,this.container=null,this.issuesList=null}createSelectionContainer(e){this.container=e;const t=document.createElement("div");t.style.marginBottom="12px",t.style.padding="8px",t.style.borderRadius="4px",t.style.border="1px dashed #ccc",t.style.backgroundColor="#f9f9f9",t.style.maxHeight="150px",t.style.overflowY="auto";const s=document.createElement("div");s.style.fontSize="12px",s.style.color="#666",s.style.marginBottom="5px",s.textContent="Selected Issues:",t.appendChild(s);const n=document.createElement("div");n.id="selected-issues-list",n.style.fontSize="14px",this.issuesList=n,this.displayNoIssuesMessage(),t.appendChild(n),e.appendChild(t),this.updateDisplay()}displayNoIssuesMessage(){if(!this.issuesList)return;if(this.issuesList.querySelector("#no-issues-selected"))return;const e=document.createElement("div");e.id="no-issues-selected",e.textContent="No issues selected",e.style.color="#666",e.style.fontStyle="italic",this.issuesList.appendChild(e)}updateDisplay(){if(!this.issuesList)return void console.error("Issues list not initialized");if(this.issuesList.innerHTML="",!this.selectedIssues||0===this.selectedIssues.length){this.displayNoIssuesMessage();const e=this.issuesList.parentElement;return void(e&&(e.style.borderColor="#ccc",e.style.backgroundColor="#f9f9f9"))}const e=this.issuesList.parentElement;e&&(e.style.borderColor="#1f75cb",e.style.backgroundColor="rgba(31, 117, 203, 0.05)"),this.selectedIssues.forEach(((e,t)=>{if(!e)return;const s=document.createElement("div");s.className="selected-issue-item",s.style.padding="5px",s.style.marginBottom="3px",s.style.borderRadius="3px",s.style.backgroundColor="rgba(31, 117, 203, 0.1)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center";const n=document.createElement("div"),o=e.iid||"Unknown",i=e.title||"Untitled Issue";n.innerHTML=`<strong>#${o}</strong> - ${i}`,n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.style.whiteSpace="nowrap",n.style.marginRight="5px",s.appendChild(n);const l=document.createElement("button");l.textContent="×",l.style.backgroundColor="transparent",l.style.border="none",l.style.color="#dc3545",l.style.fontSize="16px",l.style.fontWeight="bold",l.style.cursor="pointer",l.style.padding="0 5px",l.title="Remove this issue",l.addEventListener("mouseenter",(()=>{l.style.color="#c82333"})),l.addEventListener("mouseleave",(()=>{l.style.color="#dc3545"})),l.onclick=e=>{e.stopPropagation(),this.removeIssue(t)},s.appendChild(l),this.issuesList.appendChild(s)})),console.log(`Updated selection display with ${this.selectedIssues.length} issues`)}removeIssue(t){if(t>=0&&t<this.selectedIssues.length){const s=this.selectedIssues[t];if(this.selectedIssues.splice(t,1),this.updateDisplay(),"function"==typeof this.onRemoveIssue)this.onRemoveIssue(t);else try{e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}catch(e){console.error("Error syncing with IssueSelector:",e)}console.log(`Removed issue at index ${t}:`,s)}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.updateDisplay(),console.log(`Set ${this.selectedIssues.length} selected issues in SelectionDisplay`)}getSelectedIssues(){return[...this.selectedIssues]}},e.IssueSelector=class IssueSelector{constructor(e={}){this.uiManager=e.uiManager,this.onSelectionChange=e.onSelectionChange||null,this.onSelectionComplete=e.onSelectionComplete||null,this.isSelectingIssue=!1,this.selectionOverlays=[],this.selectedOverlays=[],this.selectedIssues=e.initialSelection||[],document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isSelectingIssue&&this.exitSelectionMode()}))}startSelection(){if(console.log("Starting issue selection mode"),this.isSelectingIssue)return void console.log("Already in selection mode, ignoring duplicate call");this.isSelectingIssue=!0;const e=[...this.selectedIssues],t=document.getElementById("comment-status");t&&(t.textContent="Click on cards to select/deselect issues. Press ESC or click DONE when finished.",t.style.color="#1f75cb");const s=document.createElement("div");s.id="selection-page-overlay",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(0, 0, 0, 0.2)",s.style.zIndex="998",s.style.pointerEvents="none",document.body.appendChild(s),this.createCardOverlays(e),this.createCancelButton();const n=document.getElementById("select-issues-button");n&&(n.dataset.active="true",n.style.backgroundColor="#28a745",n.textContent="✓ Selecting..."),console.log(`Selection mode started with ${e.length} issues`)}createCancelButton(){const e=document.createElement("div");e.id="selection-cancel-button",e.textContent="DONE",e.style.position="fixed",e.style.bottom="20px",e.style.right="450px",e.style.backgroundColor="#6c757d",e.style.color="white",e.style.padding="10px 20px",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.zIndex="999",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)",e.style.transition="all 0.2s ease",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#5a6268",e.style.transform="translateY(-2px)",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#6c757d",e.style.transform="translateY(0)",e.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)"})),e.addEventListener("click",(e=>{e.stopPropagation(),this.exitSelectionMode()})),document.body.appendChild(e),this.selectionOverlays.push(e);const t=document.createElement("div");t.id="selection-counter",t.textContent=`${this.selectedIssues.length} issues selected`,t.style.position="fixed",t.style.bottom="20px",t.style.left="20px",t.style.backgroundColor=this.selectedIssues.length>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="8px 16px",t.style.borderRadius="20px",t.style.fontSize="14px",t.style.zIndex="999",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",document.body.appendChild(t),this.selectionOverlays.push(t)}createCardOverlays(e=[]){console.log("Creating card overlays for selection");const t=document.querySelectorAll(".board-card");console.log(`Found ${t.length} board cards to overlay`),this.selectedIssues=e||[],this.selectedOverlays=[],t.forEach(((t,s)=>{try{const n=t.getBoundingClientRect(),o=document.createElement("div");o.className="card-selection-overlay",o.style.position="absolute",o.style.left=`${n.left}px`,o.style.top=`${n.top}px`,o.style.width=`${n.width}px`,o.style.height=`${n.height}px`,o.style.backgroundColor="rgba(31, 117, 203, 0.2)",o.style.border="2px solid rgba(31, 117, 203, 0.6)",o.style.borderRadius="4px",o.style.zIndex="999",o.style.cursor="pointer",o.style.transition="background-color 0.2s ease",o.dataset.cardId=t.id||`card-${Date.now()}-${s}`,o.dataset.selected="false",o.originalCard=t;const i=this.getIssueItemFromCard(t);if(i&&(o.dataset.issueId=`${i.iid}-${i.referencePath}`,e.some((e=>e.iid===i.iid&&e.referencePath===i.referencePath)))){o.dataset.selected="true",o.style.backgroundColor="rgba(0, 177, 106, 0.3)",o.style.borderColor="rgba(0, 177, 106, 0.8)",o.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedOverlays.length+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",o.appendChild(t),this.selectedOverlays.push(o)}o.addEventListener("mouseenter",(()=>{"true"!==o.dataset.selected&&(o.style.backgroundColor="rgba(31, 117, 203, 0.3)",o.style.boxShadow="0 0 8px rgba(31, 117, 203, 0.5)")})),o.addEventListener("mouseleave",(()=>{"true"!==o.dataset.selected&&(o.style.backgroundColor="rgba(31, 117, 203, 0.2)",o.style.boxShadow="none")})),o.addEventListener("click",(e=>{e.stopPropagation(),this.toggleCardSelection(t,o)})),document.body.appendChild(o),this.selectionOverlays.push(o)}catch(e){console.error("Error creating overlay for card:",e)}}));const s=document.createElement("div");s.id="selection-help-text",s.textContent="Click on issues to select/deselect them • Press ESC or click DONE when finished",s.style.position="fixed",s.style.top="10px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.7)",s.style.color="white",s.style.padding="8px 16px",s.style.borderRadius="20px",s.style.fontSize="14px",s.style.zIndex="999",s.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",document.body.appendChild(s),this.selectionOverlays.push(s),this.updateSelectionCounter(),console.log(`Created ${this.selectionOverlays.length} selection overlays`)}updateSelectionCounter(){const e=document.getElementById("selection-counter");if(e){const t=this.selectedIssues.length;e.textContent=`${t} issue${1!==t?"s":""} selected`,e.style.backgroundColor=t>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)"}"function"==typeof this.onSelectionChange&&this.onSelectionChange(this.selectedIssues),this.syncSelectionWithBulkCommentsView()}getIssueItemFromCard(t){try{if(t.__vue__){if(t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$options&&t.__vue__.$options.children&&t.__vue__.$options.children.length>0){const e=t.__vue__.$options.children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$props&&t.__vue__.$props.item)return t.__vue__.$props.item}const s=t.querySelector("[data-issue-id]")?.dataset?.issueId,n=t.querySelector(".board-card-title");if(s&&n)return{iid:s,title:n.textContent.trim(),referencePath:e.location.pathname.split("/boards")[0]}}catch(e){console.error("Error getting issue item from card:",e)}return null}toggleCardSelection(e,t){if(!this.isSelectingIssue)return;const s=this.getIssueItemFromCard(e);if(s){console.log("Toggle selection for issue:",s.iid);if("true"===t.dataset.selected)t.dataset.selected="false",t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)",t.style.boxShadow="none",this.selectedIssues=this.selectedIssues.filter((e=>!(e.iid===s.iid&&e.referencePath===s.referencePath))),this.selectedOverlays=this.selectedOverlays.filter((e=>e!==t)),t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),this.renumberBadges();else{t.dataset.selected="true",t.style.backgroundColor="rgba(0, 177, 106, 0.3)",t.style.borderColor="rgba(0, 177, 106, 0.8)",t.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedIssues.length+1,n=document.createElement("div");n.className="selection-badge",n.textContent=e,n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.backgroundColor="rgba(0, 177, 106, 1)",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontWeight="bold",n.style.fontSize="12px",n.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),t.appendChild(n),this.selectedIssues.push(s),this.selectedOverlays.push(t)}this.updateSelectionCounter()}else{console.error("Failed to get issue item from card"),t.style.backgroundColor="rgba(220, 53, 69, 0.4)",t.style.borderColor="rgba(220, 53, 69, 0.8)",setTimeout((()=>{t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)"}),500);const e=document.getElementById("comment-status");e&&(e.textContent="Could not extract issue data from this card. Try another one.",e.style.color="#dc3545")}}renumberBadges(){this.selectedOverlays.forEach(((e,t)=>{const s=e.querySelector(".selection-badge");s&&(s.textContent=t+1)}))}exitSelectionMode(){console.log("Exiting selection mode"),this.isSelectingIssue=!1,document.getElementById("selection-page-overlay")?.remove(),this.selectionOverlays.forEach((e=>{e.remove()})),this.selectionOverlays=[],this.selectedOverlays=[];const e=document.getElementById("select-issues-button");e&&(e.dataset.active="false",e.style.backgroundColor="#6c757d",e.textContent="📎 Select Issues"),this.syncSelectionWithBulkCommentsView(),"function"==typeof this.onSelectionComplete&&this.onSelectionComplete(this.selectedIssues);const t=document.getElementById("comment-status");t&&(this.selectedIssues.length>0?(t.textContent=`${this.selectedIssues.length} issues selected.`,t.style.color="#28a745",t.style.backgroundColor="#f8f9fa",t.style.border="1px solid #e9ecef"):(t.textContent='No issues selected. Click "Select" to choose issues.',t.style.color="#666",t.style.backgroundColor="#f8f9fa",t.style.border="1px solid #e9ecef")),console.log(`Selection mode exited with ${this.selectedIssues.length} issues selected`)}toggleCardSelection(e,t){if(!this.isSelectingIssue)return;const s=this.getIssueItemFromCard(e);if(s){console.log("Toggle selection for issue:",s.iid);if("true"===t.dataset.selected)t.dataset.selected="false",t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)",t.style.boxShadow="none",this.selectedIssues=this.selectedIssues.filter((e=>!(e.iid===s.iid&&e.referencePath===s.referencePath))),this.selectedOverlays=this.selectedOverlays.filter((e=>e!==t)),t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),this.renumberBadges();else{t.dataset.selected="true",t.style.backgroundColor="rgba(0, 177, 106, 0.3)",t.style.borderColor="rgba(0, 177, 106, 0.8)",t.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedIssues.length+1,n=document.createElement("div");n.className="selection-badge",n.textContent=e,n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.backgroundColor="rgba(0, 177, 106, 1)",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontWeight="bold",n.style.fontSize="12px",n.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),t.appendChild(n),this.selectedIssues.push(s),this.selectedOverlays.push(t)}this.updateSelectionCounter(),this.syncSelectionWithBulkCommentsView()}else{console.error("Failed to get issue item from card"),t.style.backgroundColor="rgba(220, 53, 69, 0.4)",t.style.borderColor="rgba(220, 53, 69, 0.8)",setTimeout((()=>{t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)"}),500);const e=document.getElementById("comment-status");e&&(e.textContent="Could not extract issue data from this card. Try another one.",e.style.color="#dc3545")}}syncSelectionWithBulkCommentsView(){try{if(this.uiManager&&this.uiManager.bulkCommentsView)this.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else if(e.uiManager&&e.uiManager.bulkCommentsView)e.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else{const e=document.querySelector(".bulk-comments-view");e&&e.__vue__&&e.__vue__.setSelectedIssues?e.__vue__.setSelectedIssues([...this.selectedIssues]):console.warn("BulkCommentsView not found for synchronization")}}catch(e){console.error("Error syncing selection with bulk comments view:",e)}}repositionOverlays(){if(!this.isSelectingIssue)return;this.selectionOverlays.forEach((e=>{if("card-selection-overlay"===e.className&&e.originalCard){const t=e.originalCard.getBoundingClientRect();e.style.left=`${t.left}px`,e.style.top=`${t.top}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}}));const e=document.getElementById("selection-cancel-button");e&&(e.style.bottom="20px",e.style.right="380px");const t=document.getElementById("selection-counter");t&&(t.style.bottom="20px",t.style.left="20px")}getSelectedIssues(){return[...this.selectedIssues]}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.isSelectingIssue&&this.selectionOverlays.length>0&&this.updateOverlaysFromSelection();const t=document.getElementById("comment-status");if(t&&!this.isSelectingIssue){const e=this.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected.`,t.style.color="green"):(t.textContent='No issues selected. Click "Select" to choose issues.',t.style.color="#666")}this.syncSelectionWithBulkCommentsView(),console.log(`IssueSelector: Set ${this.selectedIssues.length} selected issues`)}updateOverlaysFromSelection(){if(this.isSelectingIssue)try{const e=this.selectionOverlays.filter((e=>"card-selection-overlay"===e.className));e.forEach((e=>{e.dataset&&e.originalCard&&(e.dataset.selected="false",e.style.backgroundColor="rgba(31, 117, 203, 0.2)",e.style.borderColor="rgba(31, 117, 203, 0.6)",e.style.boxShadow="none",e.querySelectorAll(".selection-badge").forEach((e=>e.remove())))})),this.selectedOverlays=[],this.selectedIssues.forEach(((t,s)=>{if(!t)return;const n=e.find((e=>!(!e.dataset||!e.dataset.issueId)&&e.dataset.issueId===`${t.iid}-${t.referencePath}`));if(n){n.dataset.selected="true",n.style.backgroundColor="rgba(0, 177, 106, 0.3)",n.style.borderColor="rgba(0, 177, 106, 0.8)",n.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=s+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",n.appendChild(t),this.selectedOverlays.push(n)}})),this.updateSelectionCounter()}catch(e){console.error("Error updating overlays from selection:",e)}}clearSelection(){this.selectedIssues=[],this.syncSelectionWithBulkCommentsView(),this.onSelectionChange&&this.onSelectionChange(this.selectedIssues)}},e.TabManager=class TabManager{constructor(uiManager){this.uiManager=uiManager,this.tabContainer=null,this.tabs={},this.contentAreas={};try{this.currentTab=getLastActiveTab()||"summary"}catch(e){console.warn("Error loading last active tab:",e),this.currentTab="summary"}console.log("Initial active tab:",this.currentTab)}initialize(e){this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.marginBottom="10px",this.tabContainer.style.borderBottom="1px solid #ddd",this.createTab("summary","Summary","summary"===this.currentTab),this.createTab("boards","Boards","boards"===this.currentTab),this.createTab("history","History","history"===this.currentTab),this.createTab("bulkcomments","Bulk Comments","bulkcomments"===this.currentTab),e.appendChild(this.tabContainer),this.createContentAreas(e)}createTab(e,t,s=!1){const n=document.createElement("div");n.textContent=t,n.dataset.tab=e,n.style.padding="5px 10px",n.style.cursor="pointer",s&&(n.style.borderBottom="2px solid #1f75cb",n.style.fontWeight="bold",this.currentTab=e),n.addEventListener("click",(()=>{this.switchToTab(e)})),this.tabs[e]=n,this.tabContainer.appendChild(n)}createContentAreas(e){const t=document.createElement("div");t.id="assignee-time-summary-content",t.style.display="summary"===this.currentTab?"block":"none",e.appendChild(t),this.contentAreas.summary=t;const s=document.createElement("div");s.id="boards-time-summary-content",s.style.display="boards"===this.currentTab?"block":"none",e.appendChild(s),this.contentAreas.boards=s;const n=document.createElement("div");n.id="history-time-summary-content",n.style.display="history"===this.currentTab?"block":"none",e.appendChild(n),this.contentAreas.history=n;const o=document.createElement("div");o.id="bulk-comments-content",o.style.display="bulkcomments"===this.currentTab?"block":"none",e.appendChild(o),this.contentAreas.bulkcomments=o}switchToTab(t){Object.keys(this.tabs).forEach((e=>{this.tabs[e].style.borderBottom="none",this.tabs[e].style.fontWeight="normal",this.contentAreas[e].style.display="none"})),this.tabs[t].style.borderBottom="2px solid #1f75cb",this.tabs[t].style.fontWeight="bold",this.contentAreas[t].style.display="block",this.currentTab=t;try{saveLastActiveTab(t)}catch(e){console.warn("Error saving tab selection:",e)}"history"===t&&"function"==typeof e.renderHistory?e.renderHistory():"bulkcomments"===t&&this.uiManager.bulkCommentsView&&this.uiManager.bulkCommentsView.render()}getContentArea(e){return this.contentAreas[e]}getCurrentTab(){return this.currentTab}},e.CommandManager=class CommandManager{constructor(e={}){this.targetElement=e.targetElement,this.gitlabApi=e.gitlabApi,this.labelManager=e.labelManager,this.onCommandInsert=e.onCommandInsert||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.shortcutContainer=null,this.commandShortcut=null}initialize(e){this.shortcutContainer=e,this.commandShortcut=new CommandShortcut({targetElement:this.targetElement,onShortcutInsert:(e,t)=>{console.log(`Shortcut inserted: ${e} with value ${t}`),"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}}),this.commandShortcut.initialize(e),this.addCustomShortcuts()}addCustomShortcuts(){this.commandShortcut&&(this.addMilestoneShortcut(),this.addAssignShortcut(),this.addDueDateShortcut(),this.addWeightShortcut())}addMilestoneShortcut(){this.commandShortcut.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"%backlog",label:"Backlog"},{value:"none",label:"Remove Milestone"}],onSelect:e=>{if(!this.targetElement)return;let t="/milestone ";"none"===e?t+='%""':e.startsWith("%")?t+=e:t+=`%"${e}"`;this.replaceOrInsertCommand("milestone",t,/\/milestone\s+%[^\n]+/g,(()=>this.insertTextAtCursor(t))),this.notification.info(`Milestone command added: ${e}`)}})}addAssignShortcut(){const e=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}];if(this.assigneeWhitelist&&this.assigneeWhitelist.length>0){const t=this.assigneeWhitelist.map((e=>({value:e.username,label:e.name||e.username})));e.push(...t)}e.push({value:"manage_whitelist",label:"✏️ Manage Assignees..."}),this.commandShortcut.addCustomShortcut({type:"assign",label:"/assign",items:e,onSelect:e=>{if("manage_whitelist"===e)return void this.openAssigneeManager();if(!this.targetElement)return;let t="/assign ";t+="none"===e?"@none":"@me"===e?"@me":e.startsWith("@")?e:`@${e}`;this.replaceOrInsertCommand("assign",t,/\/assign\s+@[^\n]+/g,(()=>this.insertTextAtCursor(t))),"none"===e?this.notification.info("Issue will be unassigned"):this.notification.info(`Issue will be assigned to ${e.replace("@","")}`)}})}addDueDateShortcut(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=new Date(e);s.setDate(s.getDate()+7);const n=new Date(e);n.setMonth(n.getMonth()+1);const formatDate=e=>e.toISOString().substring(0,10);this.commandShortcut.addCustomShortcut({type:"due",label:"/due",items:[{value:"",label:"Set Due Date"},{value:formatDate(e),label:"Today"},{value:formatDate(t),label:"Tomorrow"},{value:formatDate(s),label:"Next Week"},{value:formatDate(n),label:"Next Month"},{value:"custom",label:"Custom Date..."},{value:"none",label:"Remove Due Date"}],onSelect:t=>{if(!this.targetElement)return;if("custom"===t){const s=prompt("Enter due date (YYYY-MM-DD):",formatDate(e));if(!s)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(s))return void this.notification.error("Invalid date format. Please use YYYY-MM-DD");t=s}let s="/due ";s+="none"===t?"none":t;this.replaceOrInsertCommand("due",s,/\/due\s+[^\n]+/g,(()=>this.insertTextAtCursor(s))),"none"===t?this.notification.info("Due date will be removed"):this.notification.info(`Due date set to ${t}`)}})}addWeightShortcut(){this.commandShortcut.addCustomShortcut({type:"weight",label:"/weight",items:[{value:"",label:"Set Weight"},{value:"1",label:"1 (Trivial)"},{value:"2",label:"2 (Small)"},{value:"3",label:"3 (Medium)"},{value:"5",label:"5 (Large)"},{value:"8",label:"8 (Very Large)"},{value:"custom",label:"Custom Weight..."},{value:"none",label:"Remove Weight"}],onSelect:e=>{if(!this.targetElement)return;if("custom"===e){const t=prompt("Enter weight (number):","");if(!t)return;const s=parseInt(t,10);if(isNaN(s)||s<0)return void this.notification.error("Invalid weight. Please enter a positive number");e=t}let t="/weight ";t+="none"===e?"none":e;this.replaceOrInsertCommand("weight",t,/\/weight\s+[^\n]+/g,(()=>this.insertTextAtCursor(t))),"none"===e?this.notification.info("Weight will be removed"):this.notification.info(`Weight set to ${e}`)}})}openAssigneeManager(){const e=document.createElement("div");e.id="assignee-manager-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="1010",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="500px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(o);const i=document.createElement("div"),l=document.createElement("p");l.textContent="Add usernames to quickly assign issues. These will appear in your /assign dropdown.",l.style.marginBottom="15px";const a=document.createElement("div");a.style.marginBottom="15px",a.style.maxHeight="200px",a.style.overflowY="auto";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add some below.",e.style.color="#666",e.style.fontStyle="italic",e.style.padding="10px 0",e};this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="8px",s.style.borderBottom="1px solid #eee";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const o=document.createElement("div");o.textContent=e.name||e.username,o.style.fontWeight="bold",o.style.marginRight="5px";const i=document.createElement("div");i.textContent=`@${e.username}`,i.style.color="#666",i.style.fontSize="13px",n.appendChild(o),n.appendChild(i);const l=document.createElement("button");l.textContent="Remove",l.style.padding="3px 8px",l.style.backgroundColor="#dc3545",l.style.color="white",l.style.border="none",l.style.borderRadius="3px",l.style.cursor="pointer",l.onclick=()=>{this.assigneeWhitelist.splice(t,1),saveAssigneeWhitelist(this.assigneeWhitelist),s.remove(),0===this.assigneeWhitelist.length&&a.appendChild(createEmptyMessage())},s.appendChild(n),s.appendChild(l),a.appendChild(s)})),0===this.assigneeWhitelist.length&&a.appendChild(createEmptyMessage());const r=document.createElement("div");r.style.marginTop="20px",r.style.marginBottom="20px",r.style.padding="15px",r.style.backgroundColor="#f8f9fa",r.style.borderRadius="4px";const d=document.createElement("div");d.textContent="Add New Assignee",d.style.fontWeight="bold",d.style.marginBottom="10px";const c=document.createElement("div");c.style.marginBottom="10px";const u=document.createElement("label");u.textContent="Display Name:",u.style.display="block",u.style.marginBottom="5px";const h=document.createElement("input");h.type="text",h.placeholder="John Doe",h.style.width="100%",h.style.padding="8px",h.style.borderRadius="4px",h.style.border="1px solid #ccc",c.appendChild(u),c.appendChild(h);const p=document.createElement("div");p.style.marginBottom="15px";const m=document.createElement("label");m.textContent="GitLab Username:",m.style.display="block",m.style.marginBottom="5px";const y=document.createElement("input");y.type="text",y.placeholder="username (without @)",y.style.width="100%",y.style.padding="8px",y.style.borderRadius="4px",y.style.border="1px solid #ccc",p.appendChild(m),p.appendChild(y);const g=document.createElement("button");g.textContent="Add Assignee",g.style.padding="8px 16px",g.style.backgroundColor="#28a745",g.style.color="white",g.style.border="none",g.style.borderRadius="4px",g.style.cursor="pointer",g.onclick=()=>{const e=h.value.trim(),t=y.value.trim();if(!t)return void alert("Username is required");const s={name:e||t,username:t},n=this.assigneeWhitelist.findIndex((e=>e.username===t));n>=0?this.assigneeWhitelist[n]=s:this.assigneeWhitelist.push(s),saveAssigneeWhitelist(this.assigneeWhitelist);const o=a.querySelector('div[style*="italic"]');o&&o.remove();const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="8px",i.style.borderBottom="1px solid #eee";const l=document.createElement("div");l.style.display="flex",l.style.alignItems="center";const r=document.createElement("div");r.textContent=s.name,r.style.fontWeight="bold",r.style.marginRight="5px";const d=document.createElement("div");d.textContent=`@${s.username}`,d.style.color="#666",d.style.fontSize="13px",l.appendChild(r),l.appendChild(d);const c=document.createElement("button");c.textContent="Remove",c.style.padding="3px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="3px",c.style.cursor="pointer",c.onclick=()=>{const e=this.assigneeWhitelist.findIndex((e=>e.username===s.username));e>=0&&(this.assigneeWhitelist.splice(e,1),saveAssigneeWhitelist(this.assigneeWhitelist),i.remove(),0===this.assigneeWhitelist.length&&a.appendChild(createEmptyMessage()))},i.appendChild(l),i.appendChild(c),a.appendChild(i),h.value="",y.value="",this.notification.success(`Added assignee: ${s.name}`)},r.appendChild(d),r.appendChild(c),r.appendChild(p),r.appendChild(g);const b=document.createElement("button");b.textContent="Close",b.style.padding="8px 16px",b.style.backgroundColor="#6c757d",b.style.color="white",b.style.border="none",b.style.borderRadius="4px",b.style.cursor="pointer",b.style.marginTop="10px",b.onclick=()=>{e.remove(),this.addAssignShortcut()},i.appendChild(l),i.appendChild(a),i.appendChild(r),i.appendChild(b),t.appendChild(s),t.appendChild(i),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&(e.remove(),this.addAssignShortcut())}))}insertTextAtCursor(e){if(!this.targetElement)return;const t=this.targetElement.selectionStart,s=this.targetElement.selectionEnd,n=this.targetElement.value;let o=e;t>0&&"\n"!==n.charAt(t-1)&&n.length>0&&(o="\n"+o),this.targetElement.value=n.substring(0,t)+o+n.substring(s);const i=t+o.length;this.targetElement.setSelectionRange(i,i),this.targetElement.focus()}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const o=this.targetElement.value;if(s.test(o)){const e=o.replace(s,t);this.targetElement.value=e,this.targetElement.focus()}else n();"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}},e.LabelManager=class LabelManager{constructor(t={}){this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onLabelsLoaded=t.onLabelsLoaded||null,this.labelWhitelist=getLabelWhitelist(),this.availableLabels=[],this.filteredLabels=[],this.isLoading=!1}saveWhitelist(e){this.labelWhitelist=e,saveLabelWhitelist(e),this.filterLabels()}resetToDefaultWhitelist(){this.labelWhitelist=resetLabelWhitelist(),this.filterLabels()}isLabelInWhitelist(e,t=this.labelWhitelist){Array.isArray(t)||(console.warn("Whitelist is not an array, using empty array instead"),t=[]);const s=e.toLowerCase();return t.some((e=>s.includes(e.toLowerCase())))}filterLabels(){this.availableLabels&&0!==this.availableLabels.length?(this.filteredLabels=this.availableLabels.filter((e=>this.isLabelInWhitelist(e.name))),this.filteredLabels.sort(((e,t)=>e.name.localeCompare(t.name))),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels)):this.filteredLabels=[]}async fetchAllLabels(){try{if(this.isLoading=!0,this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)return console.warn("GitLab API instance not available, using fallback labels"),this.isLoading=!1,this.addFallbackLabels();const t=getPathFromUrl();if(!t)return console.warn("Path info not found, returning empty labels array"),this.isLoading=!1,this.addFallbackLabels();try{const e=await this.gitlabApi.callGitLabApi(t.apiUrl,{params:{per_page:100}});return this.availableLabels=e,this.filterLabels(),this.isLoading=!1,e}catch(e){return console.error(`Error fetching ${t.type} labels from API:`,e),this.isLoading=!1,this.addFallbackLabels()}}catch(e){return console.error("Error in fetchAllLabels:",e),this.isLoading=!1,this.addFallbackLabels()}}getLabelOptions(e=!0){const t=this.filteredLabels.map((e=>({value:e.name,label:e.name,color:e.color})));return e&&t.unshift({value:"",label:"Add Label"}),t}createStyledLabel(e){const t=document.createElement("span");t.textContent=e.label||e.name;const s=e.color||generateColorFromString(e.label||e.name),n=getContrastColor(s);return t.style.backgroundColor=s,t.style.color=n,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}insertLabelCommand(e,t){if(!e)return;const s=`/label ~${t}`,n=/\/label\s+~[^\n]+/g,o=e.value;if(n.test(o))e.value=o.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let i=s;t>0&&"\n"!==o.charAt(t-1)&&o.length>0&&(i="\n"+i),e.value=o.substring(0,t)+i+o.substring(n);const l=t+i.length;e.setSelectionRange(l,l)}e.focus()}async initLabelDropdown(e,t={}){const s=e({items:[{value:"",label:"Loading labels..."}],disabled:!0,...t});try{await this.fetchAllLabels(),s.updateItems(this.getLabelOptions()),s.enable()}catch(e){console.error("Error initializing label dropdown:",e),s.updateItems([{value:"",label:"Error loading labels"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"}]),s.enable()}return s}addFallbackLabels(){return this.filteredLabels=[{value:"",label:"Add Label"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"documentation",label:"Documentation"}].map((e=>({name:e.label,color:generateColorFromString(e.label)}))),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels),this.filteredLabels}},e.AssigneeManager=class AssigneeManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onAssigneesChange=e.onAssigneesChange||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.currentUsers=[],this.isLoading=!1}getAssigneeWhitelist(){return[...this.assigneeWhitelist]}saveWhitelist(e){this.assigneeWhitelist=e,saveAssigneeWhitelist(e),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist)}addAssignee(e){if(!e||!e.username)return!1;const t=this.assigneeWhitelist.findIndex((t=>t.username.toLowerCase()===e.username.toLowerCase()));return t>=0?this.assigneeWhitelist[t]={...this.assigneeWhitelist[t],...e}:this.assigneeWhitelist.push(e),saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0}removeAssignee(e){if(!e)return!1;const t=this.assigneeWhitelist.length;return this.assigneeWhitelist=this.assigneeWhitelist.filter((t=>t.username.toLowerCase()!==e.toLowerCase())),this.assigneeWhitelist.length!==t&&(saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0)}async fetchCurrentUser(){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");try{const e=await this.gitlabApi.getCurrentUser();return this.addAssignee({name:e.name,username:e.username}),e}catch(e){throw console.error("Error fetching current user:",e),e}}async fetchProjectMembers(e){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");if(!e)throw new Error("Project ID is required");try{this.isLoading=!0;const t=await this.gitlabApi.callGitLabApi(`projects/${encodeURIComponent(e)}/members`,{params:{per_page:100}});return this.currentUsers=t.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.isLoading=!1,this.currentUsers}catch(t){throw console.error(`Error fetching members for project ${e}:`,t),this.isLoading=!1,t}}async fetchGroupMembers(e){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");if(!e)throw new Error("Group ID is required");try{this.isLoading=!0;const t=await this.gitlabApi.callGitLabApi(`groups/${encodeURIComponent(e)}/members`,{params:{per_page:100}});return this.currentUsers=t.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.isLoading=!1,this.currentUsers}catch(t){throw console.error(`Error fetching members for group ${e}:`,t),this.isLoading=!1,t}}insertAssignCommand(e,t){if(!e)return;let s="/assign ";s+=t&&"none"!==t?"me"===t?"@me":t.startsWith("@")?t:`@${t}`:"@none";const n=/\/assign\s+@[^\n]+/g,o=e.value;if(n.test(o))e.value=o.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let i=s;t>0&&"\n"!==o.charAt(t-1)&&o.length>0&&(i="\n"+i),e.value=o.substring(0,t)+i+o.substring(n);const l=t+i.length;e.setSelectionRange(l,l)}e.focus(),"none"===t?this.notification.info("Issue will be unassigned"):"me"===t?this.notification.info("Issue will be assigned to you"):this.notification.info(`Issue will be assigned to ${t.replace("@","")}`)}createAssigneeOption(e,t){const s=document.createElement("div");if(s.className="assignee-option",s.style.padding="8px 12px",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""})),e.avatar_url){const t=document.createElement("img");t.src=e.avatar_url,t.alt=e.name||e.username,t.style.width="24px",t.style.height="24px",t.style.borderRadius="50%",t.style.marginRight="8px",s.appendChild(t)}else{const t=document.createElement("div");t.style.width="24px",t.style.height="24px",t.style.borderRadius="50%",t.style.backgroundColor="#e0e0e0",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.marginRight="8px",t.style.fontSize="12px",t.style.fontWeight="bold",t.style.color="#666";const n=(e.name||e.username||"").split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();t.textContent=n,s.appendChild(t)}const n=document.createElement("div"),o=document.createElement("div");if(o.textContent=e.name||e.username,o.style.fontWeight="bold",n.appendChild(o),e.username&&"none"!==e.username&&"me"!==e.username&&e.name&&e.name!==e.username){const t=document.createElement("div");t.textContent=`@${e.username}`,t.style.fontSize="12px",t.style.color="#666",n.appendChild(t)}return s.appendChild(n),"function"==typeof t&&s.addEventListener("click",t),s}openAssigneeSelector(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.zIndex="1010",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";const s=document.createElement("div");s.style.backgroundColor="white",s.style.borderRadius="6px",s.style.padding="20px",s.style.width="600px",s.style.maxWidth="90%",s.style.maxHeight="80vh",s.style.overflow="auto",s.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.marginBottom="15px",n.style.borderBottom="1px solid #eee",n.style.paddingBottom="10px";const o=document.createElement("h3");o.textContent="Select Assignee",o.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>t.remove(),n.appendChild(o),n.appendChild(i);const l=document.createElement("div"),a=document.createElement("div");a.style.marginBottom="20px";const r=this.createAssigneeOption({name:"Unassign",username:"none"},(()=>{this.insertAssignCommand(e,"none"),t.remove()})),d=this.createAssigneeOption({name:"Assign to me",username:"me"},(()=>{this.insertAssignCommand(e,"me"),t.remove()}));a.appendChild(r),a.appendChild(d);const c=document.createElement("div");c.style.borderBottom="1px solid #eee",c.style.marginBottom="15px";const u=document.createElement("div");u.style.marginBottom="20px";const h=document.createElement("h4");if(h.textContent="Saved Assignees",h.style.marginBottom="10px",h.style.fontSize="16px",u.appendChild(h),this.assigneeWhitelist.length>0){const s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns="repeat(auto-fill, minmax(250px, 1fr))",s.style.gap="8px",this.assigneeWhitelist.forEach((n=>{const o=this.createAssigneeOption(n,(()=>{this.insertAssignCommand(e,n.username),t.remove()}));s.appendChild(o)})),u.appendChild(s)}else{const e=document.createElement("p");e.textContent="No saved assignees. Add some below.",e.style.color="#666",e.style.fontStyle="italic",u.appendChild(e)}const p=document.createElement("div");p.style.marginTop="20px",p.style.padding="15px",p.style.backgroundColor="#f8f9fa",p.style.borderRadius="4px";const m=document.createElement("h4");m.textContent="Add New Assignee",m.style.marginBottom="15px",m.style.fontSize="16px";const y=document.createElement("div");y.style.marginBottom="10px";const g=document.createElement("label");g.textContent="Display Name:",g.style.display="block",g.style.marginBottom="5px";const b=document.createElement("input");b.type="text",b.placeholder="John Doe",b.style.width="100%",b.style.padding="8px",b.style.borderRadius="4px",b.style.border="1px solid #ccc",y.appendChild(g),y.appendChild(b);const f=document.createElement("div");f.style.marginBottom="15px";const C=document.createElement("label");C.textContent="GitLab Username:",C.style.display="block",C.style.marginBottom="5px";const x=document.createElement("input");x.type="text",x.placeholder="username (without @)",x.style.width="100%",x.style.padding="8px",x.style.borderRadius="4px",x.style.border="1px solid #ccc",f.appendChild(C),f.appendChild(x);const v=document.createElement("div");v.style.display="flex",v.style.justifyContent="flex-end";const E=document.createElement("button");E.textContent="Add Assignee",E.style.padding="8px 16px",E.style.backgroundColor="#28a745",E.style.color="white",E.style.border="none",E.style.borderRadius="4px",E.style.cursor="pointer",E.onclick=()=>{const s=b.value.trim(),n=x.value.trim();if(!n)return void this.notification.error("Username is required");const o={name:s||n,username:n};this.addAssignee(o),this.notification.success(`Added assignee: ${o.name}`),t.remove(),this.openAssigneeSelector(e)},v.appendChild(E),p.appendChild(m),p.appendChild(y),p.appendChild(f),p.appendChild(v),l.appendChild(a),l.appendChild(c),l.appendChild(u),l.appendChild(p),s.appendChild(n),s.appendChild(l),t.appendChild(s),document.body.appendChild(t),t.addEventListener("click",(e=>{e.target===t&&t.remove()}))}openAssigneeManager(){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="1010",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="600px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(o);const i=document.createElement("div"),l=document.createElement("p");l.textContent="Manage assignees that appear in the assignee dropdown. These users will be available for quick assignment to issues.",l.style.marginBottom="20px";const a=document.createElement("div");a.style.marginBottom="20px";const r=document.createElement("h4");r.textContent="Current Assignees",r.style.marginBottom="10px",r.style.fontSize="16px",a.appendChild(r);const d=document.createElement("div");if(d.style.maxHeight="300px",d.style.overflowY="auto",d.style.border="1px solid #eee",d.style.borderRadius="4px",this.assigneeWhitelist.length>0)this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="10px",s.style.borderBottom=t<this.assigneeWhitelist.length-1?"1px solid #eee":"none";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const o=document.createElement("div");o.style.width="32px",o.style.height="32px",o.style.borderRadius="50%",o.style.backgroundColor="#e0e0e0",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.marginRight="10px",o.style.fontSize="14px",o.style.fontWeight="bold",o.style.color="#666";const i=(e.name||e.username||"").split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();o.textContent=i,n.appendChild(o);const l=document.createElement("div"),a=document.createElement("div");a.textContent=e.name||e.username,a.style.fontWeight="bold";const r=document.createElement("div");r.textContent=`@${e.username}`,r.style.fontSize="12px",r.style.color="#666",l.appendChild(a),l.appendChild(r),n.appendChild(l);const c=document.createElement("button");c.textContent="Remove",c.style.padding="4px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=()=>{if(this.removeAssignee(e.username),s.remove(),this.notification.info(`Removed assignee: ${e.name||e.username}`),0===this.assigneeWhitelist.length){const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}},s.appendChild(n),s.appendChild(c),d.appendChild(s)}));else{const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}a.appendChild(d);const c=document.createElement("div");c.style.marginTop="20px",c.style.padding="15px",c.style.backgroundColor="#f8f9fa",c.style.borderRadius="4px";const u=document.createElement("h4");u.textContent="Add New Assignee",u.style.marginBottom="15px",u.style.fontSize="16px";const h=document.createElement("div");h.style.marginBottom="10px";const p=document.createElement("label");p.textContent="Display Name:",p.style.display="block",p.style.marginBottom="5px";const m=document.createElement("input");m.type="text",m.placeholder="John Doe",m.style.width="100%",m.style.padding="8px",m.style.borderRadius="4px",m.style.border="1px solid #ccc",h.appendChild(p),h.appendChild(m);const y=document.createElement("div");y.style.marginBottom="15px";const g=document.createElement("label");g.textContent="GitLab Username:",g.style.display="block",g.style.marginBottom="5px";const b=document.createElement("input");b.type="text",b.placeholder="username (without @)",b.style.width="100%",b.style.padding="8px",b.style.borderRadius="4px",b.style.border="1px solid #ccc",y.appendChild(g),y.appendChild(b);const f=document.createElement("div");f.style.display="flex",f.style.justifyContent="space-between";const C=document.createElement("button");C.textContent="Add Assignee",C.style.padding="8px 16px",C.style.backgroundColor="#28a745",C.style.color="white",C.style.border="none",C.style.borderRadius="4px",C.style.cursor="pointer",C.onclick=()=>{const t=m.value.trim(),s=b.value.trim();if(!s)return void this.notification.error("Username is required");const n={name:t||s,username:s};this.addAssignee(n),this.notification.success(`Added assignee: ${n.name}`),e.remove(),this.openAssigneeManager()};const x=document.createElement("button");x.textContent="Add Current User",x.style.padding="8px 16px",x.style.backgroundColor="#17a2b8",x.style.color="white",x.style.border="none",x.style.borderRadius="4px",x.style.cursor="pointer",x.style.marginRight="10px",x.onclick=async()=>{x.disabled=!0,x.textContent="Loading...";try{const t=await this.fetchCurrentUser();this.notification.success(`Added current user: ${t.name}`),e.remove(),this.openAssigneeManager()}catch(e){this.notification.error("Failed to fetch current user"),x.disabled=!1,x.textContent="Add Current User"}},f.appendChild(x),f.appendChild(C),c.appendChild(u),c.appendChild(h),c.appendChild(y),c.appendChild(f);const v=document.createElement("div");v.style.marginTop="20px",v.style.display="flex",v.style.justifyContent="flex-end";const E=document.createElement("button");E.textContent="Close",E.style.padding="8px 16px",E.style.backgroundColor="#6c757d",E.style.color="white",E.style.border="none",E.style.borderRadius="4px",E.style.cursor="pointer",E.onclick=()=>{e.remove()},v.appendChild(E),i.appendChild(l),i.appendChild(a),i.appendChild(c),i.appendChild(v),t.appendChild(s),t.appendChild(i),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}},e.MilestoneManager=class MilestoneManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onMilestonesLoaded=e.onMilestonesLoaded||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.milestones=[],this.currentMilestone=null,this.isLoading=!1}async fetchMilestones(e="active"){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");try{this.isLoading=!0;const t=getPathFromUrl();if(!t)return console.warn("Could not determine project/group path"),this.isLoading=!1,[];const s=`${t.type}s/${t.encodedPath}/milestones`,n=await this.gitlabApi.callGitLabApi(s,{params:{state:e,per_page:100,order_by:"due_date"}});return this.milestones=n.map((e=>({id:e.id,iid:e.iid,title:e.title,description:e.description,state:e.state,due_date:e.due_date,start_date:e.start_date,web_url:e.web_url}))),this.isLoading=!1,"function"==typeof this.onMilestonesLoaded&&this.onMilestonesLoaded(this.milestones),this.milestones}catch(e){throw console.error("Error fetching milestones:",e),this.isLoading=!1,e}}getMilestone(e){return e?"number"==typeof e||/^\d+$/.test(e)?this.milestones.find((t=>t.id===parseInt(e)||t.iid===parseInt(e))):this.milestones.find((t=>t.title===e)):null}getCurrentMilestone(){if(0===this.milestones.length)return null;const e=new Date;e.setHours(0,0,0,0);const t=this.milestones.filter((t=>"active"===t.state&&t.due_date&&new Date(t.due_date)>=e));if(t.length>0)return t.sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date)))[0];const s=this.milestones.filter((e=>"active"===e.state));return s.length>0?s[0]:null}getNextMilestone(){const e=this.getCurrentMilestone();if(!e||!e.due_date){const e=this.milestones.filter((e=>"active"===e.state));return e.length>0?e[0]:null}const t=new Date(e.due_date),s=this.milestones.filter((e=>"active"===e.state&&e.due_date&&new Date(e.due_date)>t));return s.length>0?s.sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date)))[0]:null}getUpcomingMilestones(e=5){const t=this.getCurrentMilestone(),s=this.getNextMilestone();return this.milestones.filter((e=>{if(!e.due_date||"active"!==e.state)return!1;if(t&&e.id===t.id)return!1;if(s&&e.id===s.id)return!1;const n=new Date(e.due_date),o=new Date;return o.setHours(0,0,0,0),n>=o})).sort(((e,t)=>new Date(e.due_date)-new Date(t.due_date))).slice(0,e)}getMilestoneOptions(){const e=[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"none",label:"Remove Milestone"}];if(this.milestones.length>0){e.push({value:"separator",label:"─────────────"});const t=this.milestones.filter((e=>"active"===e.state)).map((e=>({value:e.title,label:e.title,dueDate:e.due_date})));e.push(...t)}return e}insertMilestoneCommand(e,t){if(!e)return;let s="/milestone ";"none"===t?s+='%""':t.startsWith("%")?s+=t:s+=`%"${t}"`;const n=/\/milestone\s+%[^\n]+/g,o=e.value;if(n.test(o))e.value=o.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let i=s;t>0&&"\n"!==o.charAt(t-1)&&o.length>0&&(i="\n"+i),e.value=o.substring(0,t)+i+o.substring(n);const l=t+i.length;e.setSelectionRange(l,l)}if(e.focus(),"none"===t)this.notification.info("Milestone will be removed");else{const e=t.startsWith("%")?t.substring(1):t;this.notification.info(`Milestone set to ${e}`)}}createMilestoneOption(e,t){const s=document.createElement("div");s.className="milestone-option",s.style.padding="10px",s.style.borderRadius="4px",s.style.border="1px solid #dee2e6",s.style.cursor="pointer",s.style.transition="background-color 0.2s ease",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="#f5f5f5"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=""}));const n=document.createElement("div");if(n.className="milestone-title",n.textContent=e.label,n.style.fontWeight="bold",n.style.fontSize="14px",n.style.marginBottom="5px",s.appendChild(n),e.dueDate){const t=document.createElement("div");t.className="milestone-due-date";const n=new Date(e.dueDate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});t.textContent=`Due: ${n}`,t.style.fontSize="12px",t.style.color="#6c757d",t.style.marginBottom="5px",s.appendChild(t)}if(e.description){const t=document.createElement("div");t.className="milestone-description";let n=e.description;n.length>100&&(n=n.substring(0,97)+"..."),t.textContent=n,t.style.fontSize="12px",t.style.color="#6c757d",s.appendChild(t)}if(e.state){const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="flex-end",t.style.marginTop="5px";const n=document.createElement("span");n.className="milestone-state",n.textContent=e.state,n.style.fontSize="11px",n.style.padding="2px 6px",n.style.borderRadius="10px",n.style.textTransform="capitalize","active"===e.state?(n.style.backgroundColor="#28a745",n.style.color="white"):"closed"===e.state&&(n.style.backgroundColor="#6c757d",n.style.color="white"),t.appendChild(n),s.appendChild(t)}return"function"==typeof t&&s.addEventListener("click",t),s}openMilestoneSelector(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.zIndex="1010",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";const s=document.createElement("div");s.style.backgroundColor="white",s.style.borderRadius="6px",s.style.padding="20px",s.style.width="600px",s.style.maxWidth="90%",s.style.maxHeight="80vh",s.style.overflow="auto",s.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.marginBottom="15px",n.style.borderBottom="1px solid #eee",n.style.paddingBottom="10px";const o=document.createElement("h3");o.textContent="Select Milestone",o.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>t.remove(),n.appendChild(o),n.appendChild(i);const l=document.createElement("div"),a=document.createElement("div");a.style.marginBottom="15px";const r=document.createElement("input");r.type="text",r.placeholder="Search milestones...",r.style.width="100%",r.style.padding="8px",r.style.borderRadius="4px",r.style.border="1px solid #ccc",a.appendChild(r),l.appendChild(a);const d=document.createElement("div");d.style.marginBottom="20px";[{value:"%current",label:"Current Sprint",description:"The active milestone with the closest due date"},{value:"%next",label:"Next Sprint",description:"The milestone following the current one"},{value:"%upcoming",label:"Upcoming",description:"Future milestones beyond the next one"},{value:"none",label:"Remove Milestone",description:"Clear the milestone from this issue"}].forEach((s=>{const n=this.createMilestoneOption(s,(()=>{this.insertMilestoneCommand(e,s.value),t.remove()}));d.appendChild(n)}));const c=document.createElement("div");c.style.borderBottom="1px solid #eee",c.style.margin="20px 0";const u=document.createElement("div");u.textContent="Loading milestones...",u.style.textAlign="center",u.style.padding="20px",u.style.color="#666";const h=document.createElement("div"),p=document.createElement("h4");p.textContent="Project Milestones",p.style.marginBottom="10px",h.appendChild(p),h.appendChild(u);const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="flex-end",m.style.marginTop="20px";const y=document.createElement("button");y.textContent="Refresh Milestones",y.style.padding="6px 12px",y.style.backgroundColor="#6c757d",y.style.color="white",y.style.border="none",y.style.borderRadius="4px",y.style.cursor="pointer",m.appendChild(y),l.appendChild(d),l.appendChild(c),l.appendChild(h),l.appendChild(m),s.appendChild(n),s.appendChild(l),t.appendChild(s),document.body.appendChild(t),t.addEventListener("click",(e=>{e.target===t&&t.remove()})),this.fetchMilestones().then((s=>{if(u.remove(),0===s.length){const e=document.createElement("div");return e.textContent="No milestones found for this project.",e.style.textAlign="center",e.style.padding="20px",e.style.color="#666",void h.appendChild(e)}const n=document.createElement("div");n.style.display="grid",n.style.gap="10px",n.style.gridTemplateColumns="1fr",s.forEach((s=>{const o=this.createMilestoneOption({value:s.title,label:s.title,description:s.description,dueDate:s.due_date,state:s.state},(()=>{this.insertMilestoneCommand(e,s.title),t.remove()}));n.appendChild(o)})),h.appendChild(n),r.addEventListener("input",(()=>{const e=r.value.toLowerCase();Array.from(n.children).forEach((t=>{const s=t.querySelector(".milestone-title"),n=t.querySelector(".milestone-description");if(!s)return;const o=s.textContent.toLowerCase(),i=n?n.textContent.toLowerCase():"";o.includes(e)||i.includes(e)?t.style.display="":t.style.display="none"}))})),y.addEventListener("click",(()=>{n.innerHTML="",n.appendChild(u),u.style.display="block",this.fetchMilestones().then((s=>{u.style.display="none",n.innerHTML="",s.forEach((s=>{const o=this.createMilestoneOption({value:s.title,label:s.title,description:s.description,dueDate:s.due_date,state:s.state},(()=>{this.insertMilestoneCommand(e,s.title),t.remove()}));n.appendChild(o)})),this.notification.success("Milestones refreshed")})).catch((e=>{console.error("Error refreshing milestones:",e),u.style.display="none";const t=document.createElement("div");t.textContent="Error refreshing milestones.",t.style.color="#dc3545",t.style.textAlign="center",t.style.padding="10px",n.innerHTML="",n.appendChild(t),this.notification.error("Failed to refresh milestones")}))}))})).catch((e=>{console.error("Error loading milestones:",e),u.textContent="Error loading milestones.",u.style.color="#dc3545"}))}},e.SettingsManager=class SettingsManager{constructor(t={}){this.labelManager=t.labelManager,this.assigneeManager=t.assigneeManager,this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onSettingsChanged=t.onSettingsChanged||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.availableAssignees=[],this.isLoadingAssignees=!1}openSettingsModal(){const e=document.createElement("div");e.id="git-helper-settings-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="1010",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="700px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Settings",n.style.margin="0";const o=document.createElement("button");o.innerHTML="&times;",o.style.backgroundColor="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.padding="0 5px",o.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(o);const i=document.createElement("div");this.createCollapsibleSection(i,"Assignees","Manage assignees for quick access in comments",(e=>this.createAssigneeSettings(e)),!0),this.createCollapsibleSection(i,"Labels","Manage which labels appear in the dropdown menus",(e=>this.createLabelWhitelistSettings(e)),!1),this.createCollapsibleSection(i,"Appearance","Customize the appearance of GitLab Sprint Helper",(e=>this.createAppearanceSettings(e)),!1);const l=document.createElement("div");l.style.marginTop="20px",l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.borderTop="1px solid #eee",l.style.paddingTop="15px";const a=document.createElement("button");a.textContent="Reset to Defaults",a.style.padding="8px 16px",a.style.backgroundColor="#6c757d",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.onclick=()=>{confirm("Are you sure you want to reset all settings to default values?")&&(this.resetAllSettings(),e.remove(),this.notification.success("Settings reset to defaults"))};const r=document.createElement("button");r.textContent="Close",r.style.padding="8px 16px",r.style.backgroundColor="#28a745",r.style.color="white",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.onclick=()=>{e.remove()},l.appendChild(a),l.appendChild(r),t.appendChild(s),t.appendChild(i),t.appendChild(l),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}createCollapsibleSection(e,t,s,n,o=!1){const i=document.createElement("div");i.className="settings-section",i.style.marginBottom="15px",i.style.border="1px solid #ddd",i.style.borderRadius="6px",i.style.overflow="hidden";const l=document.createElement("div");l.className="settings-section-header",l.style.padding="12px 15px",l.style.backgroundColor="#f8f9fa",l.style.borderBottom="none",l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.cursor="pointer",l.style.transition="background-color 0.2s ease",l.addEventListener("mouseenter",(()=>{l.style.backgroundColor="#e9ecef"})),l.addEventListener("mouseleave",(()=>{l.style.backgroundColor="#f8f9fa"}));const a=document.createElement("div"),r=document.createElement("h4");r.textContent=t,r.style.margin="0",r.style.fontSize="16px";const d=document.createElement("div");d.textContent=s,d.style.fontSize="13px",d.style.color="#6c757d",d.style.marginTop="4px",a.appendChild(r),a.appendChild(d);const c=document.createElement("span");c.textContent="▶",c.style.fontSize="14px",c.style.transition="transform 0.3s ease",l.appendChild(a),l.appendChild(c);const u=document.createElement("div");u.className="settings-section-content",u.style.padding="15px",u.style.display="none",u.style.backgroundColor="white";let h=!1;return l.addEventListener("click",(()=>{const e="block"===u.style.display;u.style.display=e?"none":"block",c.textContent=e?"▶":"▼",l.style.borderBottom=e?"none":"1px solid #ddd",h||e||(n(u),h=!0)})),i.appendChild(l),i.appendChild(u),e.appendChild(i),i}createAssigneeSettings(e){const t=document.createElement("div"),s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.marginBottom="15px",s.style.gap="10px";const n=document.createElement("div");n.style.flex="1";const o=document.createElement("input");o.type="text",o.placeholder="Search assignees...",o.style.width="100%",o.style.padding="8px 10px",o.style.borderRadius="4px",o.style.border="1px solid #ccc",n.appendChild(o);const i=document.createElement("button");i.textContent="Fetch GitLab Users",i.style.padding="8px 12px",i.style.backgroundColor="#1f75cb",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.onclick=()=>this.fetchGitLabUsers(h),s.appendChild(n),s.appendChild(i),t.appendChild(s);const l=document.createElement("div");l.style.display="flex",l.style.borderBottom="1px solid #dee2e6",l.style.marginBottom="15px";const a=[{id:"whitelisted",label:"My Assignees",active:!0},{id:"available",label:"Available Users",active:!1}],r={},d={};a.forEach((e=>{const t=document.createElement("div");t.textContent=e.label,t.style.padding="8px 15px",t.style.cursor="pointer",t.style.transition="all 0.2s ease",e.active&&(t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold"),t.addEventListener("mouseenter",(()=>{e.active||(t.style.backgroundColor="#f5f5f5")})),t.addEventListener("mouseleave",(()=>{e.active||(t.style.backgroundColor="")})),t.addEventListener("click",(()=>{a.forEach((e=>{e.active=!1,r[e.id].style.borderBottom="none",r[e.id].style.fontWeight="normal",r[e.id].style.backgroundColor="",d[e.id].style.display="none"})),e.active=!0,t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold",d[e.id].style.display="block","available"===e.id&&0===this.availableAssignees.length&&this.fetchGitLabUsers(m)})),r[e.id]=t,l.appendChild(t)})),t.appendChild(l);const c=document.createElement("div");c.style.display="block";const u=document.createElement("div");u.style.display="none";const h=document.createElement("div");h.style.maxHeight="300px",h.style.overflowY="auto",h.style.border="1px solid #eee",h.style.borderRadius="4px";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};let p=[];p=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),p.length>0?p.forEach(((e,t)=>{h.appendChild(this.createAssigneeListItem(e,t,h,createEmptyMessage))})):h.appendChild(createEmptyMessage()),c.appendChild(h),c.appendChild(this.createAddAssigneeForm(h,createEmptyMessage));const m=document.createElement("div");m.className="available-assignees-list",m.style.maxHeight="400px",m.style.overflowY="auto",m.style.border="1px solid #eee",m.style.borderRadius="4px";const y=document.createElement("div");y.textContent='Click "Fetch GitLab Users" to load available assignees.',y.style.padding="15px",y.style.color="#666",y.style.fontStyle="italic",y.style.textAlign="center",m.appendChild(y),u.appendChild(m),d.whitelisted=c,d.available=u,t.appendChild(c),t.appendChild(u),o.addEventListener("input",(()=>{const e=o.value.toLowerCase();("whitelisted"===a.find((e=>e.active)).id?h:m).querySelectorAll(".assignee-item").forEach((t=>{const s=t.querySelector(".assignee-name"),n=t.querySelector(".assignee-username");if(!s||!n)return;const o=s.textContent.toLowerCase(),i=n.textContent.toLowerCase();o.includes(e)||i.includes(e)?t.style.display="":t.style.display="none"}))})),e.appendChild(t)}createAddAssigneeForm(e,t){const s=document.createElement("div");s.style.marginTop="15px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="4px";const n=document.createElement("h5");n.textContent="Add New Assignee",n.style.marginTop="0",n.style.marginBottom="10px";const o=document.createElement("div");o.style.marginBottom="10px";const i=document.createElement("label");i.textContent="Display Name:",i.style.display="block",i.style.marginBottom="5px";const l=document.createElement("input");l.type="text",l.placeholder="John Doe",l.style.width="100%",l.style.padding="6px 10px",l.style.borderRadius="4px",l.style.border="1px solid #ccc",o.appendChild(i),o.appendChild(l);const a=document.createElement("div");a.style.marginBottom="15px";const r=document.createElement("label");r.textContent="GitLab Username:",r.style.display="block",r.style.marginBottom="5px";const d=document.createElement("input");d.type="text",d.placeholder="username (without @)",d.style.width="100%",d.style.padding="6px 10px",d.style.borderRadius="4px",d.style.border="1px solid #ccc",a.appendChild(r),a.appendChild(d);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="flex-end";const u=document.createElement("button");return u.textContent="Add Assignee",u.style.padding="6px 12px",u.style.backgroundColor="#28a745",u.style.color="white",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",u.onclick=()=>{const s=l.value.trim(),n=d.value.trim();if(!n)return void this.notification.error("Username is required");const o={name:s||n,username:n};if(this.assigneeManager)this.assigneeManager.addAssignee(o);else{const e=getAssigneeWhitelist(),t=e.findIndex((e=>e.username===n));t>=0?e[t]=o:e.push(o),saveAssigneeWhitelist(e)}const i=e.querySelector('div[style*="italic"]');i&&i.remove();const a=getAssigneeWhitelist();e.appendChild(this.createAssigneeListItem(o,a.length-1,e,t)),l.value="",d.value="",this.notification.success(`Added assignee: ${o.name}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},c.appendChild(u),s.appendChild(n),s.appendChild(o),s.appendChild(a),s.appendChild(c),s}async fetchGitLabUsers(e){if(!this.gitlabApi)return void this.notification.error("GitLab API not available");this.isLoadingAssignees=!0,e.innerHTML="";const t=document.createElement("div");t.textContent="Loading users from GitLab...",t.style.padding="15px",t.style.textAlign="center",e.appendChild(t);try{const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s=[];"project"===t.type?s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}}):"group"===t.type&&(s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})),this.availableAssignees=s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.renderAvailableUsers(e)}catch(t){console.error("Error fetching GitLab users:",t),e.innerHTML="";const s=document.createElement("div");s.textContent=`Error loading users: ${t.message}`,s.style.padding="15px",s.style.color="#dc3545",s.style.textAlign="center",e.appendChild(s),this.notification.error("Failed to load GitLab users")}finally{this.isLoadingAssignees=!1}}renderAvailableUsers(e){e.innerHTML="";const t=getAssigneeWhitelist().map((e=>e.username.toLowerCase()));if(0===this.availableAssignees.length){const t=document.createElement("div");return t.textContent="No users found. Try fetching again.",t.style.padding="15px",t.style.color="#666",t.style.fontStyle="italic",t.style.textAlign="center",void e.appendChild(t)}this.availableAssignees.sort(((e,t)=>e.name.localeCompare(t.name))),this.availableAssignees.forEach((s=>{const n=t.includes(s.username.toLowerCase()),o=document.createElement("div");o.className="assignee-item",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.padding="10px 15px",o.style.borderBottom="1px solid #eee",o.style.backgroundColor=n?"rgba(40, 167, 69, 0.05)":"";const i=document.createElement("div");if(i.style.display="flex",i.style.alignItems="center",s.avatar_url){const e=document.createElement("img");e.src=s.avatar_url,e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.marginRight="10px",i.appendChild(e)}else{const e=document.createElement("div");e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.backgroundColor="#e0e0e0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.marginRight="10px",e.style.fontWeight="bold",e.style.color="#666";const t=(s.name||s.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();e.textContent=t,i.appendChild(e)}const l=document.createElement("div"),a=document.createElement("div");a.className="assignee-name",a.textContent=s.name,a.style.fontWeight="bold";const r=document.createElement("div");r.className="assignee-username",r.textContent=`@${s.username}`,r.style.fontSize="12px",r.style.color="#666",l.appendChild(a),l.appendChild(r),i.appendChild(l);const d=document.createElement("button");n?(d.textContent="Added ✓",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default"):(d.textContent="Add",d.style.backgroundColor="#28a745",d.style.color="white",d.style.cursor="pointer",d.addEventListener("click",(()=>{const e={name:s.name,username:s.username};if(this.assigneeManager)this.assigneeManager.addAssignee(e);else{const t=getAssigneeWhitelist();t.push(e),saveAssigneeWhitelist(t)}d.textContent="Added ✓",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default",o.style.backgroundColor="rgba(40, 167, 69, 0.05)",this.notification.success(`Added ${s.name} to assignees`),this.onSettingsChanged&&this.onSettingsChanged("assignees")}))),d.style.padding="5px 10px",d.style.border="none",d.style.borderRadius="4px",d.style.fontSize="12px",o.appendChild(i),o.appendChild(d),e.appendChild(o)}))}createAssigneeListItem(e,t,s,n){const o=document.createElement("div");o.className="assignee-item",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.padding="10px 15px",o.style.borderBottom="1px solid #eee";const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center";const l=document.createElement("div");l.style.width="30px",l.style.height="30px",l.style.borderRadius="50%",l.style.backgroundColor="#e0e0e0",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.marginRight="10px",l.style.fontWeight="bold",l.style.color="#666";const a=(e.name||e.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();l.textContent=a,i.appendChild(l);const r=document.createElement("div"),d=document.createElement("div");d.className="assignee-name",d.textContent=e.name||e.username,d.style.fontWeight="bold";const c=document.createElement("div");c.className="assignee-username",c.textContent=`@${e.username}`,c.style.fontSize="12px",c.style.color="#666",r.appendChild(d),r.appendChild(c),i.appendChild(r);const u=document.createElement("div"),h=document.createElement("button");return h.textContent="Remove",h.style.padding="5px 10px",h.style.backgroundColor="#dc3545",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontSize="12px",h.onclick=()=>{let t=[];if(this.assigneeManager)this.assigneeManager.removeAssignee(e.username),t=this.assigneeManager.getAssigneeWhitelist();else{t=getAssigneeWhitelist();const s=t.filter((t=>t.username.toLowerCase()!==e.username.toLowerCase()));saveAssigneeWhitelist(s),t=s}o.remove(),0===t.length&&s.appendChild(n()),this.notification.info(`Removed assignee: ${e.name||e.username}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},u.appendChild(h),o.appendChild(i),o.appendChild(u),o}createLabelWhitelistSettings(e){const t=document.createElement("div");t.style.marginBottom="20px";const s=document.createElement("h4");s.textContent="Label Whitelist",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Select which labels should appear in the dropdown. The system will show any label that contains these terms.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n),this.createWhitelistEditor(t);const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="flex-end",o.style.marginTop="15px",o.style.gap="10px";const i=document.createElement("button");i.textContent="Reset Labels",i.style.padding="6px 12px",i.style.backgroundColor="#6c757d",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.onclick=()=>{if(confirm("Reset label whitelist to default values?")){for(this.resetLabelWhitelist();t.firstChild;)t.removeChild(t.firstChild);t.appendChild(s),t.appendChild(n),this.createWhitelistEditor(t),t.appendChild(o),this.notification.success("Label whitelist reset to defaults")}};const l=document.createElement("button");l.textContent="Save Labels",l.style.padding="6px 12px",l.style.backgroundColor="#28a745",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer",l.onclick=()=>{this.saveWhitelistSettings(),this.notification.success("Label settings saved")},o.appendChild(i),o.appendChild(l),t.appendChild(o),e.appendChild(t)}createAppearanceSettings(e){const t=document.createElement("div"),s=document.createElement("h4");s.textContent="Appearance Settings",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Customize the appearance of the GitLab Sprint Helper.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n);const o=document.createElement("div");o.style.padding="20px",o.style.textAlign="center",o.style.backgroundColor="#f8f9fa",o.style.borderRadius="4px",o.style.color="#666",o.textContent="Appearance settings coming soon!",t.appendChild(o),e.appendChild(t)}createGitLabStyleLabel(e){const t=document.createElement("span");t.textContent=e.name;const s=e.color||generateColorFromString(e.name),n=getContrastColor(s);return t.style.backgroundColor=s,t.style.color=n,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}createWhitelistEditor(e){const t=document.createElement("div");t.id="whitelist-loading-message",t.textContent="Loading available labels...",t.style.fontStyle="italic",t.style.color="#666",e.appendChild(t);const s=document.createElement("div");s.id="whitelist-container",s.style.display="flex",s.style.flexWrap="wrap",s.style.gap="10px",s.style.marginTop="15px",e.appendChild(s);const n=getLabelWhitelist();Array.isArray(n)||(console.warn("Whitelist is not an array, using default"),n=[]),this.labelManager?this.labelManager.fetchAllLabels().then((e=>{if(t.remove(),!e||0===e.length){const e=document.createElement("div");return e.textContent="No labels found. Showing whitelist terms instead.",e.style.width="100%",e.style.marginBottom="15px",s.appendChild(e),void this.showWhitelistTermsOnly(s,n)}e.sort(((e,t)=>e.name.localeCompare(t.name)));const o=new Set;e.forEach((e=>{if(o.has(e.name.toLowerCase()))return;o.add(e.name.toLowerCase());const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="10px",t.style.width="calc(33.33% - 10px)";const i=document.createElement("input");i.type="checkbox",i.id=`label-${e.name}`,i.dataset.label=e.name.toLowerCase(),i.style.marginRight="8px",this.labelManager.isLabelInWhitelist(e.name,n)&&(i.checked=!0);const l=this.createGitLabStyleLabel(e);l.style.cursor="pointer",l.onclick=()=>{i.checked=!i.checked},t.appendChild(i),t.appendChild(l),s.appendChild(t)}));const i=document.createElement("div");i.style.width="100%",i.style.marginTop="20px",i.style.padding="15px",i.style.borderTop="1px solid #ddd";const l=document.createElement("div");l.textContent="Add custom terms (comma separated):",l.style.marginBottom="8px",l.style.fontWeight="bold";const a=document.createElement("input");a.type="text",a.id="custom-whitelist-terms",a.style.width="100%",a.style.padding="8px",a.style.borderRadius="4px",a.style.border="1px solid #ccc";const r=Array.from(o);let d=[];Array.isArray(n)&&(d=n.filter((e=>"string"==typeof e&&!r.some((t=>t.includes(e.toLowerCase())))))),a.value=d.join(", "),i.appendChild(l),i.appendChild(a),s.appendChild(i)})).catch((e=>{console.error("Error fetching labels for whitelist editor:",e),t.textContent="Error loading labels. Using whitelist terms instead.",t.style.color="#dc3545",this.showWhitelistTermsOnly(s,n)})):(t.textContent="Label manager not available. Using whitelist terms instead.",t.style.color="#dc3545",this.showWhitelistTermsOnly(s,n))}showWhitelistTermsOnly(e,t){Array.isArray(t)||(console.warn("Whitelist is not an array in showWhitelistTermsOnly"),t=[]),t.forEach((t=>{if("string"!=typeof t)return;const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="10px",s.style.width="calc(33.33% - 10px)";const n=document.createElement("input");n.type="checkbox",n.id=`label-${t}`,n.dataset.label=t.toLowerCase(),n.style.marginRight="8px",n.checked=!0;const o=document.createElement("span");o.textContent=t,o.style.padding="4px 8px",o.style.borderRadius="100px",o.style.fontSize="12px",o.style.fontWeight="500",o.style.display="inline-block",o.style.margin="2px",o.style.backgroundColor=generateColorFromString(t),o.style.color=getContrastColor(o.style.backgroundColor),o.style.cursor="pointer",o.onclick=()=>{n.checked=!n.checked},s.appendChild(n),s.appendChild(o),e.appendChild(s)}));const s=document.createElement("div");s.style.width="100%",s.style.marginTop="20px",s.style.padding="15px",s.style.borderTop="1px solid #ddd";const n=document.createElement("div");n.textContent="Add custom terms (comma separated):",n.style.marginBottom="8px",n.style.fontWeight="bold";const o=document.createElement("input");o.type="text",o.id="custom-whitelist-terms",o.style.width="100%",o.style.padding="8px",o.style.borderRadius="4px",o.style.border="1px solid #ccc",s.appendChild(n),s.appendChild(o),e.appendChild(s)}saveWhitelistSettings(){const e=[],t=new Set;document.querySelectorAll('#whitelist-container input[type="checkbox"]').forEach((s=>{if(s.checked){const n=s.dataset.label.toLowerCase();t.has(n)||(e.push(n),t.add(n))}}));const s=document.getElementById("custom-whitelist-terms");if(s&&s.value){s.value.split(",").map((e=>e.trim().toLowerCase())).forEach((s=>{s&&!t.has(s)&&(e.push(s),t.add(s))}))}saveLabelWhitelist(e),this.labelManager&&this.labelManager.saveWhitelist(e),this.notification&&this.notification.success(`Saved ${e.length} whitelist terms`),this.onSettingsChanged&&this.onSettingsChanged("labels")}resetLabelWhitelist(){resetLabelWhitelist(),this.labelManager&&this.labelManager.resetToDefaultWhitelist(),this.onSettingsChanged&&this.onSettingsChanged("labels")}resetAllSettings(){this.resetLabelWhitelist(),saveAssigneeWhitelist([]),this.onSettingsChanged&&this.onSettingsChanged("all")}},e.SummaryView=class SummaryView{constructor(uiManager){this.uiManager=uiManager}render(e,t,s,n,o){const i=document.getElementById("assignee-time-summary-content");if(!i)return;if(i.innerHTML="",this.uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:this.getClosedBoardCount()}),0===n)return void this.renderNoDataMessage(i);const l=formatHours(t);this.uiManager.updateHeader(`Summary ${l}h`),o&&this.renderMilestoneInfo(i,o),this.renderDataTable(i,e,l)}getClosedBoardCount(){let e=0;return document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}if(s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished")){const s=t.querySelectorAll(".board-card");e+=s.length}})),e}renderNoDataMessage(e){const t=document.createElement("p");t.textContent="No time estimate data found. Make sure the board is fully loaded and try again.",t.style.color="#666",e.appendChild(t);const s=document.createElement("p");s.style.fontSize="12px",s.style.fontStyle="italic",s.innerHTML="Tip: Try scrolling through all cards to ensure they are loaded before clicking Recalculate.",e.appendChild(s),this.uiManager.updateHeader("Summary 0.0h")}renderMilestoneInfo(e,t){const s=document.createElement("div");s.style.marginBottom="10px",s.style.fontSize="13px",s.style.color="#555",s.textContent=`Current Milestone: ${t}`,e.appendChild(s)}renderDataTable(e,t,s){const n=document.createElement("table");n.style.width="100%",n.style.borderCollapse="collapse";const o=document.createElement("tr");o.style.borderBottom="2px solid #ddd",o.style.fontWeight="bold";const i=document.createElement("td");i.textContent="Total",i.style.padding="5px 0";const l=document.createElement("td");l.textContent=`${s}h`,l.style.textAlign="right",l.style.padding="5px 0",o.appendChild(i),o.appendChild(l),n.appendChild(o);Object.keys(t).sort(((e,s)=>t[s]-t[e])).forEach((e=>{const s=formatHours(t[e]),o=document.createElement("tr");o.style.borderBottom="1px solid #eee";const i=document.createElement("td");i.textContent=e,i.style.padding="5px 0";const l=document.createElement("td");l.textContent=`${s}h`,l.style.textAlign="right",l.style.padding="5px 0",o.appendChild(i),o.appendChild(l),n.appendChild(o)})),e.appendChild(n)}},e.BoardsView=class BoardsView{constructor(uiManager){this.uiManager=uiManager}render(e,t){const s=document.getElementById("boards-time-summary-content");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="boards-list-summary";Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const o=this.createBoardSection(s,e[s],t[s]);n.appendChild(o)})),s.appendChild(n)}createBoardSection(e,t,s){const n=formatHours(t.timeEstimate),o=document.createElement("div");o.className="board-section",o.style.marginBottom="15px";const i=document.createElement("div");i.className="board-header",i.style.display="flex",i.style.justifyContent="space-between",i.style.padding="5px",i.style.backgroundColor="#f5f5f5",i.style.borderRadius="3px",i.style.cursor="pointer",i.style.fontWeight="bold";const l=document.createElement("div");l.className="board-details",l.style.display="none",l.style.marginTop="5px",l.style.marginLeft="10px",i.addEventListener("click",(()=>{"none"===l.style.display?(l.style.display="block",r.textContent="▼"):(l.style.display="none",r.textContent="▶")}));const a=document.createElement("div");a.textContent=`${e} (${t.tickets} tickets, ${n}h)`;const r=document.createElement("span");return r.textContent="▶",r.style.marginLeft="5px",i.appendChild(a),i.appendChild(r),s&&l.appendChild(this.createAssigneeTable(s)),o.appendChild(i),o.appendChild(l),o}createAssigneeTable(e){const t=document.createElement("table");t.style.width="100%",t.style.borderCollapse="collapse",t.style.marginTop="5px";const s=document.createElement("tr");s.style.borderBottom="1px solid #ddd";const n=document.createElement("th");n.textContent="Assignee",n.style.textAlign="left",n.style.padding="3px 0";const o=document.createElement("th");o.textContent="Tickets",o.style.textAlign="right",o.style.padding="3px 5px";const i=document.createElement("th");i.textContent="Hours",i.style.textAlign="right",i.style.padding="3px 0",s.appendChild(n),s.appendChild(o),s.appendChild(i),t.appendChild(s);return Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const n=e[s],o=formatHours(n.timeEstimate),i=document.createElement("tr");i.style.borderBottom="1px solid #eee";const l=document.createElement("td");l.textContent=s,l.style.padding="3px 0";const a=document.createElement("td");a.textContent=n.tickets,a.style.textAlign="right",a.style.padding="3px 5px";const r=document.createElement("td");r.textContent=`${o}h`,r.style.textAlign="right",r.style.padding="3px 0",i.appendChild(l),i.appendChild(a),i.appendChild(r),t.appendChild(i)})),t}},e.HistoryView=class HistoryView{constructor(uiManager){this.uiManager=uiManager}render(){const t=document.getElementById("history-time-summary-content");if(!t)return;t.innerHTML="";const s=getHistoryKey(),n=GM_getValue(s,[]),o=document.createElement("div");o.style.fontSize="12px",o.style.color="#666",o.style.marginBottom="10px",o.style.wordBreak="break-all";let i=e.location.href;i.length>60&&(i=i.substring(0,57)+"..."),t.appendChild(o),0!==n.length?(this.addClearHistoryButton(t,s),this.renderHistoryTable(t,n)):this.renderNoHistoryMessage(t)}renderNoHistoryMessage(e){const t=document.createElement("p");t.textContent="No history data available for this URL yet.",t.style.color="#666",e.appendChild(t)}addClearHistoryButton(e,t){const s=document.createElement("button");s.textContent="Clear History",s.style.padding="3px 6px",s.style.fontSize="12px",s.style.backgroundColor="#dc3545",s.style.color="white",s.style.border="none",s.style.borderRadius="3px",s.style.cursor="pointer",s.style.marginBottom="10px",s.onclick=()=>{confirm("Are you sure you want to clear history data for this URL?")&&(GM_setValue(t,[]),this.render())},e.appendChild(s)}renderHistoryTable(e,t){const s=document.createElement("table");s.style.width="100%",s.style.borderCollapse="collapse";const n=document.createElement("tr");n.style.borderBottom="2px solid #ddd",n.style.fontWeight="bold";const o=document.createElement("th");o.textContent="Date",o.style.textAlign="left",o.style.padding="5px 0";const i=document.createElement("th");i.textContent="Hours",i.style.textAlign="right",i.style.padding="5px 0";const l=document.createElement("th");l.textContent="Milestone",l.style.textAlign="left",l.style.padding="5px 0",n.appendChild(o),n.appendChild(i),n.appendChild(l),s.appendChild(n),t.slice().reverse().forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid #eee";const n=document.createElement("td"),o=new Date(e.timestamp);n.textContent=o.toLocaleDateString()+" "+o.toLocaleTimeString().substring(0,5),n.style.padding="5px 0";const i=document.createElement("td");i.textContent=`${e.totalHours}h`,i.style.textAlign="right",i.style.padding="5px 0";const l=document.createElement("td");l.textContent=e.milestone,l.style.padding="5px 0",t.appendChild(n),t.appendChild(i),t.appendChild(l),s.appendChild(t)})),e.appendChild(s)}},e.BulkCommentsView=class BulkCommentsView{constructor(uiManager){this.uiManager=uiManager,this.selectedIssues=[],this.commandShortcuts=null,this.isLoading=!1,this.initializedShortcuts=new Set,this.gitlabApi=e.gitlabApi||uiManager&&uiManager.gitlabApi,this.notification=new Notification({position:"bottom-right",duration:3e3}),uiManager&&uiManager.labelManager?this.labelManager=uiManager.labelManager:"function"==typeof LabelManager?this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.commandShortcuts&&this.addLabelShortcut()}}):this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([])},this.selectionDisplay=new SelectionDisplay({selectedIssues:this.selectedIssues,onRemoveIssue:e=>this.onRemoveIssue(e)})}initializeAllShortcuts(){this.commandShortcuts&&(this.addLabelShortcut(),this.addMilestoneShortcut(),this.addAssignShortcut())}addMilestoneShortcut(){this.commandShortcuts&&this.commandShortcuts.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"none",label:"Remove Milestone"},{value:"custom",label:"Custom..."}],onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter milestone name:");if(!t)return;e=t}const t=document.getElementById("issue-comment-input");if(!t)return;let s="/milestone ";"none"===e?s+='%""':e.startsWith("%")?s+=e:s+=`%"${e}"`,this.insertTextAtCursor(t,s),this.notification.info(`Milestone set to ${"none"===e?"none":e}`)}})}addAssignShortcut(){if(!this.commandShortcuts)return;let e=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}];this.commandShortcuts.addCustomShortcut({type:"assign",label:"/assign",items:[{value:"",label:"Loading assignees..."}],onSelect:()=>{}}),this.fetchGroupMembers().then((t=>{if(this.assigneeManager){const t=this.assigneeManager.getAssigneeWhitelist();if(t.length>0){e.push({value:"separator",label:"────── Favorites ──────"});const s=t.map((e=>({value:e.username,label:e.name||e.username})));e=e.concat(s)}}if(t&&t.length>0){e.push({value:"separator2",label:"────── Group Members ──────"});const s=t.map((e=>({value:e.username,label:e.name||e.username})));e=e.concat(s)}this.updateAssignShortcut(e)})).catch((t=>{if(console.error("Error fetching group members:",t),this.assigneeManager){const t=this.assigneeManager.getAssigneeWhitelist();if(t.length>0){const s=t.map((e=>({value:e.username,label:e.name||e.username})));e=e.concat(s)}}this.updateAssignShortcut(e)}))}updateAssignShortcut(e){if(!this.commandShortcuts)return;let t=null;this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(t=this.commandShortcuts.shortcuts.assign.dropdown.value),this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.removeShortcut("assign"),this.commandShortcuts.addCustomShortcut({type:"assign",label:"/assign",items:e,onSelect:e=>{if(!e||"separator"===e||"separator2"===e)return;if("custom"===e){const t=prompt("Enter GitLab username (without @):");if(!t)return;e=t}const t=document.getElementById("issue-comment-input");if(!t)return;let s="/assign ";s+="none"===e?"@none":"@me"===e?"@me":e.startsWith("@")?e:`@${e}`,this.insertTextAtCursor(t,s),"none"===e?this.notification.info("Issue will be unassigned"):"@me"===e?this.notification.info("Issue will be assigned to you"):this.notification.info(`Issue will be assigned to ${e.replace("@","")}`)}}),t&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(this.commandShortcuts.shortcuts.assign.dropdown.value=t)}async fetchGroupMembers(){try{if(this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)throw new Error("GitLab API not available");const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s;if("project"===t.type)s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}});else{if("group"!==t.type)throw new Error("Unsupported path type: "+t.type);s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})}return s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url})))}catch(e){return console.error("Error fetching group members:",e),[]}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.selectionDisplay&&this.selectionDisplay.setSelectedIssues(this.selectedIssues);const t=document.getElementById("comment-status");if(t){const e=this.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected. Enter your comment and click "Add Comment".`,t.style.color="green"):this.isLoading||(t.textContent='No issues selected. Click "Select Issues".',t.style.color="#666")}console.log(`BulkCommentsView: Set ${this.selectedIssues.length} selected issues`)}onRemoveIssue(t){if(this.selectedIssues.length>t){this.selectedIssues[t];this.selectedIssues.splice(t,1),this.uiManager&&this.uiManager.issueSelector?this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]):e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}const s=document.getElementById("comment-status");if(s){const e=this.selectedIssues.length;e>0?(s.textContent=`${e} issue${1!==e?"s":""} selected.`,s.style.color="green"):(s.textContent='No issues selected. Click "Select Issues" to choose issues.',s.style.color="#666")}console.log(`Removed issue at index ${t}, remaining: ${this.selectedIssues.length}`)}createActionButtons(e){const t=document.createElement("div");t.style.display="flex",t.style.gap="8px",t.style.marginBottom="8px";const s=document.createElement("button");s.id="select-issues-button",s.textContent="Select",s.style.padding="8px 12px",s.style.backgroundColor="#6c757d",s.style.color="white",s.style.border="none",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="background-color 0.2s ease",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.minWidth="80px",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#218838":"#5a6268"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#28a745":"#6c757d"})),s.onclick=()=>{if(this.uiManager&&this.uiManager.issueSelector)this.uiManager.issueSelector.isSelectingIssue?(this.uiManager.issueSelector.exitSelectionMode(),s.dataset.active="false",s.style.backgroundColor="#6c757d",s.textContent="Select"):(this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]),this.uiManager.issueSelector.startSelection(),s.dataset.active="true",s.style.backgroundColor="#28a745",s.textContent="Done");else{console.error("Issue selector not initialized");const e=document.getElementById("comment-status");e&&(e.textContent="Error: Issue selector not initialized.",e.style.color="#dc3545")}},t.appendChild(s);const n=document.createElement("button");n.textContent="Send",n.style.padding="8px 12px",n.style.backgroundColor="#1f75cb",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="14px",n.style.transition="background-color 0.2s ease",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flex="1",n.style.minWidth="80px",n.addEventListener("mouseenter",(()=>{n.style.backgroundColor="#1a63ac"})),n.addEventListener("mouseleave",(()=>{n.style.backgroundColor="#1f75cb"})),n.onclick=()=>this.submitComments(),t.appendChild(n),e.appendChild(t)}clearSelectedIssues(){this.selectedIssues=[],this.selectionDisplay&&this.selectionDisplay.setSelectedIssues([]);const e=document.getElementById("comment-status");e&&(e.textContent="Selection cleared.",e.style.color="#666"),this.notification&&this.notification.info("Selection cleared"),console.log("Cleared selected issues")}setSelectedIssue(e){this.setSelectedIssues(e?[e]:[])}render(){const e=document.getElementById("bulk-comments-content");e&&(e.innerHTML="",this.addCommentSection(e))}addCommentSection(e){const t=document.createElement("div");t.classList.add("api-section"),t.style.marginBottom="15px",t.style.padding="10px",t.style.backgroundColor="#f5f5f5",t.style.borderRadius="8px",t.style.border="1px solid #e0e0e0",this.selectionDisplay.createSelectionContainer(t),this.createCommentInput(t),this.createActionButtons(t),this.createStatusElements(t),this.isLoading=!0,this.showLoadingState();try{this.initializeAllShortcuts(),this.addLabelShortcut([{value:"",label:"Loading labels..."}]),this.labelManager&&"function"==typeof this.labelManager.fetchAllLabels?this.labelManager.fetchAllLabels().then((e=>{this.addLabelShortcut(),this.isLoading=!1,this.hideLoadingState()})).catch((e=>{console.error("Error loading labels:",e),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState()})):(console.warn("Label manager not available, using fallback labels"),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState())}catch(e){console.error("Error initializing shortcuts:",e),this.isLoading=!1,this.hideLoadingState()}e.appendChild(t)}getFallbackLabels(){return[{value:"",label:"Add Label"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"documentation",label:"Documentation"},{value:"custom",label:"Custom..."}]}createCommentInput(e){const t=document.createElement("div");t.id="shortcuts-wrapper",t.style.width="100%",t.style.marginBottom="15px",e.appendChild(t);const s=document.createElement("textarea");s.id="issue-comment-input",s.placeholder="Enter your comment here...",s.style.width="100%",s.style.padding="8px",s.style.marginBottom="12px",s.style.borderRadius="4px",s.style.border="1px solid #ccc",s.style.minHeight="60px",s.style.fontSize="14px",s.style.transition="border-color 0.2s ease",s.style.resize="vertical",s.addEventListener("focus",(()=>{s.style.borderColor="#1f75cb",s.style.outline="none",s.style.boxShadow="0 0 0 2px rgba(31, 117, 203, 0.2)"})),s.addEventListener("blur",(()=>{s.style.borderColor="#ccc",s.style.boxShadow="none"})),e.appendChild(s),this.commandShortcuts=new CommandShortcut({targetElement:s,onShortcutInsert:(e,t)=>{console.log(`Shortcut inserted: ${e} with value ${t}`)}}),this.commandShortcuts.initialize(t)}insertTextAtCursor(e,t){if(!e)return;const s=e.value,n=e.selectionStart,o=e.selectionEnd;let i=t;n>0&&"\n"!==s.charAt(n-1)&&s.length>0&&(i="\n"+i),e.value=s.substring(0,n)+i+s.substring(o);const l=n+i.length;e.setSelectionRange(l,l),e.focus()}createStatusElements(e){const t=document.createElement("div");t.id="comment-status",t.style.fontSize="13px",t.style.marginTop="10px",t.style.padding="8px 12px",t.style.borderRadius="4px",t.style.backgroundColor="#f8f9fa",t.style.border="1px solid #e9ecef",t.style.textAlign="center",t.style.color="#666",t.textContent="Loading shortcuts...",e.appendChild(t);const s=document.createElement("div");s.id="comment-progress-container",s.style.display="none",s.style.marginTop="15px",s.style.padding="10px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="4px",s.style.border="1px solid #e9ecef";const n=document.createElement("div");n.id="comment-progress-label",n.textContent="Submitting comments...",n.style.fontSize="13px",n.style.marginBottom="8px",n.style.textAlign="center",n.style.fontWeight="bold",s.appendChild(n);const o=document.createElement("div");o.style.height="12px",o.style.backgroundColor="#e9ecef",o.style.borderRadius="6px",o.style.overflow="hidden",o.style.boxShadow="inset 0 1px 3px rgba(0,0,0,0.1)";const i=document.createElement("div");i.id="comment-progress-bar",i.style.height="100%",i.style.width="0%",i.style.backgroundColor="#1f75cb",i.style.transition="width 0.3s ease",o.appendChild(i),s.appendChild(o),e.appendChild(s)}showLoadingState(){const e=document.getElementById("comment-status");e&&(e.textContent="Loading shortcuts...",e.style.color="#1f75cb",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef");const t=document.getElementById("issue-comment-input");t&&(t.disabled=!0,t.style.opacity="0.7",t.style.cursor="not-allowed");document.querySelectorAll(".api-section button").forEach((e=>{e.disabled=!0,e.style.opacity="0.7",e.style.cursor="not-allowed"}))}hideLoadingState(){const e=document.getElementById("comment-status");if(e){const t=this.selectedIssues.length;t>0?(e.textContent=`${t} issue${1!==t?"s":""} selected.`,e.style.color="#28a745",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef"):(e.textContent="Select issues to add comments.",e.style.color="#666",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef")}const t=document.getElementById("issue-comment-input");t&&(t.disabled=!1,t.style.opacity="1",t.style.cursor="text");document.querySelectorAll(".api-section button").forEach((e=>{e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"}))}async submitComments(){const t=document.getElementById("issue-comment-input"),s=document.getElementById("comment-status"),n=document.getElementById("comment-progress-container"),o=document.getElementById("comment-progress-bar"),i=document.getElementById("comment-progress-label");if(0===this.selectedIssues.length)return this.notification.error("No issues selected"),void(s&&(s.textContent="Error: No issues selected.",s.style.color="#dc3545",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"));const l=t.value.trim();if(!l)return this.notification.error("Comment cannot be empty"),void(s&&(s.textContent="Error: Comment cannot be empty.",s.style.color="#dc3545",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"));s&&(s.textContent=`Submitting comments to ${this.selectedIssues.length} issues...`,s.style.color="#1f75cb",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"),n.style.display="block",o.style.width="0%";const a=Array.from(document.querySelectorAll("button")).find((e=>e.textContent&&e.textContent.includes("Send")));a&&(a.disabled=!0,a.style.opacity="0.7",a.style.cursor="not-allowed");let r=0,d=0;const gitlabApi=e.gitlabApi||this.uiManager&&this.uiManager.gitlabApi;if(!gitlabApi)return this.notification.error("GitLab API not available"),s&&(s.textContent="Error: GitLab API not available.",s.style.color="#dc3545",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"),void(a&&(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer"));for(let e=0;e<this.selectedIssues.length;e++){const t=this.selectedIssues[e],s=Math.round(e/this.selectedIssues.length*100);o.style.width=`${s}%`,i.textContent=`Processing ${e+1} of ${this.selectedIssues.length} issues...`;try{await gitlabApi.addComment(t,l),r++}catch(e){console.error(`Failed to add comment to issue #${t.iid}:`,e),d++}}o.style.width="100%",a&&(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer"),r===this.selectedIssues.length?(s&&(s.textContent=`Successfully added comment to all ${r} issues!`,s.style.color="#28a745",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"),this.notification.success(`Added comment to ${r} issues`),t.value="",setTimeout((()=>{n.style.display="none"}),2e3),setTimeout((()=>{this.clearSelectedIssues(),s&&(s.textContent="")}),3e3),setTimeout((()=>{this.refreshBoard()}),1e3)):(s&&(s.textContent=`Added comment to ${r} issues, failed for ${d} issues.`,s.style.color=r>0?"#ff9900":"#dc3545",s.style.backgroundColor="#f8f9fa",s.style.border="1px solid #e9ecef",s.style.textAlign="center"),r>0?(this.notification.warning(`Added comment to ${r} issues, failed for ${d}`),setTimeout((()=>{this.refreshBoard()}),1e3)):this.notification.error(`Failed to add comments to all ${d} issues`),o.style.backgroundColor=r>0?"#ff9900":"#dc3545")}addLabelShortcut(e){if(!this.commandShortcuts)return;let t,s=null;if(this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(s=this.commandShortcuts.shortcuts.label.dropdown.value),e)t=e;else if(this.labelManager&&this.labelManager.filteredLabels&&this.labelManager.filteredLabels.length){t=[{value:"",label:"Add Label"}];const e=this.labelManager.filteredLabels.map((e=>({value:e.name,label:e.name})));t=t.concat(e),t.push({value:"custom",label:"Custom..."})}else try{const e=getLabelWhitelist();if(e&&e.length>0){t=[{value:"",label:"Add Label"}];const s=e.map((e=>({value:e,label:e})));t=t.concat(s),t.push({value:"custom",label:"Custom..."})}else t=this.getFallbackLabels()}catch(e){console.error("Error getting label whitelist:",e),t=this.getFallbackLabels()}this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.removeShortcut("label"),this.commandShortcuts.addCustomShortcut({type:"label",label:"/label",items:t,onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter custom label name:");if(!t)return;e=t}const t=document.getElementById("issue-comment-input");if(!t)return;const s=`/label ~"${e}"`;this.insertTextAtCursor(t,s),this.notification.info(`Label added: ${e}`)}}),s&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(this.commandShortcuts.shortcuts.label.dropdown.value=s)}refreshBoard(){try{console.log("Refreshing board...");const e=document.querySelector(".gl-search-box-by-click-search-button");if(e)e.click(),console.log("Board refreshed successfully");else{console.warn("Search button not found, trying alternative refresh method");const e=document.querySelector(".gl-search-box-by-click-input");if(e){const t=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});e.dispatchEvent(t),console.log("Board refreshed using alternative method")}else console.error("Could not find search elements to refresh board")}}catch(e){console.error("Error refreshing board:",e)}}},e.UIManager=class UIManager{constructor(){this.container=null,this.contentWrapper=null,this.headerDiv=null,this.header=null,this.recalculateBtn=null,this.collapseBtn=null,this.boardStats=null,this.tabManager=new TabManager(this),this.summaryView=new SummaryView(this),this.boardsView=new BoardsView(this),this.historyView=new HistoryView(this),this.bulkCommentsView=new BulkCommentsView(this),this.issueSelector=new IssueSelector(this)}initialize(){if(document.getElementById("assignee-time-summary"))return void(this.container=document.getElementById("assignee-time-summary"));this.container=document.createElement("div"),this.container.id="assignee-time-summary",this.container.style.position="fixed",this.container.style.bottom="15px",this.container.style.right="15px",this.container.style.backgroundColor="white",this.container.style.border="1px solid #ddd",this.container.style.borderRadius="4px",this.container.style.padding="10px",this.container.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)",this.container.style.zIndex="1000",this.container.style.maxHeight="80vh",this.container.style.overflow="hidden",this.container.style.fontSize="14px",this.container.style.width="400px",this.container.style.transition="height 0.3s ease-in-out",this.contentWrapper=document.createElement("div"),this.contentWrapper.id="assignee-time-summary-wrapper",this.contentWrapper.style.display="block",this.contentWrapper.style.maxHeight="70vh",this.contentWrapper.style.overflowY="auto",this.createHeader(),this.createBoardStats(),this.tabManager.initialize(this.contentWrapper),this.container.appendChild(this.contentWrapper),document.body.appendChild(this.container),this.container.addEventListener("click",(e=>{!this.issueSelector.isSelectingIssue||e.target.classList.contains("card-selection-overlay")||e.target.classList.contains("selection-badge")||e.target.closest("#bulk-comments-content button")||e.target.closest("#issue-comment-input")||e.target.closest("#shortcuts-wrapper")||e.target.closest("#selected-issues-list")||e.target.closest("#selection-cancel-button")||this.issueSelector.exitSelectionMode()}));"true"===loadFromStorage("gitlabTimeSummaryCollapsed","false")&&(this.contentWrapper.style.display="none",this.collapseBtn.textContent="▲",this.container.style.height="auto")}createHeader(){this.headerDiv=document.createElement("div"),this.headerDiv.style.display="flex",this.headerDiv.style.justifyContent="space-between",this.headerDiv.style.alignItems="center",this.headerDiv.style.marginBottom="5px",this.headerDiv.style.cursor="pointer",this.headerDiv.addEventListener("click",(e=>{e.target!==this.recalculateBtn&&e.target!==this.collapseBtn&&e.target!==this.settingsBtn&&this.toggleCollapse()})),this.header=document.createElement("h3"),this.header.id="assignee-time-summary-header",this.header.textContent="Summary",this.header.style.margin="0",this.header.style.fontSize="16px";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",this.recalculateBtn=document.createElement("button"),this.recalculateBtn.textContent="🔄",this.recalculateBtn.title="Recalculate",this.recalculateBtn.style.padding="3px 6px",this.recalculateBtn.style.fontSize="12px",this.recalculateBtn.style.backgroundColor="#1f75cb",this.recalculateBtn.style.color="white",this.recalculateBtn.style.border="none",this.recalculateBtn.style.borderRadius="3px",this.recalculateBtn.style.cursor="pointer",this.recalculateBtn.onclick=t=>{t.stopPropagation(),"function"==typeof e.updateSummary&&e.updateSummary(!0),this.recalculateBtn.textContent="✓",setTimeout((()=>{this.recalculateBtn.textContent="🔄"}),1e3)},this.settingsBtn=document.createElement("button"),this.settingsBtn.textContent="⚙️",this.settingsBtn.title="Settings",this.settingsBtn.style.padding="3px 6px",this.settingsBtn.style.fontSize="12px",this.settingsBtn.style.backgroundColor="#6c757d",this.settingsBtn.style.color="white",this.settingsBtn.style.border="none",this.settingsBtn.style.borderRadius="3px",this.settingsBtn.style.cursor="pointer",this.settingsBtn.onclick=e=>{e.stopPropagation()},this.collapseBtn=document.createElement("button"),this.collapseBtn.textContent="▼",this.collapseBtn.title="Collapse/Expand",this.collapseBtn.style.padding="3px 6px",this.collapseBtn.style.fontSize="12px",this.collapseBtn.style.backgroundColor="#777",this.collapseBtn.style.color="white",this.collapseBtn.style.border="none",this.collapseBtn.style.borderRadius="3px",this.collapseBtn.style.cursor="pointer",this.collapseBtn.onclick=e=>{e.stopPropagation(),this.toggleCollapse()},t.appendChild(this.recalculateBtn),t.appendChild(this.settingsBtn),t.appendChild(this.collapseBtn),this.headerDiv.appendChild(this.header),this.headerDiv.appendChild(t),this.container.appendChild(this.headerDiv)}createBoardStats(){this.boardStats=document.createElement("div"),this.boardStats.id="board-stats-summary",this.boardStats.style.fontSize="13px",this.boardStats.style.color="#555",this.boardStats.style.marginBottom="10px",this.boardStats.style.display="flex",this.boardStats.style.justifyContent="space-between",this.boardStats.textContent="Loading board statistics...",this.container.appendChild(this.boardStats)}updateBoardStats(e){if(!this.boardStats)return;this.boardStats.innerHTML="";const t=document.createElement("div");t.style.display="flex",t.style.gap="8px";const s=document.createElement("span");s.textContent=`Total: ${e.totalCards} cards`,t.appendChild(s);const n=document.createElement("span");n.textContent=`(${e.withTimeCards} with time)`,n.style.color="#777",t.appendChild(n);const o=document.createElement("div");o.textContent=`Closed: ${e.closedCards} cards`,o.style.color="#28a745",this.boardStats.appendChild(t),this.boardStats.appendChild(o)}toggleCollapse(){"none"===this.contentWrapper.style.display?(this.contentWrapper.style.display="block",this.collapseBtn.textContent="▼",this.container.style.height="",saveToStorage("gitlabTimeSummaryCollapsed","false")):(this.contentWrapper.style.display="none",this.collapseBtn.textContent="▲",this.container.style.height="auto",saveToStorage("gitlabTimeSummaryCollapsed","true"))}updateHeader(e){this.header&&(this.header.textContent=e)}},e.uiManager=e.uiManager||new UIManager,e.createSummaryContainer=function createSummaryContainer(){return uiManager.initialize(),uiManager.container},e.updateSummaryTab=function updateSummaryTab(e,t,s,n,o){if("function"==typeof processBoards){const{closedBoardCards:e}=processBoards();uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:e||0})}uiManager.summaryView.render(e,t,s,n,o)},e.updateBoardsTab=function updateBoardsTab(e,t){uiManager.boardsView.render(e,t)},e.updateBulkCommentsTab=function updateBulkCommentsTab(){uiManager.bulkCommentsView.render()},e.renderHistory=function renderHistory(){uiManager.historyView.render()},e.addEventListener("scroll",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.uiManager=uiManager,e.updateSummaryTab=updateSummaryTab,e.updateBoardsTab=updateBoardsTab,e.updateBulkCommentsTab=updateBulkCommentsTab,e.renderHistory=renderHistory,e.createSummaryContainer=createSummaryContainer,e.SettingsManager=SettingsManager,setTimeout((()=>{const t=document.querySelector('#assignee-time-summary button[title="Settings"]');t?(console.log("Found settings button, attaching direct handler"),t.onclick=t=>{t.stopPropagation(),console.log("Settings button clicked");try{new SettingsManager({labelManager:e.uiManager?.labelManager,assigneeManager:e.uiManager?.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:t=>{console.log(`Settings changed: ${t}`),e.uiManager?.bulkCommentsView&&("all"!==t&&"labels"!==t||e.uiManager.bulkCommentsView.addLabelShortcut(),"all"!==t&&"assignees"!==t||e.uiManager.bulkCommentsView.addAssignShortcut())}}).openSettingsModal()}catch(e){console.error("Error creating settings manager:",e)}},console.log("Settings button handler attached")):console.warn("Settings button not found")}),2e3),e.gitlabApi=e.gitlabApi||new GitLabAPI,checkAndInit();let l=e.location.href;new MutationObserver((()=>{e.location.href!==l&&(l=e.location.href,setTimeout(checkAndInit,1e3))})).observe(document,{subtree:!0,childList:!0}),e.gitlabApi=gitlabApi,e.updateSummary=updateSummary,e.checkAndInit=checkAndInit,e.waitForBoards=waitForBoards,function(){"use strict";const{gitlabApi:gitlabApi,updateSummary:updateSummary,checkAndInit:t,waitForBoards:s,processBoards:processBoards,renderHistory:renderHistory}=e;t(),e.gitlabHelper={updateSummary:updateSummary,gitlabApi:gitlabApi,processBoards:processBoards,renderHistory:renderHistory}}()}(window);