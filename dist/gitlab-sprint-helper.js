// ==UserScript==
// @name         GitLab Sprint Helper
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Display a summary of assignees' time estimates on GitLab boards with API integration and comment shortcuts
// @author       Daniel Samer | Linkster
// @match        https://gitlab.com/*/boards/*
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-idle
// @updateURL    https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// @downloadURL  https://gitlab.com/daniel_linkster/gitlab-helper/-/raw/main/dist/gitlab-sprint-helper.js
// ==/UserScript==

!function(e){e.formatHours=function formatHours(e){return(e/3600).toFixed(1)},e.generateColorFromString=function generateColorFromString(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return`hsl(${Math.abs(t)%360}, 70%, 75%)`},e.getContrastColor=function getContrastColor(t){if(t.startsWith("hsl")){const e=t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%\s*\)/);if(e&&e[1]){return parseInt(e[1],10)>60?"black":"white"}}let s=0,n=0,i=0;try{const o=document.createElement("div");o.style.backgroundColor=t,document.body.appendChild(o);const a=e.getComputedStyle(o).backgroundColor;document.body.removeChild(o);const r=a.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);r&&(s=parseInt(r[1],10),n=parseInt(r[2],10),i=parseInt(r[3],10))}catch(e){return t.startsWith("hsl")&&t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)?parseInt(t.match(/hsl\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%/)[1],10)>60?"black":"white":"black"}return(.299*s+.587*n+.114*i)/255>.5?"black":"white"},e.getPathFromUrl=function getPathFromUrl(){try{const t=e.location.pathname;if(t.includes("/groups/")&&t.includes("/-/boards")){const e=/\/groups\/([^\/]+(?:\/[^\/]+)*)\/?-?\/?boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract group path from URL:",t),null;const n=s[1].replace(/\/-$/,""),i=encodeURIComponent(n);return{path:n,encodedPath:i,type:"group",apiUrl:`groups/${i}/labels`}}if(t.includes("/-/boards")){const e=/^\/([^\/]+(?:\/[^\/]+)*)\/-\/boards/,s=t.match(e);if(!s||!s[1])return console.warn("Could not extract project path from URL pattern:",t),null;const n=s[1],i=encodeURIComponent(n);return{path:n,encodedPath:i,type:"project",apiUrl:`projects/${i}/labels`}}return console.warn("Not on a GitLab boards page:",t),null}catch(e){return console.error("Error extracting path from URL:",e),null}},e.getCurrentUrlKey=function getCurrentUrlKey(){return e.location.href.split("#")[0]},e.getHistoryKey=function getHistoryKey(){return`timeEstimateHistory_${getCurrentUrlKey()}`},e.GitLabAPI=class GitLabAPI{constructor(){this.csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),this.baseUrl="/api/v4"}callGitLabApi(e,t={}){const{method:s="GET",data:n=null,params:i=null}=t;let o=`${this.baseUrl}/${e}`;if(i){const e=new URLSearchParams;Object.entries(i).forEach((([t,s])=>{null!=s&&e.append(t,s)}));const t=e.toString();t&&(o+=`?${t}`)}const a={method:s,headers:{"Content-Type":"application/json"},credentials:"same-origin"};return"GET"!==s&&this.csrfToken&&(a.headers["X-CSRF-Token"]=this.csrfToken),n&&["POST","PUT","PATCH"].includes(s)&&(a.body=JSON.stringify(n)),fetch(o,a).then((e=>{if(!e.ok)throw new Error(`API request failed: ${e.status} ${e.statusText}`);return e.json()}))}addComment(e,t){const s=e.referencePath.split("#")[0],n=e.iid,i=encodeURIComponent(s);return this.callGitLabApi(`projects/${i}/issues/${n}/notes`,{method:"POST",data:{body:t}})}getCurrentUser(){return this.callGitLabApi("user")}},e.GitLabAPI=GitLabAPI,e.processBoards=function processBoards(){const e={},t={},s={};let n=0,i=0,o=0,a=null,r=0;return document.querySelectorAll(".board-list").forEach(((l,d)=>{let c="U"+d.toString();try{if(l.__vue__&&l.__vue__.$children&&l.__vue__.$children.length>0){const e=l.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(c=e.$props.list.title)}if("Unknown"===c){const e=l.querySelector(".board-title-text");e&&(c=e.textContent.trim())}}catch(e){console.error("Error getting board title:",e);const t=l.querySelector(".board-title-text");t&&(c=t.textContent.trim())}if("Unknown"===c)return;{t[c]||(t[c]={tickets:0,timeEstimate:0}),s[c]||(s[c]={});const e=c.toLowerCase();e.includes("done")||e.includes("closed")||e.includes("complete")||e.includes("finished")}const h=l.querySelectorAll(".board-card"),u=c.toLowerCase();(u.includes("done")||u.includes("closed")||u.includes("complete")||u.includes("finished"))&&(r+=h.length),h.forEach((r=>{try{if(i++,t[c].tickets++,r.__vue__&&r.__vue__.$children){const i=r.__vue__.$children.find((e=>e.$props&&e.$props.item&&void 0!==e.$props.item.timeEstimate));if(i&&i.$props){const r=i.$props;if(!a&&r.item&&r.item.milestone&&(a=r.item.milestone.title),r.item&&r.item.timeEstimate){o++;const i=r.item.timeEstimate;n+=i,t[c].timeEstimate+=i;let a=[];r.item.assignees&&r.item.assignees.nodes&&r.item.assignees.nodes.length?a=r.item.assignees.nodes:r.item.assignees&&r.item.assignees.length>0&&(a=r.item.assignees),a.length>0?a.forEach((t=>{const n=i/a.length,o=t.name;e[o]||(e[o]=0),e[o]+=n,s[c][o]||(s[c][o]={tickets:0,timeEstimate:0}),s[c][o].tickets++,s[c][o].timeEstimate+=n})):(e.Unassigned||(e.Unassigned=0),e.Unassigned+=i,s[c].Unassigned||(s[c].Unassigned={tickets:0,timeEstimate:0}),s[c].Unassigned.tickets++,s[c].Unassigned.timeEstimate+=i)}}}}catch(e){console.error("Error processing card:",e)}})),uiManager.issueSelector.applyOverflowFixes()})),{assigneeTimeMap:e,boardData:t,boardAssigneeData:s,totalEstimate:n,cardsProcessed:i,cardsWithTime:o,currentMilestone:a,closedBoardCards:r}},e.saveToStorage=function saveToStorage(e,t){try{return"object"==typeof t?localStorage.setItem(e,JSON.stringify(t)):localStorage.setItem(e,t),!0}catch(t){return console.error(`Error saving to localStorage (${e}):`,t),!1}},e.loadFromStorage=function loadFromStorage(e,t=null){try{const s=localStorage.getItem(e);if(null===s)return t;if(s.trim().startsWith("{")||s.trim().startsWith("["))try{return JSON.parse(s)}catch(t){return console.warn(`Failed to parse value for ${e} as JSON, returning as string instead`),s}return s}catch(s){return console.error(`Error loading from localStorage (${e}):`,s),t}};const t="gitLabHelperLabelWhitelist",s="gitLabHelperAssigneeWhitelist",n="gitLabHelperLastActiveTab",i={labelWhitelist:["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"],assigneeWhitelist:[],lastActiveTab:"summary",uiCollapsed:!1};function createUIManager(){return e.uiManager=e.uiManager||new UIManager,uiManager.settingsBtn&&(uiManager.settingsBtn.onclick=t=>{if(t.stopPropagation(),uiManager.bulkCommentsView&&uiManager.bulkCommentsView.settingsManager)uiManager.bulkCommentsView.settingsManager.openSettingsModal();else if(e.settingsManager)e.settingsManager.openSettingsModal();else{const t=new SettingsManager({labelManager:uiManager.labelManager,assigneeManager:uiManager.assigneeManager,gitlabApi:e.gitlabApi||uiManager.gitlabApi,onSettingsChanged:e=>{"all"!==e&&"labels"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView&&uiManager.bulkCommentsView.addAssignShortcut()}});uiManager.bulkCommentsView&&(uiManager.bulkCommentsView.settingsManager=t),e.settingsManager=t,t.openSettingsModal()}}),uiManager}function createUIManager(t=document.body){if(!e.gitlabApi)try{e.gitlabApi=new GitLabAPI}catch(e){console.error("Error creating GitLabAPI instance:",e)}try{if(e.uiManager=e.uiManager||new UIManager,uiManager.initialize(t),e.uiManager=uiManager,!e.settingsManager&&"function"==typeof SettingsManager)try{e.settingsManager=new SettingsManager({labelManager:uiManager?.labelManager,assigneeManager:uiManager?.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:e=>{uiManager?.bulkCommentsView&&("all"!==e&&"labels"!==e||uiManager.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||uiManager.bulkCommentsView.addAssignShortcut())}})}catch(e){console.error("Error creating SettingsManager:",e)}return uiManager}catch(e){return console.error("Error creating UI Manager:",e),null}}e.getLabelWhitelist=function getLabelWhitelist(){try{const e=loadFromStorage(t,null);if(null===e)return[...i.labelWhitelist];if(!Array.isArray(e))return console.warn("Label whitelist is not an array, using default"),[...i.labelWhitelist];const s=e.filter((e=>"string"==typeof e));return 0===s.length&&e.length>0?(console.warn("Label whitelist contained no valid strings, using default"),[...i.labelWhitelist]):s}catch(e){return console.error("Error getting label whitelist:",e),[...i.labelWhitelist]}},e.saveLabelWhitelist=function saveLabelWhitelist(e){try{Array.isArray(e)||(console.warn("Attempting to save invalid whitelist (not an array), using empty array instead"),e=[]);const s=e.filter((e=>"string"==typeof e));return saveToStorage(t,s)}catch(e){return console.error("Error saving label whitelist:",e),!1}},e.resetLabelWhitelist=function resetLabelWhitelist(){try{const e=[...i.labelWhitelist];return saveToStorage(t,e),e}catch(e){return console.error("Error resetting label whitelist:",e),[...i.labelWhitelist]}},e.getAssigneeWhitelist=function getAssigneeWhitelist(){try{const e=loadFromStorage(s,null);return null===e?[]:Array.isArray(e)?e.filter((e=>e&&"object"==typeof e&&"string"==typeof e.username)):(console.warn("Assignee whitelist is not an array, using empty array"),[])}catch(e){return console.error("Error getting assignee whitelist:",e),[]}},e.saveAssigneeWhitelist=function saveAssigneeWhitelist(e){try{Array.isArray(e)||(console.warn("Attempting to save invalid assignee whitelist (not an array), using empty array instead"),e=[]);const t=e.filter((e=>e&&"object"==typeof e&&"string"==typeof e.username));return saveToStorage(s,t)}catch(e){return console.error("Error saving assignee whitelist:",e),!1}},e.getLastActiveTab=function getLastActiveTab(){try{const e=loadFromStorage(n,null);if(null===e)return i.lastActiveTab;if("string"!=typeof e){const t=String(e);return t&&["summary","boards","bulkcomments","sprintmanagement"].includes(t)?t:(console.warn("Invalid tab ID format, using default"),i.lastActiveTab)}return"history"===e?"summary":["summary","boards","bulkcomments","sprintmanagement"].includes(e)?e:(console.warn(`Unknown tab ID: ${e}, using default`),i.lastActiveTab)}catch(e){return console.error("Error getting last active tab:",e),i.lastActiveTab}},e.saveLastActiveTab=function saveLastActiveTab(e){try{const t=String(e);return["summary","boards","bulkcomments","sprintmanagement"].includes(t)?saveToStorage(n,t):(console.warn(`Attempting to save invalid tab ID: ${t}, using default`),saveToStorage(n,i.lastActiveTab))}catch(e){return console.error("Error saving last active tab:",e),!1}},e.Notification=class Notification{constructor(e={}){this.position="top-right",this.duration=e.duration||3e3,this.animationDuration=e.animationDuration||"0.3s",this.container=null,this.createContainer()}createContainer(){if(document.getElementById("gitlab-helper-notifications"))this.container=document.getElementById("gitlab-helper-notifications");else{switch(this.container=document.createElement("div"),this.container.id="gitlab-helper-notifications",this.container.style.position="fixed",this.container.style.zIndex="100",this.position){case"top-right":this.container.style.top="120px",this.container.style.right="20px";break;case"top-left":this.container.style.top="20px",this.container.style.left="20px";break;case"top-center":this.container.style.top="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;case"bottom-left":this.container.style.bottom="20px",this.container.style.left="20px";break;case"bottom-center":this.container.style.bottom="20px",this.container.style.left="50%",this.container.style.transform="translateX(-50%)";break;default:this.container.style.bottom="20px",this.container.style.right="20px"}document.body.appendChild(this.container)}}show(e){const t=e.message||"",s=e.type||"info",n=e.duration||this.duration,i=e.onClose||null,o=document.createElement("div");switch(o.className=`notification notification-${s}`,o.style.padding="12px 16px",o.style.marginBottom="10px",o.style.borderRadius="4px",o.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.minWidth="200px",o.style.maxWidth="350px",o.style.opacity="0",o.style.transform=this.getInitialTransform(),o.style.transition=`opacity ${this.animationDuration} ease, transform ${this.animationDuration} ease`,s){case"success":o.style.backgroundColor="#28a745",o.style.color="white";break;case"error":o.style.backgroundColor="#dc3545",o.style.color="white";break;case"warning":o.style.backgroundColor="#ffc107",o.style.color="black";break;default:o.style.backgroundColor="#17a2b8",o.style.color="white"}const a=document.createElement("div");a.style.flex="1",a.textContent=t;const r=document.createElement("button");return r.innerHTML="&times;",r.style.backgroundColor="transparent",r.style.border="none",r.style.color=o.style.color,r.style.fontSize="18px",r.style.marginLeft="10px",r.style.cursor="pointer",r.style.padding="0 5px",r.style.opacity="0.7",r.style.transition="opacity 0.2s ease",r.style.outline="none",r.addEventListener("mouseenter",(()=>{r.style.opacity="1"})),r.addEventListener("mouseleave",(()=>{r.style.opacity="0.7"})),r.addEventListener("click",(()=>{this.close(o,i)})),o.appendChild(a),o.appendChild(r),this.container.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),10),n>0&&setTimeout((()=>{this.close(o,i)}),n),o}close(e,t=null){"true"!==e.dataset.closing&&(e.dataset.closing="true",e.style.opacity="0",e.style.transform=this.getInitialTransform(),setTimeout((()=>{e.parentNode===this.container&&this.container.removeChild(e),t&&"function"==typeof t&&t()}),1e3*parseFloat(this.animationDuration)))}getInitialTransform(){return this.position.startsWith("top")?"translateY(-20px)":"translateY(20px)"}success(e,t={}){return this.show({message:e,type:"success",...t})}error(e,t={}){return this.show({message:e,type:"error",...t})}warning(e,t={}){return this.show({message:e,type:"warning",...t})}info(e,t={}){return this.show({message:e,type:"info",...t})}},e.CommandShortcut=class CommandShortcut{constructor(e){this.targetElement=e.targetElement,this.onShortcutInsert=e.onShortcutInsert||null,this.shortcutsContainer=null,this.shortcuts={}}initialize(e){this.shortcutsContainer&&this.shortcutsContainer.parentNode&&this.shortcutsContainer.parentNode.removeChild(this.shortcutsContainer),this.shortcutsContainer=document.createElement("div"),this.shortcutsContainer.className="command-shortcuts-container",this.shortcutsContainer.style.marginBottom="10px",this.shortcutsContainer.style.display="flex",this.shortcutsContainer.style.flexDirection="column",this.shortcutsContainer.style.gap="8px",this.shortcutsContainer.style.alignItems="stretch",e.appendChild(this.shortcutsContainer),this.initializeEstimateShortcut()}initializeEstimateShortcut(){this.shortcuts.estimate&&this.removeShortcut("estimate"),this.addCustomShortcut({type:"estimate",label:"/estimate",items:[{value:"",label:"Estimate Hours"},{value:"1",label:"1h"},{value:"2",label:"2h"},{value:"4",label:"4h"},{value:"8",label:"8h"},{value:"16",label:"16h"},{value:"32",label:"32h"},{value:"custom",label:"Custom..."}],onSelect:e=>{"custom"===e?this.handleCustomEstimate():e&&this.insertEstimateText(e)}})}removeShortcut(e){if(this.shortcuts[e]&&this.shortcuts[e].element){const t=this.shortcuts[e].element;t.parentNode&&t.parentNode.removeChild(t),delete this.shortcuts[e]}}handleCustomEstimate(){const e=prompt("Enter custom estimate hours (whole numbers only):","");if(null===e||""===e)return;const t=parseInt(e,10);isNaN(t)||t<=0||t!==parseFloat(e)?alert("Please enter a valid positive whole number."):this.insertEstimateText(t.toString())}insertEstimateText(e){if(!this.targetElement)return;const t=`/estimate ${e}h`,s=this.targetElement.value,n=/\/estimate\s+\d+h/g;if(n.test(s))this.targetElement.value=s.replace(n,t);else{const e=this.targetElement.selectionStart,n=this.targetElement.selectionEnd;let i=t;e>0&&"\n"!==s.charAt(e-1)&&s.length>0&&(i="\n"+i),this.targetElement.value=s.substring(0,e)+i+s.substring(n);const o=e+i.length;this.targetElement.setSelectionRange(o,o)}this.targetElement.focus(),"function"==typeof this.onShortcutInsert&&this.onShortcutInsert("estimate",e)}addCustomShortcut(e){if(!this.shortcutsContainer)return console.error("Shortcuts container not initialized"),null;this.shortcuts&&this.shortcuts[e.type]&&this.removeShortcut(e.type);const t=document.createElement("div");t.className=`shortcut-item ${e.type}-shortcut`,t.style.display="flex",t.style.alignItems="center",t.style.width="100%",t.style.marginBottom="8px",t.style.justifyContent="space-between",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="6px 10px",t.style.backgroundColor="#f8f9fa",t.style.height="36px",t.style.boxSizing="border-box",t.dataset.shortcutType=e.type;const s=document.createElement("div");s.textContent=e.label,s.style.fontSize="13px",s.style.fontWeight="bold",s.style.color="#555",s.style.minWidth="100px",s.style.flexShrink="0",s.style.whiteSpace="nowrap";const n=document.createElement("div");n.style.flex="1",n.style.position="relative",n.style.height="24px",n.style.marginLeft="10px";const i=document.createElement("select");i.className=`${e.type}-dropdown`,i.style.width="100%",i.style.height="100%",i.style.appearance="auto",i.style.padding="0 25px 0 8px",i.style.fontSize="13px",i.style.border="1px solid #ccc",i.style.borderRadius="4px",i.style.backgroundColor="#fff",i.style.boxSizing="border-box";const o=document.createElement("option");o.value="",o.textContent=e.items[0]?.label||"Select...",o.selected=!0,i.appendChild(o),e.items&&e.items.length>0&&e.items.forEach(((e,t)=>{if(0===t)return;const s=document.createElement("option");s.value=e.value,s.textContent=e.label,i.appendChild(s)})),i.addEventListener("change",(t=>{const s=t.target.value;s&&e.onSelect&&(e.onSelect(s),t.target.value="")})),n.appendChild(i),t.appendChild(s),t.appendChild(n);const a=["estimate","label","milestone","assign"],r=a.indexOf(e.type);if(-1===r)this.shortcutsContainer.appendChild(t);else{let e=!1;const s=this.shortcutsContainer.querySelectorAll(".shortcut-item");for(let n=0;n<s.length;n++){const i=s[n].dataset.shortcutType;if(a.indexOf(i)>r){this.shortcutsContainer.insertBefore(t,s[n]),e=!0;break}}e||this.shortcutsContainer.appendChild(t)}return this.shortcuts[e.type]={element:t,dropdown:i,options:e},t}},e.SelectionDisplay=class SelectionDisplay{constructor(e={}){this.selectedIssues=e.selectedIssues||[],this.onRemoveIssue=e.onRemoveIssue||null,this.container=null,this.issuesList=null}createSelectionContainer(e){this.container=e;const t=document.createElement("div");t.style.marginBottom="12px",t.style.padding="8px",t.style.borderRadius="4px",t.style.border="1px dashed #ccc",t.style.backgroundColor="#f9f9f9",t.style.maxHeight="150px",t.style.overflowY="auto";const s=document.createElement("div");s.style.fontSize="12px",s.style.color="#666",s.style.marginBottom="5px",s.textContent="Selected Issues:",t.appendChild(s);const n=document.createElement("div");n.id="selected-issues-list",n.style.fontSize="14px",this.issuesList=n,this.displayNoIssuesMessage(),t.appendChild(n),e.appendChild(t),this.updateDisplay()}displayNoIssuesMessage(){if(!this.issuesList)return;if(this.issuesList.querySelector("#no-issues-selected"))return;const e=document.createElement("div");e.id="no-issues-selected",e.textContent="No issues selected",e.style.color="#666",e.style.fontStyle="italic",this.issuesList.appendChild(e)}updateDisplay(){if(!this.issuesList)return void console.error("Issues list not initialized");if(this.issuesList.innerHTML="",!this.selectedIssues||0===this.selectedIssues.length){this.displayNoIssuesMessage();const e=this.issuesList.parentElement;return void(e&&(e.style.borderColor="#ccc",e.style.backgroundColor="#f9f9f9"))}const e=this.issuesList.parentElement;e&&(e.style.borderColor="#1f75cb",e.style.backgroundColor="rgba(31, 117, 203, 0.05)"),this.selectedIssues.forEach(((e,t)=>{if(!e)return;const s=document.createElement("div");s.className="selected-issue-item",s.style.padding="5px",s.style.marginBottom="3px",s.style.borderRadius="3px",s.style.backgroundColor="rgba(31, 117, 203, 0.1)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center";const n=document.createElement("div"),i=e.iid||"Unknown",o=e.title||"Untitled Issue";n.innerHTML=`<strong>#${i}</strong> - ${o}`,n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.style.whiteSpace="nowrap",n.style.marginRight="5px",s.appendChild(n);const a=document.createElement("button");a.textContent="Ã—",a.style.backgroundColor="transparent",a.style.border="none",a.style.color="#dc3545",a.style.fontSize="16px",a.style.fontWeight="bold",a.style.cursor="pointer",a.style.padding="0 5px",a.title="Remove this issue",a.addEventListener("mouseenter",(()=>{a.style.color="#c82333"})),a.addEventListener("mouseleave",(()=>{a.style.color="#dc3545"})),a.onclick=e=>{e.stopPropagation(),this.removeIssue(t)},s.appendChild(a),this.issuesList.appendChild(s)}))}onRemoveIssue(t){if(this.selectedIssues.length>t){this.selectedIssues[t];this.selectedIssues.splice(t,1),this.uiManager&&this.uiManager.issueSelector?this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]):e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.updateDisplay()}},e.IssueSelector=class IssueSelector{constructor(e={}){this.uiManager=e.uiManager,this.onSelectionChange=e.onSelectionChange||null,this.onSelectionComplete=e.onSelectionComplete||null,this.isSelectingIssue=!1,this.selectionOverlays=[],this.selectedOverlays=[],this.selectedIssues=e.initialSelection||[],this.pageOverlay=null,this.selectionCounter=null,this.helpText=null,document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isSelectingIssue&&this.exitSelectionMode()}))}startSelection(){if(this.isSelectingIssue)return;this.isSelectingIssue=!0;const t=[...this.selectedIssues];this.applyOverflowFixes(),this.createCardOverlays(t),this.createFixedControls();const s=document.getElementById("select-issues-button");s&&(s.dataset.active="true",s.style.backgroundColor="#28a745",s.textContent="âœ“ Done"),e.addEventListener("scroll",this.handleScroll),e.addEventListener("resize",this.handleResize),this.setupMutationObserver()}applyOverflowFixes(){this.originalStyles=[];document.querySelectorAll("ul.board-list").forEach((e=>{this.originalStyles=[{element:e,property:"overflow-x",value:e.style.overflowX}],e.style.setProperty("overflow-x","unset","important"),e.style.setProperty("overflow-y","unset","important")}));const e=document.querySelectorAll('[data-testid="board-list-cards-area"]');return e.forEach((e=>{this.originalStyles.push({element:e,property:"overflow",value:e.style.overflow}),this.originalStyles.push({element:e,property:"position",value:e.style.position}),e.style.overflow="auto",e.style.position="relative"})),e}createCardOverlays(e=[]){this.selectionOverlays.forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})),this.selectionOverlays=[],this.selectedIssues=e||[],this.selectedOverlays=[];const t=document.querySelectorAll('[data-testid="board-list-cards-area"]');console.log(`Found ${t.length} card areas`),t.forEach((t=>{try{const s=t.querySelectorAll(".board-card");console.log(`Found ${s.length} cards in card area`),s.forEach(((s,n)=>{try{const i=this.getIssueItemFromCard(s);if(!i)return;const o=document.createElement("div");if(o.className="card-selection-overlay",o.style.position="absolute",o.style.zIndex="99",o.style.backgroundColor="rgba(31, 117, 203, 0.2)",o.style.border="2px solid rgba(31, 117, 203, 0.6)",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.transition="background-color 0.2s ease",o.style.boxSizing="border-box",o.dataset.cardId=s.id||`card-${Date.now()}-${n}`,o.dataset.selected="false",o.originalCard=s,o.dataset.issueId=`${i.iid}-${i.referencePath}`,this.positionOverlay(o,s,t),e.some((e=>e.iid===i.iid&&e.referencePath===i.referencePath))){o.dataset.selected="true",o.style.backgroundColor="rgba(0, 177, 106, 0.3)",o.style.borderColor="rgba(0, 177, 106, 0.8)",o.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedOverlays.length+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",o.appendChild(t),this.selectedOverlays.push(o)}o.addEventListener("mouseenter",(function(){"true"!==this.dataset.selected&&(this.style.backgroundColor="rgba(31, 117, 203, 0.3)",this.style.boxShadow="0 0 8px rgba(31, 117, 203, 0.5)")})),o.addEventListener("mouseleave",(function(){"true"!==this.dataset.selected&&(this.style.backgroundColor="rgba(31, 117, 203, 0.2)",this.style.boxShadow="none")})),o.addEventListener("click",(e=>{e.stopPropagation(),this.toggleCardSelection(s,o)})),t.appendChild(o),this.selectionOverlays.push(o)}catch(e){console.error("Error creating overlay for card:",e)}}))}catch(e){console.error("Error processing card area:",e)}}))}updateSelectionCounter(){if(this.selectionCounter){const e=this.selectedIssues.length;this.selectionCounter.textContent=`${e} issue${1!==e?"s":""} selected`,this.selectionCounter.style.backgroundColor=e>0?"rgba(40, 167, 69, 0.8)":"rgba(0, 0, 0, 0.7)"}"function"==typeof this.onSelectionChange&&this.onSelectionChange(this.selectedIssues),this.syncSelectionWithBulkCommentsView()}getIssueItemFromCard(t){try{if(t.__vue__){if(t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$options&&t.__vue__.$options.children&&t.__vue__.$options.children.length>0){const e=t.__vue__.$options.children.find((e=>e.$props&&e.$props.item));if(e&&e.$props&&e.$props.item)return e.$props.item}if(t.__vue__.$props&&t.__vue__.$props.item)return t.__vue__.$props.item}const s=t.querySelector("[data-issue-id]")?.dataset?.issueId,n=t.querySelector(".board-card-title");if(s&&n)return{iid:s,title:n.textContent.trim(),referencePath:e.location.pathname.split("/boards")[0]}}catch(e){console.error("Error getting issue item from card:",e)}return null}renumberBadges(){this.selectedOverlays.forEach(((e,t)=>{const s=e.querySelector(".selection-badge");s&&(s.textContent=t+1)}))}exitSelectionMode(){if(!this.isSelectingIssue)return;this.isSelectingIssue=!1,this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.overflowFixTimeout&&(clearTimeout(this.overflowFixTimeout),this.overflowFixTimeout=null),this.boardObserver&&(this.boardObserver.disconnect(),this.boardObserver=null),this.selectionOverlays.forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})),this.selectionCounter&&this.selectionCounter.parentNode&&(this.selectionCounter.parentNode.removeChild(this.selectionCounter),this.selectionCounter=null),this.helpText&&this.helpText.parentNode&&(this.helpText.parentNode.removeChild(this.helpText),this.helpText=null),this.selectionOverlays=[],this.selectedOverlays=[];const t=document.getElementById("select-issues-button");t&&(t.dataset.active="false",t.style.backgroundColor="#6c757d",t.textContent="ðŸ“Ž Select Issues"),this.syncSelectionWithBulkCommentsView(),"function"==typeof this.onSelectionComplete&&this.onSelectionComplete(this.selectedIssues),e.removeEventListener("scroll",this.handleScroll),e.removeEventListener("resize",this.handleResize)}toggleCardSelection(e,t){if(!this.isSelectingIssue)return;const s=this.getIssueItemFromCard(e);if(s){if("true"===t.dataset.selected)t.dataset.selected="false",t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)",t.style.boxShadow="none",this.selectedIssues=this.selectedIssues.filter((e=>!(e.iid===s.iid&&e.referencePath===s.referencePath))),this.selectedOverlays=this.selectedOverlays.filter((e=>e!==t)),t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),this.renumberBadges();else{t.dataset.selected="true",t.style.backgroundColor="rgba(0, 177, 106, 0.3)",t.style.borderColor="rgba(0, 177, 106, 0.8)",t.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=this.selectedIssues.length+1,n=document.createElement("div");n.className="selection-badge",n.textContent=e,n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.backgroundColor="rgba(0, 177, 106, 1)",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontWeight="bold",n.style.fontSize="12px",n.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",t.querySelectorAll(".selection-badge").forEach((e=>e.remove())),t.appendChild(n),this.selectedIssues.push(s),this.selectedOverlays.push(t)}this.updateSelectionCounter(),this.syncSelectionWithBulkCommentsView()}else{console.error("Failed to get issue item from card"),t.style.backgroundColor="rgba(220, 53, 69, 0.4)",t.style.borderColor="rgba(220, 53, 69, 0.8)",setTimeout((()=>{t.style.backgroundColor="rgba(31, 117, 203, 0.2)",t.style.borderColor="rgba(31, 117, 203, 0.6)"}),500);const e=document.getElementById("comment-status");e&&(e.textContent="Could not extract issue data from this card. Try another one.",e.style.color="#dc3545")}}syncSelectionWithBulkCommentsView(){try{if(this.uiManager&&this.uiManager.bulkCommentsView)this.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else if(e.uiManager&&e.uiManager.bulkCommentsView)e.uiManager.bulkCommentsView.setSelectedIssues([...this.selectedIssues]);else{const e=document.querySelector(".bulk-comments-view");e&&e.__vue__&&e.__vue__.setSelectedIssues?e.__vue__.setSelectedIssues([...this.selectedIssues]):console.warn("BulkCommentsView not found for synchronization")}}catch(e){console.error("Error syncing selection with bulk comments view:",e)}}repositionOverlays(){this.isSelectingIssue&&(this.helpText&&(this.helpText.style.top="10px",this.helpText.style.left="50%"),this.selectionCounter&&(this.selectionCounter.style.top="50px",this.selectionCounter.style.left="50%"),this.selectionOverlays.forEach((e=>{if(e&&"card-selection-overlay"===e.className&&e.originalCard){const t=e.originalCard,s=e.parentNode;t&&s&&this.positionOverlay(e,t,s)}})))}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.isSelectingIssue&&this.selectionOverlays.length>0&&this.updateOverlaysFromSelection();const t=document.getElementById("comment-status");if(t&&!this.isSelectingIssue){const e=this.selectedIssues.length;e>0?(t.textContent=`${e} issue${1!==e?"s":""} selected.`,t.style.color="green"):(t.textContent='No issues selected. Click "Select" to choose issues.',t.style.color="#666")}this.syncSelectionWithBulkCommentsView()}positionOverlay(e,t,s){try{const n=t.getBoundingClientRect(),i=s.getBoundingClientRect(),o=n.top-i.top+s.scrollTop,a=n.left-i.left+s.scrollLeft;e.style.top=`${o}px`,e.style.left=`${a}px`,e.style.width=`${n.width}px`,e.style.height=`${n.height}px`}catch(e){console.error("Error positioning overlay:",e)}}updateOverlaysFromSelection(){if(this.isSelectingIssue)try{const e=this.selectionOverlays.filter((e=>"card-selection-overlay"===e.className));e.forEach((e=>{e.dataset&&e.originalCard&&(e.dataset.selected="false",e.style.backgroundColor="rgba(31, 117, 203, 0.2)",e.style.borderColor="rgba(31, 117, 203, 0.6)",e.style.boxShadow="none",e.querySelectorAll(".selection-badge").forEach((e=>e.remove())))})),this.selectedOverlays=[],this.selectedIssues.forEach(((t,s)=>{if(!t)return;const n=e.find((e=>!(!e.dataset||!e.dataset.issueId)&&e.dataset.issueId===`${t.iid}-${t.referencePath}`));if(n){n.dataset.selected="true",n.style.backgroundColor="rgba(0, 177, 106, 0.3)",n.style.borderColor="rgba(0, 177, 106, 0.8)",n.style.boxShadow="0 0 12px rgba(0, 177, 106, 0.3)";const e=s+1,t=document.createElement("div");t.className="selection-badge",t.textContent=e,t.style.position="absolute",t.style.top="-10px",t.style.right="-10px",t.style.width="20px",t.style.height="20px",t.style.borderRadius="50%",t.style.backgroundColor="rgba(0, 177, 106, 1)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontWeight="bold",t.style.fontSize="12px",t.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.2)",n.appendChild(t),this.selectedOverlays.push(n)}})),this.updateSelectionCounter()}catch(e){console.error("Error updating overlays from selection:",e)}}createFixedControls(){const e=document.createElement("div");e.id="selection-help-text",e.textContent="Click on issues to select/deselect them â€¢ Press ESC or click button when finished",e.style.position="fixed",e.style.top="10px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.padding="8px 16px",e.style.borderRadius="20px",e.style.fontSize="14px",e.style.zIndex="999",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",this.helpText=e,document.body.appendChild(e),this.selectionOverlays.push(e);const t=document.createElement("div");t.id="selection-counter",t.textContent=`${this.selectedIssues.length} issues selected`,t.style.position="fixed",t.style.top="50px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor=this.selectedIssues.length>0?"rgba(40, 167, 69, 0.9)":"rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="8px 16px",t.style.borderRadius="20px",t.style.fontSize="14px",t.style.zIndex="999",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)",this.selectionCounter=t,document.body.appendChild(t),this.selectionOverlays.push(t)}handleScroll=()=>{this.repositionOverlays()};handleResize=()=>{this.repositionOverlays()};setupMutationObserver(){this.boardObserver&&this.boardObserver.disconnect(),this.boardObserver=new MutationObserver((t=>{if(!this.isSelectingIssue)return;let s=!1,n=!1;t.forEach((t=>{if("childList"===t.type&&t.addedNodes.length>0){Array.from(t.addedNodes).some((e=>e.classList&&e.classList.contains("board-card")))&&(s=!0)}if("attributes"===t.type&&"style"===t.attributeName){const s=t.target;if(s.matches('[data-testid="board-list-cards-area"]')||s.matches(".board-list ul")){const t=e.getComputedStyle(s);s.matches('[data-testid="board-list-cards-area"]')&&"auto"!==t.overflow&&(n=!0),s.matches(".board-list ul")&&"unset"!==t.overflowX&&(n=!0)}}})),n&&(console.log("Overflow settings changed, reapplying fixes"),clearTimeout(this.overflowFixTimeout),this.overflowFixTimeout=setTimeout((()=>{this.applyOverflowFixes()}),50)),s&&(console.log("Cards changed, updating overlays"),clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout((()=>{this.createCardOverlays(this.selectedIssues)}),100))}));document.querySelectorAll('.board-list, [data-testid="board-list"], .boards-list').forEach((e=>{this.boardObserver.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})}))}},e.TabManager=class TabManager{constructor(uiManager){this.uiManager=uiManager,this.tabContainer=null,this.tabs={},this.contentAreas={};try{let e=getLastActiveTab()||"summary";"history"===e&&(e="summary"),this.currentTab=e}catch(e){console.warn("Error loading last active tab:",e),this.currentTab="summary"}}initialize(e){this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.marginBottom="10px",this.tabContainer.style.borderBottom="1px solid #ddd",this.createTab("summary","Summary","summary"===this.currentTab),this.createTab("boards","Boards","boards"===this.currentTab),this.createTab("bulkcomments","Issues","bulkcomments"===this.currentTab),this.createTab("sprintmanagement","Sprint","sprintmanagement"===this.currentTab),e.appendChild(this.tabContainer),this.createContentAreas(e)}createTab(e,t,s=!1){const n=document.createElement("div");n.textContent=t,n.dataset.tab=e,n.style.padding="5px 10px",n.style.cursor="pointer",s&&(n.style.borderBottom="2px solid #1f75cb",n.style.fontWeight="bold",this.currentTab=e),n.addEventListener("click",(()=>{this.switchToTab(e)})),this.tabs[e]=n,this.tabContainer.appendChild(n)}createContentAreas(e){const t=document.createElement("div");t.id="assignee-time-summary-content",t.style.display="summary"===this.currentTab?"block":"none",t.style.position="relative",t.style.height="530px",t.style.overflowY="auto",t.style.maxHeight="60vh",e.appendChild(t),this.contentAreas.summary=t,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(t,"summary-tab","Loading summary data...");const s=document.createElement("div");s.id="boards-time-summary-content",s.style.display="boards"===this.currentTab?"block":"none",s.style.position="relative",s.style.height="530px",s.style.overflowY="auto",s.style.maxHeight="60vh",e.appendChild(s),this.contentAreas.boards=s,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(s,"boards-tab","Loading board data...");const n=document.createElement("div");n.id="bulk-comments-content",n.style.display="bulkcomments"===this.currentTab?"block":"none",n.style.position="relative",n.style.height="530px",n.style.overflowY="auto",n.style.maxHeight="60vh",e.appendChild(n),this.contentAreas.bulkcomments=n,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(n,"bulkcomments-tab","Loading comment tools...");const i=document.createElement("div");i.id="sprint-management-content",i.style.display="sprintmanagement"===this.currentTab?"block":"none",i.style.position="relative",i.style.height="530px",i.style.overflowY="auto",i.style.maxHeight="60vh",e.appendChild(i),this.contentAreas.sprintmanagement=i,this.uiManager&&this.uiManager.addLoadingScreen&&this.uiManager.addLoadingScreen(i,"sprintmanagement-tab","Loading sprint management tools...")}switchToTab(e){Object.keys(this.tabs).forEach((e=>{this.tabs[e].style.borderBottom="none",this.tabs[e].style.fontWeight="normal",this.contentAreas[e].style.display="none"})),this.tabs[e].style.borderBottom="2px solid #1f75cb",this.tabs[e].style.fontWeight="bold",this.contentAreas[e].style.display="block",this.currentTab=e;try{saveLastActiveTab(e)}catch(e){console.warn("Error saving tab selection:",e)}"bulkcomments"===e&&this.uiManager.bulkCommentsView&&(this.uiManager.bulkCommentsView.render(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")),"sprintmanagement"===e&&this.uiManager.sprintManagementView&&(this.uiManager.sprintManagementView.render(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("sprintmanagement-tab")),uiManager.issueSelector.applyOverflowFixes()}},e.CommandManager=class CommandManager{constructor(e={}){this.targetElement=e.targetElement,this.gitlabApi=e.gitlabApi,this.labelManager=e.labelManager,this.onCommandInsert=e.onCommandInsert||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.shortcutContainer=null,this.commandShortcut=null}initialize(e){this.shortcutContainer=e,this.commandShortcut=new CommandShortcut({targetElement:this.targetElement,onShortcutInsert:(e,t)=>{"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}}),this.commandShortcut.initialize(e),this.addCustomShortcuts()}addCustomShortcuts(){this.commandShortcut&&(this.addMilestoneShortcut(),this.addAssignShortcut(),this.addDueDateShortcut(),this.addWeightShortcut())}addMilestoneShortcut(){this.commandShortcut.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"%backlog",label:"Backlog"},{value:"none",label:"Remove Milestone"}],onSelect:e=>{if(!this.targetElement)return;let t="/milestone ";"none"===e?t+='%""':e.startsWith("%")?t+=e:t+=`%"${e}"`;this.replaceOrInsertCommand("milestone",t,/\/milestone\s+%[^\n]+/g,(()=>this.insertTextAtCursor(t))),this.notification.info(`Milestone command added: ${e}`)}})}addAssignShortcut(){if(this.commandShortcuts)try{let t=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}];if(this.assigneeManager&&"function"==typeof this.assigneeManager.getAssigneeWhitelist)try{const e=this.assigneeManager.getAssigneeWhitelist();if(Array.isArray(e)&&e.length>0){t.push({value:"separator",label:"â”€â”€â”€â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s)}}catch(e){console.error("Error getting assignee whitelist from manager:",e);try{const e=getAssigneeWhitelist();if(Array.isArray(e)&&e.length>0){t.push({value:"separator",label:"â”€â”€â”€â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s)}}catch(e){console.error("Error accessing assignee whitelist from storage:",e)}}else try{let s=[];if("function"==typeof getAssigneeWhitelist?s=getAssigneeWhitelist():e.getAssigneeWhitelist?s=e.getAssigneeWhitelist():console.warn("getAssigneeWhitelist function not available, no assignees will be loaded"),Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"â”€â”€â”€â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}}catch(e){console.error("Error directly accessing assignee whitelist:",e)}this.fetchGroupMembers().then((e=>{if(e&&e.length>0){t.push({value:"separator2",label:"â”€â”€â”€â”€â”€â”€ Group Members â”€â”€â”€â”€â”€â”€"});const s=e.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(s),this.updateAssignShortcut(t)}})).catch((e=>{console.error("Error fetching group members:",e)})),t.push({value:"custom",label:"Custom..."}),t.push({value:"manage",label:"âœï¸ Manage Assignees..."}),this.updateAssignShortcut(t)}catch(e){console.error("Error adding assign shortcut:",e)}}addDueDateShortcut(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=new Date(e);s.setDate(s.getDate()+7);const n=new Date(e);n.setMonth(n.getMonth()+1);const formatDate=e=>e.toISOString().substring(0,10);this.commandShortcut.addCustomShortcut({type:"due",label:"/due",items:[{value:"",label:"Set Due Date"},{value:formatDate(e),label:"Today"},{value:formatDate(t),label:"Tomorrow"},{value:formatDate(s),label:"Next Week"},{value:formatDate(n),label:"Next Month"},{value:"custom",label:"Custom Date..."},{value:"none",label:"Remove Due Date"}],onSelect:t=>{if(!this.targetElement)return;if("custom"===t){const s=prompt("Enter due date (YYYY-MM-DD):",formatDate(e));if(!s)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(s))return void this.notification.error("Invalid date format. Please use YYYY-MM-DD");t=s}let s="/due ";s+="none"===t?"none":t;this.replaceOrInsertCommand("due",s,/\/due\s+[^\n]+/g,(()=>this.insertTextAtCursor(s))),"none"===t?this.notification.info("Due date will be removed"):this.notification.info(`Due date set to ${t}`)}})}addWeightShortcut(){this.commandShortcut.addCustomShortcut({type:"weight",label:"/weight",items:[{value:"",label:"Set Weight"},{value:"1",label:"1 (Trivial)"},{value:"2",label:"2 (Small)"},{value:"3",label:"3 (Medium)"},{value:"5",label:"5 (Large)"},{value:"8",label:"8 (Very Large)"},{value:"custom",label:"Custom Weight..."},{value:"none",label:"Remove Weight"}],onSelect:e=>{if(!this.targetElement)return;if("custom"===e){const t=prompt("Enter weight (number):","");if(!t)return;const s=parseInt(t,10);if(isNaN(s)||s<0)return void this.notification.error("Invalid weight. Please enter a positive number");e=t}let t="/weight ";t+="none"===e?"none":e;this.replaceOrInsertCommand("weight",t,/\/weight\s+[^\n]+/g,(()=>this.insertTextAtCursor(t))),"none"===e?this.notification.info("Weight will be removed"):this.notification.info(`Weight set to ${e}`)}})}openAssigneeManager(){const e=document.createElement("div");e.id="assignee-manager-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="110",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="500px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div"),a=document.createElement("p");a.textContent="Add usernames to quickly assign issues. These will appear in your /assign dropdown.",a.style.marginBottom="15px";const r=document.createElement("div");r.style.marginBottom="15px",r.style.maxHeight="200px",r.style.overflowY="auto";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add some below.",e.style.color="#666",e.style.fontStyle="italic",e.style.padding="10px 0",e};this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="8px",s.style.borderBottom="1px solid #eee";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const i=document.createElement("div");i.textContent=e.name||e.username,i.style.fontWeight="bold",i.style.marginRight="5px";const o=document.createElement("div");o.textContent=`@${e.username}`,o.style.color="#666",o.style.fontSize="13px",n.appendChild(i),n.appendChild(o);const a=document.createElement("button");a.textContent="Remove",a.style.padding="3px 8px",a.style.backgroundColor="#dc3545",a.style.color="white",a.style.border="none",a.style.borderRadius="3px",a.style.cursor="pointer",a.onclick=()=>{this.assigneeWhitelist.splice(t,1),saveAssigneeWhitelist(this.assigneeWhitelist),s.remove(),0===this.assigneeWhitelist.length&&r.appendChild(createEmptyMessage())},s.appendChild(n),s.appendChild(a),r.appendChild(s)})),0===this.assigneeWhitelist.length&&r.appendChild(createEmptyMessage());const l=document.createElement("div");l.style.marginTop="20px",l.style.marginBottom="20px",l.style.padding="15px",l.style.backgroundColor="#f8f9fa",l.style.borderRadius="4px";const d=document.createElement("div");d.textContent="Add New Assignee",d.style.fontWeight="bold",d.style.marginBottom="10px";const c=document.createElement("div");c.style.marginBottom="10px";const h=document.createElement("label");h.textContent="Display Name:",h.style.display="block",h.style.marginBottom="5px";const u=document.createElement("input");u.type="text",u.placeholder="John Doe",u.style.width="100%",u.style.padding="8px",u.style.borderRadius="4px",u.style.border="1px solid #ccc",c.appendChild(h),c.appendChild(u);const p=document.createElement("div");p.style.marginBottom="15px";const m=document.createElement("label");m.textContent="GitLab Username:",m.style.display="block",m.style.marginBottom="5px";const g=document.createElement("input");g.type="text",g.placeholder="username (without @)",g.style.width="100%",g.style.padding="8px",g.style.borderRadius="4px",g.style.border="1px solid #ccc",p.appendChild(m),p.appendChild(g);const y=document.createElement("button");y.textContent="Add Assignee",y.style.padding="8px 16px",y.style.backgroundColor="#28a745",y.style.color="white",y.style.border="none",y.style.borderRadius="4px",y.style.cursor="pointer",y.onclick=()=>{const e=u.value.trim(),t=g.value.trim();if(!t)return void alert("Username is required");const s={name:e||t,username:t},n=this.assigneeWhitelist.findIndex((e=>e.username===t));n>=0?this.assigneeWhitelist[n]=s:this.assigneeWhitelist.push(s),saveAssigneeWhitelist(this.assigneeWhitelist);const i=r.querySelector('div[style*="italic"]');i&&i.remove();const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.padding="8px",o.style.borderBottom="1px solid #eee";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center";const l=document.createElement("div");l.textContent=s.name,l.style.fontWeight="bold",l.style.marginRight="5px";const d=document.createElement("div");d.textContent=`@${s.username}`,d.style.color="#666",d.style.fontSize="13px",a.appendChild(l),a.appendChild(d);const c=document.createElement("button");c.textContent="Remove",c.style.padding="3px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="3px",c.style.cursor="pointer",c.onclick=()=>{const e=this.assigneeWhitelist.findIndex((e=>e.username===s.username));e>=0&&(this.assigneeWhitelist.splice(e,1),saveAssigneeWhitelist(this.assigneeWhitelist),o.remove(),0===this.assigneeWhitelist.length&&r.appendChild(createEmptyMessage()))},o.appendChild(a),o.appendChild(c),r.appendChild(o),u.value="",g.value="",this.notification.success(`Added assignee: ${s.name}`)},l.appendChild(d),l.appendChild(c),l.appendChild(p),l.appendChild(y);const b=document.createElement("button");b.textContent="Close",b.style.padding="8px 16px",b.style.backgroundColor="#6c757d",b.style.color="white",b.style.border="none",b.style.borderRadius="4px",b.style.cursor="pointer",b.style.marginTop="10px",b.onclick=()=>{e.remove(),this.addAssignShortcut()},o.appendChild(a),o.appendChild(r),o.appendChild(l),o.appendChild(b),t.appendChild(s),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&(e.remove(),this.addAssignShortcut())}))}insertTextAtCursor(e){if(!this.targetElement)return;const t=this.targetElement.selectionStart,s=this.targetElement.selectionEnd,n=this.targetElement.value;let i=e;t>0&&"\n"!==n.charAt(t-1)&&n.length>0&&(i="\n"+i),this.targetElement.value=n.substring(0,t)+i+n.substring(s);const o=t+i.length;this.targetElement.setSelectionRange(o,o),this.targetElement.focus()}replaceOrInsertCommand(e,t,s,n){if(!this.targetElement)return;const i=this.targetElement.value;if(s.test(i)){const e=i.replace(s,t);this.targetElement.value=e,this.targetElement.focus()}else n();"function"==typeof this.onCommandInsert&&this.onCommandInsert(e,t)}},e.LabelManager=class LabelManager{constructor(t={}){this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onLabelsLoaded=t.onLabelsLoaded||null,this.labelWhitelist=[];try{this.labelWhitelist=getLabelWhitelist(),Array.isArray(this.labelWhitelist)||(console.warn("Loaded whitelist is not an array, using default"),this.labelWhitelist=this.getDefaultWhitelist())}catch(e){console.warn("Error loading label whitelist, using default",e),this.labelWhitelist=this.getDefaultWhitelist()}this.availableLabels=[],this.filteredLabels=[],this.isLoading=!1}getDefaultWhitelist(){return["bug","feature","documentation","enhancement","security","priority","high","medium","low","critical","frontend","backend","ui","ux","api","wontfix","duplicate","invalid","question","ready","in progress","review","blocked"]}saveWhitelist(e){Array.isArray(e)||(e=[]),this.labelWhitelist=e;try{saveLabelWhitelist(e)}catch(e){console.error("Error saving label whitelist",e)}this.filterLabels()}resetToDefaultWhitelist(){try{this.labelWhitelist=this.getDefaultWhitelist(),saveLabelWhitelist(this.labelWhitelist)}catch(e){console.error("Error resetting label whitelist",e)}return this.filterLabels(),this.labelWhitelist}isLabelInWhitelist(e,t=null){const s=t||this.labelWhitelist;if(!Array.isArray(s)||"string"!=typeof e)return!1;const n=e.toLowerCase();return s.some((e=>"string"==typeof e&&n.includes(e.toLowerCase())))}filterLabels(){this.availableLabels&&0!==this.availableLabels.length?(this.filteredLabels=this.availableLabels.filter((e=>!(!e||"string"!=typeof e.name)&&this.isLabelInWhitelist(e.name))),this.filteredLabels.sort(((e,t)=>e.name.localeCompare(t.name))),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels)):this.filteredLabels=[]}async fetchAllLabels(){try{if(this.isLoading=!0,this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)return console.warn("GitLab API instance not available, using fallback labels"),this.isLoading=!1,this.addFallbackLabels();const t=getPathFromUrl();if(!t||!t.apiUrl)return console.warn("Path info not found or invalid, returning fallback labels"),this.isLoading=!1,this.addFallbackLabels();try{const e=await this.gitlabApi.callGitLabApi(t.apiUrl,{params:{per_page:100}});return Array.isArray(e)?(this.availableLabels=e,this.filterLabels(),this.isLoading=!1,this.filteredLabels):(console.warn("API did not return an array of labels, using fallback"),this.isLoading=!1,this.addFallbackLabels())}catch(e){return console.error(`Error fetching ${t.type} labels from API:`,e),this.isLoading=!1,this.addFallbackLabels()}}catch(e){return console.error("Error in fetchAllLabels:",e),this.isLoading=!1,this.addFallbackLabels()}}addFallbackLabels(){return this.availableLabels=[{name:"bug",color:"#ff0000"},{name:"feature",color:"#1f75cb"},{name:"enhancement",color:"#7057ff"},{name:"documentation",color:"#0075ca"},{name:"priority",color:"#d73a4a"},{name:"blocked",color:"#b60205"}],this.filterLabels(),"function"==typeof this.onLabelsLoaded&&this.onLabelsLoaded(this.filteredLabels),this.filteredLabels}getLabelOptions(e=!0){if(!this.filteredLabels||0===this.filteredLabels.length){const t=[];return e&&t.push({value:"",label:"Add Label"}),t.concat([{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"custom",label:"Custom..."}])}const t=this.filteredLabels.map((e=>({value:e.name,label:e.name,color:e.color})));return e&&t.unshift({value:"",label:"Add Label"}),t.push({value:"custom",label:"Custom..."}),t}createStyledLabel(e){const t=document.createElement("span");t.textContent=e.label||e.name||"";const s=e.label||e.name||"label",n=e.color||generateColorFromString(s),i=getContrastColor(n);return t.style.backgroundColor=n,t.style.color=i,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}insertLabelCommand(e,t){if(!e||"string"!=typeof t)return;const s=`/label ~"${t}"`,n=/\/label\s+~[^\n]+/g,i=e.value;if(n.test(i))e.value=i.replace(n,s);else{const t=e.selectionStart,n=e.selectionEnd;let o=s;t>0&&"\n"!==i.charAt(t-1)&&i.length>0&&(o="\n"+o),e.value=i.substring(0,t)+o+i.substring(n);const a=t+o.length;e.setSelectionRange(a,a)}e.focus()}async initLabelDropdown(e,t={}){const s=e({items:[{value:"",label:"Loading labels..."}],disabled:!0,...t});try{await this.fetchAllLabels(),s.updateItems(this.getLabelOptions()),s.enable()}catch(e){console.error("Error initializing label dropdown:",e),s.updateItems([{value:"",label:"Error loading labels"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"custom",label:"Custom..."}]),s.enable()}return s}},e.AssigneeManager=class AssigneeManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onAssigneesChange=e.onAssigneesChange||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.assigneeWhitelist=getAssigneeWhitelist(),this.currentUsers=[]}getAssigneeWhitelist(){return[...this.assigneeWhitelist]}saveWhitelist(e){this.assigneeWhitelist=e,saveAssigneeWhitelist(e),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist)}addAssignee(e){if(!e||!e.username)return!1;const t=this.assigneeWhitelist.findIndex((t=>t.username.toLowerCase()===e.username.toLowerCase()));return t>=0?this.assigneeWhitelist[t]={...this.assigneeWhitelist[t],...e}:this.assigneeWhitelist.push(e),saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0}removeAssignee(e){if(!e)return!1;const t=this.assigneeWhitelist.length;return this.assigneeWhitelist=this.assigneeWhitelist.filter((t=>t.username.toLowerCase()!==e.toLowerCase())),this.assigneeWhitelist.length!==t&&(saveAssigneeWhitelist(this.assigneeWhitelist),"function"==typeof this.onAssigneesChange&&this.onAssigneesChange(this.assigneeWhitelist),!0)}async fetchCurrentUser(){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");try{const e=await this.gitlabApi.getCurrentUser();return this.addAssignee({name:e.name,username:e.username}),e}catch(e){throw console.error("Error fetching current user:",e),e}}async fetchGroupMembers(e){if(!this.gitlabApi)throw new Error("GitLab API instance not provided");if(!e)throw new Error("Group ID is required");try{const t=await this.gitlabApi.callGitLabApi(`groups/${encodeURIComponent(e)}/members`,{params:{per_page:100}});return this.currentUsers=t.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.currentUsers}catch(t){throw console.error(`Error fetching members for group ${e}:`,t),t}}openAssigneeManager(){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="110",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="600px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Manage Assignees",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div"),a=document.createElement("p");a.textContent="Manage assignees that appear in the assignee dropdown. These users will be available for quick assignment to issues.",a.style.marginBottom="20px";const r=document.createElement("div");r.style.marginBottom="20px";const l=document.createElement("h4");l.textContent="Current Assignees",l.style.marginBottom="10px",l.style.fontSize="16px",r.appendChild(l);const d=document.createElement("div");if(d.style.height="300px",d.style.overflowY="auto",d.style.border="1px solid #eee",d.style.borderRadius="4px",this.assigneeWhitelist.length>0)this.assigneeWhitelist.forEach(((e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.padding="10px",s.style.borderBottom=t<this.assigneeWhitelist.length-1?"1px solid #eee":"none";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center";const i=document.createElement("div");i.style.width="32px",i.style.height="32px",i.style.borderRadius="50%",i.style.backgroundColor="#e0e0e0",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.marginRight="10px",i.style.fontSize="14px",i.style.fontWeight="bold",i.style.color="#666";const o=e.name||e.username||"";i.textContent=o.split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase(),n.appendChild(i);const a=document.createElement("div"),r=document.createElement("div");r.textContent=e.name||e.username,r.style.fontWeight="bold";const l=document.createElement("div");l.textContent=`@${e.username}`,l.style.fontSize="12px",l.style.color="#666",a.appendChild(r),a.appendChild(l),n.appendChild(a);const c=document.createElement("button");c.textContent="Remove",c.style.padding="4px 8px",c.style.backgroundColor="#dc3545",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=()=>{if(this.removeAssignee(e.username),s.remove(),this.notification.info(`Removed assignee: ${e.name||e.username}`),0===this.assigneeWhitelist.length){const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}},s.appendChild(n),s.appendChild(c),d.appendChild(s)}));else{const e=document.createElement("div");e.textContent="No assignees added yet. Add some below.",e.style.padding="10px",e.style.color="#666",e.style.fontStyle="italic",d.appendChild(e)}r.appendChild(d);const c=document.createElement("div");c.style.marginTop="20px",c.style.padding="15px",c.style.backgroundColor="#f8f9fa",c.style.borderRadius="4px";const h=document.createElement("h4");h.textContent="Add New Assignee",h.style.marginBottom="15px",h.style.fontSize="16px";const u=document.createElement("div");u.style.marginBottom="10px";const p=document.createElement("label");p.textContent="Display Name:",p.style.display="block",p.style.marginBottom="5px";const m=document.createElement("input");m.type="text",m.placeholder="John Doe",m.style.width="100%",m.style.padding="8px",m.style.borderRadius="4px",m.style.border="1px solid #ccc",u.appendChild(p),u.appendChild(m);const g=document.createElement("div");g.style.marginBottom="15px";const y=document.createElement("label");y.textContent="GitLab Username:",y.style.display="block",y.style.marginBottom="5px";const b=document.createElement("input");b.type="text",b.placeholder="username (without @)",b.style.width="100%",b.style.padding="8px",b.style.borderRadius="4px",b.style.border="1px solid #ccc",g.appendChild(y),g.appendChild(b);const f=document.createElement("div");f.style.display="flex",f.style.justifyContent="space-between";const x=document.createElement("button");x.textContent="Add Assignee",x.style.padding="8px 16px",x.style.backgroundColor="#28a745",x.style.color="white",x.style.border="none",x.style.borderRadius="4px",x.style.cursor="pointer",x.onclick=()=>{const t=m.value.trim(),s=b.value.trim();if(!s)return void this.notification.error("Username is required");const n={name:t||s,username:s};this.addAssignee(n),this.notification.success(`Added assignee: ${n.name}`),e.remove(),this.openAssigneeManager()};const C=document.createElement("button");C.textContent="Add Current User",C.style.padding="8px 16px",C.style.backgroundColor="#17a2b8",C.style.color="white",C.style.border="none",C.style.borderRadius="4px",C.style.cursor="pointer",C.style.marginRight="10px",C.onclick=async()=>{C.disabled=!0,C.textContent="Loading...";try{const t=await this.fetchCurrentUser();this.notification.success(`Added current user: ${t.name}`),e.remove(),this.openAssigneeManager()}catch(e){this.notification.error("Failed to fetch current user"),C.disabled=!1,C.textContent="Add Current User"}},f.appendChild(C),f.appendChild(x),c.appendChild(h),c.appendChild(u),c.appendChild(g),c.appendChild(f);const v=document.createElement("div");v.style.marginTop="20px",v.style.display="flex",v.style.justifyContent="flex-end";const S=document.createElement("button");S.textContent="Close",S.style.padding="8px 16px",S.style.backgroundColor="#6c757d",S.style.color="white",S.style.border="none",S.style.borderRadius="4px",S.style.cursor="pointer",S.onclick=()=>{e.remove()},v.appendChild(S),o.appendChild(a),o.appendChild(r),o.appendChild(c),o.appendChild(v),t.appendChild(s),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}},e.MilestoneManager=class MilestoneManager{constructor(e={}){this.gitlabApi=e.gitlabApi,this.onMilestonesLoaded=e.onMilestonesLoaded||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.milestones=[],this.currentMilestone=null,this.isLoading=!1}},e.SettingsManager=class SettingsManager{constructor(t={}){this.labelManager=t.labelManager,this.assigneeManager=t.assigneeManager,this.gitlabApi=t.gitlabApi||e.gitlabApi,this.onSettingsChanged=t.onSettingsChanged||null,this.notification=new Notification({position:"bottom-right",duration:3e3}),this.availableAssignees=[],this.isLoadingAssignees=!1}openSettingsModal(){const e=document.createElement("div");e.id="git-helper-settings-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.zIndex="1000",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer";const t=document.createElement("div");t.style.backgroundColor="white",t.style.borderRadius="6px",t.style.padding="20px",t.style.width="700px",t.style.maxWidth="90%",t.style.maxHeight="80vh",t.style.overflow="auto",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginBottom="15px",s.style.borderBottom="1px solid #eee",s.style.paddingBottom="10px";const n=document.createElement("h3");n.textContent="Settings",n.style.margin="0";const i=document.createElement("button");i.innerHTML="&times;",i.style.backgroundColor="transparent",i.style.border="none",i.style.fontSize="24px",i.style.cursor="pointer",i.style.padding="0 5px",i.onclick=()=>e.remove(),s.appendChild(n),s.appendChild(i);const o=document.createElement("div");this.createCollapsibleSection(o,"Assignees","Manage assignees for quick access in comments",(e=>this.createAssigneeSettings(e)),!0),this.createCollapsibleSection(o,"Labels","Manage which labels appear in the dropdown menus",(e=>this.createLabelWhitelistSettings(e)),!1),this.createCollapsibleSection(o,"Appearance","Customize the appearance of GitLab Sprint Helper",(e=>this.createAppearanceSettings(e)),!1);const a=document.createElement("div");a.style.marginTop="20px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.borderTop="1px solid #eee",a.style.paddingTop="15px";const r=document.createElement("button");r.textContent="Reset to Defaults",r.style.padding="8px 16px",r.style.backgroundColor="#6c757d",r.style.color="white",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.onclick=()=>{confirm("Are you sure you want to reset all settings to default values?")&&(this.resetAllSettings(),e.remove(),this.notification.success("Settings reset to defaults"))};const l=document.createElement("button");l.textContent="Close",l.style.padding="8px 16px",l.style.backgroundColor="#28a745",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer",l.onclick=()=>{e.remove()},a.appendChild(r),a.appendChild(l),t.appendChild(s),t.appendChild(o),t.appendChild(a),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&e.remove()}))}createCollapsibleSection(e,t,s,n,i=!1){const o=document.createElement("div");o.className="settings-section",o.style.marginBottom="15px",o.style.border="1px solid #ddd",o.style.borderRadius="6px",o.style.overflow="hidden";const a=document.createElement("div");a.className="settings-section-header",a.style.padding="12px 15px",a.style.backgroundColor="#f8f9fa",a.style.borderBottom="none",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.cursor="pointer",a.style.transition="background-color 0.2s ease",a.addEventListener("mouseenter",(()=>{a.style.backgroundColor="#e9ecef"})),a.addEventListener("mouseleave",(()=>{a.style.backgroundColor="#f8f9fa"}));const r=document.createElement("div"),l=document.createElement("h4");l.textContent=t,l.style.margin="0",l.style.fontSize="16px";const d=document.createElement("div");d.textContent=s,d.style.fontSize="13px",d.style.color="#6c757d",d.style.marginTop="4px",r.appendChild(l),r.appendChild(d);const c=document.createElement("span");c.textContent="â–¶",c.style.fontSize="14px",c.style.transition="transform 0.3s ease",a.appendChild(r),a.appendChild(c);const h=document.createElement("div");h.className="settings-section-content",h.style.padding="15px",h.style.display="none",h.style.backgroundColor="white";let u=!1;return a.addEventListener("click",(()=>{const e="block"===h.style.display;h.style.display=e?"none":"block",c.textContent=e?"â–¶":"â–¼",a.style.borderBottom=e?"none":"1px solid #ddd",u||e||(n(h),u=!0)})),o.appendChild(a),o.appendChild(h),e.appendChild(o),o}createAssigneeSettings(e){const t=document.createElement("div"),s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.marginBottom="15px",s.style.gap="10px";const n=document.createElement("div");n.style.flex="1";const i=document.createElement("input");i.type="text",i.placeholder="Search assignees...",i.style.width="100%",i.style.padding="8px 10px",i.style.borderRadius="4px",i.style.border="1px solid #ccc",n.appendChild(i);const o=document.createElement("button");o.textContent="Fetch GitLab Users",o.style.padding="8px 12px",o.style.backgroundColor="#1f75cb",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.onclick=()=>this.fetchGitLabUsers(m),s.appendChild(n),s.appendChild(o),t.appendChild(s);const a=document.createElement("div");a.style.display="flex",a.style.borderBottom="1px solid #dee2e6",a.style.marginBottom="15px";const r=[{id:"whitelisted",label:"My Assignees",active:!0},{id:"available",label:"Available Users",active:!1}],l={},d={};r.forEach((e=>{const t=document.createElement("div");t.textContent=e.label,t.style.padding="8px 15px",t.style.cursor="pointer",t.style.transition="all 0.2s ease",e.active&&(t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold"),t.addEventListener("mouseenter",(()=>{e.active||(t.style.backgroundColor="#f5f5f5")})),t.addEventListener("mouseleave",(()=>{e.active||(t.style.backgroundColor="")})),t.addEventListener("click",(()=>{r.forEach((e=>{e.active=!1,l[e.id].style.borderBottom="none",l[e.id].style.fontWeight="normal",l[e.id].style.backgroundColor="",d[e.id].style.display="none"})),e.active=!0,t.style.borderBottom="2px solid #1f75cb",t.style.fontWeight="bold",d[e.id].style.display="block","whitelisted"===e.id?this.refreshAssigneeList(u):"available"===e.id&&this.fetchGitLabUsers(m)})),l[e.id]=t,a.appendChild(t)})),t.appendChild(a);const c=document.createElement("div");c.style.display="block";const h=document.createElement("div");h.style.display="none";const u=document.createElement("div");u.style.height="300px",u.style.overflowY="auto",u.style.border="1px solid #eee",u.style.borderRadius="4px";const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};let p=[];p=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),p.length>0?p.forEach(((e,t)=>{u.appendChild(this.createAssigneeListItem(e,t,u,createEmptyMessage))})):u.appendChild(createEmptyMessage()),c.appendChild(u),c.appendChild(this.createAddAssigneeForm(u,createEmptyMessage));const m=document.createElement("div");m.className="available-assignees-list",m.style.height="300px",m.style.overflowY="auto",m.style.border="1px solid #eee",m.style.borderRadius="4px";const g=document.createElement("div");g.textContent='Click "Fetch GitLab Users" to load available assignees.',g.style.padding="15px",g.style.color="#666",g.style.fontStyle="italic",g.style.textAlign="center",m.appendChild(g),h.appendChild(m),d.whitelisted=c,d.available=h,t.appendChild(c),t.appendChild(h),i.addEventListener("input",(()=>{const e=i.value.toLowerCase();("whitelisted"===r.find((e=>e.active)).id?u:m).querySelectorAll(".assignee-item").forEach((t=>{const s=t.querySelector(".assignee-name"),n=t.querySelector(".assignee-username");if(!s||!n)return;const i=s.textContent.toLowerCase(),o=n.textContent.toLowerCase();i.includes(e)||o.includes(e)?t.style.display="":t.style.display="none"}))})),e.appendChild(t)}createAddAssigneeForm(e,t){const s=document.createElement("div");s.style.marginTop="15px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="4px";const n=document.createElement("h5");n.textContent="Add New Assignee",n.style.marginTop="0",n.style.marginBottom="10px";const i=document.createElement("div");i.style.marginBottom="10px";const o=document.createElement("label");o.textContent="Display Name:",o.style.display="block",o.style.marginBottom="5px";const a=document.createElement("input");a.type="text",a.placeholder="John Doe",a.style.width="100%",a.style.padding="6px 10px",a.style.borderRadius="4px",a.style.border="1px solid #ccc",i.appendChild(o),i.appendChild(a);const r=document.createElement("div");r.style.marginBottom="15px";const l=document.createElement("label");l.textContent="GitLab Username:",l.style.display="block",l.style.marginBottom="5px";const d=document.createElement("input");d.type="text",d.placeholder="username (without @)",d.style.width="100%",d.style.padding="6px 10px",d.style.borderRadius="4px",d.style.border="1px solid #ccc",r.appendChild(l),r.appendChild(d);const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="flex-end";const h=document.createElement("button");return h.textContent="Add Assignee",h.style.padding="6px 12px",h.style.backgroundColor="#28a745",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.onclick=()=>{const s=a.value.trim(),n=d.value.trim();if(!n)return void this.notification.error("Username is required");const i={name:s||n,username:n};if(this.assigneeManager)this.assigneeManager.addAssignee(i);else{const e=getAssigneeWhitelist(),t=e.findIndex((e=>e.username===n));t>=0?e[t]=i:e.push(i),saveAssigneeWhitelist(e)}const o=e.querySelector('div[style*="italic"]');o&&o.remove();const r=getAssigneeWhitelist();e.appendChild(this.createAssigneeListItem(i,r.length-1,e,t)),a.value="",d.value="",this.notification.success(`Added assignee: ${i.name}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},c.appendChild(h),s.appendChild(n),s.appendChild(i),s.appendChild(r),s.appendChild(c),s}async fetchGitLabUsers(e){if(!this.gitlabApi)return void this.notification.error("GitLab API not available");this.isLoadingAssignees=!0,e.innerHTML="";const t=document.createElement("div");t.textContent="Loading users from GitLab...",t.style.padding="15px",t.style.textAlign="center",e.appendChild(t);try{const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s=[];"project"===t.type?s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}}):"group"===t.type&&(s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})),this.availableAssignees=s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))),this.renderAvailableUsers(e)}catch(t){console.error("Error fetching GitLab users:",t),e.innerHTML="";const s=document.createElement("div");s.textContent=`Error loading users: ${t.message}`,s.style.padding="15px",s.style.color="#dc3545",s.style.textAlign="center",e.appendChild(s),this.notification.error("Failed to load GitLab users")}finally{this.isLoadingAssignees=!1}}renderAvailableUsers(e){e.innerHTML="";const t=getAssigneeWhitelist().map((e=>e.username.toLowerCase()));if(0===this.availableAssignees.length){const t=document.createElement("div");return t.textContent="No users found. Try fetching again.",t.style.padding="15px",t.style.color="#666",t.style.fontStyle="italic",t.style.textAlign="center",void e.appendChild(t)}this.availableAssignees.sort(((e,t)=>e.name.localeCompare(t.name))),this.availableAssignees.forEach((s=>{const n=t.includes(s.username.toLowerCase()),i=document.createElement("div");i.className="assignee-item",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="10px 15px",i.style.borderBottom="1px solid #eee",i.style.backgroundColor=n?"rgba(40, 167, 69, 0.05)":"";const o=document.createElement("div");if(o.style.display="flex",o.style.alignItems="center",s.avatar_url){const e=document.createElement("img");e.src=s.avatar_url,e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.marginRight="10px",o.appendChild(e)}else{const e=document.createElement("div");e.style.width="30px",e.style.height="30px",e.style.borderRadius="50%",e.style.backgroundColor="#e0e0e0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.marginRight="10px",e.style.fontWeight="bold",e.style.color="#666";const t=(s.name||s.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();e.textContent=t,o.appendChild(e)}const a=document.createElement("div"),r=document.createElement("div");r.className="assignee-name",r.textContent=s.name,r.style.fontWeight="bold";const l=document.createElement("div");l.className="assignee-username",l.textContent=`@${s.username}`,l.style.fontSize="12px",l.style.color="#666",a.appendChild(r),a.appendChild(l),o.appendChild(a);const d=document.createElement("button");n?(d.textContent="Added âœ“",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default"):(d.textContent="Add",d.style.backgroundColor="#28a745",d.style.color="white",d.style.cursor="pointer",d.addEventListener("click",(()=>{const e={name:s.name,username:s.username};if(this.assigneeManager)this.assigneeManager.addAssignee(e);else{const t=getAssigneeWhitelist();t.push(e),saveAssigneeWhitelist(t)}d.textContent="Added âœ“",d.style.backgroundColor="#e9ecef",d.style.color="#28a745",d.style.cursor="default",i.style.backgroundColor="rgba(40, 167, 69, 0.05)",this.notification.success(`Added ${s.name} to assignees`),"function"==typeof this.onSettingsChanged&&this.onSettingsChanged("assignees"),this.refreshWhitelistedTab()}))),d.style.padding="5px 10px",d.style.border="none",d.style.borderRadius="4px",d.style.fontSize="12px",i.appendChild(o),i.appendChild(d),e.appendChild(i)}))}refreshWhitelistedTab(){const e=document.querySelector('div[style*="display: block"]');if(!e)return;const t=e.querySelector('div[style*="overflowY: auto"]');if(!t)return;const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};t.innerHTML="";const s=document.createElement("div");s.textContent="Refreshing assignees...",s.style.padding="15px",s.style.textAlign="center",s.style.color="#666",t.appendChild(s),setTimeout((()=>{let e=[];e=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),t.innerHTML="",e.length>0?e.forEach(((e,s)=>{t.appendChild(this.createAssigneeListItem(e,s,t,createEmptyMessage))})):t.appendChild(createEmptyMessage())}),300)}createAssigneeListItem(e,t,s,n){const i=document.createElement("div");i.className="assignee-item",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="10px 15px",i.style.borderBottom="1px solid #eee";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center";const a=document.createElement("div");a.style.width="30px",a.style.height="30px",a.style.borderRadius="50%",a.style.backgroundColor="#e0e0e0",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.marginRight="10px",a.style.fontWeight="bold",a.style.color="#666";const r=(e.name||e.username).split(" ").map((e=>e.charAt(0))).slice(0,2).join("").toUpperCase();a.textContent=r,o.appendChild(a);const l=document.createElement("div"),d=document.createElement("div");d.className="assignee-name",d.textContent=e.name||e.username,d.style.fontWeight="bold";const c=document.createElement("div");c.className="assignee-username",c.textContent=`@${e.username}`,c.style.fontSize="12px",c.style.color="#666",l.appendChild(d),l.appendChild(c),o.appendChild(l);const h=document.createElement("div"),u=document.createElement("button");return u.textContent="Remove",u.style.padding="5px 10px",u.style.backgroundColor="#dc3545",u.style.color="white",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",u.style.fontSize="12px",u.onclick=()=>{let t=[];if(this.assigneeManager)this.assigneeManager.removeAssignee(e.username),t=this.assigneeManager.getAssigneeWhitelist();else{t=getAssigneeWhitelist();const s=t.filter((t=>t.username.toLowerCase()!==e.username.toLowerCase()));saveAssigneeWhitelist(s),t=s}i.remove(),0===t.length&&s.appendChild(n()),this.notification.info(`Removed assignee: ${e.name||e.username}`),this.onSettingsChanged&&this.onSettingsChanged("assignees")},h.appendChild(u),i.appendChild(o),i.appendChild(h),i}createLabelWhitelistSettings(e){const t=document.createElement("div");t.style.marginBottom="20px";const s=document.createElement("h4");s.textContent="Label Whitelist",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Select which labels should appear in the dropdown. The system will show any label that contains these terms.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n);const i=document.createElement("div");i.id="whitelist-loading-message",i.textContent="Loading all labels from GitLab...",i.style.fontStyle="italic",i.style.color="#666",t.appendChild(i);const o=document.createElement("div");o.id="whitelist-container",o.style.display="flex",o.style.flexWrap="wrap",o.style.gap="10px",o.style.marginTop="15px",o.style.height="300px",o.style.overflowY="auto",o.style.border="1px solid #eee",o.style.borderRadius="4px",o.style.padding="10px",t.appendChild(o);const a=getLabelWhitelist(),r=Array.isArray(a)?a:[],displayLabels=e=>{if(i.remove(),!e||0===e.length){const e=document.createElement("div");return e.textContent="No labels found in this project.",e.style.width="100%",e.style.textAlign="center",e.style.marginBottom="15px",e.style.color="#666",void o.appendChild(e)}e.sort(((e,t)=>e.name.localeCompare(t.name)));const t=new Set;e.forEach((e=>{if(t.has(e.name.toLowerCase()))return;t.add(e.name.toLowerCase());const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="10px",s.style.width="calc(33.33% - 10px)";const n=document.createElement("input");n.type="checkbox",n.id=`label-${e.name}`,n.dataset.label=e.name.toLowerCase(),n.style.marginRight="8px";const i=r.some((t=>e.name.toLowerCase().includes(t.toLowerCase())));n.checked=i;const a=this.createGitLabStyleLabel(e);a.style.cursor="pointer",a.onclick=()=>{n.checked=!n.checked,this.autoSaveWhitelist(o)},n.addEventListener("change",(()=>{this.autoSaveWhitelist(o)})),s.appendChild(n),s.appendChild(a),o.appendChild(s)}))};(async()=>{try{if(!this.gitlabApi)throw new Error("GitLab API not available");const e=getPathFromUrl();if(!e||!e.apiUrl)throw new Error("Could not determine project/group path");const t=await this.gitlabApi.callGitLabApi(e.apiUrl,{params:{per_page:100}});displayLabels(t)}catch(e){console.error("Error fetching ALL labels:",e),i.textContent="Error loading labels. "+e.message,i.style.color="#dc3545"}})(),e.appendChild(t)}refreshAssigneeList(e){if(!e)return;const t=document.createElement("div");t.textContent="Refreshing assignees...",t.style.padding="15px",t.style.textAlign="center",t.style.color="#666",e.innerHTML="",e.appendChild(t);const createEmptyMessage=()=>{const e=document.createElement("div");return e.textContent="No assignees added yet. Add from Available Users or add manually below.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",e};setTimeout((()=>{let t=[];t=this.assigneeManager?this.assigneeManager.getAssigneeWhitelist():getAssigneeWhitelist(),e.innerHTML="",t.length>0?t.forEach(((t,s)=>{e.appendChild(this.createAssigneeListItem(t,s,e,createEmptyMessage))})):e.appendChild(createEmptyMessage())}),300)}createAppearanceSettings(e){const t=document.createElement("div"),s=document.createElement("h4");s.textContent="Appearance Settings",s.style.marginBottom="10px";const n=document.createElement("p");n.textContent="Customize the appearance of the GitLab Sprint Helper.",n.style.marginBottom="15px",n.style.fontSize="14px",n.style.color="#666",t.appendChild(s),t.appendChild(n);const i=document.createElement("div");i.style.padding="20px",i.style.textAlign="center",i.style.backgroundColor="#f8f9fa",i.style.borderRadius="4px",i.style.color="#666",i.textContent="Appearance settings coming soon!",t.appendChild(i),e.appendChild(t)}createGitLabStyleLabel(e){const t=document.createElement("span");t.textContent=e.name;const s=e.color||generateColorFromString(e.name),n=getContrastColor(s);return t.style.backgroundColor=s,t.style.color=n,t.style.padding="4px 8px",t.style.borderRadius="100px",t.style.fontSize="12px",t.style.fontWeight="500",t.style.display="inline-block",t.style.margin="2px",t.style.maxWidth="100%",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.whiteSpace="nowrap",t}resetLabelWhitelist(){resetLabelWhitelist(),this.labelManager&&this.labelManager.resetToDefaultWhitelist(),this.onSettingsChanged&&this.onSettingsChanged("labels")}resetAllSettings(){this.resetLabelWhitelist(),saveAssigneeWhitelist([]),this.onSettingsChanged&&this.onSettingsChanged("all")}autoSaveWhitelist(e){const t=[],s=new Set;e.querySelectorAll('input[type="checkbox"]').forEach((e=>{if(e.checked){const n=e.dataset.label.toLowerCase();s.has(n)||(t.push(n),s.add(n))}})),saveLabelWhitelist(t),this.labelManager&&this.labelManager.saveWhitelist(t),this.notification&&this.notification.success("Label whitelist updated"),this.onSettingsChanged&&this.onSettingsChanged("labels")}},e.SummaryView=class SummaryView{constructor(uiManager){this.uiManager=uiManager}render(e,t,s,n,i,o,a){const r=document.getElementById("assignee-time-summary-content");if(!r)return;if(r.innerHTML="",this.uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:this.getClosedBoardCount()}),0===n)return this.renderNoDataMessage(r),void(this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("summary-tab"));const l=formatHours(t);let d=0;for(const e in o){const t=e.toLowerCase();(t.includes("done")||t.includes("closed")||t.includes("complete")||t.includes("finished"))&&(d+=o[e].timeEstimate||0)}const c=formatHours(d);this.uiManager.updateHeader(`Summary ${l}h - <span style="color:#28a745">${c}h</span>`),i&&this.renderMilestoneInfo(r,i),this.renderDataTableWithDistribution(r,e,l,o,a),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("summary-tab")}getClosedBoardCount(){let e=0;return document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}if(s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished")){const s=t.querySelectorAll(".board-card");e+=s.length}})),e}renderNoDataMessage(e){const t=document.createElement("p");t.textContent="No time estimate data found. Make sure the board is fully loaded and try again.",t.style.color="#666",e.appendChild(t);const s=document.createElement("p");s.style.fontSize="12px",s.style.fontStyle="italic",s.innerHTML="Tip: Try scrolling through all cards to ensure they are loaded before clicking Recalculate.",e.appendChild(s),this.uiManager.updateHeader("Summary 0.0h")}renderMilestoneInfo(e,t){const s=document.createElement("div");s.style.marginBottom="10px",s.style.fontSize="13px",s.style.color="#555",s.textContent=`Current Milestone: ${t}`,e.appendChild(s)}renderDataTableWithDistribution(e,t,s,n,i){const o=document.createElement("table");o.style.width="100%",o.style.borderCollapse="collapse";const a=Object.keys(n||{}),r=document.createElement("tr");r.style.borderBottom="2px solid #ddd",r.style.fontWeight="bold";const l=document.createElement("td");l.textContent="Total",l.style.padding="5px 0";const d=document.createElement("td");d.textContent=`${s}h`,d.style.textAlign="right",d.style.padding="5px 0";const c=document.createElement("td");if(c.style.textAlign="right",c.style.padding="5px 0 5px 15px",c.style.color="#666",c.style.fontSize="12px",a.length>0&&n){const e=a.map((e=>{const t=n[e]||{timeEstimate:0},s=parseFloat(formatHours(t.timeEstimate||0));return Math.round(s)})),t=e.map(((t,s)=>{let n='<span style="';return 0===t&&(n+="color:#aaa;"),s===e.length-1&&t>0&&(n+="color:#28a745;"),n+=`">${t}h</span>`,n})).join("/");c.innerHTML=t}r.appendChild(l),r.appendChild(d),r.appendChild(c),o.appendChild(r);Object.keys(t).sort(((e,s)=>t[s]-t[e])).forEach((e=>{const s=formatHours(t[e]),n=document.createElement("tr");n.style.borderBottom="1px solid #eee";const r=document.createElement("td");r.textContent=e,r.style.padding="5px 0";const l=document.createElement("td");l.textContent=`${s}h`,l.style.textAlign="right",l.style.padding="5px 0";const d=document.createElement("td");if(d.style.textAlign="right",d.style.padding="5px 0 5px 15px",d.style.color="#666",d.style.fontSize="12px",a.length>0&&i){const t=a.map((t=>{const s=(i[t]||{})[e]||{timeEstimate:0},n=parseFloat(formatHours(s.timeEstimate||0));return Math.round(n)})),s=t.map(((e,s)=>{let n='<span style="';return 0===e&&(n+="color:#aaa;"),s===t.length-1&&e>0&&(n+="color:#28a745;"),n+=`">${e}h</span>`,n})).join("/");d.innerHTML=s}n.appendChild(r),n.appendChild(l),n.appendChild(d),o.appendChild(n)})),e.appendChild(o)}},e.BoardsView=class BoardsView{constructor(uiManager){this.uiManager=uiManager}render(e,t){const s=document.getElementById("boards-time-summary-content");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="boards-list-summary";const i=Object.keys(e).filter((t=>e[t].tickets>0&&e[t].timeEstimate>0)).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate));if(0===i.length){const e=document.createElement("div");e.textContent="No boards with time estimates found.",e.style.padding="15px",e.style.color="#666",e.style.fontStyle="italic",e.style.textAlign="center",n.appendChild(e)}else i.forEach((s=>{const i=this.createBoardSection(s,e[s],t[s]);n.appendChild(i)}));s.appendChild(n),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("boards-tab")}createBoardSection(e,t,s){const n=formatHours(t.timeEstimate),i=document.createElement("div");i.className="board-section",i.style.marginBottom="15px";const o=document.createElement("div");o.className="board-header",o.style.display="flex",o.style.justifyContent="space-between",o.style.padding="5px",o.style.backgroundColor="#f5f5f5",o.style.borderRadius="3px",o.style.cursor="pointer",o.style.fontWeight="bold";const a=document.createElement("div");a.className="board-details",a.style.display="none",a.style.marginTop="5px",a.style.marginLeft="10px",o.addEventListener("click",(()=>{"none"===a.style.display?(a.style.display="block",l.textContent="â–¼"):(a.style.display="none",l.textContent="â–¶")}));const r=document.createElement("div");r.textContent=`${e} (${t.tickets} tickets, ${n}h)`;const l=document.createElement("span");if(l.textContent="â–¶",l.style.marginLeft="5px",o.appendChild(r),o.appendChild(l),s&&Object.keys(s).length>0)a.appendChild(this.createAssigneeTable(s));else{const e=document.createElement("div");e.textContent="No assignee data available for this board.",e.style.padding="8px 0",e.style.color="#666",e.style.fontStyle="italic",a.appendChild(e)}return i.appendChild(o),i.appendChild(a),i}createAssigneeTable(e){const t=document.createElement("table");t.style.width="100%",t.style.borderCollapse="collapse",t.style.marginTop="5px";const s=document.createElement("tr");s.style.borderBottom="1px solid #ddd";const n=document.createElement("th");n.textContent="Assignee",n.style.textAlign="left",n.style.padding="3px 0";const i=document.createElement("th");i.textContent="Tickets",i.style.textAlign="right",i.style.padding="3px 5px";const o=document.createElement("th");o.textContent="Hours",o.style.textAlign="right",o.style.padding="3px 0",s.appendChild(n),s.appendChild(i),s.appendChild(o),t.appendChild(s);return Object.keys(e).sort(((t,s)=>e[s].timeEstimate-e[t].timeEstimate)).forEach((s=>{const n=e[s],i=formatHours(n.timeEstimate),o=document.createElement("tr");o.style.borderBottom="1px solid #eee";const a=document.createElement("td");a.textContent=s,a.style.padding="3px 0";const r=document.createElement("td");r.textContent=n.tickets,r.style.textAlign="right",r.style.padding="3px 5px";const l=document.createElement("td");l.textContent=`${i}h`,l.style.textAlign="right",l.style.padding="3px 0",o.appendChild(a),o.appendChild(r),o.appendChild(l),t.appendChild(o)})),t}},e.SprintManagementView=class SprintManagementView{constructor(uiManager){this.uiManager=uiManager,this.notification=null;try{"function"==typeof Notification&&(this.notification=new Notification({position:"bottom-right",duration:3e3}))}catch(e){console.error("Error initializing notification:",e)}this.sprintState={endSprint:!1,preparedForNext:!1,currentMilestone:null,userPerformance:{}},this.sprintHistory=[],this.loadSprintState(),this.loadSprintHistory()}render(){const t=document.getElementById("sprint-management-content");if(!t)return;t.innerHTML="";const s=new URLSearchParams(e.location.search);let n=!1;if(s.has("milestone_title")&&"Started"===s.get("milestone_title")){let e=0;s.forEach((()=>{e++})),n=1===e}if(!n)return void this.renderLockedState(t);this.getCurrentMilestone();const i=document.createElement("div");i.style.padding="10px",i.style.margin="0 10px",i.style.backgroundColor="#f8f9fa",i.style.borderRadius="6px",i.style.fontWeight="bold",this.sprintState.currentMilestone?i.textContent=`Current Milestone: ${this.sprintState.currentMilestone}`:(i.textContent="No milestone detected",i.style.color="#dc3545"),t.appendChild(i);const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="5px",o.style.marginTop="",o.style.padding="15px",o.style.backgroundColor="#f8f9fa",o.style.borderRadius="6px",o.style.border="1px solid #dee2e6",o.style.margin="10px 10px 0",this.createStepButton(o,"1. End Sprint","#1f75cb",(()=>this.endSprint()),!this.sprintState.endSprint),this.createStepButton(o,"2. Ready for next Sprint","#6f42c1",(()=>this.prepareForNextSprint()),this.sprintState.endSprint&&!this.sprintState.preparedForNext),this.createStepButton(o,"3. Copy Sprint Data Summary","#28a745",(()=>this.copySprintData()),this.sprintState.preparedForNext),this.createStepButton(o,"4. Copy Closed Issue Names","#fd7e14",(()=>this.copyClosedTickets()),this.sprintState.preparedForNext);const a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.marginTop="10px";const r=document.createElement("button");r.textContent="5. Reset Sprint",r.className="reset-sprint-button",r.style.padding="10px 16px",r.style.backgroundColor="#dc3545",r.style.color="white",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.fontWeight="bold",r.addEventListener("click",(()=>this.resetSprint()));const l=document.createElement("button");l.textContent="6. Edit Data",l.className="edit-sprint-data-button",l.style.padding="10px 16px";const d=this.sprintState.endSprint;l.style.backgroundColor=d?"#17a2b8":"#6c757d",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor=d?"pointer":"not-allowed",l.style.fontWeight="bold",l.style.opacity=d?"1":"0.7",l.disabled=!d,d&&l.addEventListener("click",(()=>this.editSprintData())),a.appendChild(r),a.appendChild(l),o.appendChild(a),t.appendChild(o),void 0!==this.sprintState.totalTickets&&this.showSprintDataSummary(t),this.renderSprintHistory(t),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("sprintmanagement-tab")}renderLockedState(t){const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.padding="40px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="6px",s.style.margin="10px",s.style.textAlign="center";const n=document.createElement("div");n.innerHTML="ðŸ”’",n.style.fontSize="48px",n.style.marginBottom="20px";const i=document.createElement("h3");i.textContent="Sprint Management is Locked",i.style.marginBottom="15px",i.style.color="#495057";const o=document.createElement("p");o.innerHTML="Sprint Management is only available when URL contains <strong>exactly</strong> <code>?milestone_title=Started</code> with no other parameters",o.style.color="#6c757d",o.style.marginBottom="20px";const a=document.createElement("a"),r=new URL(e.location.href);r.search="",r.searchParams.set("milestone_title","Started"),a.href=r.toString(),a.textContent="Access Sprint Management",a.style.display="inline-block",a.style.padding="10px 16px",a.style.backgroundColor="#1f75cb",a.style.color="white",a.style.textDecoration="none",a.style.borderRadius="4px",a.style.fontWeight="bold",a.style.marginTop="10px",s.appendChild(n),s.appendChild(i),s.appendChild(o),s.appendChild(a),t.appendChild(s),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("sprintmanagement-tab")}copyClosedTickets(){try{const e=this.getClosedTickets();if(0===e.length)return void this.notification.warning("No closed tickets found on the board");const t=e.map((e=>e.title)).join("\n");navigator.clipboard.writeText(t).then((()=>{this.notification.success(`Copied ${e.length} issue ${1!==e.length?"names":"name"} to clipboard`)})).catch((e=>{console.error("Error copying to clipboard:",e),this.notification.error("Failed to copy to clipboard")}))}catch(e){console.error("Error copying closed tickets:",e),this.notification.error("Error processing issues")}}updateStatus(e,t="info"){this.notification?this.notification[t](e):console.log(`${t.toUpperCase()}: ${e}`)}getClosedTickets(){const e=[];return document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}if(s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished")){t.querySelectorAll(".board-card").forEach((t=>{try{if(t.__vue__&&t.__vue__.$children){const s=t.__vue__.$children.find((e=>e.$props&&e.$props.item));if(s&&s.$props&&s.$props.item){const t=s.$props.item,n=t.title,i=t.iid;n&&e.push({id:i||"unknown",title:n})}}else{const s=t.querySelector(".board-card-title");if(s){const n=s.textContent.trim();let i="unknown";const o=t.querySelector("[data-issue-id]");o&&o.dataset.issueId&&(i=o.dataset.issueId),n&&e.push({id:i,title:n})}}}catch(e){console.error("Error processing card:",e)}}))}})),e}copySprintData(){try{const{totalTickets:e,closedTickets:t,totalHours:s,closedHours:n,extraHoursClosed:i=0}=this.sprintState,o=n+i;let a="schlecht";const r=e>0?t/e:0,l=s>0?o/s:0;r>.7||l>.7?a="gut":(r>.5||l>.5)&&(a="mittel");const d=`${e}\n${t}\n${s}\n${o}\n\n${a}`;navigator.clipboard.writeText(d).then((()=>{this.notification.success("Sprint data copied to clipboard")})).catch((e=>{console.error("Error copying sprint data to clipboard:",e),this.notification.error("Failed to copy sprint data")}))}catch(e){console.error("Error copying sprint data:",e),this.notification.error("Error processing sprint data")}}calculateSprintData(){let e=0,t=0,s=0;document.querySelectorAll(".board-list").forEach((n=>{let i="";try{if(n.__vue__&&n.__vue__.$children&&n.__vue__.$children.length>0){const e=n.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(i=e.$props.list.title.toLowerCase())}if(!i){const e=n.querySelector(".board-title-text");e&&(i=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const t=n.querySelector(".board-title-text");t&&(i=t.textContent.trim().toLowerCase())}const o=i.includes("done")||i.includes("closed")||i.includes("complete")||i.includes("finished");n.querySelectorAll(".board-card").forEach((n=>{try{if(n.__vue__&&n.__vue__.$children){const i=n.__vue__.$children.find((e=>e.$props&&e.$props.item));if(i&&i.$props&&i.$props.item){const n=i.$props.item;if(e++,n.timeEstimate){const e=n.timeEstimate/3600;t+=e,o&&(s+=e)}}}}catch(e){console.error("Error processing card:",e)}}))})),t=Math.round(10*t)/10,s=Math.round(10*s)/10;let n="schlecht";const i=this.getClosedTickets().length,o=e>0?i/e:0,a=t>0?s/t:0;return o>.7||a>.7?n="gut":(o>.5||a>.5)&&(n="mittel"),{totalTickets:e,totalHours:t,closedHours:s,prediction:n}}createStepButton(e,t,s,n,i=!0){const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="5px";const a=document.createElement("button");if(a.textContent=t,a.style.padding="12px 16px",a.style.backgroundColor=i?s:"#6c757d",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor=i?"pointer":"not-allowed",a.style.fontWeight="bold",a.style.opacity=i?"1":"0.7",a.style.transition="all 0.2s ease",a.disabled=!i,i){const e=this.darkenColor(s,10);a.addEventListener("mouseenter",(function(){this.style.backgroundColor=e})),a.addEventListener("mouseleave",(function(){this.style.backgroundColor=s})),a.addEventListener("click",(function(){n()}))}return o.appendChild(a),e.appendChild(o),a}darkenColor(e,t){e=e.replace(/^#/,"");let s=parseInt(e.substr(0,2),16),n=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16);return s=Math.floor(s*(100-t)/100),n=Math.floor(n*(100-t)/100),i=Math.floor(i*(100-t)/100),s=Math.min(255,Math.max(0,s)),n=Math.min(255,Math.max(0,n)),i=Math.min(255,Math.max(0,i)),`#${s.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`}getCurrentMilestone(){try{document.querySelectorAll(".board-list").forEach((e=>{e.querySelectorAll(".board-card").forEach((e=>{try{if(e.__vue__&&e.__vue__.$children){const t=e.__vue__.$children.find((e=>e.$props&&e.$props.item&&e.$props.item.milestone));t&&t.$props.item&&t.$props.item.milestone&&t.$props.item.milestone.title&&(this.sprintState.currentMilestone=t.$props.item.milestone.title)}}catch(e){console.error("Error parsing issue for milestone:",e)}}))})),this.sprintState.currentMilestone&&this.saveSprintState()}catch(e){console.error("Error getting current milestone:",e)}}endSprint(){try{const e=this.calculateSprintData(),t=this.getClosedTickets(),s=this.calculateUserPerformance(),n=Date.now().toString();this.sprintState.id=n,this.sprintState.endSprint=!0,this.sprintState.totalTickets=e.totalTickets,this.sprintState.closedTickets=t.length,this.sprintState.totalHours=e.totalHours,this.sprintState.closedHours=e.closedHours,this.sprintState.userPerformance=s,this.sprintState.timestamp=(new Date).toISOString(),this.saveSprintState(),this.notification.success("Sprint ended. Data captured successfully."),this.uiManager&&this.uiManager.issueSelector&&"function"==typeof this.uiManager.issueSelector.startSelection&&(this.uiManager.tabManager&&"function"==typeof this.uiManager.tabManager.switchToTab&&this.uiManager.tabManager.switchToTab("bulkcomments"),setTimeout((()=>{this.uiManager.issueSelector.startSelection()}),300),this.notification.info("Issue selection started. Please select issues to process.")),this.render()}catch(e){console.error("Error ending sprint:",e),this.notification.error("Failed to end sprint: "+e.message)}}prepareForNextSprint(){try{const e=this.calculateSprintData(),t=Math.max(0,this.sprintState.totalHours-e.totalHours);this.archiveCompletedSprint(),this.sprintState.preparedForNext=!0,this.sprintState.extraHoursClosed=t,this.saveSprintState(),this.notification.success(`Sprint preparation complete. ${t.toFixed(1)}h of carried over work identified.`),this.render()}catch(e){console.error("Error preparing for next sprint:",e),this.notification.error("Failed to prepare for next sprint: "+e.message)}}resetSprint(){if(confirm("Are you sure you want to reset all sprint data? This cannot be undone.")){this.sprintState.endSprint&&!this.sprintState.preparedForNext&&this.archiveCompletedSprint();const e=this.sprintState.id;this.sprintState={endSprint:!1,preparedForNext:!1,currentMilestone:null,userPerformance:{}},e&&this.sprintHistory.length>0&&(this.sprintHistory=this.sprintHistory.filter((t=>t.id!==e)),this.saveSprintHistory()),this.saveSprintState(),this.notification.info("Sprint data has been reset."),this.render()}}editSprintData(){try{const e=`\n            <div style="display: flex; flex-direction: column; gap: 10px;">\n                <div>\n                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Total Tickets:</label>\n                    <input type="number" id="edit-total-tickets" value="${this.sprintState.totalTickets||0}" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">\n                </div>\n                <div>\n                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Closed Tickets:</label>\n                    <input type="number" id="edit-closed-tickets" value="${this.sprintState.closedTickets||0}" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">\n                </div>\n                <div>\n                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Total Hours:</label>\n                    <input type="number" id="edit-total-hours" value="${this.sprintState.totalHours||0}" min="0" step="0.1" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">\n                </div>\n                <div>\n                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Closed Hours:</label>\n                    <input type="number" id="edit-closed-hours" value="${this.sprintState.closedHours||0}" min="0" step="0.1" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">\n                </div>\n                <div>\n                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Extra Closed Hours:</label>\n                    <input type="number" id="edit-extra-hours" value="${this.sprintState.extraHoursClosed||0}" min="0" step="0.1" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">\n                </div>\n            </div>\n        `;this.showModal("Edit Sprint Data",e,(()=>{this.sprintState.totalTickets=parseFloat(document.getElementById("edit-total-tickets").value)||0,this.sprintState.closedTickets=parseFloat(document.getElementById("edit-closed-tickets").value)||0,this.sprintState.totalHours=parseFloat(document.getElementById("edit-total-hours").value)||0,this.sprintState.closedHours=parseFloat(document.getElementById("edit-closed-hours").value)||0,this.sprintState.extraHoursClosed=parseFloat(document.getElementById("edit-extra-hours").value)||0,this.sprintState.totalTickets>0&&!this.sprintState.endSprint&&(this.sprintState.endSprint=!0),this.sprintState.extraHoursClosed>0&&!this.sprintState.survivorsSet&&(this.sprintState.survivorsSet=!0),this.saveSprintState(),this.notification.success("Sprint data updated successfully."),this.render()}))}catch(e){console.error("Error editing sprint data:",e),this.notification.error("Failed to edit sprint data: "+e.message)}}showModal(e,t,s){const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0.5)",n.style.zIndex="1000",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.cursor="pointer";const i=document.createElement("div");i.style.backgroundColor="white",i.style.borderRadius="6px",i.style.padding="20px",i.style.width="500px",i.style.maxWidth="90%";const o=document.createElement("div");o.style.borderBottom="1px solid #eee",o.style.paddingBottom="10px",o.style.marginBottom="15px",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center";const a=document.createElement("h3");a.style.margin="0",a.textContent=e;const r=document.createElement("button");r.textContent="Ã—",r.style.background="none",r.style.border="none",r.style.fontSize="24px",r.style.cursor="pointer",r.style.padding="0",r.style.lineHeight="1",r.onclick=()=>{document.body.removeChild(n)},o.appendChild(a),o.appendChild(r);const l=document.createElement("div");l.style.marginBottom="20px","string"==typeof t?l.innerHTML=t:l.appendChild(t);const d=document.createElement("div");d.style.borderTop="1px solid #eee",d.style.paddingTop="15px",d.style.display="flex",d.style.justifyContent="flex-end",d.style.gap="10px";const c=document.createElement("button");c.textContent="Cancel",c.style.padding="8px 16px",c.style.backgroundColor="#6c757d",c.style.color="white",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=()=>{document.body.removeChild(n)};const h=document.createElement("button");h.textContent="Save",h.style.padding="8px 16px",h.style.backgroundColor="#28a745",h.style.color="white",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.onclick=()=>{"function"==typeof s&&s(),document.body.removeChild(n)},d.appendChild(c),d.appendChild(h),i.appendChild(o),i.appendChild(l),i.appendChild(d),n.appendChild(i),n.addEventListener("click",(e=>{e.target===n&&document.body.removeChild(n)})),document.body.appendChild(n)}showSprintDataSummary(e){const t=document.createElement("div");t.style.margin="10px",t.style.padding="15px",t.style.backgroundColor="#f8f9fa",t.style.borderRadius="6px",t.style.border="1px solid #dee2e6";const s=document.createElement("h3");s.textContent="Current Sprint Data",s.style.margin="0 0 15px 0",s.style.fontSize="16px",t.appendChild(s);const createDataRow=(e,t)=>{const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.marginBottom="8px",s.style.padding="5px 0",s.style.borderBottom="1px solid #eee";const n=document.createElement("div");n.textContent=e,n.style.fontWeight="bold";const i=document.createElement("div");return i.textContent=t,s.appendChild(n),s.appendChild(i),s},{totalTickets:n=0,closedTickets:i=0,totalHours:o=0,closedHours:a=0,extraHoursClosed:r=0,timestamp:l}=this.sprintState;if(t.appendChild(createDataRow("Total Tickets:",n)),t.appendChild(createDataRow("Closed Tickets:",i)),t.appendChild(createDataRow("Total Hours:",o.toFixed(1)+"h")),t.appendChild(createDataRow("Closed Hours:",a.toFixed(1)+"h")),r>0&&(t.appendChild(createDataRow("Extra Hours Closed:",r.toFixed(1)+"h")),t.appendChild(createDataRow("Total Hours Closed:",(a+r).toFixed(1)+"h"))),l){const e=new Date(l),s=`${e.toLocaleDateString()} ${e.toLocaleTimeString()}`;t.appendChild(createDataRow("Captured On:",s))}e.appendChild(t)}saveSprintState(){try{localStorage.setItem("gitLabHelperSprintState",JSON.stringify(this.sprintState))}catch(e){console.error("Failed to save sprint state to localStorage:",e),this.notification.error("Failed to save sprint state")}}loadSprintState(){try{const e=localStorage.getItem("gitLabHelperSprintState");e&&(this.sprintState=JSON.parse(e))}catch(e){console.error("Failed to load sprint state from localStorage:",e),this.notification.error("Failed to load sprint state")}}calculateUserPerformance(){const e={};try{document.querySelectorAll(".board-list").forEach((t=>{let s="";try{if(t.__vue__&&t.__vue__.$children&&t.__vue__.$children.length>0){const e=t.__vue__.$children.find((e=>e.$props&&e.$props.list&&e.$props.list.title));e&&e.$props.list.title&&(s=e.$props.list.title.toLowerCase())}if(!s){const e=t.querySelector(".board-title-text");e&&(s=e.textContent.trim().toLowerCase())}}catch(e){console.error("Error getting board title:",e);const n=t.querySelector(".board-title-text");n&&(s=n.textContent.trim().toLowerCase())}const n=s.includes("done")||s.includes("closed")||s.includes("complete")||s.includes("finished");t.querySelectorAll(".board-card").forEach((t=>{try{if(t.__vue__&&t.__vue__.$children){const s=t.__vue__.$children.find((e=>e.$props&&e.$props.item));if(s&&s.$props&&s.$props.item){const t=s.$props.item;let i=[];if(t.assignees&&t.assignees.nodes&&t.assignees.nodes.length?i=t.assignees.nodes:t.assignees&&t.assignees.length>0&&(i=t.assignees),0===i.length)return;const o=(t.timeEstimate||0)/i.length;i.forEach((t=>{const s=t.name||t.username||"Unknown";e[s]||(e[s]={totalTickets:0,closedTickets:0,totalHours:0,closedHours:0}),e[s].totalTickets++,e[s].totalHours+=o/3600,n&&(e[s].closedTickets++,e[s].closedHours+=o/3600)}))}}}catch(e){console.error("Error processing card for user performance:",e)}}))})),Object.keys(e).forEach((t=>{e[t].totalHours=Math.round(10*e[t].totalHours)/10,e[t].closedHours=Math.round(10*e[t].closedHours)/10}))}catch(e){console.error("Error calculating user performance:",e)}return e}archiveCompletedSprint(){try{if(!this.sprintState.endSprint||!this.sprintState.timestamp)return;const e={id:this.sprintState.id||Date.now().toString(),milestone:this.sprintState.currentMilestone,totalTickets:this.sprintState.totalTickets,closedTickets:this.sprintState.closedTickets,totalHours:this.sprintState.totalHours,closedHours:this.sprintState.closedHours,extraHoursClosed:this.sprintState.extraHoursClosed||0,userPerformance:this.sprintState.userPerformance||{},timestamp:this.sprintState.timestamp,completedAt:(new Date).toISOString()};this.sprintHistory.unshift(e),this.sprintHistory.length>10&&(this.sprintHistory=this.sprintHistory.slice(0,10)),this.saveSprintHistory()}catch(e){console.error("Error archiving sprint:",e)}}saveSprintHistory(){try{localStorage.setItem("gitLabHelperSprintHistory",JSON.stringify(this.sprintHistory))}catch(e){console.error("Failed to save sprint history to localStorage:",e),this.notification.error("Failed to save sprint history")}}loadSprintHistory(){try{const e=localStorage.getItem("gitLabHelperSprintHistory");e&&(this.sprintHistory=JSON.parse(e))}catch(e){console.error("Failed to load sprint history from localStorage:",e),this.notification.error("Failed to load sprint history"),this.sprintHistory=[]}}renderSprintHistory(e){if(!this.sprintHistory||0===this.sprintHistory.length)return;const t=document.createElement("div");t.style.margin="10px",t.style.padding="15px",t.style.backgroundColor="#f8f9fa",t.style.borderRadius="6px",t.style.border="1px solid #dee2e6";const s=document.createElement("h3");s.textContent="Sprint History",s.style.margin="0 0 15px 0",s.style.fontSize="16px",t.appendChild(s);const n=document.createElement("table");n.style.width="100%",n.style.borderCollapse="collapse";const i=document.createElement("thead"),o=document.createElement("tr");["Sprint","Tickets","Hours","Completed"].forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.padding="8px",t.style.textAlign="left",t.style.borderBottom="2px solid #dee2e6",o.appendChild(t)})),i.appendChild(o),n.appendChild(i);const a=document.createElement("tbody");this.sprintHistory.forEach((e=>{const t=document.createElement("tr");t.style.borderBottom="1px solid #dee2e6",t.style.transition="background-color 0.2s",t.style.cursor="pointer",t.addEventListener("mouseenter",(()=>{t.style.backgroundColor="#f1f1f1"})),t.addEventListener("mouseleave",(()=>{t.style.backgroundColor=""})),t.addEventListener("click",(()=>{this.showSprintDetails(e)}));const s=document.createElement("td");s.style.padding="8px",s.textContent=e.milestone||"Unnamed Sprint",s.style.color="#1f75cb",s.style.fontWeight="bold",t.appendChild(s);const n=document.createElement("td");n.style.padding="8px",n.textContent=`${e.closedTickets}/${e.totalTickets}`,t.appendChild(n);const i=(e.closedHours||0)+(e.extraHoursClosed||0),o=document.createElement("td");o.style.padding="8px",o.textContent=`${i.toFixed(1)}/${e.totalHours.toFixed(1)}h`,t.appendChild(o);const r=document.createElement("td");r.style.padding="8px";const l=new Date(e.completedAt||e.timestamp);r.textContent=l.toLocaleDateString(),t.appendChild(r),a.appendChild(t)})),n.appendChild(a),t.appendChild(n),e.appendChild(t)}showSprintDetails(e){const t=(e.closedHours||0)+(e.extraHoursClosed||0),s=e.totalTickets>0?(e.closedTickets/e.totalTickets*100).toFixed(1):0,n=e.totalHours>0?(t/e.totalHours*100).toFixed(1):0,i=new Date(e.timestamp),o=new Date(e.completedAt||e.timestamp);let a=`\n        <div style="padding: 10px;">\n            <h3 style="margin-top: 0; color: #1f75cb;">${e.milestone||"Unnamed Sprint"}</h3>\n            \n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">\n                <div style="padding: 10px; background-color: #e9ecef; border-radius: 4px;">\n                    <h4 style="margin-top: 0; font-size: 14px;">Tickets</h4>\n                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">\n                        ${e.closedTickets}/${e.totalTickets}\n                    </div>\n                    <div style="font-size: 14px; color: #6c757d;">\n                        ${s}% completed\n                    </div>\n                </div>\n                \n                <div style="padding: 10px; background-color: #e9ecef; border-radius: 4px;">\n                    <h4 style="margin-top: 0; font-size: 14px;">Hours</h4>\n                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">\n                        ${t.toFixed(1)}/${e.totalHours.toFixed(1)}h\n                    </div>\n                    <div style="font-size: 14px; color: #6c757d;">\n                        ${n}% completed\n                    </div>\n                </div>\n            </div>\n            \n            <div style="margin-bottom: 20px;">\n                <h4 style="margin-bottom: 10px; font-size: 16px;">Sprint Details</h4>\n                <table style="width: 100%; border-collapse: collapse;">\n                    <tr style="border-bottom: 1px solid #dee2e6;">\n                        <td style="padding: 8px; font-weight: bold;">Started:</td>\n                        <td style="padding: 8px;">${i.toLocaleString()}</td>\n                    </tr>\n                    <tr style="border-bottom: 1px solid #dee2e6;">\n                        <td style="padding: 8px; font-weight: bold;">Completed:</td>\n                        <td style="padding: 8px;">${o.toLocaleString()}</td>\n                    </tr>\n                    <tr style="border-bottom: 1px solid #dee2e6;">\n                        <td style="padding: 8px; font-weight: bold;">Carried Over Hours:</td>\n                        <td style="padding: 8px;">${(e.extraHoursClosed||0).toFixed(1)}h</td>\n                    </tr>\n                </table>\n            </div>\n    `;if(e.userPerformance&&Object.keys(e.userPerformance).length>0){a+='\n            <div>\n                <h4 style="margin-bottom: 10px; font-size: 16px;">User Performance</h4>\n                <table style="width: 100%; border-collapse: collapse;">\n                    <thead>\n                        <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">\n                            <th style="padding: 8px; text-align: left;">User</th>\n                            <th style="padding: 8px; text-align: center;">Tickets</th>\n                            <th style="padding: 8px; text-align: center;">Completion</th>\n                            <th style="padding: 8px; text-align: right;">Hours</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n        ';Object.entries(e.userPerformance).sort((([,e],[,t])=>t.closedHours-e.closedHours)).forEach((([e,t])=>{const s=t.totalTickets>0?(t.closedTickets/t.totalTickets*100).toFixed(0):0;a+=`\n                <tr style="border-bottom: 1px solid #dee2e6;">\n                    <td style="padding: 8px;">${e}</td>\n                    <td style="padding: 8px; text-align: center;">${t.closedTickets}/${t.totalTickets}</td>\n                    <td style="padding: 8px; text-align: center;">${s}%</td>\n                    <td style="padding: 8px; text-align: right;">${t.closedHours.toFixed(1)}/${t.totalHours.toFixed(1)}h</td>\n                </tr>\n            `})),a+="\n                    </tbody>\n                </table>\n            </div>\n        "}a+="</div>",this.showModal(`Sprint Details: ${e.milestone||"Unnamed Sprint"}`,a)}},e.BulkCommentsView=class BulkCommentsView{constructor(uiManager){this.uiManager=uiManager,this.selectedIssues=[],this.commandShortcuts=null,this.isLoading=!1,this.initializedShortcuts=new Set,this.commentInput=null,this.gitlabApi=e.gitlabApi||uiManager&&uiManager.gitlabApi,this.notification=new Notification({position:"bottom-right",duration:3e3}),uiManager&&uiManager.labelManager?this.labelManager=uiManager.labelManager:"function"==typeof LabelManager?this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.commandShortcuts&&this.addLabelShortcut()}}):this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([])},this.selectionDisplay=new SelectionDisplay({selectedIssues:this.selectedIssues,onRemoveIssue:e=>this.onRemoveIssue(e)})}updateAssignShortcut(t){if(this.commandShortcuts)if(!t||t.length<=3)console.warn("Not updating assign shortcut: no meaningful items to add");else try{let s=null;this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(s=this.commandShortcuts.shortcuts.assign.dropdown.value),this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.removeShortcut("assign"),this.commandShortcuts.addCustomShortcut({type:"assign",label:"/assign",items:t,onSelect:t=>{if(!t||"separator"===t||"separator2"===t)return;if("manage"===t){if(this.assigneeManager&&"function"==typeof this.assigneeManager.openAssigneeManager)this.assigneeManager.openAssigneeManager();else if(e.assigneeManager&&"function"==typeof e.assigneeManager.openAssigneeManager)e.assigneeManager.openAssigneeManager();else{if("function"!=typeof openAssigneeManager)return console.error("No assignee manager found"),void this.notification.error("Assignee manager not available");openAssigneeManager()}return void setTimeout((()=>{this.addAssignShortcut()}),500)}if("custom"===t){const e=prompt("Enter GitLab username (without @):");if(!e)return;t=e}const s=this.commentInput||document.getElementById("issue-comment-input");if(!s)return void console.error("No textarea found for inserting assign command");let n="/assign ";n+="none"===t?"@none":"@me"===t?"@me":t.startsWith("@")?t:`@${t}`,this.insertTextAtCursor(s,n),"none"===t?this.notification.info("Issue will be unassigned"):"@me"===t?this.notification.info("Issue will be assigned to you"):this.notification.info(`Issue will be assigned to ${t.replace("@","")}`)}}),s&&this.commandShortcuts.shortcuts.assign&&this.commandShortcuts.shortcuts.assign.dropdown&&(this.commandShortcuts.shortcuts.assign.dropdown.value=s)}catch(e){console.error("Error updating assign shortcut:",e)}else console.error("Cannot update assign shortcut: commandShortcuts not available")}initializeAllShortcuts(){if(this.commandShortcuts)try{const e=new Set(Object.keys(this.commandShortcuts.shortcuts||{}));e.has("estimate")||(this.commandShortcuts.initializeEstimateShortcut(),e.add("estimate")),e.has("label")||(this.addLabelShortcut([{value:"",label:"Loading labels..."}]),e.add("label")),e.has("milestone")||(this.addMilestoneShortcut(),e.add("milestone")),e.has("assign")||(this.addAssignShortcut(),e.add("assign"))}catch(e){console.error("Error initializing shortcuts:",e),this.notification.error("Error initializing shortcuts")}}addMilestoneShortcut(){if(this.commandShortcuts)try{this.commandShortcuts.addCustomShortcut({type:"milestone",label:"/milestone",items:[{value:"",label:"Set Milestone"},{value:"%current",label:"Current Sprint"},{value:"%next",label:"Next Sprint"},{value:"%upcoming",label:"Upcoming"},{value:"none",label:"Remove Milestone"},{value:"custom",label:"Custom..."}],onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter milestone name:");if(!t)return;e=t}if(!this.commentInput)return void console.warn("Comment input not available");let t="/milestone ";"none"===e?t+='%""':e.startsWith("%")?t+=e:t+=`%"${e}"`,this.insertTextAtCursor(this.commentInput,t),this.notification.info(`Milestone set to ${"none"===e?"none":e}`)}})}catch(e){console.error("Error adding milestone shortcut:",e)}}addAssignShortcut(){if(!this.commandShortcuts)return;let t=[{value:"",label:"Assign to..."},{value:"@me",label:"Myself"},{value:"none",label:"Unassign"}],s=null;try{"function"==typeof GM_getValue&&(s=GM_getValue("gitLabHelperAssigneeWhitelist",[]))}catch(e){console.error("Error accessing GM_getValue:",e)}if(Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"â”€â”€â”€â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}else{let s=[];if(this.assigneeManager&&"function"==typeof this.assigneeManager.getAssigneeWhitelist)try{s=this.assigneeManager.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from this.assigneeManager:",e)}if((!s||!s.length)&&e.assigneeManager&&"function"==typeof e.assigneeManager.getAssigneeWhitelist)try{s=e.assigneeManager.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from window.assigneeManager:",e)}if(!(s&&s.length||"function"!=typeof getAssigneeWhitelist))try{s=getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from imported getAssigneeWhitelist:",e)}if(!(s&&s.length||"function"!=typeof e.getAssigneeWhitelist))try{s=e.getAssigneeWhitelist()}catch(e){console.error("Error getting assignees from window.getAssigneeWhitelist:",e)}if(!s||!s.length)try{const e=localStorage.getItem("gitLabHelperAssigneeWhitelist");e&&(s=JSON.parse(e))}catch(e){console.error("Error getting assignees from localStorage:",e)}if(Array.isArray(s)&&s.length>0){t.push({value:"separator",label:"â”€â”€â”€â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€"});const e=s.map((e=>({value:e.username,label:e.name||e.username})));t=t.concat(e)}else console.warn("Could not find any assignees through any method")}t.push({value:"custom",label:"Custom..."}),this.updateAssignShortcut(t),setTimeout((()=>{this.fetchGroupMembers().then((e=>{if(e&&e.length>0){const s=[...t];s.push({value:"separator2",label:"â”€â”€â”€â”€â”€â”€ Group Members â”€â”€â”€â”€â”€â”€"});const n=t.filter((e=>e.value&&!["separator","separator2","custom","manage","@me","none",""].includes(e.value))).map((e=>e.value.toLowerCase())),i=e.filter((e=>!n.includes(e.username.toLowerCase()))).map((e=>({value:e.username,label:e.name||e.username})));i.length>0&&(s.push(...i),this.updateAssignShortcut(s))}})).catch((e=>{console.error("Error fetching group members:",e)}))}),100)}async fetchGroupMembers(){try{if(this.gitlabApi||(this.gitlabApi=e.gitlabApi),!this.gitlabApi)throw new Error("GitLab API not available");const t=getPathFromUrl();if(!t)throw new Error("Could not determine project/group path");let s;if("project"===t.type)s=await this.gitlabApi.callGitLabApi(`projects/${t.encodedPath}/members`,{params:{per_page:100}});else{if("group"!==t.type)throw new Error("Unsupported path type: "+t.type);s=await this.gitlabApi.callGitLabApi(`groups/${t.encodedPath}/members`,{params:{per_page:100}})}return Array.isArray(s)?s.map((e=>({id:e.id,name:e.name,username:e.username,avatar_url:e.avatar_url}))):(console.warn("API did not return an array of members"),[])}catch(e){return console.error("Error fetching group members:",e),[]}}setSelectedIssues(e){this.selectedIssues=Array.isArray(e)?[...e]:[],this.selectionDisplay&&this.selectionDisplay.setSelectedIssues(this.selectedIssues)}onRemoveIssue(t){if(this.selectedIssues.length>t){this.selectedIssues[t];this.selectedIssues.splice(t,1),this.uiManager&&this.uiManager.issueSelector?this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]):e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues])}const s=document.getElementById("comment-status");if(s){const e=this.selectedIssues.length;e>0?(s.textContent=`${e} issue${1!==e?"s":""} selected.`,s.style.color="green"):(s.textContent='No issues selected. Click "Select Issues" to choose issues.',s.style.color="#666")}}createActionButtons(e){const t=document.createElement("div");t.style.display="flex",t.style.gap="8px",t.style.marginBottom="8px";const s=document.createElement("button");s.id="select-issues-button",s.textContent="Select",s.style.padding="8px 12px",s.style.backgroundColor="#6c757d",s.style.color="white",s.style.border="none",s.style.borderRadius="4px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="background-color 0.2s ease",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.minWidth="80px",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#218838":"#5a6268"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="true"===s.dataset.active?"#28a745":"#6c757d"})),s.onclick=()=>{if(this.uiManager&&this.uiManager.issueSelector)this.uiManager.issueSelector.isSelectingIssue?(this.uiManager.issueSelector.exitSelectionMode(),s.dataset.active="false",s.style.backgroundColor="#6c757d",s.textContent="Select"):(this.uiManager.issueSelector.setSelectedIssues([...this.selectedIssues]),this.uiManager.issueSelector.startSelection(),s.dataset.active="true",s.style.backgroundColor="#28a745",s.textContent="Done");else{console.error("Issue selector not initialized");const e=document.getElementById("comment-status");e&&(e.textContent="Error: Issue selector not initialized.",e.style.color="#dc3545")}},t.appendChild(s);const n=document.createElement("button");n.textContent="Send",n.style.padding="8px 12px",n.style.backgroundColor="#1f75cb",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="14px",n.style.transition="background-color 0.2s ease",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flex="1",n.style.minWidth="80px",n.addEventListener("mouseenter",(()=>{n.style.backgroundColor="#1a63ac"})),n.addEventListener("mouseleave",(()=>{n.style.backgroundColor="#1f75cb"})),n.onclick=()=>this.submitComments(),t.appendChild(n),e.appendChild(t)}clearSelectedIssues(){console.log("Current selectedIssues:",this.selectedIssues),this.selectedIssues.splice(0,this.selectedIssues.length),this.selectedIssues=[],this.selectionDisplay&&"function"==typeof this.selectionDisplay.setSelectedIssues?(console.log("Calling selectionDisplay.setSelectedIssues with empty array"),this.selectionDisplay.setSelectedIssues([])):(console.warn("selectionDisplay not available or missing setSelectedIssues method"),this.uiManager&&this.uiManager.bulkCommentsView&&this.uiManager.bulkCommentsView.selectionDisplay&&(console.log("Found selectionDisplay through uiManager"),this.uiManager.bulkCommentsView.selectionDisplay.setSelectedIssues([])));const e=document.getElementById("comment-status");e&&(e.textContent="Selection cleared.",e.style.color="#666"),this.notification&&this.notification.info("Selection cleared"),this.uiManager&&this.uiManager.issueSelector&&(console.log("Clearing selection in issueSelector"),this.uiManager.issueSelector.setSelectedIssues([])),"function"==typeof this.$forceUpdate&&this.$forceUpdate(),console.log("Selection cleared, current selectedIssues:",this.selectedIssues)}render(){const e=document.getElementById("bulk-comments-content");e&&(e.innerHTML="",this.addCommentSection(e),this.commandShortcuts?(this.initializeAllShortcuts(),this.isLoading=!0,this.labelManager&&"function"==typeof this.labelManager.fetchAllLabels?this.labelManager.fetchAllLabels().then((e=>{this.addLabelShortcut(),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")})).catch((e=>{console.error("Error loading labels:",e),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")})):(console.warn("Label manager not available, using fallback labels"),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab"))):(console.error("Command shortcuts not initialized"),this.isLoading=!1,this.hideLoadingState(),this.uiManager&&this.uiManager.removeLoadingScreen&&this.uiManager.removeLoadingScreen("bulkcomments-tab")))}addCommentSection(e){const t=document.createElement("div");t.classList.add("api-section"),t.style.backgroundColor="#f5f5f5",t.style.borderRadius="8px",t.style.border="1px solid #e0e0e0",this.selectionDisplay.createSelectionContainer(t),this.createCommentInput(t),this.createActionButtons(t),this.createStatusElements(document.getElementById("assignee-time-summary")),this.isLoading=!0,this.showLoadingState();try{this.commentInput&&this.commandShortcuts?(this.initializeAllShortcuts(),this.addLabelShortcut([{value:"",label:"Loading labels..."}]),this.labelManager&&"function"==typeof this.labelManager.fetchAllLabels?this.labelManager.fetchAllLabels().then((e=>{this.addLabelShortcut(),this.isLoading=!1,this.hideLoadingState()})).catch((e=>{console.error("Error loading labels:",e),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState()})):(console.warn("Label manager not available, using fallback labels"),this.addLabelShortcut(this.getFallbackLabels()),this.isLoading=!1,this.hideLoadingState())):(console.error("Textarea or command shortcuts not initialized"),this.isLoading=!1,this.hideLoadingState())}catch(e){console.error("Error initializing shortcuts:",e),this.isLoading=!1,this.hideLoadingState()}e.appendChild(t)}getFallbackLabels(){return[{value:"",label:"Add Label"},{value:"bug",label:"Bug"},{value:"feature",label:"Feature"},{value:"enhancement",label:"Enhancement"},{value:"documentation",label:"Documentation"},{value:"custom",label:"Custom..."}]}createCommentInput(e){const t=document.createElement("div");t.id="shortcuts-wrapper",t.style.width="100%",t.style.marginBottom="15px",t.style.minHeight="120px",t.style.position="relative";const s=document.createElement("div");s.style.opacity="0.4",s.style.pointerEvents="none",["Estimate","Label","Milestone","Assign"].forEach((e=>{const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="8px",t.style.height="36px",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.padding="6px 10px";const n=document.createElement("div");n.textContent=`/${e.toLowerCase()}`,n.style.fontWeight="bold",n.style.minWidth="100px";const i=document.createElement("div");i.style.flex="1",i.style.height="24px",i.style.backgroundColor="#eee",i.style.marginLeft="10px",i.style.borderRadius="4px",t.appendChild(n),t.appendChild(i),s.appendChild(t)})),t.appendChild(s),e.appendChild(t);const n=document.createElement("textarea");n.id="issue-comment-input",n.placeholder="Enter your comment here...",n.style.width="100%",n.style.padding="8px",n.style.marginBottom="12px",n.style.borderRadius="4px",n.style.border="1px solid #ccc",n.style.minHeight="60px",n.style.fontSize="14px",n.style.transition="border-color 0.2s ease",n.style.resize="vertical",n.style.boxSizing="border-box",n.addEventListener("focus",(()=>{n.style.borderColor="#1f75cb",n.style.outline="none",n.style.boxShadow="0 0 0 2px rgba(31, 117, 203, 0.2)"})),n.addEventListener("blur",(()=>{n.style.borderColor="#ccc",n.style.boxShadow="none"})),e.appendChild(n),this.commentInput=n;try{"function"==typeof CommandShortcut?(this.commandShortcuts=new CommandShortcut({targetElement:n,onShortcutInsert:(e,t)=>{}}),this.commandShortcuts.initialize(t),s.parentNode===t&&t.removeChild(s)):console.error("CommandShortcut class not available")}catch(e){console.error("Error initializing CommandShortcut:",e)}}insertTextAtCursor(e,t){if(!e)return;const s=e.value,n=e.selectionStart,i=e.selectionEnd;let o=t;n>0&&"\n"!==s.charAt(n-1)&&s.length>0&&(o="\n"+o),e.value=s.substring(0,n)+o+s.substring(i);const a=n+o.length;e.setSelectionRange(a,a),e.focus()}createStatusElements(e){const t=document.createElement("div");t.id="comment-progress-container",t.style.display="none",t.style.marginTop="15px",t.style.color="white";const s=document.createElement("div");s.id="comment-progress-label",s.textContent="Submitting comments...",s.style.fontSize="13px",s.style.marginBottom="8px",s.style.textAlign="center",s.style.fontWeight="bold",t.appendChild(s);const n=document.createElement("div");n.style.height="12px",n.style.backgroundColor="black",n.style.overflow="hidden",n.style.boxShadow="inset 0 1px 3px rgba(255,255,255,0.1)";const i=document.createElement("div");i.id="comment-progress-bar",i.style.height="100%",i.style.width="0%",i.style.backgroundColor="#00ff2ac7",i.style.transition="width 0.3s ease",n.appendChild(i),t.appendChild(n),e.appendChild(t)}showLoadingState(){this.commandShortcuts&&!this.commandShortcuts.shortcuts?.label&&this.addLabelShortcut([{value:"",label:"Loading labels..."}]),this.commandShortcuts&&!this.commandShortcuts.shortcuts?.milestone&&this.addMilestoneShortcut(),this.commandShortcuts&&!this.commandShortcuts.shortcuts?.assign&&this.addAssignShortcut(),this.commentInput&&(this.commentInput.disabled=!0,this.commentInput.style.backgroundColor="#f9f9f9")}hideLoadingState(){const e=document.getElementById("comment-status");if(e){const t=this.selectedIssues.length;t>0?(e.textContent=`${t} issue${1!==t?"s":""} selected.`,e.style.color="#28a745",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef"):(e.textContent="Select issues to add comments.",e.style.color="#666",e.style.backgroundColor="#f8f9fa",e.style.border="1px solid #e9ecef")}const t=document.getElementById("issue-comment-input");t&&(t.disabled=!1,t.style.opacity="1",t.style.cursor="text");document.querySelectorAll(".api-section button").forEach((e=>{e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"}))}async submitComments(){if(!this.commentInput)return void this.notification.error("Comment input not found");const t=document.getElementById("comment-progress-container"),s=document.getElementById("comment-progress-bar"),n=document.getElementById("comment-progress-label");if(0===this.selectedIssues.length)return void this.notification.error("No issues selected");const i=this.commentInput.value.trim();if(!i)return void this.notification.error("Comment cannot be empty");let o;if(this.uiManager&&this.uiManager.addLoadingScreen){const t=document.getElementById("assignee-time-summary");if(t){const s=e.getComputedStyle(t).position;"static"===s&&(t.style.position="relative",t.dataset.originalPosition=s),o=this.uiManager.addLoadingScreen(t,"comment-submit",`Sending comments to ${this.selectedIssues.length} issues...`)}}t&&(t.style.display="block",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.bottom=0,t.style.zIndex=102),s&&(s.style.width="0%");const a=Array.from(document.querySelectorAll("button")).find((e=>e.textContent&&e.textContent.includes("Send")));a&&(a.disabled=!0,a.style.opacity="0.7",a.style.cursor="not-allowed");let r=0,l=0;const gitlabApi=this.gitlabApi||e.gitlabApi||this.uiManager&&this.uiManager.gitlabApi;if(!gitlabApi)return this.notification.error("GitLab API not available"),a&&(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer"),t&&(t.style.display="none"),void(this.uiManager&&this.uiManager.removeLoadingScreen&&o&&this.uiManager.removeLoadingScreen("comment-submit"));for(let e=0;e<this.selectedIssues.length;e++){const t=this.selectedIssues[e];if(!t){l++;continue}const o=Math.round(e/this.selectedIssues.length*100);s&&(s.style.width=`${o}%`),n&&(n.textContent=`Processing ${e+1} of ${this.selectedIssues.length} issues...`),this.uiManager&&this.uiManager.updateLoadingMessage&&this.uiManager.updateLoadingMessage("comment-submit",`Sending comment to issue #${t.iid||e+1} (${e+1}/${this.selectedIssues.length})...`);try{await gitlabApi.addComment(t,i),r++}catch(e){console.error(`Failed to add comment to issue #${t.iid}:`,e),l++}}if(s&&(s.style.width="100%"),a&&(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer"),r===this.selectedIssues.length){this.notification.success(`Added comment to ${r} issues`),this.commentInput&&(this.commentInput.value="");let e=this;this.refreshBoard().then((function(){t.style.display="none",e.clearSelectedIssues(),e.uiManager.issueSelector.exitSelectionMode(),e.uiManager.removeLoadingScreen("comment-submit")}))}else r>0?(this.notification.warning(`Added comment to ${r} issues, failed for ${l}`),this.refreshBoard().then((function(){t.style.display="none",that.clearSelectedIssues(),that.uiManager.issueSelector.exitSelectionMode(),that.uiManager.removeLoadingScreen("comment-submit")}))):this.notification.error(`Failed to add comments to all ${l} issues`),s&&(s.style.backgroundColor=r>0?"#ff9900":"#dc3545")}addLabelShortcut(e){if(this.commandShortcuts)try{let t,s=null;if(this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(s=this.commandShortcuts.shortcuts.label.dropdown.value),e)t=e;else if(this.labelManager&&this.labelManager.filteredLabels&&this.labelManager.filteredLabels.length){t=[{value:"",label:"Add Label"}];const e=this.labelManager.filteredLabels.map((e=>({value:e.name,label:e.name})));t=t.concat(e),t.push({value:"custom",label:"Custom..."})}else try{const e=getLabelWhitelist();if(e&&e.length>0){t=[{value:"",label:"Add Label"}];const s=e.map((e=>({value:e,label:e})));t=t.concat(s),t.push({value:"custom",label:"Custom..."})}else t=this.getFallbackLabels()}catch(e){console.error("Error getting label whitelist:",e),t=this.getFallbackLabels()}this.commandShortcuts.shortcuts&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.removeShortcut("label"),this.commandShortcuts.addCustomShortcut({type:"label",label:"/label",items:t,onSelect:e=>{if(!e)return;if("custom"===e){const t=prompt("Enter custom label name:");if(!t)return;e=t}const t=document.getElementById("issue-comment-input");if(!t)return;const s=`/label ~"${e}"`;this.insertTextAtCursor(t,s),this.notification.info(`Label added: ${e}`)}}),s&&this.commandShortcuts.shortcuts.label&&this.commandShortcuts.shortcuts.label.dropdown&&(this.commandShortcuts.shortcuts.label.dropdown.value=s)}catch(e){console.error("Error adding label shortcut:",e)}}async refreshBoard(){try{const t=document.querySelectorAll(".board-list-component");console.log(`Found ${t.length} board lists to refresh`);const s=[];for(const e of t)if(e.__vue__&&e.__vue__.$apollo&&e.__vue__.$apollo.queries.currentList){const t=e.__vue__.$apollo.queries.currentList.refetch();s.push(t)}return await Promise.all(s),console.log("All boards refreshed, applying overflow fixes and updating summary"),e.uiManager&&e.uiManager.issueSelector&&e.uiManager.issueSelector.applyOverflowFixes(),"function"==typeof e.updateSummary&&e.updateSummary(!0),console.log("Board refresh and updates complete"),!0}catch(e){return console.error("Error refreshing boards:",e),!1}}},e.UIManager=class UIManager{constructor(){this.gitlabApi=e.gitlabApi,this.container=null,this.contentWrapper=null,this.headerDiv=null,this.header=null,this.recalculateBtn=null,this.collapseBtn=null,this.boardStats=null,this.initializeManagers(),this.tabManager=new TabManager(this),this.summaryView=new SummaryView(this),this.boardsView=new BoardsView(this),this.bulkCommentsView=new BulkCommentsView(this),this.sprintManagementView=new SprintManagementView(this),this.issueSelector=new IssueSelector({uiManager:this,onSelectionChange:e=>{this.bulkCommentsView&&this.bulkCommentsView.setSelectedIssues(e)}})}initialize(e=document.body){if(document.getElementById("assignee-time-summary"))return this.container=document.getElementById("assignee-time-summary"),this.contentWrapper=document.getElementById("assignee-time-summary-wrapper"),void(this.container.style.position="relative");this.container=document.createElement("div"),this.container.id="assignee-time-summary",this.container.style.position="fixed",this.container.style.bottom="15px",this.container.style.right="15px",this.container.style.backgroundColor="white",this.container.style.border="1px solid #ddd",this.container.style.borderRadius="4px",this.container.style.padding="10px",this.container.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)",this.container.style.zIndex="100",this.container.style.maxHeight="80vh",this.container.style.overflow="hidden",this.container.style.fontSize="14px",this.container.style.width="400px",this.container.style.transition="height 0.3s ease-in-out",this.contentWrapper=document.createElement("div"),this.contentWrapper.id="assignee-time-summary-wrapper",this.contentWrapper.style.display="block",this.contentWrapper.style.maxHeight="70vh",this.contentWrapper.style.minHeight="350px",this.contentWrapper.style.overflowY="auto",this.contentWrapper.style.position="relative",this.createHeader(),this.createBoardStats(),this.tabManager.initialize(this.contentWrapper),this.ensureTabContentHeight(),this.container.appendChild(this.contentWrapper),e.appendChild(this.container),this.attachmentElement=e,this.container.addEventListener("click",(e=>{!this.issueSelector||!this.issueSelector.isSelectingIssue||e.target.classList.contains("card-selection-overlay")||e.target.classList.contains("selection-badge")||e.target.closest("#bulk-comments-content button")||e.target.closest("#issue-comment-input")||e.target.closest("#shortcuts-wrapper")||e.target.closest("#selected-issues-list")||e.target.closest("#selection-cancel-button")||this.issueSelector.exitSelectionMode()}));try{"true"===loadFromStorage("gitlabTimeSummaryCollapsed","false")&&(this.contentWrapper.style.display="none",this.collapseBtn&&(this.collapseBtn.textContent="â–²"),this.container.style.height="auto")}catch(e){console.warn("Error loading collapsed state:",e)}}initializeManagers(){try{this.labelManager=new LabelManager({gitlabApi:this.gitlabApi,onLabelsLoaded:e=>{this.bulkCommentsView&&this.bulkCommentsView.addLabelShortcut&&this.bulkCommentsView.addLabelShortcut()}})}catch(e){console.error("Error initializing LabelManager:",e),this.labelManager={filteredLabels:[],fetchAllLabels:()=>Promise.resolve([]),isLabelInWhitelist:()=>!1}}try{this.assigneeManager=new AssigneeManager({gitlabApi:this.gitlabApi,onAssigneesChange:e=>{this.bulkCommentsView&&this.bulkCommentsView.addAssignShortcut&&this.bulkCommentsView.addAssignShortcut()}})}catch(e){console.error("Error initializing AssigneeManager:",e),this.assigneeManager={getAssigneeWhitelist:()=>[]}}try{this.milestoneManager=new MilestoneManager({gitlabApi:this.gitlabApi,onMilestonesLoaded:e=>{}})}catch(e){console.error("Error initializing MilestoneManager:",e),this.milestoneManager={milestones:[],fetchMilestones:()=>Promise.resolve([])}}}createHeader(){this.headerDiv=document.createElement("div"),this.headerDiv.style.display="flex",this.headerDiv.style.justifyContent="space-between",this.headerDiv.style.alignItems="center",this.headerDiv.style.marginBottom="5px",this.headerDiv.style.cursor="pointer",this.headerDiv.addEventListener("click",(e=>{e.target!==this.recalculateBtn&&e.target!==this.collapseBtn&&e.target!==this.settingsBtn&&this.toggleCollapse()})),this.header=document.createElement("h3"),this.header.id="assignee-time-summary-header",this.header.textContent="Summary",this.header.style.margin="0",this.header.style.fontSize="16px";const t=document.createElement("div");t.style.display="flex",t.style.gap="5px",this.recalculateBtn=document.createElement("button"),this.recalculateBtn.textContent="ðŸ”„",this.recalculateBtn.title="Recalculate",this.recalculateBtn.style.padding="3px 6px",this.recalculateBtn.style.fontSize="12px",this.recalculateBtn.style.backgroundColor="#1f75cb",this.recalculateBtn.style.color="white",this.recalculateBtn.style.border="none",this.recalculateBtn.style.borderRadius="3px",this.recalculateBtn.style.cursor="pointer",this.recalculateBtn.onclick=t=>{t.stopPropagation(),"function"==typeof e.updateSummary&&e.updateSummary(!0),this.recalculateBtn.textContent="âœ“",setTimeout((()=>{this.recalculateBtn.textContent="ðŸ”„"}),1e3)},this.settingsBtn=document.createElement("button"),this.settingsBtn.textContent="âš™ï¸",this.settingsBtn.title="Settings",this.settingsBtn.style.padding="3px 6px",this.settingsBtn.style.fontSize="12px",this.settingsBtn.style.backgroundColor="#6c757d",this.settingsBtn.style.color="white",this.settingsBtn.style.border="none",this.settingsBtn.style.borderRadius="3px",this.settingsBtn.style.cursor="pointer",this.settingsBtn.onclick=e=>{e.stopPropagation(),this.openSettings()},this.collapseBtn=document.createElement("button"),this.collapseBtn.textContent="â–¼",this.collapseBtn.title="Collapse/Expand",this.collapseBtn.style.padding="3px 6px",this.collapseBtn.style.fontSize="12px",this.collapseBtn.style.backgroundColor="#777",this.collapseBtn.style.color="white",this.collapseBtn.style.border="none",this.collapseBtn.style.borderRadius="3px",this.collapseBtn.style.cursor="pointer",this.collapseBtn.onclick=e=>{e.stopPropagation(),this.toggleCollapse()},t.appendChild(this.recalculateBtn),t.appendChild(this.settingsBtn),t.appendChild(this.collapseBtn),this.headerDiv.appendChild(this.header),this.headerDiv.appendChild(t),this.container.appendChild(this.headerDiv)}createBoardStats(){const e=document.getElementById("board-stats-summary");e?this.boardStats=e:(this.boardStats=document.createElement("div"),this.boardStats.id="board-stats-summary",this.boardStats.style.fontSize="13px",this.boardStats.style.color="#555",this.boardStats.style.marginBottom="10px",this.boardStats.style.display="flex",this.boardStats.style.justifyContent="space-between",this.boardStats.textContent="Loading board statistics...",this.container.appendChild(this.boardStats))}updateBoardStats(e){if(!this.boardStats)return;const t=e?.totalCards||a0,s=e?.closedCards||0;this.boardStats.innerHTML="";const n=document.createElement("div");n.style.display="flex",n.style.gap="8px";const i=document.createElement("span");i.textContent=`Total: ${t} cards`,n.appendChild(i);const o=document.createElement("div");o.textContent=`Closed: ${s} cards`,o.style.color="#28a745",this.boardStats.appendChild(n),this.boardStats.appendChild(o)}toggleCollapse(){if(this.contentWrapper&&this.collapseBtn)try{"none"===this.contentWrapper.style.display?(this.contentWrapper.style.display="block",this.collapseBtn.textContent="â–¼",this.container.style.height="",saveToStorage("gitlabTimeSummaryCollapsed","false")):(this.contentWrapper.style.display="none",this.collapseBtn.textContent="â–²",this.container.style.height="auto",saveToStorage("gitlabTimeSummaryCollapsed","true"))}catch(e){console.error("Error toggling collapse state:",e)}}openSettings(){try{if("function"==typeof e.SettingsManager){new e.SettingsManager({labelManager:this.labelManager,assigneeManager:this.assigneeManager,gitlabApi:this.gitlabApi,onSettingsChanged:e=>{"all"!==e&&"labels"!==e||this.bulkCommentsView&&this.bulkCommentsView.addLabelShortcut(),"all"!==e&&"assignees"!==e||this.bulkCommentsView&&this.bulkCommentsView.addAssignShortcut()}}).openSettingsModal()}else console.error("SettingsManager not available")}catch(e){console.error("Error opening settings:",e)}}updateHeader(e){this.header&&(this.header.innerHTML=e)}addLoadingScreen(t,s,n="Loading..."){if("string"==typeof t&&(t=document.getElementById(t)),!t)return console.warn(`Container not found for loading screen: ${s}`),null;const i=document.getElementById(`loading-screen-${s}`);if(i){const e=i.querySelector(".loading-message");return e&&(e.textContent=n),i}const o=document.createElement("div");o.id=`loading-screen-${s}`,o.className="gitlab-helper-loading-screen",o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="rgba(0, 0, 0, 0.5)",o.style.display="flex",o.style.flexDirection="column",o.style.justifyContent="center",o.style.alignItems="center",o.style.zIndex="101",o.style.transition="opacity 0.3s ease";const a=document.createElement("div");a.className="loading-spinner",a.style.width="40px",a.style.height="40px",a.style.borderRadius="50%",a.style.border="3px solid rgba(255, 255, 255, 0.2)",a.style.borderTopColor="#ffffff",a.style.animation="gitlab-helper-spin 1s linear infinite";const r=document.createElement("div");if(r.className="loading-message",r.textContent=n,r.style.marginTop="15px",r.style.fontWeight="bold",r.style.color="#ffffff",r.style.fontSize="14px",r.style.textAlign="center",r.style.padding="0 20px",r.style.maxWidth="90%",!document.getElementById("gitlab-helper-loading-styles")){const e=document.createElement("style");e.id="gitlab-helper-loading-styles",e.textContent="\n        @keyframes gitlab-helper-spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        @keyframes gitlab-helper-pulse {\n            0% { opacity: 0.6; }\n            50% { opacity: 1; }\n            100% { opacity: 0.6; }\n        }\n    ",document.head.appendChild(e)}o.appendChild(a),o.appendChild(r);const l=e.getComputedStyle(t).position;return"static"!==l&&l||(t.style.position="relative",t.dataset.originalPosition=l),t.appendChild(o),r.style.animation="gitlab-helper-pulse 2s ease infinite",o}removeLoadingScreen(e,t=!0){const s=document.getElementById(`loading-screen-${e}`);if(!s)return;const n=s.parentNode;t?(s.style.opacity="0",setTimeout((()=>{s.parentNode&&s.parentNode.removeChild(s),n&&n.dataset.originalPosition&&(n.style.position=n.dataset.originalPosition,delete n.dataset.originalPosition)}),300)):(s.parentNode.removeChild(s),n&&n.dataset.originalPosition&&(n.style.position=n.dataset.originalPosition,delete n.dataset.originalPosition))}updateLoadingMessage(e,t){const s=document.getElementById(`loading-screen-${e}`);if(!s)return;const n=s.querySelector(".loading-message");n&&(n.textContent=t)}ensureTabContentHeight(){const e=[document.getElementById("assignee-time-summary-content"),document.getElementById("boards-time-summary-content"),document.getElementById("bulk-comments-content")],t=document.getElementById("assignee-time-summary-wrapper"),s=this.headerDiv||document.querySelector("#assignee-time-summary > div:first-child");if(!t||!s)return console.warn("Could not find wrapper or header elements for height calculation"),void e.forEach((e=>{e&&(e.style.minHeight="300px",e.style.position="relative")}));const n=s.offsetHeight+36+(this.boardStats?this.boardStats.offsetHeight:0)+20;e.forEach((e=>{e&&(e.style.minHeight=`calc(100% - ${n}px)`,e.style.height=`calc(100% - ${n}px)`,e.style.position="relative")}))}},e.uiManager=e.uiManager||new UIManager,e.createSummaryContainer=function createSummaryContainer(){return uiManager.initialize(),uiManager.container},e.updateSummaryTab=function updateSummaryTab(e,t,s,n,i,o,a){if("function"==typeof processBoards){const{closedBoardCards:e}=processBoards();uiManager.updateBoardStats({totalCards:s,withTimeCards:n,closedCards:e||0})}uiManager.summaryView.render(e,t,s,n,i,o,a)},e.updateBoardsTab=function updateBoardsTab(e,t){uiManager.boardsView.render(e,t)},e.updateBulkCommentsTab=function updateBulkCommentsTab(){uiManager.bulkCommentsView.render()},e.renderHistory=function renderHistory(){uiManager.historyView.render()},e.addEventListener("scroll",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{uiManager&&uiManager.issueSelector&&"function"==typeof uiManager.issueSelector.repositionOverlays&&uiManager.issueSelector.repositionOverlays()})),e.uiManager=uiManager,e.updateSummaryTab=updateSummaryTab,e.updateBoardsTab=updateBoardsTab,e.updateBulkCommentsTab=updateBulkCommentsTab,e.renderHistory=renderHistory,e.createSummaryContainer=createSummaryContainer,e.SettingsManager=SettingsManager,setTimeout((()=>{const t=document.querySelector('#assignee-time-summary button[title="Settings"]');t?t.onclick=t=>{t.stopPropagation();try{new SettingsManager({labelManager:e.uiManager?.labelManager,assigneeManager:e.uiManager?.assigneeManager,gitlabApi:e.gitlabApi,onSettingsChanged:t=>{e.uiManager?.bulkCommentsView&&("all"!==t&&"labels"!==t||e.uiManager.bulkCommentsView.addLabelShortcut(),"all"!==t&&"assignees"!==t||e.uiManager.bulkCommentsView.addAssignShortcut())}}).openSettingsModal()}catch(e){console.error("Error creating settings manager:",e)}}:console.warn("Settings button not found")}),2e3);let o=!1;function checkAndInit(){o||e.location.href.includes("/boards")&&function waitForBoardsElement(e=30,t=500){return new Promise(((s,n)=>{let i=0;const checkForElement=()=>{i++;const n=document.querySelector('[data-testid="boards-list"]');if(n)return void s(n);const o=[".boards-list",".board-list-component",".boards-app"];for(const e of o){const t=document.querySelector(e);if(t)return void s(t)}if(i>=e)return console.warn("Maximum attempts reached, attaching to body as fallback"),void s(document.body);setTimeout(checkForElement,t)};checkForElement()}))}().then((e=>{createUIManager(e);o=!0,waitForBoards()})).catch((e=>{console.error("Error initializing UI:",e);createUIManager(document.body);o=!0,waitForBoards()}))}function updateSummary(t=!1){if(!e.uiManager)return void console.warn("UI Manager not initialized, cannot update summary");let s,n=!1;clearTimeout(s);try{const t=processBoards(),{assigneeTimeMap:i,boardData:o,boardAssigneeData:a,totalEstimate:r,cardsProcessed:l,cardsWithTime:d,currentMilestone:c,closedBoardCards:h}=t;clearTimeout(s),s=setTimeout((()=>{n=!0}),3e3),e.uiManager.updateBoardStats({totalCards:l,withTimeCards:d,closedCards:h||0});const u=(r/3600).toFixed(1);e.uiManager.updateHeader(`Summary ${u}h`);const p=o||{},m=a||{};e.uiManager.summaryView&&e.uiManager.summaryView.render(i,r,l,d,c,p,m),e.uiManager.boardsView&&e.uiManager.boardsView.render(p,m);const g=document.getElementById("sprint-management-content");g&&"block"===g.style.display&&e.uiManager.sprintManagementView&&e.uiManager.sprintManagementView.render();const y=document.getElementById("bulk-comments-content");y&&"block"===y.style.display&&e.uiManager.bulkCommentsView&&e.uiManager.bulkCommentsView.render()}catch(e){console.error("Error updating summary:",e)}}function addBoardChangeListeners(){try{document.querySelectorAll(".board-list").forEach((e=>{new MutationObserver((()=>{updateSummary()})).observe(e,{childList:!0,subtree:!0})}))}catch(e){console.error("Error adding board change listeners:",e)}}function waitForBoards(){if(e.boardsInitialized)return;let t=document.getElementById("board-stats-summary");if(!t)if(t=document.createElement("div"),t.id="board-stats-summary",t.style.fontSize="13px",t.style.color="#555",t.style.marginBottom="10px",e.uiManager?.container)e.uiManager.container.appendChild(t);else{const e=document.createElement("div");e.id="temp-stats-container",e.appendChild(t),document.body.appendChild(e)}t.textContent="Waiting for boards to load...";let s=0;const n=setInterval((()=>{s++;const i=document.querySelectorAll(".board-list");i.length>=3?(clearInterval(n),t&&(t.textContent=`Found ${i.length} boards, initializing...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners(),e.boardsInitialized=!0}),1e3)):s>=30?(clearInterval(n),t&&(t.textContent=`Found ${i.length} boards, continuing anyway...`),setTimeout((()=>{updateSummary(),addBoardChangeListeners(),e.boardsInitialized=!0}),1e3)):i.length>0&&t&&(t.textContent=`Found ${i.length} boards, waiting for more...`)}),500)}checkAndInit();let a=e.location.href;try{new MutationObserver((()=>{e.location.href!==a&&(a=e.location.href,setTimeout(checkAndInit,1e3))})).observe(document,{subtree:!0,childList:!0})}catch(e){console.error("Error setting up URL observer:",e)}e.gitlabApi=e.gitlabApi||new GitLabAPI,e.updateSummary=updateSummary,e.checkAndInit=checkAndInit,e.waitForBoards=waitForBoards,e.SettingsManager=SettingsManager,e.LabelManager=LabelManager,e.AssigneeManager=AssigneeManager,e.addEventListener("scroll",(()=>{e.uiManager?.issueSelector&&"function"==typeof e.uiManager.issueSelector.repositionOverlays&&e.uiManager.issueSelector.repositionOverlays()})),e.addEventListener("resize",(()=>{e.uiManager?.issueSelector&&"function"==typeof e.uiManager.issueSelector.repositionOverlays&&e.uiManager.issueSelector.repositionOverlays()})),function(){"use strict"}()}(window);